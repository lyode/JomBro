<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <!-- PWA Meta Tags -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="JomBro">
    <meta name="theme-color" content="#ff6b9d">
    <meta name="description" content="AI-Powered Social Challenge Platform - Connect, Challenge, Conquer!">
    
    <!-- Firebase v9 SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
       
    <title>JomBro - Enhanced Social Challenge Platform</title>

    <style>
        :root {
            --safe-area-top: env(safe-area-inset-top, 20px);
            --safe-area-bottom: env(safe-area-inset-bottom, 20px);
            --primary-pink: #ff6b9d;
            --primary-purple: #8b5cf6;
            --primary-blue: #00d4ff;
            --accent-pink: #ff8cc8;
            --accent-purple: #a855f7;
            --accent-blue: #3b82f6;
            --dark-bg: #0a0a0a;
            --glass-bg: rgba(15, 15, 15, 0.85);
            --glass-border: rgba(255, 255, 255, 0.1);
            --glass-shadow: rgba(0, 0, 0, 0.5);
            --text-primary: #ffffff;
            --text-secondary: rgba(255, 255, 255, 0.7);
            --success-green: #10b981;
            --warning-orange: #f59e0b;
            --error-red: #ef4444;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-font-smoothing: antialiased;
            touch-action: manipulation;
        }

        html, body {
            height: 100vh;
            width: 100%;
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif;
            background: #000000;
            color: var(--text-primary);
            user-select: none;
            overflow: hidden;
        }

        /* Auth Screen Styles */
        .auth-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 5000;
            padding: 20px;
        }

        .auth-container {
            background: var(--glass-bg);
            backdrop-filter: blur(25px);
            border: 1px solid var(--glass-border);
            border-radius: 25px;
            padding: 40px 30px;
            text-align: center;
            box-shadow: 0 25px 50px var(--glass-shadow);
            max-width: 350px;
            width: 100%;
        }

        .auth-logo {
            font-size: 48px;
            margin-bottom: 10px;
        }

        .auth-title {
            font-size: 28px;
            font-weight: 300;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .auth-subtitle {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 30px;
        }

        .auth-btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .auth-btn.google {
            background: #fff;
            color: #333;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .auth-btn.phone {
            background: var(--primary-pink);
            color: #fff;
        }

        .auth-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
        }

        /* Enhanced Modal System */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 3000;
            padding: 20px;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: var(--glass-bg);
            backdrop-filter: blur(25px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 25px;
            max-width: 90%;
            max-height: 80%;
            overflow-y: auto;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--glass-border);
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 20px;
            cursor: pointer;
            padding: 5px;
        }

        /* Enhanced User Profile Styles */
        .profile-header {
            text-align: center;
            margin-bottom: 25px;
        }

        .profile-avatar-large {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(45deg, var(--primary-pink), var(--primary-purple));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            margin: 0 auto 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .profile-avatar-large:hover {
            transform: scale(1.05);
        }

        .profile-avatar-edit {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 24px;
            height: 24px;
            background: var(--primary-pink);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            cursor: pointer;
        }

        .profile-name {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .profile-bio {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 5px;
        }

        .profile-level {
            display: inline-block;
            background: var(--primary-pink);
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .profile-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin: 20px 0;
        }

        .profile-stat {
            text-align: center;
            background: rgba(255, 255, 255, 0.05);
            padding: 15px 10px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .profile-stat:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
        }

        .profile-stat-value {
            font-size: 18px;
            font-weight: 700;
            color: var(--primary-pink);
            margin-bottom: 4px;
        }

        .profile-stat-label {
            font-size: 11px;
            color: var(--text-secondary);
            text-transform: uppercase;
        }

        .profile-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 20px;
        }

        /* Enhanced Friends System */
        .friends-search {
            position: relative;
            margin-bottom: 20px;
        }

        .friends-search-input {
            width: 100%;
            padding: 12px 15px 12px 40px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 14px;
            outline: none;
        }

        .friends-search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
        }

        .friends-tabs {
            display: flex;
            margin-bottom: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 4px;
        }

        .friends-tab {
            flex: 1;
            padding: 8px 12px;
            text-align: center;
            font-size: 12px;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: var(--text-secondary);
        }

        .friends-tab.active {
            background: var(--primary-pink);
            color: white;
        }

        .friend-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .friend-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(5px);
        }

        .friend-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(45deg, var(--primary-blue), var(--primary-purple));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            position: relative;
        }

        .friend-status {
            position: absolute;
            bottom: -2px;
            right: -2px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 2px solid var(--dark-bg);
        }

        .friend-status.online {
            background: var(--success-green);
        }

        .friend-status.offline {
            background: var(--text-secondary);
        }

        .friend-info {
            flex: 1;
        }

        .friend-name {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 2px;
        }

        .friend-activity {
            font-size: 11px;
            color: var(--text-secondary);
        }

        .friend-actions {
            display: flex;
            gap: 8px;
        }

        .friend-action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 8px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .friend-action-btn.primary {
            background: var(--primary-pink);
            color: white;
        }

        .friend-action-btn.secondary {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
        }

        /* Enhanced Group System */
        .group-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-label {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .form-input {
            padding: 12px 15px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid var(--glass-border);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 14px;
            outline: none;
            transition: all 0.3s ease;
        }

        .form-input:focus {
            border-color: var(--primary-pink);
            box-shadow: 0 0 0 2px rgba(255, 107, 157, 0.2);
        }

        .form-textarea {
            min-height: 80px;
            resize: vertical;
        }

        .form-select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%23ffffff' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 8px center;
            background-repeat: no-repeat;
            background-size: 16px;
            padding-right: 32px;
        }

        .group-privacy-options {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 8px;
        }

        .privacy-option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .privacy-option:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .privacy-option input[type="radio"] {
            margin: 0;
        }

        .members-selector {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid var(--glass-border);
            border-radius: 10px;
            padding: 10px;
        }

        .member-option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .member-option:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .member-checkbox {
            margin: 0;
        }

        /* Enhanced Chat Interface */
        .chat-interface {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 60%;
            background: var(--glass-bg);
            backdrop-filter: blur(25px);
            border-top: 1px solid var(--glass-border);
            border-radius: 20px 20px 0 0;
            transform: translateY(100%);
            transition: transform 0.3s ease;
            z-index: 1000;
            display: flex;
            flex-direction: column;
        }

        .chat-interface.open {
            transform: translateY(0);
        }

        .chat-header {
            padding: 15px 20px;
            border-bottom: 1px solid var(--glass-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .chat-members {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .chat-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 18px;
            cursor: pointer;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .message {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .message.own {
            flex-direction: row-reverse;
        }

        .message.system {
            justify-content: center;
            margin: 10px 0;
        }

        .message.system .message-content {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-secondary);
            font-size: 12px;
            text-align: center;
            max-width: 80%;
        }

        .message-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--primary-pink);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            flex-shrink: 0;
        }

        .message-content {
            background: rgba(255,255,255,0.1);
            padding: 8px 12px;
            border-radius: 12px;
            max-width: 70%;
            word-wrap: break-word;
        }

        .message.own .message-content {
            background: var(--primary-pink);
        }

        .message-text {
            font-size: 14px;
            line-height: 1.4;
        }

        .message-time {
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .chat-input-container {
            padding: 15px;
            border-top: 1px solid var(--glass-border);
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .chat-input {
            flex: 1;
            background: rgba(255,255,255,0.1);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 10px 15px;
            color: var(--text-primary);
            font-size: 14px;
            outline: none;
        }

        .chat-input::placeholder {
            color: var(--text-secondary);
        }

        .chat-send {
            background: var(--primary-pink);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: #fff;
            font-size: 16px;
        }

        /* Main App Layout */
        .phone-container {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            padding: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1;
        }

        .glass-interface {
            width: 100%;
            max-width: 400px;
            height: calc(100vh - 20px);
            background: var(--glass-bg);
            backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid var(--glass-border);
            border-radius: 25px;
            box-shadow: 0 25px 50px var(--glass-shadow);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        .glass-header {
            position: sticky;
            top: 0;
            z-index: 100;
            padding: calc(var(--safe-area-top) + 20px) 25px 20px 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
            background: rgba(15, 15, 15, 0.95);
            backdrop-filter: blur(25px);
        }

        .logo-section {
            display: flex;
            flex-direction: column;
            cursor: pointer;
        }

        .logo-text {
            font-size: 26px;
            font-weight: 200;
            color: var(--text-primary);
            letter-spacing: -1px;
        }

        .logo-slogan {
            font-size: 10px;
            color: var(--primary-pink);
            margin-top: -2px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            opacity: 0.9;
            animation: pulse 3s infinite;
        }

        .logo-subtitle {
            font-size: 9px;
            color: var(--text-secondary);
            margin-top: 2px;
            opacity: 0.8;
        }

        .header-actions {
            display: flex;
            gap: 8px;
        }

        .header-btn {
            width: 30px;
            height: 30px;
            border-radius: 15px;
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.15);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 14px;
            color: var(--text-primary);
            transition: all 0.3s ease;
            position: relative;
        }

        .header-btn:hover {
            background: rgba(255, 107, 157, 0.2);
            border-color: var(--primary-pink);
            transform: scale(1.1);
        }

        .notification-badge {
            position: absolute;
            top: -4px;
            right: -4px;
            width: 16px;
            height: 16px;
            background: var(--primary-pink);
            border-radius: 50%;
            font-size: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
        }

        .glass-content {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
            scroll-behavior: smooth;
        }

        .glass-section {
            padding: 15px 25px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.06);
        }

        .live-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .live-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .live-dot {
            width: 6px;
            height: 6px;
            background: #ff4757;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .user-status {
            background: rgba(255, 107, 157, 0.15);
            border: 1px solid rgba(255, 107, 157, 0.3);
            color: var(--primary-pink);
            padding: 4px 10px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 600;
            cursor: pointer;
        }

        .live-players {
            display: flex;
            gap: 12px;
            overflow-x: auto;
            padding-bottom: 5px;
        }

        .player-avatar {
            position: relative;
            flex-shrink: 0;
        }

        .avatar-ring {
            width: 44px;
            height: 44px;
            border-radius: 22px;
            background: linear-gradient(45deg, var(--primary-pink), var(--primary-purple));
            padding: 2px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .avatar-ring:hover {
            transform: scale(1.1);
        }

        .avatar-inner {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: var(--dark-bg);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            overflow: hidden;
        }

        .avatar-status {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 10px;
            height: 10px;
            background: var(--success-green);
            border: 2px solid var(--dark-bg);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .challenge-main {
            flex: 1;
            padding: 20px 25px;
            min-height: 300px;
        }

        .challenge-title {
            font-size: 24px;
            font-weight: 600;
            color: var(--primary-pink);
            margin-bottom: 20px;
            line-height: 1.2;
        }

        .challenge-description {
            font-size: 15px;
            line-height: 1.6;
            color: var(--text-primary);
            margin-bottom: 20px;
            opacity: 0.9;
        }

        .action-section {
            padding: 18px 25px;
            background: linear-gradient(180deg, transparent 0%, rgba(255, 255, 255, 0.05) 100%);
            border-top: 1px solid rgba(255, 255, 255, 0.08);
        }

        .btn-primary {
            background: linear-gradient(145deg, #ff6b9d, #c44569);
            color: #fff;
            border: none;
            padding: 16px 24px;
            border-radius: 15px;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s ease;
            width: 100%;
            box-shadow: 0 6px 20px rgba(255, 107, 157, 0.4);
        }

        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(255, 107, 157, 0.6);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
            border: 1px solid var(--glass-border);
            padding: 12px 20px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-2px);
        }

        .chat-toggle {
            position: fixed;
            bottom: 80px;
            right: 20px;
            width: 60px;
            height: 60px;
            background: var(--primary-pink);
            border: none;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: #fff;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(255, 107, 157, 0.4);
            z-index: 1001;
            transition: all 0.3s ease;
        }

        .chat-toggle:hover {
            transform: scale(1.1);
        }

        .online-count {
            background: rgba(0, 255, 150, 0.2);
            color: var(--success-green);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
            margin-left: 8px;
        }

        /* Utility Classes */
        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 18px;
            color: var(--text-primary);
        }

        .hidden {
            display: none !important;
        }

        .text-center {
            text-align: center;
        }

        .mb-10 {
            margin-bottom: 10px;
        }

        .mb-15 {
            margin-bottom: 15px;
        }

        .mb-20 {
            margin-bottom: 20px;
        }

        .hashtag {
            background: rgba(139, 92, 246, 0.15);
            border: 1px solid rgba(139, 92, 246, 0.3);
            color: var(--primary-purple);
            padding: 5px 10px;
            border-radius: 10px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-block;
        }

        .hashtag:hover {
            background: rgba(139, 92, 246, 0.25);
            transform: scale(1.05);
        }

        /* Upload Area Styles */
        .upload-area {
            border: 2px dashed var(--glass-border);
            border-radius: 12px;
            padding: 30px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.02);
        }

        .upload-area:hover {
            border-color: var(--primary-pink);
            background: rgba(255, 107, 157, 0.05);
            transform: translateY(-2px);
        }

        .upload-area.has-file {
            border-color: var(--success-green);
            background: rgba(16, 185, 129, 0.1);
        }

        .score-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .score-item:last-child {
            border-bottom: none;
        }

        .gallery-item {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .gallery-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
        }

        .challenge-progress-bar {
            width: 100%;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            overflow: hidden;
            margin: 8px 0;
        }

        .challenge-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-pink), var(--primary-purple));
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <!-- Auth Screen -->
    <div id="authScreen" class="auth-screen">
        <div class="auth-container">
            <div class="auth-logo">üöÄ</div>
            <div class="auth-title">Welcome to JomBro</div>
            <div class="auth-subtitle">Connect with friends and tackle challenges together!</div>
            
            <button class="auth-btn google" onclick="signInWithGoogle()">
                <span>üîç</span>
                Continue with Google
            </button>
            
            <button class="auth-btn phone" onclick="signInWithPhone()">
                <span>üì±</span>
                Continue with Phone
            </button>
            
            <div style="margin-top: 20px; font-size: 12px; color: var(--text-secondary);">
                By continuing, you agree to our Terms & Privacy Policy
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="phone-container" style="display: none;">
        <div class="glass-interface">
            <!-- Header -->
            <div class="glass-header">
                <div class="logo-section" onclick="showProfile()">
                    <div class="logo-text">JomBro</div>
                    <div class="logo-slogan">Let's go! Let's Go!</div>
                    <div class="logo-subtitle" id="userDisplayName">Loading...</div>
                </div>
                <div class="header-actions">
                    <div class="header-btn" onclick="toggleChat()" title="Group Chat">
                        üí¨
                        <div class="notification-badge" id="chatNotifications" style="display: none;">3</div>
                    </div>
                    <div class="header-btn" onclick="showFriends()" title="Friends">
                        üë•
                        <div class="notification-badge" id="friendsNotifications" style="display: none;">2</div>
                    </div>
                    <div class="header-btn" onclick="showGroups()" title="Groups">üè†</div>
                    <div class="header-btn" onclick="signOut()" title="Sign Out">üö™</div>
                </div>
            </div>

            <div class="glass-content">
                <!-- Live Players Section -->
                <div class="glass-section">
                    <div class="live-header">
                        <div class="live-indicator">
                            <div class="live-dot"></div>
                            <span>LIVE</span>
                            <span class="online-count" id="onlineCount">0 online</span>
                        </div>
                        <div class="user-status" id="userStatus" onclick="showProfile()">
                            <span id="userLevel">Level 1</span>
                        </div>
                    </div>
                    <div class="live-players" id="livePlayersContainer">
                        <!-- Real users appear here -->
                    </div>
                </div>

                <!-- Main Challenge -->
                <div class="challenge-main">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div id="challengeCategory" style="background: var(--primary-pink); color: white; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600;">Social Connection</div>
                            <div style="background: rgba(255, 255, 255, 0.1); color: var(--text-secondary); padding: 4px 8px; border-radius: 8px; font-size: 10px;">AI Generated</div>
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button onclick="nextChallenge()" style="background: rgba(255, 255, 255, 0.1); border: none; color: var(--text-primary); padding: 6px 8px; border-radius: 8px; cursor: pointer; font-size: 12px;" title="Next Challenge">üîÑ</button>
                            <button onclick="refreshChallenges()" style="background: rgba(255, 255, 255, 0.1); border: none; color: var(--text-primary); padding: 6px 8px; border-radius: 8px; cursor: pointer; font-size: 12px;" title="Generate New">‚ú®</button>
                            <button onclick="showChallengeLibrary()" style="background: rgba(255, 255, 255, 0.1); border: none; color: var(--text-primary); padding: 6px 8px; border-radius: 8px; cursor: pointer; font-size: 12px;" title="Challenge Library">üìö</button>
                        </div>
                    </div>
                    
                    <div class="challenge-title" id="challengeTitle">Coffee Shop Poetry Challenge</div>
                    <div class="challenge-description" id="challengeDescription">
                        Visit any coffee shop and ask the barista to write a short poem on your cup or napkin! 
                        Share your experience with friends and see who gets the most creative poem!
                    </div>
                    
                    <div id="challengeHashtags" style="display: flex; flex-wrap: wrap; gap: 8px; margin: 15px 0;">
                        <span class="hashtag">#CoffeePoetry</span>
                        <span class="hashtag">#Connection</span>
                        <span class="hashtag">#JomBro</span>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin: 20px 0;">
                        <div style="text-align: center; background: rgba(255, 255, 255, 0.05); padding: 12px; border-radius: 10px;">
                            <div style="font-size: 16px; font-weight: 700; color: var(--primary-pink);" id="challengeTokens">500</div>
                            <div style="font-size: 10px; color: var(--text-secondary); text-transform: uppercase;">Tokens</div>
                        </div>
                        <div style="text-align: center; background: rgba(255, 255, 255, 0.05); padding: 12px; border-radius: 10px;">
                            <div style="font-size: 16px; font-weight: 700; color: var(--primary-pink);" id="challengeDifficulty">Easy</div>
                            <div style="font-size: 10px; color: var(--text-secondary); text-transform: uppercase;">Level</div>
                        </div>
                        <div style="text-align: center; background: rgba(255, 255, 255, 0.05); padding: 12px; border-radius: 10px;">
                            <div style="font-size: 16px; font-weight: 700; color: var(--primary-pink);" id="challengeDuration">30m</div>
                            <div style="font-size: 10px; color: var(--text-secondary); text-transform: uppercase;">Duration</div>
                        </div>
                    </div>
                    
                    <div style="background: rgba(139, 92, 246, 0.1); border: 1px solid rgba(139, 92, 246, 0.3); color: var(--primary-purple); padding: 12px; border-radius: 12px; margin: 15px 0; text-align: center;">
                        <div style="font-size: 12px; font-weight: 600; margin-bottom: 4px;">ü§ñ AI Recommendation</div>
                        <div style="font-size: 11px;" id="aiReason">Perfect for building connections and boosting your social confidence!</div>
                    </div>
                </div>

                <!-- Action Section -->
                <div class="action-section">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                        <button class="btn-secondary" onclick="submitChallengeProof()" style="display: flex; align-items: center; justify-content: center; gap: 6px;">
                            üì∏ Submit Proof
                        </button>
                        <button class="btn-secondary" onclick="showChallengeGallery()" style="display: flex; align-items: center; justify-content: center; gap: 6px;">
                            üèÜ My Gallery
                        </button>
                    </div>
                    <button class="btn-primary" onclick="startChallenge()">
                        üöÄ START CHALLENGE & INVITE FRIENDS
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Enhanced User Profile Modal -->
    <div id="profileModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">üë§ My Profile</div>
                <button class="modal-close" onclick="hideModal('profile')">&times;</button>
            </div>
            
            <div class="profile-header">
                <div class="profile-avatar-large" id="profileAvatar" onclick="changeProfilePicture()">
                    LY
                    <div class="profile-avatar-edit">üì∑</div>
                </div>
                <div class="profile-name" id="profileName">Lyode</div>
                <div class="profile-bio" id="profileBio">Challenge enthusiast ‚Ä¢ Coffee lover ‚Ä¢ Always up for adventures!</div>
                <div class="profile-level" id="profileLevel">Level 5 Explorer</div>
            </div>

            <div class="profile-stats">
                <div class="profile-stat" onclick="showAchievements()">
                    <div class="profile-stat-value" id="profileChallenges">47</div>
                    <div class="profile-stat-label">Challenges</div>
                </div>
                <div class="profile-stat" onclick="showFriends()">
                    <div class="profile-stat-value" id="profileFriends">23</div>
                    <div class="profile-stat-label">Friends</div>
                </div>
                <div class="profile-stat" onclick="showStats()">
                    <div class="profile-stat-value" id="profileStreak">12</div>
                    <div class="profile-stat-label">Day Streak</div>
                </div>
            </div>

            <div class="profile-actions">
                <button class="btn-secondary" onclick="editProfile()">Edit Profile</button>
                <button class="btn-secondary" onclick="showSettings()">Settings</button>
            </div>
        </div>
    </div>

    <!-- Enhanced Friends Modal -->
    <div id="friendsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">üë• Friends</div>
                <button class="modal-close" onclick="hideModal('friends')">&times;</button>
            </div>

            <div class="friends-search">
                <div class="friends-search-icon">üîç</div>
                <input type="text" class="friends-search-input" placeholder="Search friends..." 
                       oninput="searchFriends(this.value)">
            </div>

            <div class="friends-tabs">
                <div class="friends-tab active" onclick="switchFriendsTab('all')">All Friends</div>
                <div class="friends-tab" onclick="switchFriendsTab('online')">Online</div>
                <div class="friends-tab" onclick="switchFriendsTab('requests')">Requests</div>
            </div>

            <div id="friendsList">
                <!-- Friends will be populated here -->
            </div>

            <div style="margin-top: 20px;">
                <button class="btn-primary" onclick="findFriends()">üîç Find New Friends</button>
            </div>
        </div>
    </div>

    <!-- Enhanced Create Group Modal -->
    <div id="groupModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">üè† Create Group</div>
                <button class="modal-close" onclick="hideModal('group')">&times;</button>
            </div>

            <form class="group-form" onsubmit="createGroup(event)">
                <div class="form-group">
                    <label class="form-label">Group Name</label>
                    <input type="text" class="form-input" id="groupName" placeholder="My Adventure Squad" required>
                </div>

                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea class="form-input form-textarea" id="groupDescription" 
                              placeholder="What's your group about? What challenges will you tackle together?"></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label">Group Icon</label>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <div class="group-icon-option" onclick="selectGroupIcon('üèîÔ∏è')">üèîÔ∏è</div>
                        <div class="group-icon-option" onclick="selectGroupIcon('üöÄ')">üöÄ</div>
                        <div class="group-icon-option" onclick="selectGroupIcon('‚ö°')">‚ö°</div>
                        <div class="group-icon-option" onclick="selectGroupIcon('üî•')">üî•</div>
                        <div class="group-icon-option" onclick="selectGroupIcon('üåü')">üåü</div>
                        <div class="group-icon-option" onclick="selectGroupIcon('üí™')">üí™</div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Privacy Settings</label>
                    <div class="group-privacy-options">
                        <label class="privacy-option">
                            <input type="radio" name="privacy" value="public" checked>
                            <div>
                                <div style="font-weight: 600;">üåç Public</div>
                                <div style="font-size: 12px; color: var(--text-secondary);">Anyone can find and join</div>
                            </div>
                        </label>
                        <label class="privacy-option">
                            <input type="radio" name="privacy" value="private">
                            <div>
                                <div style="font-weight: 600;">üîí Private</div>
                                <div style="font-size: 12px; color: var(--text-secondary);">Invite only</div>
                            </div>
                        </label>
                        <label class="privacy-option">
                            <input type="radio" name="privacy" value="friends">
                            <div>
                                <div style="font-weight: 600;">üë• Friends Only</div>
                                <div style="font-size: 12px; color: var(--text-secondary);">Only friends can join</div>
                            </div>
                        </label>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Invite Friends</label>
                    <div class="members-selector" id="membersSelector">
                        <!-- Friends list for invitation -->
                    </div>
                </div>

                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="button" class="btn-secondary" onclick="hideModal('group')" style="flex: 1;">Cancel</button>
                    <button type="submit" class="btn-primary" style="flex: 1;">Create Group</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Enhanced Chat Interface -->
    <div id="chatInterface" class="chat-interface">
        <div class="chat-header">
            <div>
                <div class="chat-title" id="chatTitle">Challenge Group Chat</div>
                <div class="chat-members" id="chatMembers">3 members online</div>
            </div>
            <button class="chat-close" onclick="toggleChat()">‚úï</button>
        </div>
        <div class="chat-messages" id="chatMessages">
            <!-- Messages appear here -->
        </div>
        <div class="chat-input-container">
            <input type="text" class="chat-input" id="chatInput" placeholder="Type a message..." 
                   onkeypress="handleChatKeyPress(event)">
            <button class="chat-send" onclick="sendMessage()">‚û§</button>
        </div>
    </div>

    <!-- Challenge Submission Modal -->
    <div id="challengeSubmissionModal" class="modal">
        <div class="modal-content" style="max-width: 450px;">
            <div class="modal-header">
                <div class="modal-title">üì∏ Submit Challenge Proof</div>
                <button class="modal-close" onclick="hideModal('challengeSubmission')">&times;</button>
            </div>

            <div id="submissionContent">
                <div style="text-align: center; margin-bottom: 20px;">
                    <div style="font-size: 18px; font-weight: 600; margin-bottom: 8px;" id="submissionChallengeTitle">Coffee Shop Poetry Challenge</div>
                    <div style="font-size: 12px; color: var(--text-secondary);">Upload photo or video proof of your completed challenge</div>
                </div>

                <!-- Upload Area -->
                <div class="upload-area" onclick="triggerFileUpload()" id="uploadArea">
                    <div class="upload-content">
                        <div style="font-size: 48px; margin-bottom: 15px; color: var(--primary-pink);">üì∑</div>
                        <div style="font-size: 16px; font-weight: 600; margin-bottom: 8px;">Upload Media</div>
                        <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 15px;">Photos, videos, or screenshots</div>
                        <div style="background: var(--primary-pink); color: white; padding: 8px 16px; border-radius: 8px; font-size: 12px; font-weight: 600;">Choose File</div>
                    </div>
                </div>

                <input type="file" id="mediaUpload" accept="image/*,video/*" style="display: none;" onchange="handleFileUpload(event)">

                <!-- Preview Area -->
                <div id="mediaPreview" style="display: none; margin: 20px 0;">
                    <div style="font-size: 14px; font-weight: 600; margin-bottom: 10px;">Preview:</div>
                    <div id="previewContent" style="border-radius: 12px; overflow: hidden; max-height: 200px; display: flex; justify-content: center;"></div>
                </div>

                <!-- Challenge Description -->
                <div style="margin: 20px 0;">
                    <label style="font-size: 12px; font-weight: 600; color: var(--text-primary); margin-bottom: 8px; display: block;">Tell us about your experience:</label>
                    <textarea id="challengeStory" placeholder="Describe what happened, how you felt, what you learned..." 
                              style="width: 100%; min-height: 80px; padding: 12px; background: rgba(255,255,255,0.1); border: 1px solid var(--glass-border); border-radius: 10px; color: var(--text-primary); font-size: 14px; resize: vertical; outline: none;"></textarea>
                </div>

                <!-- AI Analysis Results (Hidden initially) -->
                <div id="aiAnalysis" style="display: none; margin: 20px 0;">
                    <div style="background: linear-gradient(135deg, rgba(139, 92, 246, 0.2), rgba(255, 107, 157, 0.2)); border: 1px solid rgba(139, 92, 246, 0.3); border-radius: 12px; padding: 20px;">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                            <div style="font-size: 24px;">ü§ñ</div>
                            <div>
                                <div style="font-size: 14px; font-weight: 600;">AI Verification Complete</div>
                                <div style="font-size: 11px; color: var(--text-secondary);">Analyzing your submission...</div>
                            </div>
                        </div>
                        
                        <div id="aiScore" style="text-align: center; margin: 20px 0;">
                            <div style="font-size: 48px; font-weight: 700; color: var(--success-green);" id="scoreValue">85</div>
                            <div style="font-size: 12px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 1px;">AI Score</div>
                        </div>

                        <div id="aiScoreBreakdown" style="margin: 15px 0;">
                            <div style="font-size: 12px; font-weight: 600; margin-bottom: 10px;">Verification Details:</div>
                            <div class="score-item">
                                <span style="font-size: 11px;">‚úÖ Challenge Completion</span>
                                <span style="font-size: 11px; color: var(--success-green); font-weight: 600;">Verified</span>
                            </div>
                            <div class="score-item">
                                <span style="font-size: 11px;">üéØ Effort & Creativity</span>
                                <span style="font-size: 11px; color: var(--success-green); font-weight: 600;" id="effortScore">High</span>
                            </div>
                            <div class="score-item">
                                <span style="font-size: 11px;">üìù Story Quality</span>
                                <span style="font-size: 11px; color: var(--success-green); font-weight: 600;" id="storyScore">Excellent</span>
                            </div>
                        </div>

                        <div id="aiFeedback" style="background: rgba(255, 255, 255, 0.1); padding: 12px; border-radius: 8px; margin: 15px 0;">
                            <div style="font-size: 11px; font-weight: 600; margin-bottom: 6px;">üéâ AI Feedback:</div>
                            <div style="font-size: 11px; line-height: 1.4;" id="feedbackText">
                                Great job! Your coffee shop poetry challenge shows genuine creativity and social connection. The barista's poem is heartwarming and your story captures the experience beautifully!
                            </div>
                        </div>

                        <div id="rewardsEarned" style="background: rgba(255, 107, 157, 0.2); padding: 12px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 12px; font-weight: 600; margin-bottom: 6px;">üèÜ Rewards Earned</div>
                            <div style="display: flex; justify-content: space-around; align-items: center;">
                                <div>
                                    <div style="font-size: 14px; font-weight: 700; color: var(--primary-pink);" id="tokensEarned">500</div>
                                    <div style="font-size: 9px; color: var(--text-secondary);">Tokens</div>
                                </div>
                                <div>
                                    <div style="font-size: 14px; font-weight: 700; color: var(--primary-pink);" id="xpEarned">+25</div>
                                    <div style="font-size: 9px; color: var(--text-secondary);">Experience</div>
                                </div>
                                <div>
                                    <div style="font-size: 14px; font-weight: 700; color: var(--primary-pink);" id="streakBonus">+1</div>
                                    <div style="font-size: 9px; color: var(--text-secondary);">Streak</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button class="btn-secondary" onclick="hideModal('challengeSubmission')" style="flex: 1;">Cancel</button>
                    <button class="btn-primary" onclick="submitChallenge()" id="submitBtn" style="flex: 2;">
                        ü§ñ Submit for AI Verification
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Challenge Gallery Modal -->
    <div id="challengeGalleryModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <div class="modal-title">üèÜ My Challenge Gallery</div>
                <button class="modal-close" onclick="hideModal('challengeGallery')">&times;</button>
            </div>

            <div style="margin-bottom: 15px;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div style="font-size: 12px; color: var(--text-secondary);">Your completed challenges with AI scores</div>
                    <div style="font-size: 11px; background: var(--primary-pink); color: white; padding: 4px 8px; border-radius: 6px;" id="avgScore">Avg: 87.5</div>
                </div>
            </div>

            <div id="challengeGalleryContent" style="max-height: 400px; overflow-y: auto;">
                <!-- Gallery items will be populated here -->
            </div>
        </div>
    </div>

    <!-- Challenge Library Modal -->
    <div id="challengeLibraryModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <div class="modal-title">üìö Challenge Library</div>
                <button class="modal-close" onclick="hideModal('challengeLibrary')">&times;</button>
            </div>

            <div style="margin-bottom: 20px;">
                <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 10px;">Choose from AI-curated challenge categories:</div>
                <div id="challengeCategories" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                    <!-- Categories will be populated here -->
                </div>
            </div>

            <div id="categorychallenges" style="max-height: 300px; overflow-y: auto;">
                <!-- Challenges will be populated here -->
            </div>
        </div>
    </div>

    <!-- Groups Modal -->
    <div id="groupsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">üè† My Groups</div>
                <button class="modal-close" onclick="hideModal('groups')">&times;</button>
            </div>

            <div id="groupsList">
                <!-- Groups will be populated here -->
            </div>

            <div style="margin-top: 20px;">
                <button class="btn-primary" onclick="showCreateGroup()">‚ûï Create New Group</button>
            </div>
        </div>
    </div>

    <!-- Floating Chat Toggle -->
    <button id="chatToggle" class="chat-toggle" onclick="toggleChat()" style="display: none;">
        üí¨
    </button>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyC_orriRUuf1ynDiFaJAPrO6-Gu3GeURxQ",
            authDomain: "jombro-9d129.firebaseapp.com",
            projectId: "jombro-9d129",
            storageBucket: "jombro-9d129.firebasestorage.app",
            messagingSenderId: "390572076435",
            appId: "1:390572076435:web:2a90027c66dc34d9834c66",
            measurementId: "G-YPQ5R5GLP8"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();

        // Global state
        let currentUser = null;
        let chatOpen = false;
        let unsubscribeChat = null;
        let currentFriendsTab = 'all';
        let userProfile = {};
        let friendsList = [];
        let groupsList = [];
        let currentChallengeIndex = 0;
        let availableChallenges = [];

        // AI Challenge Generation System
        const challengeCategories = {
            SOCIAL: {
                name: 'Social Connection',
                icon: 'üë•',
                color: '#ff6b9d',
                challenges: [
                    {
                        title: 'Coffee Shop Poetry Challenge',
                        description: 'Visit any coffee shop and ask the barista to write a short poem on your cup or napkin! Share your experience with friends and see who gets the most creative poem!',
                        difficulty: 'Easy',
                        duration: '30m',
                        tokens: 500,
                        hashtags: ['#CoffeePoetry', '#Connection', '#JomBro']
                    },
                    {
                        title: 'Compliment Stranger Challenge',
                        description: 'Give genuine compliments to 5 strangers today. Notice their reactions and spread positivity wherever you go!',
                        difficulty: 'Medium',
                        duration: '45m',
                        tokens: 750,
                        hashtags: ['#Kindness', '#Positivity', '#Social']
                    },
                    {
                        title: 'Random Acts of Kindness',
                        description: 'Perform 3 random acts of kindness for strangers. Pay for someone\'s coffee, help carry groceries, or leave encouraging notes!',
                        difficulty: 'Easy',
                        duration: '60m',
                        tokens: 600,
                        hashtags: ['#Kindness', '#RandomActs', '#Helping']
                    },
                    {
                        title: 'Start a Conversation Challenge',
                        description: 'Start meaningful conversations with 3 people you don\'t know well. Ask about their passions, dreams, or interesting experiences!',
                        difficulty: 'Hard',
                        duration: '90m',
                        tokens: 1000,
                        hashtags: ['#Conversation', '#Connection', '#People']
                    }
                ]
            },
            ADVENTURE: {
                name: 'Adventure & Exploration',
                icon: 'üó∫Ô∏è',
                color: '#8b5cf6',
                challenges: [
                    {
                        title: 'Hidden Gem Discovery',
                        description: 'Find and explore a place in your city you\'ve never been to before. Take photos and share what makes it special!',
                        difficulty: 'Easy',
                        duration: '120m',
                        tokens: 800,
                        hashtags: ['#Exploration', '#Discovery', '#Hidden']
                    },
                    {
                        title: 'Public Transport Adventure',
                        description: 'Take public transport to a random stop and explore the area for 1 hour. Document your unexpected discoveries!',
                        difficulty: 'Medium',
                        duration: '90m',
                        tokens: 700,
                        hashtags: ['#Adventure', '#Random', '#Transport']
                    },
                    {
                        title: 'Sunrise/Sunset Quest',
                        description: 'Wake up early or stay up to watch a sunrise or sunset from somewhere you\'ve never watched it before!',
                        difficulty: 'Medium',
                        duration: '60m',
                        tokens: 650,
                        hashtags: ['#Nature', '#Sunrise', '#Peaceful']
                    }
                ]
            },
            CREATIVE: {
                name: 'Creative Expression',
                icon: 'üé®',
                color: '#00d4ff',
                challenges: [
                    {
                        title: 'Street Art Photography',
                        description: 'Find and photograph 10 pieces of street art, murals, or creative displays in your area. Create a mini photo story!',
                        difficulty: 'Easy',
                        duration: '75m',
                        tokens: 550,
                        hashtags: ['#StreetArt', '#Photography', '#Creative']
                    },
                    {
                        title: 'One-Minute Video Story',
                        description: 'Create a 1-minute video telling a story about your day, neighborhood, or something that inspires you!',
                        difficulty: 'Medium',
                        duration: '45m',
                        tokens: 700,
                        hashtags: ['#Video', '#Storytelling', '#Creative']
                    },
                    {
                        title: 'Sidewalk Chalk Art',
                        description: 'Create sidewalk chalk art that will brighten someone\'s day. Write positive messages or draw something beautiful!',
                        difficulty: 'Easy',
                        duration: '40m',
                        tokens: 500,
                        hashtags: ['#ChalkArt', '#Public', '#Positive']
                    }
                ]
            },
            FITNESS: {
                name: 'Health & Fitness',
                icon: 'üí™',
                color: '#10b981',
                challenges: [
                    {
                        title: 'Stairs Only Challenge',
                        description: 'Avoid elevators and escalators for the entire day. Take the stairs everywhere and count your total steps climbed!',
                        difficulty: 'Medium',
                        duration: 'All Day',
                        tokens: 800,
                        hashtags: ['#Fitness', '#Stairs', '#Health']
                    },
                    {
                        title: 'Walking Meeting Challenge',
                        description: 'Turn your next meeting or phone call into a walking session. Combine productivity with movement!',
                        difficulty: 'Easy',
                        duration: '30m',
                        tokens: 400,
                        hashtags: ['#Walking', '#Productivity', '#Health']
                    },
                    {
                        title: 'Exercise in Nature',
                        description: 'Do a 30-minute workout outdoors - in a park, beach, or your backyard. Fresh air + fitness = amazing!',
                        difficulty: 'Medium',
                        duration: '30m',
                        tokens: 600,
                        hashtags: ['#Nature', '#Outdoor', '#Fitness']
                    }
                ]
            },
            LEARNING: {
                name: 'Learning & Growth',
                icon: 'üìö',
                color: '#f59e0b',
                challenges: [
                    {
                        title: 'Learn 10 New Words',
                        description: 'Learn 10 new words in any language and use them in conversations today. Expand your vocabulary!',
                        difficulty: 'Easy',
                        duration: '40m',
                        tokens: 450,
                        hashtags: ['#Language', '#Learning', '#Words']
                    },
                    {
                        title: 'Teach Someone Something',
                        description: 'Teach someone a skill you know - cooking, music, tech, anything! Share knowledge and make connections.',
                        difficulty: 'Medium',
                        duration: '60m',
                        tokens: 700,
                        hashtags: ['#Teaching', '#Sharing', '#Skills']
                    },
                    {
                        title: 'Local History Discovery',
                        description: 'Research and learn 5 interesting facts about your city\'s history. Share what surprised you most!',
                        difficulty: 'Easy',
                        duration: '45m',
                        tokens: 500,
                        hashtags: ['#History', '#Local', '#Facts']
                    }
                ]
            },
            MINDFULNESS: {
                name: 'Mindfulness & Wellness',
                icon: 'üßò',
                color: '#a855f7',
                challenges: [
                    {
                        title: 'Digital Detox Hour',
                        description: 'Spend 1 hour completely offline. Read, meditate, walk, or just be present without any digital devices!',
                        difficulty: 'Hard',
                        duration: '60m',
                        tokens: 800,
                        hashtags: ['#DigitalDetox', '#Mindfulness', '#Present']
                    },
                    {
                        title: 'Gratitude Photo Series',
                        description: 'Take photos of 5 things you\'re grateful for today and write a short gratitude note for each one.',
                        difficulty: 'Easy',
                        duration: '30m',
                        tokens: 400,
                        hashtags: ['#Gratitude', '#Mindfulness', '#Positive']
                    },
                    {
                        title: 'Meditation in Public',
                        description: 'Find a peaceful public spot and meditate for 15 minutes. Practice mindfulness surrounded by city life.',
                        difficulty: 'Medium',
                        duration: '20m',
                        tokens: 550,
                        hashtags: ['#Meditation', '#Public', '#Peace']
                    }
                ]
            }
        };

        // AI-Powered Challenge Recommendation System
        function generateAIChallenge() {
            const categories = Object.keys(challengeCategories);
            const userPreferences = getUserPreferences();
            
            // Weight categories based on user history and preferences
            let weightedCategories = categories.map(cat => ({
                category: cat,
                weight: calculateCategoryWeight(cat, userPreferences)
            }));
            
            // Sort by weight and add some randomness
            weightedCategories.sort((a, b) => b.weight - a.weight);
            
            // Select category (70% chance for top preference, 30% for variety)
            const selectedCategory = Math.random() < 0.7 ? 
                weightedCategories[0].category : 
                categories[Math.floor(Math.random() * categories.length)];
            
            const challenges = challengeCategories[selectedCategory].challenges;
            const selectedChallenge = challenges[Math.floor(Math.random() * challenges.length)];
            
            return {
                ...selectedChallenge,
                category: selectedCategory,
                categoryInfo: challengeCategories[selectedCategory],
                aiReason: generateAIReason(selectedCategory, selectedChallenge, userPreferences)
            };
        }

        function getUserPreferences() {
            // Analyze user's completed challenges, interests, and behavior
            return {
                preferredDifficulty: userProfile.preferredDifficulty || 'Medium',
                completedCategories: userProfile.completedCategories || {},
                timePreference: userProfile.timePreference || 'medium',
                socialLevel: userProfile.socialLevel || 'medium',
                currentStreak: userProfile.streak || 0,
                level: userProfile.level || 1
            };
        }

        function calculateCategoryWeight(category, preferences) {
            let weight = 1;
            
            // Boost categories user hasn't tried much
            const completed = preferences.completedCategories[category] || 0;
            if (completed < 3) weight += 0.5;
            
            // Adjust based on user level
            if (category === 'SOCIAL' && preferences.socialLevel === 'high') weight += 0.3;
            if (category === 'ADVENTURE' && preferences.level > 3) weight += 0.2;
            if (category === 'MINDFULNESS' && preferences.currentStreak > 5) weight += 0.2;
            
            // Add randomness for variety
            weight += Math.random() * 0.3;
            
            return weight;
        }

        function generateAIReason(category, challenge, preferences) {
            const reasons = {
                SOCIAL: [
                    "Perfect for building connections and boosting your social confidence!",
                    "Great way to practice your people skills and spread positivity!",
                    "This will help you step out of your comfort zone in a fun way!"
                ],
                ADVENTURE: [
                    "Time for some exploration! This matches your adventurous spirit!",
                    "Perfect for discovering something new in your area!",
                    "Great way to break your routine and see the world differently!"
                ],
                CREATIVE: [
                    "Let your creativity shine! This will unlock your artistic side!",
                    "Perfect for expressing yourself and creating something beautiful!",
                    "Great way to see the world through an artistic lens!"
                ],
                FITNESS: [
                    "Excellent for staying active and energized!",
                    "Perfect way to combine health with fun activities!",
                    "Great for building healthy habits that stick!"
                ],
                LEARNING: [
                    "Perfect for expanding your knowledge and growing as a person!",
                    "Great way to challenge your brain and learn something new!",
                    "Excellent for building skills you can use forever!"
                ],
                MINDFULNESS: [
                    "Perfect for finding peace and balance in your day!",
                    "Great way to practice being present and grateful!",
                    "Excellent for mental wellness and inner growth!"
                ]
            };
            
            const categoryReasons = reasons[category] || reasons.SOCIAL;
            return categoryReasons[Math.floor(Math.random() * categoryReasons.length)];
        }

        // Challenge Management Functions
        function initializeChallenges() {
            // Generate initial pool of challenges
            availableChallenges = [
                generateAIChallenge(),
                generateAIChallenge(),
                generateAIChallenge()
            ];
            
            // Add sample completed challenges for demo
            initializeSampleCompletedChallenges();
            
            // Display first challenge
            displayCurrentChallenge();
        }

        function initializeSampleCompletedChallenges() {
            const sampleCompleted = [
                {
                    id: 1,
                    challenge: {
                        title: 'Random Acts of Kindness',
                        category: 'SOCIAL',
                        tokens: 600
                    },
                    file: {
                        name: 'kindness_photo.jpg',
                        type: 'image/jpeg',
                        url: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 300 200"><rect width="300" height="200" fill="%23ff6b9d"/><text x="150" y="100" text-anchor="middle" font-size="40" fill="white">üì∑</text><text x="150" y="140" text-anchor="middle" font-size="16" fill="white">Kindness Photo</text></svg>'
                    },
                    story: 'I helped an elderly lady carry her groceries and paid for a stranger\'s coffee. Both experiences were heartwarming and reminded me how small acts can make a big difference!',
                    score: 92,
                    tokens: 552,
                    xp: 23,
                    completedAt: new Date(Date.now() - 2 * 24 * 60 * 60 * 1000), // 2 days ago
                    verified: true
                },
                {
                    id: 2,
                    challenge: {
                        title: 'Street Art Photography',
                        category: 'CREATIVE',
                        tokens: 550
                    },
                    file: {
                        name: 'street_art.jpg',
                        type: 'image/jpeg',
                        url: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 300 200"><rect width="300" height="200" fill="%2300d4ff"/><text x="150" y="100" text-anchor="middle" font-size="40" fill="white">üé®</text><text x="150" y="140" text-anchor="middle" font-size="16" fill="white">Street Art</text></svg>'
                    },
                    story: 'Found amazing murals in the downtown area! The artists\' creativity is incredible and each piece tells a unique story about our community.',
                    score: 88,
                    tokens: 484,
                    xp: 22,
                    completedAt: new Date(Date.now() - 5 * 24 * 60 * 60 * 1000), // 5 days ago
                    verified: true
                },
                {
                    id: 3,
                    challenge: {
                        title: 'Digital Detox Hour',
                        category: 'MINDFULNESS',
                        tokens: 800
                    },
                    file: {
                        name: 'meditation_video.mp4',
                        type: 'video/mp4',
                        url: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 300 200"><rect width="300" height="200" fill="%23a855f7"/><text x="150" y="100" text-anchor="middle" font-size="40" fill="white">üé•</text><text x="150" y="140" text-anchor="middle" font-size="16" fill="white">Meditation</text></svg>'
                    },
                    story: 'Spent an hour in the park without any devices. The peace and clarity I felt was amazing. I could hear birds, feel the breeze, and just be present.',
                    score: 95,
                    tokens: 760,
                    xp: 24,
                    completedAt: new Date(Date.now() - 7 * 24 * 60 * 60 * 1000), // 1 week ago
                    verified: true
                }
            ];
            
            completedChallenges = sampleCompleted;
        }

        function displayCurrentChallenge() {
            const challenge = availableChallenges[currentChallengeIndex];
            if (!challenge) return;
            
            document.getElementById('challengeTitle').textContent = challenge.title;
            document.getElementById('challengeDescription').textContent = challenge.description;
            document.getElementById('challengeCategory').textContent = challenge.categoryInfo.name;
            document.getElementById('challengeDifficulty').textContent = challenge.difficulty;
            document.getElementById('challengeDuration').textContent = challenge.duration;
            document.getElementById('challengeTokens').textContent = challenge.tokens;
            document.getElementById('aiReason').textContent = challenge.aiReason;
            
            // Update category badge color
            const categoryBadge = document.getElementById('challengeCategory');
            if (categoryBadge) {
                categoryBadge.style.background = challenge.categoryInfo.color;
                categoryBadge.style.color = 'white';
            }
            
            // Update hashtags
            const hashtagsContainer = document.getElementById('challengeHashtags');
            if (hashtagsContainer) {
                hashtagsContainer.innerHTML = challenge.hashtags.map(tag => 
                    `<span class="hashtag" style="border-color: ${challenge.categoryInfo.color};" onclick="searchHashtag('${tag}')">${tag}</span>`
                ).join('');
            }
        }

        function nextChallenge() {
            currentChallengeIndex = (currentChallengeIndex + 1) % availableChallenges.length;
            
            // Generate new challenge if we've seen all
            if (currentChallengeIndex === 0) {
                availableChallenges.push(generateAIChallenge());
            }
            
            displayCurrentChallenge();
            
            // Show notification
            showToast('üéØ New AI-generated challenge loaded!', 'success');
        }

        function refreshChallenges() {
            // Generate 3 new challenges
            availableChallenges = [
                generateAIChallenge(),
                generateAIChallenge(),
                generateAIChallenge()
            ];
            currentChallengeIndex = 0;
            displayCurrentChallenge();
            
            showToast('‚ú® Fresh challenges generated by AI!', 'success');
        }

        function showChallengeLibrary() {
            // Create modal content for challenge library
            showChallengeLibraryModal();
        }

        function showChallengeLibraryModal() {
            showModal('challengeLibrary');
            populateChallengeLibrary();
        }

        function populateChallengeLibrary() {
            const categoriesContainer = document.getElementById('challengeCategories');
            const challengesContainer = document.getElementById('categorychallenges');
            
            // Populate categories
            categoriesContainer.innerHTML = Object.keys(challengeCategories).map(categoryKey => {
                const category = challengeCategories[categoryKey];
                return `
                    <div onclick="showCategoryChallenges('${categoryKey}')" style="
                        background: linear-gradient(135deg, ${category.color}20, ${category.color}10);
                        border: 1px solid ${category.color}40;
                        color: var(--text-primary);
                        padding: 15px;
                        border-radius: 12px;
                        cursor: pointer;
                        transition: all 0.3s ease;
                        text-align: center;
                    " onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                        <div style="font-size: 24px; margin-bottom: 8px;">${category.icon}</div>
                        <div style="font-size: 12px; font-weight: 600;">${category.name}</div>
                        <div style="font-size: 10px; color: var(--text-secondary); margin-top: 4px;">
                            ${category.challenges.length} challenges
                        </div>
                    </div>
                `;
            }).join('');
            
            // Show all challenges initially
            showAllChallenges();
        }

        function showCategoryChallenges(categoryKey) {
            const category = challengeCategories[categoryKey];
            const challengesContainer = document.getElementById('categorychallenges');
            
            challengesContainer.innerHTML = `
                <div style="margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                    <div style="font-size: 20px;">${category.icon}</div>
                    <div>
                        <div style="font-size: 14px; font-weight: 600;">${category.name}</div>
                        <div style="font-size: 11px; color: var(--text-secondary);">${category.challenges.length} available challenges</div>
                    </div>
                </div>
                ${category.challenges.map(challenge => `
                    <div onclick="selectChallengeFromLibrary('${categoryKey}', '${challenge.title}')" style="
                        background: rgba(255, 255, 255, 0.05);
                        border: 1px solid rgba(255, 255, 255, 0.1);
                        border-radius: 12px;
                        padding: 15px;
                        margin-bottom: 10px;
                        cursor: pointer;
                        transition: all 0.3s ease;
                    " onmouseover="this.style.background='rgba(255, 255, 255, 0.1)'" onmouseout="this.style.background='rgba(255, 255, 255, 0.05)'">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
                            <div style="font-size: 14px; font-weight: 600; flex: 1;">${challenge.title}</div>
                            <div style="display: flex; gap: 8px; flex-shrink: 0;">
                                <span style="background: ${category.color}; color: white; padding: 2px 8px; border-radius: 8px; font-size: 10px; font-weight: 600;">${challenge.difficulty}</span>
                                <span style="background: rgba(255, 255, 255, 0.1); color: var(--text-secondary); padding: 2px 8px; border-radius: 8px; font-size: 10px;">${challenge.duration}</span>
                            </div>
                        </div>
                        <div style="font-size: 12px; color: var(--text-secondary); line-height: 1.4; margin-bottom: 8px;">
                            ${challenge.description}
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div style="display: flex; gap: 4px;">
                                ${challenge.hashtags.slice(0, 2).map(tag => `
                                    <span style="font-size: 9px; color: ${category.color}; background: ${category.color}20; padding: 2px 6px; border-radius: 6px;">${tag}</span>
                                `).join('')}
                            </div>
                            <div style="font-size: 12px; font-weight: 600; color: var(--primary-pink);">
                                ${challenge.tokens} tokens
                            </div>
                        </div>
                    </div>
                `).join('')}
            `;
        }

        function showAllChallenges() {
            const challengesContainer = document.getElementById('categorychallenges');
            let allChallenges = [];
            
            Object.keys(challengeCategories).forEach(categoryKey => {
                const category = challengeCategories[categoryKey];
                category.challenges.forEach(challenge => {
                    allChallenges.push({
                        ...challenge,
                        categoryKey,
                        category
                    });
                });
            });
            
            // Shuffle and show random selection
            allChallenges.sort(() => Math.random() - 0.5);
            const selectedChallenges = allChallenges.slice(0, 8);
            
            challengesContainer.innerHTML = `
                <div style="margin-bottom: 15px;">
                    <div style="font-size: 14px; font-weight: 600; margin-bottom: 4px;">‚ú® Featured Challenges</div>
                    <div style="font-size: 11px; color: var(--text-secondary);">AI-curated selection for you</div>
                </div>
                ${selectedChallenges.map(challenge => `
                    <div onclick="selectChallengeFromLibrary('${challenge.categoryKey}', '${challenge.title}')" style="
                        background: rgba(255, 255, 255, 0.05);
                        border: 1px solid rgba(255, 255, 255, 0.1);
                        border-radius: 12px;
                        padding: 15px;
                        margin-bottom: 10px;
                        cursor: pointer;
                        transition: all 0.3s ease;
                    " onmouseover="this.style.background='rgba(255, 255, 255, 0.1)'" onmouseout="this.style.background='rgba(255, 255, 255, 0.05)'">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
                            <div style="display: flex; align-items: center; gap: 8px; flex: 1;">
                                <span style="font-size: 16px;">${challenge.category.icon}</span>
                                <div style="font-size: 14px; font-weight: 600;">${challenge.title}</div>
                            </div>
                            <div style="display: flex; gap: 8px; flex-shrink: 0;">
                                <span style="background: ${challenge.category.color}; color: white; padding: 2px 8px; border-radius: 8px; font-size: 10px; font-weight: 600;">${challenge.difficulty}</span>
                                <span style="background: rgba(255, 255, 255, 0.1); color: var(--text-secondary); padding: 2px 8px; border-radius: 8px; font-size: 10px;">${challenge.duration}</span>
                            </div>
                        </div>
                        <div style="font-size: 12px; color: var(--text-secondary); line-height: 1.4; margin-bottom: 8px;">
                            ${challenge.description.substring(0, 100)}...
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div style="font-size: 10px; color: ${challenge.category.color}; background: ${challenge.category.color}20; padding: 2px 8px; border-radius: 6px;">
                                ${challenge.category.name}
                            </div>
                            <div style="font-size: 12px; font-weight: 600; color: var(--primary-pink);">
                                ${challenge.tokens} tokens
                            </div>
                        </div>
                    </div>
                `).join('')}
            `;
        }

        function selectChallengeFromLibrary(categoryKey, challengeTitle) {
            const category = challengeCategories[categoryKey];
            const challenge = category.challenges.find(c => c.title === challengeTitle);
            
            if (challenge) {
                // Create enhanced challenge object
                const enhancedChallenge = {
                    ...challenge,
                    category: categoryKey,
                    categoryInfo: category,
                    aiReason: generateAIReason(categoryKey, challenge, getUserPreferences())
                };
                
                // Add to available challenges and set as current
                availableChallenges.unshift(enhancedChallenge);
                currentChallengeIndex = 0;
                displayCurrentChallenge();
                
                hideModal('challengeLibrary');
                showToast(`üéØ Selected: ${challenge.title}`, 'success');
            }
        }

        function searchHashtag(hashtag) {
            alert(`üîç Searching for challenges with ${hashtag}... Feature coming soon!`);
        }

        // Challenge Submission & AI Verification System
        function submitChallengeProof() {
            const currentChallenge = availableChallenges[currentChallengeIndex];
            if (!currentChallenge) {
                showToast('No active challenge to submit!', 'error');
                return;
            }
            
            document.getElementById('submissionChallengeTitle').textContent = currentChallenge.title;
            showModal('challengeSubmission');
            resetSubmissionForm();
        }

        function resetSubmissionForm() {
            document.getElementById('uploadArea').classList.remove('has-file');
            document.getElementById('mediaPreview').style.display = 'none';
            document.getElementById('challengeStory').value = '';
            document.getElementById('aiAnalysis').style.display = 'none';
            document.getElementById('submitBtn').textContent = 'ü§ñ Submit for AI Verification';
            document.getElementById('submitBtn').onclick = submitChallenge;
            currentUploadedFile = null;
        }

        function triggerFileUpload() {
            document.getElementById('mediaUpload').click();
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            currentUploadedFile = file;
            
            // Update upload area
            const uploadArea = document.getElementById('uploadArea');
            uploadArea.classList.add('has-file');
            uploadArea.querySelector('.upload-content').innerHTML = `
                <div style="font-size: 32px; margin-bottom: 10px; color: var(--success-green);">‚úÖ</div>
                <div style="font-size: 14px; font-weight: 600; margin-bottom: 5px;">File Selected</div>
                <div style="font-size: 11px; color: var(--text-secondary);">${file.name}</div>
            `;
            
            // Show preview
            const previewContainer = document.getElementById('mediaPreview');
            const previewContent = document.getElementById('previewContent');
            
            if (file.type.startsWith('image/')) {
                const img = document.createElement('img');
                img.src = URL.createObjectURL(file);
                img.style.maxWidth = '100%';
                img.style.maxHeight = '200px';
                img.style.borderRadius = '8px';
                previewContent.innerHTML = '';
                previewContent.appendChild(img);
                previewContainer.style.display = 'block';
            } else if (file.type.startsWith('video/')) {
                const video = document.createElement('video');
                video.src = URL.createObjectURL(file);
                video.controls = true;
                video.style.maxWidth = '100%';
                video.style.maxHeight = '200px';
                video.style.borderRadius = '8px';
                previewContent.innerHTML = '';
                previewContent.appendChild(video);
                previewContainer.style.display = 'block';
            }
            
            showToast('üìé Media uploaded successfully!', 'success');
        }

        async function submitChallenge() {
            const story = document.getElementById('challengeStory').value.trim();
            const currentChallenge = availableChallenges[currentChallengeIndex];
            
            if (!currentUploadedFile) {
                showToast('Please upload a photo or video first!', 'error');
                return;
            }
            
            if (!story) {
                showToast('Please describe your experience!', 'error');
                return;
            }
            
            // Show loading state
            document.getElementById('submitBtn').textContent = 'ü§ñ AI Analyzing...';
            document.getElementById('submitBtn').disabled = true;
            
            // Simulate AI verification delay
            showToast('ü§ñ AI is analyzing your submission...', 'info');
            
            setTimeout(() => {
                performAIVerification(currentChallenge, currentUploadedFile, story);
            }, 3000);
        }

        function performAIVerification(challenge, file, story) {
            // Simulate AI verification with realistic scoring
            const baseScore = 60 + Math.random() * 35; // 60-95 range
            const storyBonus = story.length > 50 ? 5 : 0;
            const mediaBonus = file.type.startsWith('video/') ? 5 : 0;
            
            const finalScore = Math.min(95, Math.round(baseScore + storyBonus + mediaBonus));
            
            // Generate AI feedback based on challenge type and score
            const feedback = generateAIFeedback(challenge, finalScore, story);
            
            // Calculate rewards
            const baseTokens = challenge.tokens || 500;
            const scoreMultiplier = finalScore / 100;
            const tokensEarned = Math.round(baseTokens * scoreMultiplier);
            const xpEarned = Math.round(finalScore / 4);
            
            // Display AI analysis
            displayAIAnalysis(finalScore, feedback, tokensEarned, xpEarned);
            
            // Save completed challenge
            saveCompletedChallenge(challenge, file, story, finalScore, tokensEarned, xpEarned);
            
            // Update user stats
            updateUserStats(tokensEarned, xpEarned);
        }

        function generateAIFeedback(challenge, score, story) {
            const feedbackTemplates = {
                high: [ // 85-95
                    "Outstanding work! Your creativity and effort really shine through. This is exactly what this challenge is about!",
                    "Exceptional submission! You've gone above and beyond. Your story captures the essence perfectly!",
                    "Brilliant execution! Your approach to this challenge is inspiring and shows great thoughtfulness!",
                    "Amazing job! The quality of your submission and storytelling is truly impressive!"
                ],
                good: [ // 70-84
                    "Great job! You've completed the challenge well and your story shows genuine engagement!",
                    "Nice work! Your submission shows good effort and creativity. Well done!",
                    "Solid completion! You've captured the spirit of the challenge effectively!",
                    "Good execution! Your approach demonstrates understanding of the challenge goals!"
                ],
                average: [ // 60-69
                    "Good effort! You've completed the challenge. Consider adding more detail to your story next time!",
                    "Nice attempt! The challenge is complete, though there's room for more creativity!",
                    "Well done on completing the challenge! Your future submissions could benefit from more detail!",
                    "Good work! You've met the basic requirements. Try to be more creative next time!"
                ]
            };
            
            let category = 'average';
            if (score >= 85) category = 'high';
            else if (score >= 70) category = 'good';
            
            const templates = feedbackTemplates[category];
            return templates[Math.floor(Math.random() * templates.length)];
        }

        function displayAIAnalysis(score, feedback, tokens, xp) {
            // Update score display
            document.getElementById('scoreValue').textContent = score;
            document.getElementById('scoreValue').style.color = 
                score >= 85 ? 'var(--success-green)' : 
                score >= 70 ? 'var(--warning-orange)' : 
                'var(--error-red)';
            
            // Update score breakdown
            document.getElementById('effortScore').textContent = 
                score >= 85 ? 'Excellent' : score >= 70 ? 'Good' : 'Average';
            document.getElementById('storyScore').textContent = 
                score >= 80 ? 'Detailed' : score >= 65 ? 'Good' : 'Basic';
            
            // Update feedback
            document.getElementById('feedbackText').textContent = feedback;
            
            // Update rewards
            document.getElementById('tokensEarned').textContent = tokens;
            document.getElementById('xpEarned').textContent = `+${xp}`;
            document.getElementById('streakBonus').textContent = '+1';
            
            // Show analysis
            document.getElementById('aiAnalysis').style.display = 'block';
            
            // Update submit button
            document.getElementById('submitBtn').textContent = 'üéâ Challenge Completed!';
            document.getElementById('submitBtn').disabled = false;
            document.getElementById('submitBtn').onclick = () => {
                hideModal('challengeSubmission');
                nextChallenge();
            };
            
            showToast(`üéâ Challenge verified! Score: ${score}/100`, 'success');
        }

        function saveCompletedChallenge(challenge, file, story, score, tokens, xp) {
            const completedChallenge = {
                id: Date.now(),
                challenge: challenge,
                file: {
                    name: file.name,
                    type: file.type,
                    url: URL.createObjectURL(file) // In real app, this would be uploaded to storage
                },
                story: story,
                score: score,
                tokens: tokens,
                xp: xp,
                completedAt: new Date(),
                verified: true
            };
            
            completedChallenges.unshift(completedChallenge);
            
            // In real app, save to Firebase
            if (currentUser) {
                // db.collection('completed_challenges').add(completedChallenge);
            }
        }

        function updateUserStats(tokens, xp) {
            if (userProfile) {
                userProfile.tokens = (userProfile.tokens || 0) + tokens;
                userProfile.challenges = (userProfile.challenges || 0) + 1;
                userProfile.streak = (userProfile.streak || 0) + 1;
                
                // Level up logic
                const currentXP = userProfile.xp || 0;
                const newXP = currentXP + xp;
                const newLevel = Math.floor(newXP / 100) + 1;
                
                if (newLevel > userProfile.level) {
                    userProfile.level = newLevel;
                    showToast(`üéâ Level Up! You're now Level ${newLevel}!`, 'success');
                }
                
                userProfile.xp = newXP;
                updateProfileDisplay();
                
                // Update in Firebase
                if (currentUser) {
                    updateUserProfile({
                        tokens: userProfile.tokens,
                        challenges: userProfile.challenges,
                        streak: userProfile.streak,
                        level: userProfile.level,
                        xp: userProfile.xp
                    });
                }
            }
        }

        function showChallengeGallery() {
            showModal('challengeGallery');
            populateChallengeGallery();
        }

        function populateChallengeGallery() {
            const container = document.getElementById('challengeGalleryContent');
            const avgScoreElement = document.getElementById('avgScore');
            
            if (completedChallenges.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px 20px; color: var(--text-secondary);">
                        <div style="font-size: 48px; margin-bottom: 15px;">üì∏</div>
                        <div style="font-size: 16px; margin-bottom: 8px;">No completed challenges yet</div>
                        <div style="font-size: 12px;">Complete challenges and submit proof to build your gallery!</div>
                    </div>
                `;
                avgScoreElement.textContent = 'Avg: --';
                return;
            }
            
            // Calculate average score
            const avgScore = completedChallenges.reduce((sum, c) => sum + c.score, 0) / completedChallenges.length;
            avgScoreElement.textContent = `Avg: ${avgScore.toFixed(1)}`;
            
            container.innerHTML = completedChallenges.map(completed => `
                <div class="gallery-item" onclick="viewCompletedChallenge(${completed.id})">
                    <div style="display: flex; gap: 12px;">
                        <div style="flex-shrink: 0;">
                            ${completed.file.type.startsWith('image/') ? 
                                `<img src="${completed.file.url}" style="width: 60px; height: 60px; object-fit: cover; border-radius: 8px;">` :
                                `<div style="width: 60px; height: 60px; background: var(--primary-purple); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 20px;">üé•</div>`
                            }
                        </div>
                        <div style="flex: 1; min-width: 0;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 6px;">
                                <div style="font-size: 14px; font-weight: 600; truncate;">${completed.challenge.title}</div>
                                <div style="display: flex; align-items: center; gap: 8px; flex-shrink: 0;">
                                    <div style="background: ${completed.score >= 85 ? 'var(--success-green)' : completed.score >= 70 ? 'var(--warning-orange)' : 'var(--error-red)'}; color: white; padding: 2px 8px; border-radius: 6px; font-size: 11px; font-weight: 600;">${completed.score}</div>
                                </div>
                            </div>
                            <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 6px;">
                                ${completed.story.substring(0, 80)}${completed.story.length > 80 ? '...' : ''}
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div style="font-size: 10px; color: var(--text-secondary);">
                                    ${new Date(completed.completedAt).toLocaleDateString()}
                                </div>
                                <div style="display: flex; gap: 8px; font-size: 10px;">
                                    <span style="color: var(--primary-pink);">+${completed.tokens} tokens</span>
                                    <span style="color: var(--primary-purple);">+${completed.xp} XP</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function viewCompletedChallenge(challengeId) {
            const completed = completedChallenges.find(c => c.id === challengeId);
            if (!completed) return;
            
            alert(`üèÜ ${completed.challenge.title}\n\nScore: ${completed.score}/100\nTokens: +${completed.tokens}\nXP: +${completed.xp}\n\nYour Story:\n${completed.story}\n\nCompleted: ${new Date(completed.completedAt).toLocaleDateString()}`);
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            
            // Style the toast
            Object.assign(toast.style, {
                position: 'fixed',
                top: '20px',
                left: '50%',
                transform: 'translateX(-50%)',
                background: type === 'success' ? 'var(--success-green)' : 'var(--primary-pink)',
                color: 'white',
                padding: '12px 20px',
                borderRadius: '10px',
                zIndex: '4000',
                fontSize: '14px',
                fontWeight: '600',
                opacity: '0',
                transition: 'all 0.3s ease'
            });
            
            document.body.appendChild(toast);
            
            // Animate in
            setTimeout(() => {
                toast.style.opacity = '1';
                toast.style.transform = 'translateX(-50%) translateY(10px)';
            }, 100);
            
            // Remove after 3 seconds
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(-50%) translateY(-10px)';
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            }, 3000);
        }

        // Authentication Functions
        async function signInWithGoogle() {
            try {
                const provider = new firebase.auth.GoogleAuthProvider();
                const result = await auth.signInWithPopup(provider);
                console.log('Google sign-in successful:', result.user);
            } catch (error) {
                console.error('Google sign-in error:', error);
                alert('Sign-in failed. Please try again.');
            }
        }

        async function signInWithPhone() {
            const phoneNumber = prompt('Enter your phone number (with country code):');
            if (!phoneNumber) return;

            try {
                const appVerifier = new firebase.auth.RecaptchaVerifier('authScreen');
                const confirmationResult = await auth.signInWithPhoneNumber(phoneNumber, appVerifier);
                
                const verificationCode = prompt('Enter the verification code sent to your phone:');
                if (verificationCode) {
                    await confirmationResult.confirm(verificationCode);
                }
            } catch (error) {
                console.error('Phone sign-in error:', error);
                alert('Phone sign-in failed. Please try again.');
            }
        }

        async function signOut() {
            try {
                await updateOnlineStatus(false);
                await auth.signOut();
                window.location.reload();
            } catch (error) {
                console.error('Sign-out error:', error);
            }
        }

        // Enhanced User Management
        async function createUserProfile(user) {
            const userRef = db.collection('users').doc(user.uid);
            const userDoc = await userRef.get();
            
            if (!userDoc.exists) {
                const newProfile = {
                    uid: user.uid,
                    displayName: user.displayName || 'Anonymous',
                    email: user.email,
                    photoURL: user.photoURL,
                    bio: 'New to JomBro! Ready to tackle challenges! üöÄ',
                    level: 1,
                    tokens: 0,
                    challenges: 0,
                    streak: 0,
                    friends: [],
                    groups: [],
                    achievements: [],
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    lastActive: firebase.firestore.FieldValue.serverTimestamp(),
                    online: true
                };
                await userRef.set(newProfile);
                userProfile = newProfile;
            } else {
                userProfile = userDoc.data();
                await userRef.update({
                    lastActive: firebase.firestore.FieldValue.serverTimestamp(),
                    online: true
                });
            }
            
            updateProfileDisplay();
        }

        function updateProfileDisplay() {
            if (userProfile) {
                document.getElementById('profileName').textContent = userProfile.displayName;
                document.getElementById('profileBio').textContent = userProfile.bio || 'No bio yet';
                document.getElementById('profileLevel').textContent = `Level ${userProfile.level} Explorer`;
                document.getElementById('profileChallenges').textContent = userProfile.challenges || completedChallenges.length;
                document.getElementById('profileFriends').textContent = userProfile.friends?.length || 0;
                document.getElementById('profileStreak').textContent = userProfile.streak || 0;
                document.getElementById('profileAvatar').textContent = getInitials(userProfile.displayName);
                document.getElementById('userLevel').textContent = `Level ${userProfile.level}`;
            }
        }

        async function updateOnlineStatus(online) {
            if (currentUser) {
                await db.collection('users').doc(currentUser.uid).update({
                    online: online,
                    lastActive: firebase.firestore.FieldValue.serverTimestamp()
                });
            }
        }

        // Enhanced Friends System
        async function loadFriends() {
            if (!currentUser) return;
            
            try {
                const usersSnapshot = await db.collection('users').get();
                const allUsers = [];
                
                usersSnapshot.forEach(doc => {
                    const userData = doc.data();
                    if (userData.uid !== currentUser.uid) {
                        allUsers.push(userData);
                    }
                });
                
                friendsList = allUsers;
                displayFriends();
            } catch (error) {
                console.error('Error loading friends:', error);
            }
        }

        function displayFriends() {
            const friendsList_elem = document.getElementById('friendsList');
            if (!friendsList_elem) return;
            
            let filteredFriends = friendsList;
            
            if (currentFriendsTab === 'online') {
                filteredFriends = friendsList.filter(friend => friend.online);
            } else if (currentFriendsTab === 'requests') {
                filteredFriends = []; // Placeholder for friend requests
            }
            
            if (filteredFriends.length === 0) {
                friendsList_elem.innerHTML = `
                    <div class="text-center" style="padding: 40px 20px; color: var(--text-secondary);">
                        <div style="font-size: 48px; margin-bottom: 15px;">üë•</div>
                        <div style="font-size: 16px; margin-bottom: 8px;">No ${currentFriendsTab === 'all' ? 'friends' : currentFriendsTab} yet</div>
                        <div style="font-size: 12px;">Start connecting with other challengers!</div>
                    </div>
                `;
                return;
            }
            
            friendsList_elem.innerHTML = filteredFriends.map(friend => `
                <div class="friend-item" onclick="showFriendProfile('${friend.uid}')">
                    <div class="friend-avatar">
                        ${getInitials(friend.displayName)}
                        <div class="friend-status ${friend.online ? 'online' : 'offline'}"></div>
                    </div>
                    <div class="friend-info">
                        <div class="friend-name">${friend.displayName}</div>
                        <div class="friend-activity">
                            ${friend.online ? 'Online now' : 'Last seen ' + formatTime(friend.lastActive)}
                        </div>
                    </div>
                    <div class="friend-actions">
                        <button class="friend-action-btn primary" onclick="event.stopPropagation(); sendDirectMessage('${friend.uid}')">
                            üí¨
                        </button>
                        <button class="friend-action-btn secondary" onclick="event.stopPropagation(); inviteToChallenge('${friend.uid}')">
                            üéØ
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function switchFriendsTab(tab) {
            currentFriendsTab = tab;
            
            // Update tab appearance
            document.querySelectorAll('.friends-tab').forEach(tabEl => {
                tabEl.classList.remove('active');
            });
            document.querySelector(`[onclick="switchFriendsTab('${tab}')"]`).classList.add('active');
            
            displayFriends();
        }

        function searchFriends(query) {
            // Filter friends based on search query
            const filtered = friendsList.filter(friend => 
                friend.displayName.toLowerCase().includes(query.toLowerCase())
            );
            
            // Temporarily update display
            const friendsList_elem = document.getElementById('friendsList');
            if (query.trim() === '') {
                displayFriends();
                return;
            }
            
            friendsList_elem.innerHTML = filtered.map(friend => `
                <div class="friend-item" onclick="showFriendProfile('${friend.uid}')">
                    <div class="friend-avatar">
                        ${getInitials(friend.displayName)}
                        <div class="friend-status ${friend.online ? 'online' : 'offline'}"></div>
                    </div>
                    <div class="friend-info">
                        <div class="friend-name">${friend.displayName}</div>
                        <div class="friend-activity">
                            ${friend.online ? 'Online now' : 'Last seen recently'}
                        </div>
                    </div>
                    <div class="friend-actions">
                        <button class="friend-action-btn primary" onclick="event.stopPropagation(); sendDirectMessage('${friend.uid}')">üí¨</button>
                        <button class="friend-action-btn secondary" onclick="event.stopPropagation(); inviteToChallenge('${friend.uid}')">üéØ</button>
                    </div>
                </div>
            `).join('');
        }

        async function sendDirectMessage(friendId) {
            const friend = friendsList.find(f => f.uid === friendId);
            if (!friend) return;
            
            // Create or open direct message chat
            const message = prompt(`Send a message to ${friend.displayName}:`);
            if (!message) return;
            
            try {
                await db.collection('direct_messages').add({
                    participants: [currentUser.uid, friendId].sort(),
                    senderId: currentUser.uid,
                    message: message,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                alert(`Message sent to ${friend.displayName}! üí¨`);
            } catch (error) {
                console.error('Error sending message:', error);
                alert('Failed to send message. Please try again.');
            }
        }

        function inviteToChallenge(friendId) {
            const friend = friendsList.find(f => f.uid === friendId);
            if (!friend) return;
            
            alert(`üéØ Challenge invitation sent to ${friend.displayName}! They'll get a notification to join your Coffee Shop Poetry Challenge.`);
        }

        function showFriendProfile(friendId) {
            const friend = friendsList.find(f => f.uid === friendId);
            if (!friend) return;
            
            alert(`üë§ ${friend.displayName}\nLevel: ${friend.level || 1}\nChallenges: ${friend.challenges || 0}\nStatus: ${friend.online ? 'Online' : 'Offline'}\n\n${friend.bio || 'No bio available'}`);
        }

        // Enhanced Group System
        let selectedGroupIcon = 'üöÄ';

        function selectGroupIcon(icon) {
            selectedGroupIcon = icon;
            
            // Update visual selection
            document.querySelectorAll('.group-icon-option').forEach(el => {
                el.style.background = 'rgba(255, 255, 255, 0.1)';
                el.style.border = '2px solid transparent';
            });
            
            event.target.style.background = 'rgba(255, 107, 157, 0.2)';
            event.target.style.border = '2px solid var(--primary-pink)';
        }

        async function createGroup(event) {
            event.preventDefault();
            
            const groupName = document.getElementById('groupName').value.trim();
            const groupDescription = document.getElementById('groupDescription').value.trim();
            const privacy = document.querySelector('input[name="privacy"]:checked').value;
            
            if (!groupName) {
                alert('Please enter a group name');
                return;
            }
            
            try {
                const groupData = {
                    name: groupName,
                    description: groupDescription,
                    icon: selectedGroupIcon,
                    privacy: privacy,
                    createdBy: currentUser.uid,
                    members: [currentUser.uid],
                    admins: [currentUser.uid],
                    challenges: [],
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                const groupRef = await db.collection('groups').add(groupData);
                
                // Update user's groups
                await db.collection('users').doc(currentUser.uid).update({
                    groups: firebase.firestore.FieldValue.arrayUnion(groupRef.id)
                });
                
                alert(`üéâ Group "${groupName}" created successfully! Start inviting friends and planning challenges!`);
                hideModal('group');
                loadGroups();
                
                // Reset form
                document.getElementById('groupName').value = '';
                document.getElementById('groupDescription').value = '';
                selectedGroupIcon = 'üöÄ';
                
            } catch (error) {
                console.error('Error creating group:', error);
                alert('Failed to create group. Please try again.');
            }
        }

        async function loadGroups() {
            if (!currentUser) return;
            
            try {
                const groupsSnapshot = await db.collection('groups')
                    .where('members', 'array-contains', currentUser.uid)
                    .get();
                
                groupsList = [];
                groupsSnapshot.forEach(doc => {
                    groupsList.push({ id: doc.id, ...doc.data() });
                });
                
                displayGroups();
            } catch (error) {
                console.error('Error loading groups:', error);
            }
        }

        function displayGroups() {
            const groupsList_elem = document.getElementById('groupsList');
            if (!groupsList_elem) return;
            
            if (groupsList.length === 0) {
                groupsList_elem.innerHTML = `
                    <div class="text-center" style="padding: 40px 20px; color: var(--text-secondary);">
                        <div style="font-size: 48px; margin-bottom: 15px;">üè†</div>
                        <div style="font-size: 16px; margin-bottom: 8px;">No groups yet</div>
                        <div style="font-size: 12px;">Create your first group to start challenging with friends!</div>
                    </div>
                `;
                return;
            }
            
            groupsList_elem.innerHTML = groupsList.map(group => `
                <div class="friend-item" onclick="openGroup('${group.id}')">
                    <div class="friend-avatar">${group.icon}</div>
                    <div class="friend-info">
                        <div class="friend-name">${group.name}</div>
                        <div class="friend-activity">${group.members.length} members ‚Ä¢ ${group.privacy}</div>
                    </div>
                    <div class="friend-actions">
                        <button class="friend-action-btn primary" onclick="event.stopPropagation(); openGroupChat('${group.id}')">üí¨</button>
                    </div>
                </div>
            `).join('');
        }

        function openGroup(groupId) {
            const group = groupsList.find(g => g.id === groupId);
            if (!group) return;
            
            alert(`üè† ${group.name}\n${group.description}\nMembers: ${group.members.length}\nPrivacy: ${group.privacy}\n\nGroup features coming soon!`);
        }

        function openGroupChat(groupId) {
            const group = groupsList.find(g => g.id === groupId);
            if (!group) return;
            
            document.getElementById('chatTitle').textContent = `${group.icon} ${group.name}`;
            document.getElementById('chatMembers').textContent = `${group.members.length} members`;
            
            if (!chatOpen) {
                toggleChat();
            }
        }

        // Enhanced Chat Functions
        function initializeChat() {
            const chatRef = db.collection('messages').orderBy('timestamp', 'asc');
            
            unsubscribeChat = chatRef.onSnapshot((snapshot) => {
                const messages = [];
                snapshot.forEach((doc) => {
                    messages.push({ id: doc.id, ...doc.data() });
                });
                displayMessages(messages);
            });
        }

        function displayMessages(messages) {
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.innerHTML = '';
            
            messages.forEach((message) => {
                const messageDiv = document.createElement('div');
                
                if (message.userId === 'system') {
                    messageDiv.className = 'message system';
                } else {
                    messageDiv.className = `message ${message.userId === currentUser.uid ? 'own' : ''}`;
                }
                
                const time = message.timestamp ? 
                    new Date(message.timestamp.toDate()).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : 
                    'now';
                
                if (message.userId === 'system') {
                    messageDiv.innerHTML = `
                        <div class="message-content">
                            <div class="message-text">${message.text}</div>
                        </div>
                    `;
                } else {
                    messageDiv.innerHTML = `
                        <div class="message-avatar">${message.userAvatar || 'üë§'}</div>
                        <div class="message-content">
                            <div class="message-text">${message.text}</div>
                            <div class="message-time">${time}</div>
                        </div>
                    `;
                }
                
                chatMessages.appendChild(messageDiv);
            });
            
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const text = input.value.trim();
            
            if (!text || !currentUser) return;
            
            try {
                await db.collection('messages').add({
                    text: text,
                    userId: currentUser.uid,
                    userName: currentUser.displayName || 'Anonymous',
                    userAvatar: getInitials(currentUser.displayName || 'A'),
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                input.value = '';
            } catch (error) {
                console.error('Error sending message:', error);
            }
        }

        function handleChatKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        function toggleChat() {
            chatOpen = !chatOpen;
            const chatInterface = document.getElementById('chatInterface');
            const chatToggle = document.getElementById('chatToggle');
            
            if (chatOpen) {
                chatInterface.classList.add('open');
                chatToggle.style.display = 'none';
                if (!unsubscribeChat) {
                    initializeChat();
                }
            } else {
                chatInterface.classList.remove('open');
                chatToggle.style.display = 'block';
            }
        }

        // Live Users Functions
        function initializeLiveUsers() {
            const usersRef = db.collection('users').where('online', '==', true);
            
            usersRef.onSnapshot((snapshot) => {
                const onlineUsers = [];
                snapshot.forEach((doc) => {
                    const userData = doc.data();
                    if (userData.uid !== currentUser.uid) {
                        onlineUsers.push(userData);
                    }
                });
                
                displayLiveUsers(onlineUsers);
                document.getElementById('onlineCount').textContent = `${onlineUsers.length + 1} online`;
            });
        }

        function displayLiveUsers(users) {
            const container = document.getElementById('livePlayersContainer');
            container.innerHTML = '';
            
            users.forEach((user) => {
                const playerDiv = document.createElement('div');
                playerDiv.className = 'player-avatar';
                playerDiv.onclick = () => showFriendProfile(user.uid);
                
                playerDiv.innerHTML = `
                    <div class="avatar-ring">
                        <div class="avatar-inner">${getInitials(user.displayName || 'A')}</div>
                    </div>
                    <div class="avatar-status"></div>
                `;
                
                container.appendChild(playerDiv);
            });
        }

        // Modal Functions
        function showModal(id) {
            const modal = document.getElementById(id + 'Modal');
            if (modal) {
                modal.classList.add('show');
                
                // Load data based on modal type
                if (id === 'friends') {
                    loadFriends();
                } else if (id === 'groups') {
                    loadGroups();
                } else if (id === 'profile') {
                    updateProfileDisplay();
                }
            }
        }

        function hideModal(id) {
            const modal = document.getElementById(id + 'Modal');
            if (modal) {
                modal.classList.remove('show');
            }
        }

        // UI Functions
        function showProfile() {
            showModal('profile');
        }

        function showFriends() {
            showModal('friends');
        }

        function showGroups() {
            showModal('groups');
        }

        function showCreateGroup() {
            hideModal('groups');
            showModal('group');
            
            // Populate members selector with friends
            populateMembersSelector();
        }

        function populateMembersSelector() {
            const selector = document.getElementById('membersSelector');
            if (!selector || !friendsList.length) return;
            
            selector.innerHTML = friendsList.map(friend => `
                <label class="member-option">
                    <input type="checkbox" class="member-checkbox" value="${friend.uid}">
                    <div class="friend-avatar" style="width: 30px; height: 30px; font-size: 12px;">
                        ${getInitials(friend.displayName)}
                    </div>
                    <div>
                        <div style="font-weight: 600; font-size: 14px;">${friend.displayName}</div>
                        <div style="font-size: 11px; color: var(--text-secondary);">
                            ${friend.online ? 'Online' : 'Offline'}
                        </div>
                    </div>
                </label>
            `).join('');
        }

        function startChallenge() {
            if (!chatOpen) {
                toggleChat();
            }
            
            db.collection('messages').add({
                text: `üöÄ ${currentUser.displayName} started the Coffee Shop Poetry Challenge! Who's joining?`,
                userId: 'system',
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
        }

        function findFriends() {
            alert('üîç Friend discovery feature coming soon! For now, share your JomBro link with friends to connect!');
        }

        function editProfile() {
            const newBio = prompt('Enter your new bio:', userProfile.bio || '');
            if (newBio !== null) {
                updateUserProfile({ bio: newBio });
            }
        }

        function changeProfilePicture() {
            alert('üì∑ Profile picture upload coming soon! For now, your initials look great!');
        }

        async function updateUserProfile(updates) {
            if (!currentUser) return;
            
            try {
                await db.collection('users').doc(currentUser.uid).update(updates);
                Object.assign(userProfile, updates);
                updateProfileDisplay();
                alert('‚úÖ Profile updated successfully!');
            } catch (error) {
                console.error('Error updating profile:', error);
                alert('Failed to update profile. Please try again.');
            }
        }

        function showSettings() {
            alert('‚öôÔ∏è Settings panel coming soon! For now, you can edit your bio and manage friends.');
        }

        function showAchievements() {
            alert('üèÜ Achievements system coming soon! Keep completing challenges to unlock rewards!');
        }

        function showStats() {
            alert('üìä Detailed stats coming soon! Your current streak: ' + (userProfile.streak || 0) + ' days');
        }

        // Utility Functions
        function getInitials(name) {
            if (!name) return 'A';
            return name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
        }

        function formatTime(timestamp) {
            if (!timestamp) return 'recently';
            
            const now = new Date();
            const time = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            const diff = now - time;
            
            const minutes = Math.floor(diff / (1000 * 60));
            const hours = Math.floor(diff / (1000 * 60 * 60));
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            
            if (minutes < 1) return 'just now';
            if (minutes < 60) return `${minutes}m ago`;
            if (hours < 24) return `${hours}h ago`;
            return `${days}d ago`;
        }

        // Auth State Observer
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user;
                await createUserProfile(user);
                
                document.getElementById('authScreen').style.display = 'none';
                document.getElementById('mainApp').style.display = 'block';
                document.getElementById('chatToggle').style.display = 'block';
                
                document.getElementById('userDisplayName').textContent = user.displayName || 'Anonymous';
                
                initializeLiveUsers();
                loadFriends();
                loadGroups();
                initializeChallenges();
                
                console.log('User signed in:', user);
            } else {
                document.getElementById('authScreen').style.display = 'flex';
                document.getElementById('mainApp').style.display = 'none';
                document.getElementById('chatToggle').style.display = 'none';
                
                if (unsubscribeChat) {
                    unsubscribeChat();
                    unsubscribeChat = null;
                }
                
                console.log('User signed out');
            }
        });

        // Event Listeners
        window.addEventListener('beforeunload', () => {
            updateOnlineStatus(false);
        });

        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible') {
                updateOnlineStatus(true);
            } else {
                updateOnlineStatus(false);
            }
        });

        // Style group icon options
        document.addEventListener('DOMContentLoaded', () => {
            const style = document.createElement('style');
            style.textContent = `
                .group-icon-option {
                    width: 40px;
                    height: 40px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    background: rgba(255, 255, 255, 0.1);
                    border: 2px solid transparent;
                    border-radius: 10px;
                    cursor: pointer;
                    font-size: 18px;
                    transition: all 0.3s ease;
                }
                .group-icon-option:hover {
                    background: rgba(255, 255, 255, 0.15);
                    transform: scale(1.1);
                }
            `;
            document.head.appendChild(style);
        });

        console.log('üöÄ JomBro Enhanced Social Platform Loaded!');
    </script>
</body>
</html>
