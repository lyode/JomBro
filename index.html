<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="JomBro">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'><rect width='180' height='180' fill='%23667eea'/><text x='90' y='95' font-size='100' text-anchor='middle' fill='white'>üéÆ</text></svg>">
    <link rel="manifest" href="data:application/json,{&quot;name&quot;:&quot;JomBro&quot;,&quot;short_name&quot;:&quot;JomBro&quot;,&quot;start_url&quot;:&quot;/&quot;,&quot;display&quot;:&quot;standalone&quot;,&quot;background_color&quot;:&quot;%23667eea&quot;,&quot;theme_color&quot;:&quot;%23667eea&quot;,&quot;icons&quot;:[{&quot;src&quot;:&quot;data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'><rect width='192' height='192' fill='%23667eea'/><text x='96' y='100' font-size='100' text-anchor='middle' fill='white'>üéÆ</text></svg>&quot;,&quot;sizes&quot;:&quot;192x192&quot;,&quot;type&quot;:&quot;image/svg+xml&quot;}]}">
    <title>JomBro - Friends & AI Challenge Platform</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-functions-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            overflow-x: hidden;
            min-height: 100vh;
            position: relative;
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
        }

        /* iOS App-like styling */
        .ios-safe-area {
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
            padding-left: env(safe-area-inset-left);
            padding-right: env(safe-area-inset-right);
        }

        /* Loading Screen */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            transition: opacity 0.5s ease;
        }

        .loading-logo {
            font-size: 4rem;
            margin-bottom: 20px;
            animation: bounce 2s infinite;
        }

        .loading-text {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .loading-subtitle {
            font-size: 1rem;
            opacity: 0.8;
            margin-bottom: 40px;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-15px); }
            60% { transform: translateY(-8px); }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Container */
        .container {
            max-width: 100%;
            margin: 0 auto;
            padding: 20px;
            position: relative;
            z-index: 10;
        }

        /* Cards */
        .card {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
        }

        .card:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.3);
        }

        .card-title {
            font-size: 1.4rem;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 600;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 20px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .logo-section {
            text-align: left;
        }

        .logo {
            font-size: 2.2rem;
            font-weight: 800;
            background: linear-gradient(45deg, #fff, #f0f0f0);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 5px;
        }

        .slogan {
            font-size: 0.9rem;
            opacity: 0.9;
            font-style: italic;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .user-avatar {
            width: 65px;
            height: 65px;
            border-radius: 50%;
            background: linear-gradient(45deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            cursor: pointer;
            transition: transform 0.3s ease;
            border: 3px solid rgba(255, 255, 255, 0.4);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
        }

        .user-avatar:hover {
            transform: scale(1.05);
        }

        .user-details {
            text-align: left;
        }

        .user-name {
            font-size: 1.3rem;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .user-stats {
            display: flex;
            gap: 15px;
        }

        .stat-item {
            text-align: center;
            padding: 10px 15px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 12px;
            min-width: 70px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .stat-number {
            font-size: 1.2rem;
            font-weight: bold;
            display: block;
        }

        .stat-label {
            font-size: 0.75rem;
            opacity: 0.9;
            margin-top: 3px;
        }

        /* Buttons */
        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            justify-content: center;
            min-width: 140px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .btn-primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .btn-small {
            padding: 10px 20px;
            font-size: 0.9rem;
            min-width: 100px;
        }

        .btn-danger {
            background: linear-gradient(45deg, #ff6b6b, #ee5a52);
            color: white;
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 107, 107, 0.4);
        }

        /* Auth Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(30px);
            border-radius: 25px;
            padding: 40px;
            max-width: 420px;
            width: 100%;
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 25px 60px rgba(0, 0, 0, 0.5);
        }

        .auth-welcome {
            text-align: center;
            margin-bottom: 35px;
        }

        .auth-logo {
            font-size: 4rem;
            margin-bottom: 20px;
        }

        .auth-title {
            font-size: 2rem;
            font-weight: 800;
            margin-bottom: 10px;
        }

        .auth-subtitle {
            opacity: 0.9;
            font-size: 1.1rem;
        }

        .auth-tabs {
            display: flex;
            margin-bottom: 30px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 6px;
        }

        .auth-tab {
            flex: 1;
            padding: 14px;
            text-align: center;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-weight: 600;
        }

        .auth-tab.active {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .auth-form {
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        .input-group {
            position: relative;
            display: flex;
            align-items: center;
        }

        .input-icon {
            position: absolute;
            left: 18px;
            font-size: 1.3rem;
            z-index: 10;
        }

        .auth-input {
            width: 100%;
            padding: 18px 18px 18px 55px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 15px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .auth-input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }

        .auth-input:focus {
            outline: none;
            border-color: rgba(255, 255, 255, 0.6);
            box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.2);
        }

        .auth-btn {
            width: 100%;
            padding: 18px;
            border: none;
            border-radius: 15px;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .auth-btn-primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .auth-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.6);
        }

        .btn-loading {
            display: none;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }

        /* Friends Section */
        .friends-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .friend-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 18px;
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.25);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .friend-card:hover {
            background: rgba(255, 255, 255, 0.18);
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .friend-header {
            display: flex;
            align-items: center;
            gap: 18px;
            margin-bottom: 18px;
        }

        .friend-avatar {
            width: 55px;
            height: 55px;
            border-radius: 50%;
            background: linear-gradient(45deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            position: relative;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .online-indicator {
            position: absolute;
            bottom: -2px;
            right: -2px;
            width: 14px;
            height: 14px;
            background: #4CAF50;
            border-radius: 50%;
            border: 3px solid white;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(76, 175, 80, 0); }
            100% { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0); }
        }

        .friend-info {
            flex: 1;
        }

        .friend-name {
            font-weight: 700;
            font-size: 1.1rem;
            margin-bottom: 6px;
        }

        .friend-status {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .friend-actions {
            display: flex;
            gap: 12px;
        }

        /* Challenge Creation */
        .challenge-form {
            display: grid;
            gap: 25px;
            margin-bottom: 30px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .form-label {
            font-weight: 600;
            font-size: 1rem;
        }

        .form-input, .form-textarea, .form-select {
            padding: 15px 18px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 15px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-input::placeholder, .form-textarea::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }

        .form-input:focus, .form-textarea:focus, .form-select:focus {
            outline: none;
            border-color: rgba(255, 255, 255, 0.6);
            box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.2);
        }

        .form-textarea {
            min-height: 120px;
            resize: vertical;
        }

        .form-select option {
            background: #333;
            color: white;
        }

        /* Messages */
        .message {
            position: fixed;
            top: 30px;
            right: 20px;
            padding: 18px 25px;
            border-radius: 15px;
            color: white;
            font-weight: 600;
            z-index: 10000;
            max-width: 350px;
            animation: slideIn 0.4s ease;
            box-shadow: 0 6px 25px rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(10px);
        }

        .message.success {
            background: linear-gradient(45deg, #4CAF50, #45a049);
        }

        .message.error {
            background: linear-gradient(45deg, #f44336, #da190b);
        }

        .message.info {
            background: linear-gradient(45deg, #2196F3, #0b7dda);
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Geolocation */
        .location-status {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .location-icon {
            font-size: 1.5rem;
        }

        .location-text {
            flex: 1;
        }

        .location-title {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .location-subtitle {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        /* Nearby Players */
        .nearby-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .nearby-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }

        .nearby-card:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-3px);
        }

        .nearby-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(45deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
            margin: 0 auto 10px;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .nearby-name {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .nearby-distance {
            font-size: 0.85rem;
            opacity: 0.8;
        }

        /* Error States */
        .error-state {
            text-align: center;
            padding: 40px 20px;
            opacity: 0.8;
        }

        .error-icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }

        .error-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .error-message {
            margin-bottom: 20px;
            line-height: 1.5;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .header {
                flex-direction: column;
                text-align: center;
            }
            
            .user-info {
                flex-direction: column;
                gap: 15px;
            }
            
            .friends-grid {
                grid-template-columns: 1fr;
            }
            
            .modal-content {
                padding: 30px 20px;
            }
            
            .user-stats {
                justify-content: center;
            }
        }

        /* Hide elements until loaded */
        .app-content {
            display: none;
        }

        .app-content.loaded {
            display: block;
        }

        /* iOS-specific optimizations */
        @supports (-webkit-touch-callout: none) {
            .btn {
                -webkit-touch-callout: none;
                -webkit-user-select: none;
            }
        }
    </style>
</head>
<body class="ios-safe-area">
    <!-- Loading Screen -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-logo">üéÆ</div>
        <div class="loading-text">JomBro</div>
        <div class="loading-subtitle">Come-on bro, Let's go!</div>
        <div class="loading-spinner"></div>
    </div>

    <!-- App Content -->
    <div class="app-content" id="appContent">
        <div class="container">
            <!-- Header -->
            <div class="header">
                <div class="logo-section">
                    <div class="logo">JomBro</div>
                    <div class="slogan">Come-on bro, Let's go!</div>
                </div>
                <div class="user-info">
                    <div class="user-avatar" id="userAvatar" onclick="openProfile()">üë§</div>
                    <div class="user-details">
                        <div class="user-name" id="userName">Loading...</div>
                        <div class="user-stats">
                            <div class="stat-item">
                                <span class="stat-number" id="userTokens">0</span>
                                <span class="stat-label">Tokens</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-number" id="userLevel">1</span>
                                <span class="stat-label">Level</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-number" id="userFriends">0</span>
                                <span class="stat-label">Friends</span>
                            </div>
                        </div>
                    </div>
                    <button class="btn btn-danger btn-small" onclick="logoutUser()" id="logoutBtn">
                        Logout
                    </button>
                </div>
            </div>

            <!-- Location Status -->
            <div class="location-status" id="locationStatus">
                <div class="location-icon">üìç</div>
                <div class="location-text">
                    <div class="location-title">Getting your location...</div>
                    <div class="location-subtitle">This helps find nearby players</div>
                </div>
                <button class="btn btn-secondary btn-small" onclick="getCurrentLocation()">
                    Enable Location
                </button>
            </div>

            <!-- Nearby Players -->
            <div class="card">
                <div class="card-title">
                    <span>üåç</span>
                    <span>Nearby Players</span>
                    <span style="margin-left: auto;">
                        <button class="btn btn-secondary btn-small" onclick="refreshNearbyPlayers()">
                            Refresh
                        </button>
                    </span>
                </div>
                
                <div class="nearby-grid" id="nearbyGrid">
                    <!-- Nearby players will be populated here -->
                </div>
            </div>

            <!-- Challenge Creation -->
            <div class="card">
                <div class="card-title">
                    <span>‚ö°</span>
                    <span>Create Challenge</span>
                </div>
                
                <div class="challenge-form">
                    <div class="form-group">
                        <label class="form-label">Challenge Title</label>
                        <input type="text" class="form-input" id="challengeTitle" placeholder="What's the challenge?" maxlength="100">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Description</label>
                        <textarea class="form-textarea" id="challengeDescription" placeholder="Describe the challenge in detail..."></textarea>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div class="form-group">
                            <label class="form-label">Category</label>
                            <select class="form-select" id="challengeCategory">
                                <option value="fitness">üí™ Fitness</option>
                                <option value="creative">üé® Creative</option>
                                <option value="social">üë• Social</option>
                                <option value="food">üçï Food</option>
                                <option value="adventure">üó∫Ô∏è Adventure</option>
                                <option value="learning">üìö Learning</option>
                                <option value="mindfulness">üß† Mindfulness</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Reward (Tokens)</label>
                            <select class="form-select" id="challengeReward">
                                <option value="100">ü™ô 100 Tokens</option>
                                <option value="250">ü™ô 250 Tokens</option>
                                <option value="500">ü™ô 500 Tokens</option>
                                <option value="1000">ü™ô 1000 Tokens</option>
                            </select>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 15px; justify-content: center;">
                        <button class="btn btn-primary" onclick="createChallenge()">
                            Create Challenge
                        </button>
                        <button class="btn btn-secondary" onclick="clearChallengeForm()">
                            Clear Form
                        </button>
                    </div>
                </div>
            </div>

            <!-- Friends Section -->
            <div class="card">
                <div class="card-title">
                    <span>üë•</span>
                    <span>Friends</span>
                    <span style="margin-left: auto;">
                        <button class="btn btn-secondary btn-small" onclick="showAddFriendModal()">
                            Add Friend
                        </button>
                    </span>
                </div>
                
                <div class="friends-grid" id="friendsGrid">
                    <!-- Friends will be populated here -->
                </div>
            </div>

            <!-- Recent Activity -->
            <div class="card">
                <div class="card-title">
                    <span>üìà</span>
                    <span>Recent Activity</span>
                </div>
                
                <div id="activityFeed">
                    <!-- Activity will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Auth Modal -->
    <div class="modal" id="authModal">
        <div class="modal-content">
            <div class="auth-welcome">
                <div class="auth-logo">üéÆ</div>
                <div class="auth-title">Welcome to JomBro</div>
                <div class="auth-subtitle">Come-on bro, Let's go!</div>
            </div>
            
            <div class="auth-tabs">
                <div class="auth-tab active" onclick="switchAuthTab('login')">
                    <span class="tab-icon">üöÄ</span>
                    <span>Login</span>
                </div>
                <div class="auth-tab" onclick="switchAuthTab('signup')">
                    <span class="tab-icon">‚ú®</span>
                    <span>Sign Up</span>
                </div>
            </div>
            
            <div class="auth-form" id="loginForm">
                <div class="input-group">
                    <div class="input-icon">üìß</div>
                    <input type="email" class="auth-input" id="loginEmail" placeholder="Email address" autocomplete="email" required>
                </div>
                <div class="input-group">
                    <div class="input-icon">üîí</div>
                    <input type="password" class="auth-input" id="loginPassword" placeholder="Password" autocomplete="current-password" required>
                </div>
                <button class="auth-btn auth-btn-primary" onclick="loginUser()">
                    <span class="btn-text">Login to JomBro</span>
                    <span class="btn-loading">
                        <span class="loading-spinner"></span>
                        <span>Logging in...</span>
                    </span>
                </button>
            </div>
            
            <div class="auth-form" id="signupForm" style="display: none;">
                <div class="input-group">
                    <div class="input-icon">üë§</div>
                    <input type="text" class="auth-input" id="signupName" placeholder="Your awesome username" autocomplete="name" required>
                </div>
                <div class="input-group">
                    <div class="input-icon">üìß</div>
                    <input type="email" class="auth-input" id="signupEmail" placeholder="Email address" autocomplete="email" required>
                </div>
                <div class="input-group">
                    <div class="input-icon">üîí</div>
                    <input type="password" class="auth-input" id="signupPassword" placeholder="Create password (min 6 chars)" autocomplete="new-password" required>
                </div>
                <button class="auth-btn auth-btn-primary" onclick="signupUser()">
                    <span class="btn-text">Join JomBro</span>
                    <span class="btn-loading">
                        <span class="loading-spinner"></span>
                        <span>Creating account...</span>
                    </span>
                </button>
            </div>
        </div>
    </div>

    <!-- Add Friend Modal -->
    <div class="modal" id="addFriendModal">
        <div class="modal-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                <h3 style="font-size: 1.5rem; font-weight: 700;">Add Friend</h3>
                <button onclick="hideModal('addFriendModal')" style="background: none; border: none; color: white; font-size: 2rem; cursor: pointer; opacity: 0.8;">&times;</button>
            </div>
            
            <div class="form-group">
                <label class="form-label">Friend's Email</label>
                <input type="email" class="form-input" id="friendEmail" placeholder="Enter friend's email address" required>
            </div>
            
            <div style="display: flex; gap: 15px; margin-top: 25px;">
                <button class="btn btn-primary" onclick="addFriend()">
                    Send Friend Request
                </button>
                <button class="btn btn-secondary" onclick="hideModal('addFriendModal')">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration - REPLACE WITH YOUR ACTUAL CONFIG
        const firebaseConfig = {
            apiKey: "your-api-key-here",
            authDomain: "your-project.firebaseapp.com",
            projectId: "your-project-id",
            storageBucket: "your-project.appspot.com",
            messagingSenderId: "123456789",
            appId: "your-app-id"
        };

        // App State
        let app, auth, db, storage, functions;
        let currentUser = null;
        let userLocation = null;
        let appData = {
            friends: [],
            challenges: [],
            activities: [],
            nearbyPlayers: []
        };

        // Initialize Firebase and App
        function initApp() {
            try {
                // Initialize Firebase
                app = firebase.initializeApp(firebaseConfig);
                auth = firebase.auth();
                db = firebase.firestore();
                storage = firebase.storage();
                functions = firebase.functions();
                
                // Configure Firestore settings
                db.settings({ timestampsInSnapshots: true });
                
                // Monitor authentication state
                auth.onAuthStateChanged((user) => {
                    if (user) {
                        currentUser = user;
                        initializeUserSession();
                    } else {
                        currentUser = null;
                        showAuthModal();
                    }
                });
                
                console.log('‚úÖ Firebase initialized successfully');
                
            } catch (error) {
                console.error('‚ùå Firebase initialization error:', error);
                showMessage('‚ùå Failed to connect to Firebase. Please check your configuration.', 'error');
                
                // Show configuration help
                setTimeout(() => {
                    showMessage('üîß Please update the Firebase configuration in the code', 'info');
                }, 2000);
            }
        }

        // User Session Management
        async function initializeUserSession() {
            try {
                hideLoadingScreen();
                hideModal('authModal');
                showAppContent();
                
                await loadUserData();
                await getCurrentLocation();
                await loadUserFriends();
                await loadUserChallenges();
                await loadUserActivities();
                await refreshNearbyPlayers();
                
                showMessage(`üéâ Welcome back, ${currentUser.displayName || 'JomBro'}!`, 'success');
                
            } catch (error) {
                console.error('Error initializing user session:', error);
                showMessage('‚ö†Ô∏è Error loading user data', 'error');
            }
        }

        // Authentication Functions
        function switchAuthTab(tab) {
            document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`[onclick="switchAuthTab('${tab}')"]`).classList.add('active');
            
            if (tab === 'login') {
                document.getElementById('loginForm').style.display = 'flex';
                document.getElementById('signupForm').style.display = 'none';
            } else {
                document.getElementById('loginForm').style.display = 'none';
                document.getElementById('signupForm').style.display = 'flex';
            }
        }

        async function loginUser() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            
            if (!email || !password) {
                showMessage('‚ùå Please fill in all fields!', 'error');
                return;
            }
            
            if (!validateEmail(email)) {
                showMessage('‚ùå Please enter a valid email address!', 'error');
                return;
            }
            
            const btn = event.target;
            setButtonLoading(btn, true);
            
            try {
                await auth.signInWithEmailAndPassword(email, password);
                clearForm('loginForm');
                
            } catch (error) {
                console.error('Login error:', error);
                
                let errorMessage = 'Login failed. Please try again.';
                switch (error.code) {
                    case 'auth/user-not-found':
                        errorMessage = 'No account found with this email.';
                        break;
                    case 'auth/wrong-password':
                        errorMessage = 'Incorrect password.';
                        break;
                    case 'auth/invalid-email':
                        errorMessage = 'Invalid email address.';
                        break;
                    case 'auth/too-many-requests':
                        errorMessage = 'Too many failed attempts. Please try again later.';
                        break;
                }
                
                showMessage(`‚ùå ${errorMessage}`, 'error');
                setButtonLoading(btn, false);
            }
        }

        async function signupUser() {
            const name = document.getElementById('signupName').value.trim();
            const email = document.getElementById('signupEmail').value.trim();
            const password = document.getElementById('signupPassword').value;
            
            if (!name || !email || !password) {
                showMessage('‚ùå Please fill in all fields!', 'error');
                return;
            }
            
            if (!validateEmail(email)) {
                showMessage('‚ùå Please enter a valid email address!', 'error');
                return;
            }
            
            if (password.length < 6) {
                showMessage('‚ùå Password must be at least 6 characters!', 'error');
                return;
            }
            
            if (name.length < 2) {
                showMessage('‚ùå Name must be at least 2 characters!', 'error');
                return;
            }
            
            const btn = event.target;
            setButtonLoading(btn, true);
            
            try {
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                await userCredential.user.updateProfile({ displayName: name });
                
                // Create user document in Firestore
                await db.collection('users').doc(userCredential.user.uid).set({
                    name: name,
                    email: email,
                    tokens: 1000,
                    level: 1,
                    friends: 0,
                    challengesCompleted: 0,
                    joinedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    lastActive: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                clearForm('signupForm');
                showMessage('üéâ Account created successfully! You got 1000 starting tokens!', 'success');
                
            } catch (error) {
                console.error('Signup error:', error);
                
                let errorMessage = 'Account creation failed. Please try again.';
                switch (error.code) {
                    case 'auth/email-already-in-use':
                        errorMessage = 'An account with this email already exists.';
                        break;
                    case 'auth/invalid-email':
                        errorMessage = 'Invalid email address.';
                        break;
                    case 'auth/weak-password':
                        errorMessage = 'Password is too weak. Please choose a stronger password.';
                        break;
                }
                
                showMessage(`‚ùå ${errorMessage}`, 'error');
                setButtonLoading(btn, false);
            }
        }

        async function logoutUser() {
            try {
                await auth.signOut();
                showMessage('üëã Logged out successfully!', 'info');
                
                // Reset app state
                appData = { friends: [], challenges: [], activities: [], nearbyPlayers: [] };
                userLocation = null;
                
            } catch (error) {
                console.error('Logout error:', error);
                showMessage('‚ùå Logout failed', 'error');
            }
        }

        // User Data Management
        async function loadUserData() {
            if (!currentUser) return;
            
            try {
                const userDoc = await db.collection('users').doc(currentUser.uid).get();
                
                if (userDoc.exists) {
                    const userData = userDoc.data();
                    updateUserDisplay(userData);
                    
                    // Update last active timestamp
                    await db.collection('users').doc(currentUser.uid).update({
                        lastActive: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                } else {
                    // Create user document if it doesn't exist
                    const defaultData = {
                        name: currentUser.displayName || 'JomBro Player',
                        email: currentUser.email,
                        tokens: 1000,
                        level: 1,
                        friends: 0,
                        challengesCompleted: 0,
                        joinedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        lastActive: firebase.firestore.FieldValue.serverTimestamp()
                    };
                    
                    await db.collection('users').doc(currentUser.uid).set(defaultData);
                    updateUserDisplay(defaultData);
                }
                
            } catch (error) {
                console.error('Error loading user data:', error);
                showMessage('‚ö†Ô∏è Error loading user profile', 'error');
            }
        }

        function updateUserDisplay(userData) {
            document.getElementById('userName').textContent = userData.name || 'JomBro Player';
            document.getElementById('userTokens').textContent = (userData.tokens || 0).toLocaleString();
            document.getElementById('userLevel').textContent = userData.level || 1;
            document.getElementById('userFriends').textContent = userData.friends || 0;
            
            // Update avatar if available
            if (userData.avatar) {
                document.getElementById('userAvatar').textContent = userData.avatar;
            }
        }

        // Geolocation Functions
        async function getCurrentLocation() {
            if (!navigator.geolocation) {
                updateLocationStatus('‚ùå Geolocation not supported', 'Enable location to find nearby players');
                return;
            }
            
            updateLocationStatus('üìç Getting your location...', 'This helps find nearby players');
            
            try {
                const position = await new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(resolve, reject, {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 300000 // 5 minutes
                    });
                });
                
                userLocation = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude,
                    accuracy: position.coords.accuracy
                };
                
                updateLocationStatus('‚úÖ Location enabled', `Accuracy: ${Math.round(userLocation.accuracy)}m`);
                
                // Save location to user document
                if (currentUser) {
                    await db.collection('users').doc(currentUser.uid).update({
                        location: {
                            lat: userLocation.lat,
                            lng: userLocation.lng,
                            lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                        }
                    });
                }
                
                await refreshNearbyPlayers();
                
            } catch (error) {
                console.error('Geolocation error:', error);
                
                let errorMessage = 'Location access denied';
                switch (error.code) {
                    case error.PERMISSION_DENIED:
                        errorMessage = 'Location access denied by user';
                        break;
                    case error.POSITION_UNAVAILABLE:
                        errorMessage = 'Location information unavailable';
                        break;
                    case error.TIMEOUT:
                        errorMessage = 'Location request timed out';
                        break;
                }
                
                updateLocationStatus('‚ùå Location unavailable', errorMessage);
                showMessage(`üìç ${errorMessage}`, 'error');
            }
        }

        function updateLocationStatus(title, subtitle) {
            const locationStatus = document.getElementById('locationStatus');
            locationStatus.innerHTML = `
                <div class="location-icon">${title.includes('‚úÖ') ? 'üìç' : title.includes('‚ùå') ? '‚ùå' : 'üìç'}</div>
                <div class="location-text">
                    <div class="location-title">${title}</div>
                    <div class="location-subtitle">${subtitle}</div>
                </div>
                ${!title.includes('‚úÖ') ? '<button class="btn btn-secondary btn-small" onclick="getCurrentLocation()">Enable Location</button>' : ''}
            `;
        }

        // Nearby Players Functions
        async function refreshNearbyPlayers() {
            if (!userLocation || !currentUser) {
                renderNearbyPlayers([]);
                return;
            }
            
            try {
                // Query for users with recent location updates within 10km
                const nearbyQuery = await db.collection('users')
                    .where('location.lastUpdated', '>', new Date(Date.now() - 30 * 60 * 1000)) // Last 30 minutes
                    .limit(50)
                    .get();
                
                const nearbyPlayers = [];
                
                nearbyQuery.forEach(doc => {
                    if (doc.id !== currentUser.uid) { // Exclude current user
                        const userData = doc.data();
                        if (userData.location && userData.location.lat && userData.location.lng) {
                            const distance = calculateDistance(
                                userLocation.lat, userLocation.lng,
                                userData.location.lat, userData.location.lng
                            );
                            
                            // Only include players within 10km
                            if (distance <= 10) {
                                nearbyPlayers.push({
                                    id: doc.id,
                                    name: userData.name,
                                    avatar: userData.avatar || getRandomAvatar(),
                                    distance: distance,
                                    level: userData.level || 1,
                                    online: userData.lastActive && 
                                            userData.lastActive.toDate() > new Date(Date.now() - 10 * 60 * 1000) // Online if active in last 10 min
                                });
                            }
                        }
                    }
                });
                
                // Sort by distance
                nearbyPlayers.sort((a, b) => a.distance - b.distance);
                
                appData.nearbyPlayers = nearbyPlayers;
                renderNearbyPlayers(nearbyPlayers);
                
                showMessage(`üåç Found ${nearbyPlayers.length} nearby players`, 'success');
                
            } catch (error) {
                console.error('Error loading nearby players:', error);
                showMessage('‚ö†Ô∏è Error loading nearby players', 'error');
                renderNearbyPlayers([]);
            }
        }

        function renderNearbyPlayers(players) {
            const nearbyGrid = document.getElementById('nearbyGrid');
            
            if (!players || players.length === 0) {
                nearbyGrid.innerHTML = `
                    <div class="error-state" style="grid-column: 1 / -1;">
                        <div class="error-icon">üåç</div>
                        <div class="error-title">No nearby players found</div>
                        <div class="error-message">Enable location and try refreshing to find players within 10km</div>
                        <button class="btn btn-primary" onclick="refreshNearbyPlayers()">
                            Search Again
                        </button>
                    </div>
                `;
                return;
            }
            
            nearbyGrid.innerHTML = players.map(player => `
                <div class="nearby-card" onclick="viewPlayerProfile('${player.id}')">
                    <div class="nearby-avatar">
                        ${player.avatar}
                        ${player.online ? '<div class="online-indicator"></div>' : ''}
                    </div>
                    <div class="nearby-name">${player.name}</div>
                    <div class="nearby-distance">${formatDistance(player.distance)} ‚Ä¢ Level ${player.level}</div>
                </div>
            `).join('');
        }

        // Challenge Functions
        async function createChallenge() {
            const title = document.getElementById('challengeTitle').value.trim();
            const description = document.getElementById('challengeDescription').value.trim();
            const category = document.getElementById('challengeCategory').value;
            const reward = parseInt(document.getElementById('challengeReward').value);
            
            if (!title || !description) {
                showMessage('‚ùå Please fill in title and description!', 'error');
                return;
            }
            
            if (title.length < 5) {
                showMessage('‚ùå Challenge title must be at least 5 characters!', 'error');
                return;
            }
            
            if (description.length < 10) {
                showMessage('‚ùå Challenge description must be at least 10 characters!', 'error');
                return;
            }
            
            const creationCost = Math.floor(reward * 0.1); // 10% of reward as creation cost
            
            try {
                // Check user tokens
                const userDoc = await db.collection('users').doc(currentUser.uid).get();
                const userData = userDoc.data();
                
                if (userData.tokens < creationCost) {
                    showMessage(`‚ùå Not enough tokens! You need ${creationCost} tokens to create this challenge.`, 'error');
                    return;
                }
                
                // Create challenge
                const challengeData = {
                    title: title,
                    description: description,
                    category: category,
                    reward: reward,
                    creatorId: currentUser.uid,
                    creatorName: currentUser.displayName || 'Anonymous',
                    status: 'active',
                    participants: 0,
                    completions: 0,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    location: userLocation ? {
                        lat: userLocation.lat,
                        lng: userLocation.lng
                    } : null
                };
                
                const docRef = await db.collection('challenges').add(challengeData);
                
                // Deduct creation cost and update user stats
                await db.collection('users').doc(currentUser.uid).update({
                    tokens: firebase.firestore.FieldValue.increment(-creationCost),
                    challengesCreated: firebase.firestore.FieldValue.increment(1)
                });
                
                // Add activity
                await db.collection('activities').add({
                    userId: currentUser.uid,
                    type: 'challenge_created',
                    title: `Created challenge: ${title}`,
                    challengeId: docRef.id,
                    tokens: -creationCost,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                clearChallengeForm();
                await loadUserData(); // Refresh user data
                await loadUserActivities();
                
                showMessage(`üéØ Challenge "${title}" created! Cost: ${creationCost} tokens`, 'success');
                
            } catch (error) {
                console.error('Error creating challenge:', error);
                showMessage('‚ùå Error creating challenge', 'error');
            }
        }

        function clearChallengeForm() {
            document.getElementById('challengeTitle').value = '';
            document.getElementById('challengeDescription').value = '';
            document.getElementById('challengeCategory').value = 'fitness';
            document.getElementById('challengeReward').value = '100';
        }

        // Friend Functions
        async function loadUserFriends() {
            if (!currentUser) return;
            
            try {
                const friendsQuery = await db.collection('friendships')
                    .where('users', 'array-contains', currentUser.uid)
                    .where('status', '==', 'accepted')
                    .get();
                
                const friends = [];
                
                for (const doc of friendsQuery.docs) {
                    const friendship = doc.data();
                    const friendId = friendship.users.find(id => id !== currentUser.uid);
                    
                    if (friendId) {
                        const friendDoc = await db.collection('users').doc(friendId).get();
                        if (friendDoc.exists) {
                            const friendData = friendDoc.data();
                            friends.push({
                                id: friendId,
                                name: friendData.name,
                                avatar: friendData.avatar || getRandomAvatar(),
                                level: friendData.level || 1,
                                tokens: friendData.tokens || 0,
                                online: friendData.lastActive && 
                                        friendData.lastActive.toDate() > new Date(Date.now() - 10 * 60 * 1000),
                                status: friendData.lastActive && 
                                        friendData.lastActive.toDate() > new Date(Date.now() - 10 * 60 * 1000) ? 
                                        'Online ‚Ä¢ Ready for challenges' : 
                                        `Last seen ${formatTimeAgo(friendData.lastActive?.toDate())}`
                            });
                        }
                    }
                }
                
                appData.friends = friends;
                renderFriends(friends);
                
            } catch (error) {
                console.error('Error loading friends:', error);
                renderFriends([]);
            }
        }

        async function addFriend() {
            const friendEmail = document.getElementById('friendEmail').value.trim();
            
            if (!friendEmail) {
                showMessage('‚ùå Please enter a friend\'s email!', 'error');
                return;
            }
            
            if (!validateEmail(friendEmail)) {
                showMessage('‚ùå Please enter a valid email address!', 'error');
                return;
            }
            
            if (friendEmail === currentUser.email) {
                showMessage('‚ùå You cannot add yourself as a friend!', 'error');
                return;
            }
            
            try {
                // Find user by email
                const userQuery = await db.collection('users')
                    .where('email', '==', friendEmail)
                    .limit(1)
                    .get();
                
                if (userQuery.empty) {
                    showMessage('‚ùå No user found with this email address', 'error');
                    return;
                }
                
                const friendDoc = userQuery.docs[0];
                const friendId = friendDoc.id;
                
                // Check if friendship already exists
                const existingFriendship = await db.collection('friendships')
                    .where('users', 'array-contains', currentUser.uid)
                    .get();
                
                const alreadyFriends = existingFriendship.docs.some(doc => {
                    const data = doc.data();
                    return data.users.includes(friendId);
                });
                
                if (alreadyFriends) {
                    showMessage('üë• You are already friends with this user!', 'info');
                    return;
                }
                
                // Create friend request
                await db.collection('friendships').add({
                    users: [currentUser.uid, friendId],
                    requester: currentUser.uid,
                    status: 'pending',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Add notification for the friend
                await db.collection('notifications').add({
                    userId: friendId,
                    type: 'friend_request',
                    title: 'New Friend Request',
                    message: `${currentUser.displayName || 'Someone'} wants to be your friend!`,
                    data: { requesterId: currentUser.uid },
                    read: false,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                hideModal('addFriendModal');
                document.getElementById('friendEmail').value = '';
                
                showMessage(`üì§ Friend request sent to ${friendEmail}!`, 'success');
                
            } catch (error) {
                console.error('Error adding friend:', error);
                showMessage('‚ùå Error sending friend request', 'error');
            }
        }

        function renderFriends(friends) {
            const friendsGrid = document.getElementById('friendsGrid');
            
            if (!friends || friends.length === 0) {
                friendsGrid.innerHTML = `
                    <div class="error-state" style="grid-column: 1 / -1;">
                        <div class="error-icon">üë•</div>
                        <div class="error-title">No friends yet!</div>
                        <div class="error-message">Add some friends to start challenging each other and having fun together.</div>
                        <button class="btn btn-primary" onclick="showAddFriendModal()">
                            Add Your First Friend
                        </button>
                    </div>
                `;
                return;
            }
            
            friendsGrid.innerHTML = friends.map(friend => `
                <div class="friend-card">
                    <div class="friend-header">
                        <div class="friend-avatar">
                            ${friend.avatar}
                            ${friend.online ? '<div class="online-indicator"></div>' : ''}
                        </div>
                        <div class="friend-info">
                            <div class="friend-name">${friend.name}</div>
                            <div class="friend-status">${friend.status}</div>
                        </div>
                    </div>
                    <div class="friend-actions">
                        <button class="btn btn-primary btn-small" onclick="challengeFriend('${friend.id}')">
                            Challenge
                        </button>
                        <button class="btn btn-secondary btn-small" onclick="chatWithFriend('${friend.id}')">
                            Chat
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Activity Functions
        async function loadUserActivities() {
            if (!currentUser) return;
            
            try {
                const activitiesQuery = await db.collection('activities')
                    .where('userId', '==', currentUser.uid)
                    .orderBy('createdAt', 'desc')
                    .limit(10)
                    .get();
                
                const activities = [];
                activitiesQuery.forEach(doc => {
                    const data = doc.data();
                    activities.push({
                        id: doc.id,
                        ...data,
                        createdAt: data.createdAt?.toDate()
                    });
                });
                
                appData.activities = activities;
                renderActivities(activities);
                
            } catch (error) {
                console.error('Error loading activities:', error);
                renderActivities([]);
            }
        }

        function renderActivities(activities) {
            const activityFeed = document.getElementById('activityFeed');
            
            if (!activities || activities.length === 0) {
                activityFeed.innerHTML = `
                    <div class="error-state">
                        <div class="error-icon">üìà</div>
                        <div class="error-title">No recent activity</div>
                        <div class="error-message">Start creating challenges and adding friends to see your activity here!</div>
                    </div>
                `;
                return;
            }
            
            activityFeed.innerHTML = activities.map(activity => `
                <div style="padding: 18px; margin-bottom: 12px; background: rgba(255, 255, 255, 0.1); border-radius: 15px; border: 1px solid rgba(255, 255, 255, 0.2);">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-weight: 600; margin-bottom: 5px;">${activity.title}</div>
                            <div style="font-size: 0.9rem; opacity: 0.8;">
                                ${activity.createdAt ? formatTimeAgo(activity.createdAt) : 'Recently'}
                            </div>
                        </div>
                        ${activity.tokens ? `
                            <div style="font-weight: 700; color: ${activity.tokens > 0 ? '#4CAF50' : '#f44336'};">
                                ${activity.tokens > 0 ? '+' : ''}${activity.tokens} ü™ô
                            </div>
                        ` : ''}
                    </div>
                </div>
            `).join('');
        }

        // Utility Functions
        function calculateDistance(lat1, lng1, lat2, lng2) {
            const R = 6371; // Earth's radius in kilometers
            const dLat = toRadians(lat2 - lat1);
            const dLng = toRadians(lng2 - lng1);
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                      Math.cos(toRadians(lat1)) * Math.cos(toRadians(lat2)) *
                      Math.sin(dLng / 2) * Math.sin(dLng / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        function toRadians(degrees) {
            return degrees * (Math.PI / 180);
        }

        function formatDistance(distance) {
            if (distance < 1) {
                return `${Math.round(distance * 1000)}m`;
            }
            return `${distance.toFixed(1)}km`;
        }

        function formatTimeAgo(date) {
            if (!date) return 'Unknown';
            
            const now = new Date();
            const diff = now - date;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);
            
            if (minutes < 1) return 'Just now';
            if (minutes < 60) return `${minutes}m ago`;
            if (hours < 24) return `${hours}h ago`;
            if (days < 7) return `${days}d ago`;
            return date.toLocaleDateString();
        }

        function getRandomAvatar() {
            const avatars = ['üòé', 'üå∏', 'üöÄ', 'üí™', 'üéµ', 'üé®', 'ü§†', 'üåü', 'üéØ', 'üé≠', 'üé™', 'üåà'];
            return avatars[Math.floor(Math.random() * avatars.length)];
        }

        function validateEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }

        // UI Helper Functions
        function showModal(modalId) {
            document.getElementById(modalId).classList.add('show');
        }

        function hideModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
        }

        function showAuthModal() {
            showModal('authModal');
            hideAppContent();
        }

        function showAddFriendModal() {
            showModal('addFriendModal');
        }

        function showMessage(message, type = 'info') {
            // Remove existing messages
            document.querySelectorAll('.message').forEach(msg => msg.remove());
            
            const messageEl = document.createElement('div');
            messageEl.className = `message ${type}`;
            messageEl.textContent = message;
            document.body.appendChild(messageEl);
            
            setTimeout(() => {
                if (messageEl.parentNode) {
                    messageEl.remove();
                }
            }, 5000);
        }

        function setButtonLoading(btn, loading) {
            const btnText = btn.querySelector('.btn-text');
            const btnLoading = btn.querySelector('.btn-loading');
            
            if (loading) {
                if (btnText) btnText.style.display = 'none';
                if (btnLoading) btnLoading.style.display = 'flex';
                btn.disabled = true;
            } else {
                if (btnText) btnText.style.display = 'block';
                if (btnLoading) btnLoading.style.display = 'none';
                btn.disabled = false;
            }
        }

        function clearForm(formId) {
            const form = document.getElementById(formId);
            const inputs = form.querySelectorAll('input');
            inputs.forEach(input => input.value = '');
        }

        function hideLoadingScreen() {
            const loadingScreen = document.getElementById('loadingScreen');
            loadingScreen.style.opacity = '0';
            setTimeout(() => {
                loadingScreen.style.display = 'none';
            }, 500);
        }

        function showAppContent() {
            document.getElementById('appContent').classList.add('loaded');
            hideLoadingScreen();
        }

        function hideAppContent() {
            document.getElementById('appContent').classList.remove('loaded');
        }

        // Feature Placeholder Functions (to be implemented)
        function challengeFriend(friendId) {
            showMessage('üéØ Challenge system coming soon! Stay tuned for epic battles!', 'info');
        }

        function chatWithFriend(friendId) {
            showMessage('üí¨ Real-time chat feature coming soon!', 'info');
        }

        function viewPlayerProfile(playerId) {
            showMessage('üë§ Player profiles coming soon!', 'info');
        }

        function openProfile() {
            showMessage('‚öôÔ∏è Profile editor coming soon!', 'info');
        }

        // Service Worker Registration for PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('‚úÖ Service Worker registered successfully');
                    })
                    .catch(error => {
                        console.log('‚ùå Service Worker registration failed:', error);
                    });
            });
        }

        // Initialize the app when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ JomBro app starting...');
            initApp();
        });

        // Handle online/offline status
        window.addEventListener('online', () => {
            showMessage('üåê Back online!', 'success');
        });

        window.addEventListener('offline', () => {
            showMessage('üì¥ You are offline', 'info');
        });

        // Handle app installation prompt
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            // Show install button after 10 seconds
            setTimeout(() => {
                showMessage('üì± Add JomBro to your home screen for the best experience!', 'info');
            }, 10000);
        });

        // Handle app installation
        window.addEventListener('appinstalled', () => {
            showMessage('üéâ JomBro installed successfully!', 'success');
            deferredPrompt = null;
        });
    </script>
</body>
</html>
