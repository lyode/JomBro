<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced User Profile - JomBro</title>
    <style>
        /* Enhanced User Icon Styles */
        .user-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(45deg, #9b59b6, #e91e63);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            border: 3px solid rgba(155, 89, 182, 0.5);
            box-shadow: 0 0 15px rgba(155, 89, 182, 0.4);
            animation: glow 3s ease-in-out infinite alternate;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .user-avatar:hover {
            transform: scale(1.1) rotate(5deg);
            box-shadow: 0 0 30px rgba(155, 89, 182, 0.8);
        }

        .user-avatar::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transform: rotate(45deg);
            transition: all 0.6s;
            opacity: 0;
        }

        .user-avatar:hover::before {
            animation: shine 0.6s ease;
        }

        @keyframes shine {
            0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); opacity: 0; }
            50% { opacity: 1; }
            100% { transform: translateX(100%) translateY(100%) rotate(45deg); opacity: 0; }
        }

        /* Enhanced Profile Modal */
        .profile-modal-container {
            background: #0a0a0a;
            backdrop-filter: blur(20px);
            border-radius: 24px;
            padding: 0;
            width: 100%;
            max-width: 800px;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: 
                0 20px 60px rgba(0, 0, 0, 0.8),
                0 0 0 1px rgba(255, 255, 255, 0.1),
                inset 0 0 30px rgba(155, 89, 182, 0.1);
            position: relative;
            animation: slideUp 0.6s ease-out;
        }

        /* Enhanced Profile Header */
        .profile-header {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            padding: 40px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .profile-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1200 300"><defs><linearGradient id="grad" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:rgb(155,89,182);stop-opacity:0.1" /><stop offset="100%" style="stop-color:rgb(102,126,234);stop-opacity:0.1" /></linearGradient></defs><rect width="1200" height="300" fill="url(%23grad)"/><circle cx="100" cy="100" r="50" fill="rgba(255,255,255,0.03)"/><circle cx="1100" cy="200" r="80" fill="rgba(255,255,255,0.02)"/></svg>');
            background-size: cover;
            opacity: 0.5;
        }

        .profile-avatar-large {
            width: 140px;
            height: 140px;
            border-radius: 50%;
            margin: 0 auto 20px;
            border: 5px solid transparent;
            background: linear-gradient(white, white) padding-box,
                        linear-gradient(45deg, #9b59b6, #e91e63, #667eea) border-box;
            box-shadow: 
                0 10px 40px rgba(155, 89, 182, 0.4),
                inset 0 0 20px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 4rem;
            position: relative;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 2;
        }

        .profile-avatar-large.is-own:hover {
            transform: scale(1.05) rotate(3deg);
            box-shadow: 
                0 15px 50px rgba(155, 89, 182, 0.6),
                inset 0 0 20px rgba(0, 0, 0, 0.2);
        }

        .profile-avatar-large.is-own:hover::after {
            content: '📸 Change';
            position: absolute;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            color: white;
            backdrop-filter: blur(5px);
        }

        /* Status Indicator */
        .profile-status-indicator {
            position: absolute;
            bottom: 10px;
            right: 10px;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: #4ecdc4;
            border: 4px solid #0a0a0a;
            z-index: 3;
            animation: pulse 2s infinite;
        }

        .profile-status-indicator.offline {
            background: #718096;
            animation: none;
        }

        /* Level Badge */
        .profile-level-badge {
            position: absolute;
            top: -10px;
            right: -10px;
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            color: #0a0a0a;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2rem;
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.5);
            z-index: 3;
        }

        /* Enhanced Stats */
        .profile-stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin: 30px 0;
            padding: 0 20px;
        }

        .profile-stat-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.05), rgba(255, 255, 255, 0.02));
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .profile-stat-card:hover {
            transform: translateY(-5px);
            border-color: rgba(155, 89, 182, 0.5);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .profile-stat-icon {
            font-size: 2rem;
            margin-bottom: 10px;
            filter: drop-shadow(0 0 10px currentColor);
        }

        .profile-stat-value {
            font-size: 2rem;
            font-weight: bold;
            background: linear-gradient(135deg, #9b59b6, #667eea);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 5px;
        }

        /* Activity Timeline */
        .activity-timeline {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .activity-item {
            display: flex;
            gap: 15px;
            padding: 15px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.3s ease;
        }

        .activity-item:last-child {
            border-bottom: none;
        }

        .activity-item:hover {
            background: rgba(255, 255, 255, 0.02);
            margin: 0 -10px;
            padding: 15px 10px;
            border-radius: 8px;
        }

        .activity-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            flex-shrink: 0;
        }

        .activity-icon.achievement {
            background: linear-gradient(135deg, #ffd700, #ffed4e);
        }

        .activity-icon.friend {
            background: linear-gradient(135deg, #4ecdc4, #44a08d);
        }

        .activity-icon.challenge {
            background: linear-gradient(135deg, #667eea, #764ba2);
        }

        .activity-icon.token {
            background: linear-gradient(135deg, #f093fb, #f5576c);
        }

        /* Enhanced Achievements */
        .achievements-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .achievement-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.05), rgba(255, 255, 255, 0.02));
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .achievement-card.unlocked {
            border-color: rgba(255, 215, 0, 0.5);
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.1), rgba(255, 237, 78, 0.05));
        }

        .achievement-card:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
        }

        .achievement-icon {
            font-size: 3rem;
            margin-bottom: 10px;
            filter: grayscale(1) opacity(0.3);
            transition: all 0.3s ease;
        }

        .achievement-card.unlocked .achievement-icon {
            filter: none;
            animation: bounce 0.6s ease;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        /* User Settings Section */
        .profile-settings {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .settings-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .settings-item:last-child {
            border-bottom: none;
        }

        .settings-toggle {
            position: relative;
            width: 50px;
            height: 26px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 13px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .settings-toggle.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
        }

        .settings-toggle::after {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .settings-toggle.active::after {
            transform: translateX(24px);
        }

        /* Social Links */
        .social-links {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin: 20px 0;
        }

        .social-link {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .social-link:hover {
            transform: translateY(-3px);
            background: rgba(255, 255, 255, 0.2);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .profile-stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }
            
            .achievements-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <!-- Enhanced User Icon in Header -->
    <div class="user-avatar" id="userAvatar" onclick="showOwnProfile()" title="View your profile">
        <img id="userAvatarImage" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover; display: none;">
        <span id="userAvatarEmoji">👤</span>
    </div>

    <!-- Enhanced Profile Modal Structure -->
    <div class="profile-modal" id="profileModal">
        <div class="profile-modal-container">
            <button class="profile-close-btn" onclick="closeProfileModal()">✕</button>
            
            <div class="profile-header">
                <div class="profile-avatar-section">
                    <div class="profile-avatar-large" id="profileAvatar" onclick="handleProfileAvatarClick()">
                        <img id="profileAvatarImage" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover; display: none;">
                        <span id="profileAvatarEmoji"></span>
                        <div class="profile-status-indicator" id="profileStatusIndicator"></div>
                        <div class="profile-level-badge" id="profileLevelBadge">1</div>
                    </div>
                    <h2 class="profile-name" id="profileName">Loading...</h2>
                    <p class="profile-email" id="profileEmail">Loading...</p>
                    <div class="profile-tagline" id="profileTagline">🎮 Gaming Enthusiast</div>
                </div>
            </div>
            
            <div class="profile-content">
                <!-- Enhanced Stats Grid -->
                <div class="profile-stats-grid">
                    <div class="profile-stat-card">
                        <div class="profile-stat-icon">🪙</div>
                        <div class="profile-stat-value" id="profileTokens">0</div>
                        <div class="profile-stat-label">Tokens</div>
                    </div>
                    <div class="profile-stat-card">
                        <div class="profile-stat-icon">⭐</div>
                        <div class="profile-stat-value" id="profileLevel">1</div>
                        <div class="profile-stat-label">Level</div>
                    </div>
                    <div class="profile-stat-card">
                        <div class="profile-stat-icon">👥</div>
                        <div class="profile-stat-value" id="profileFriends">0</div>
                        <div class="profile-stat-label">Friends</div>
                    </div>
                    <div class="profile-stat-card">
                        <div class="profile-stat-icon">🏆</div>
                        <div class="profile-stat-value" id="profileWins">0</div>
                        <div class="profile-stat-label">Wins</div>
                    </div>
                </div>

                <!-- Activity Timeline -->
                <div class="profile-section">
                    <h3 class="profile-section-title">
                        <span>📊</span>
                        Recent Activity
                    </h3>
                    <div class="activity-timeline" id="activityTimeline">
                        <div class="activity-item">
                            <div class="activity-icon achievement">🏆</div>
                            <div class="activity-content">
                                <div class="activity-title">Earned "Social Butterfly" badge</div>
                                <div class="activity-time">2 hours ago</div>
                            </div>
                        </div>
                        <div class="activity-item">
                            <div class="activity-icon friend">👥</div>
                            <div class="activity-content">
                                <div class="activity-title">Added 3 new friends</div>
                                <div class="activity-time">5 hours ago</div>
                            </div>
                        </div>
                        <div class="activity-item">
                            <div class="activity-icon challenge">⚡</div>
                            <div class="activity-content">
                                <div class="activity-title">Completed "Daily Steps" challenge</div>
                                <div class="activity-time">1 day ago</div>
                            </div>
                        </div>
                        <div class="activity-item">
                            <div class="activity-icon token">🪙</div>
                            <div class="activity-content">
                                <div class="activity-title">Earned 500 tokens</div>
                                <div class="activity-time">2 days ago</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Enhanced Achievements -->
                <div class="profile-section">
                    <h3 class="profile-section-title">
                        <span>🏆</span>
                        Achievements & Badges
                    </h3>
                    <div class="achievements-grid">
                        <div class="achievement-card unlocked">
                            <div class="achievement-icon">🌟</div>
                            <div class="achievement-name">Early Adopter</div>
                            <div class="achievement-desc">Joined JomBro</div>
                        </div>
                        <div class="achievement-card unlocked">
                            <div class="achievement-icon">👥</div>
                            <div class="achievement-name">Social Butterfly</div>
                            <div class="achievement-desc">10+ friends</div>
                        </div>
                        <div class="achievement-card unlocked">
                            <div class="achievement-icon">🎮</div>
                            <div class="achievement-name">Gamer</div>
                            <div class="achievement-desc">First challenge</div>
                        </div>
                        <div class="achievement-card">
                            <div class="achievement-icon">💎</div>
                            <div class="achievement-name">Rich Player</div>
                            <div class="achievement-desc">10,000 tokens</div>
                        </div>
                        <div class="achievement-card">
                            <div class="achievement-icon">🏅</div>
                            <div class="achievement-name">Champion</div>
                            <div class="achievement-desc">Win 50 challenges</div>
                        </div>
                        <div class="achievement-card">
                            <div class="achievement-icon">🌍</div>
                            <div class="achievement-name">Global Player</div>
                            <div class="achievement-desc">100+ friends</div>
                        </div>
                    </div>
                </div>

                <!-- Settings (for own profile) -->
                <div class="profile-section" id="profileSettingsSection" style="display: none;">
                    <h3 class="profile-section-title">
                        <span>⚙️</span>
                        Settings
                    </h3>
                    <div class="profile-settings">
                        <div class="settings-item">
                            <div>
                                <div class="settings-label">Online Status</div>
                                <div class="settings-desc">Show when you're online</div>
                            </div>
                            <div class="settings-toggle active" onclick="toggleSetting('onlineStatus')"></div>
                        </div>
                        <div class="settings-item">
                            <div>
                                <div class="settings-label">Challenge Notifications</div>
                                <div class="settings-desc">Get notified for new challenges</div>
                            </div>
                            <div class="settings-toggle active" onclick="toggleSetting('notifications')"></div>
                        </div>
                        <div class="settings-item">
                            <div>
                                <div class="settings-label">Public Profile</div>
                                <div class="settings-desc">Let others find you easily</div>
                            </div>
                            <div class="settings-toggle active" onclick="toggleSetting('publicProfile')"></div>
                        </div>
                        <div class="settings-item">
                            <div>
                                <div class="settings-label">Activity Timeline</div>
                                <div class="settings-desc">Show your recent activities</div>
                            </div>
                            <div class="settings-toggle active" onclick="toggleSetting('activityTimeline')"></div>
                        </div>
                    </div>
                </div>

                <!-- Social Links -->
                <div class="social-links">
                    <div class="social-link" onclick="shareProfileOn('whatsapp')" title="Share on WhatsApp">💬</div>
                    <div class="social-link" onclick="shareProfileOn('facebook')" title="Share on Facebook">📘</div>
                    <div class="social-link" onclick="shareProfileOn('instagram')" title="Share on Instagram">📸</div>
                    <div class="social-link" onclick="shareProfileOn('twitter')" title="Share on Twitter">🐦</div>
                    <div class="social-link" onclick="shareProfileOn('telegram')" title="Share on Telegram">✈️</div>
                </div>

                <!-- Profile Actions -->
                <div class="profile-actions" id="profileActions">
                    <!-- Actions populated dynamically -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // Enhanced Profile Functions
        
        // Toggle settings
        function toggleSetting(setting) {
            const toggle = event.target;
            toggle.classList.toggle('active');
            
            // Save setting to user preferences
            const isActive = toggle.classList.contains('active');
            saveUserSetting(setting, isActive);
            
            showMessage(`✅ ${setting} ${isActive ? 'enabled' : 'disabled'}`, 'success');
        }

        // Save user setting
        async function saveUserSetting(setting, value) {
            if (!currentUser) return;
            
            try {
                await db.collection('users').doc(currentUser.uid).update({
                    [`settings.${setting}`]: value,
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                });
            } catch (error) {
                console.error('Error saving setting:', error);
            }
        }

        // Share profile on social media
        function shareProfileOn(platform) {
            const profileUrl = `${window.location.origin}/profile/${currentUser.uid}`;
            const message = `Check out my JomBro profile! 🎮\n\n${appState.user.name}\n⭐ Level ${appState.user.level}\n🪙 ${appState.user.tokens} tokens\n👥 ${appState.user.friends} friends\n\nJoin me: ${profileUrl}`;
            
            switch(platform) {
                case 'whatsapp':
                    window.open(`https://wa.me/?text=${encodeURIComponent(message)}`, '_blank');
                    break;
                case 'facebook':
                    window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(profileUrl)}`, '_blank');
                    break;
                case 'instagram':
                    copyText(message);
                    showMessage('📸 Profile info copied! Share on Instagram!', 'info');
                    break;
                case 'twitter':
                    window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(message)}`, '_blank');
                    break;
                case 'telegram':
                    window.open(`https://t.me/share/url?url=${encodeURIComponent(profileUrl)}&text=${encodeURIComponent(message)}`, '_blank');
                    break;
            }
        }

        // Enhanced profile loading with activity timeline
        async function loadProfileWithActivity(userId) {
            try {
                // Load basic profile (existing code)
                await showProfileModal(userId);
                
                // Load activity timeline
                const activities = await loadUserActivity(userId);
                renderActivityTimeline(activities);
                
                // Load achievements
                const achievements = await loadUserAchievements(userId);
                renderAchievements(achievements);
                
                // Show settings only for own profile
                const isOwnProfile = userId === currentUser.uid;
                document.getElementById('profileSettingsSection').style.display = isOwnProfile ? 'block' : 'none';
                
            } catch (error) {
                console.error('Error loading enhanced profile:', error);
            }
        }

        // Load user activity
        async function loadUserActivity(userId) {
            // In a real app, this would fetch from database
            // For now, return mock data
            return [
                { type: 'achievement', title: 'Earned "Social Butterfly" badge', time: '2 hours ago', icon: '🏆' },
                { type: 'friend', title: 'Added 3 new friends', time: '5 hours ago', icon: '👥' },
                { type: 'challenge', title: 'Completed "Daily Steps" challenge', time: '1 day ago', icon: '⚡' },
                { type: 'token', title: 'Earned 500 tokens', time: '2 days ago', icon: '🪙' }
            ];
        }

        // Render activity timeline
        function renderActivityTimeline(activities) {
            const timeline = document.getElementById('activityTimeline');
            
            let html = '';
            activities.forEach(activity => {
                html += `
                    <div class="activity-item">
                        <div class="activity-icon ${activity.type}">${activity.icon}</div>
                        <div class="activity-content">
                            <div class="activity-title">${activity.title}</div>
                            <div class="activity-time">${activity.time}</div>
                        </div>
                    </div>
                `;
            });
            
            timeline.innerHTML = html;
        }

        // Load user achievements
        async function loadUserAchievements(userId) {
            // In a real app, this would fetch from database
            return {
                unlocked: ['early-adopter', 'social-butterfly', 'gamer'],
                all: [
                    { id: 'early-adopter', name: 'Early Adopter', desc: 'Joined JomBro', icon: '🌟' },
                    { id: 'social-butterfly', name: 'Social Butterfly', desc: '10+ friends', icon: '👥' },
                    { id: 'gamer', name: 'Gamer', desc: 'First challenge', icon: '🎮' },
                    { id: 'rich-player', name: 'Rich Player', desc: '10,000 tokens', icon: '💎' },
                    { id: 'champion', name: 'Champion', desc: 'Win 50 challenges', icon: '🏅' },
                    { id: 'global-player', name: 'Global Player', desc: '100+ friends', icon: '🌍' }
                ]
            };
        }

        // Render achievements
        function renderAchievements(achievementData) {
            const container = document.querySelector('.achievements-grid');
            
            let html = '';
            achievementData.all.forEach(achievement => {
                const isUnlocked = achievementData.unlocked.includes(achievement.id);
                html += `
                    <div class="achievement-card ${isUnlocked ? 'unlocked' : ''}" title="${achievement.desc}">
                        <div class="achievement-icon">${achievement.icon}</div>
                        <div class="achievement-name">${achievement.name}</div>
                        <div class="achievement-desc">${achievement.desc}</div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // Update the existing showOwnProfile to use enhanced version
        window.showOwnProfile = function() {
            loadProfileWithActivity(currentUser.uid);
        };

        // Update viewUserProfile to use enhanced version
        window.viewUserProfile = function(userId) {
            loadProfileWithActivity(userId);
        };
    </script>
</body>
</html>
