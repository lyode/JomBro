<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="JomBro">
    <title>JomBro - AI Challenge System</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
    
    <style>
        /* Basic Reset and Global Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html {
            scroll-behavior: smooth;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0a0a0a;
            color: white;
            overflow-x: hidden;
            min-height: 100vh;
            position: relative;
            padding-bottom: 100px;
            scroll-behavior: smooth;
        }
        
        .container {
            max-width: 100%;
            margin: 0 auto;
            padding: 15px;
            position: relative;
            z-index: 10;
            scroll-behavior: smooth;
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: rgba(155, 89, 182, 0.6);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(155, 89, 182, 0.8);
        }

        /* Starfield Background */
        .starfield {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        .star {
            position: absolute;
            width: 2px;
            height: 2px;
            background: white;
            border-radius: 50%;
            box-shadow: 0 0 2px rgba(255, 255, 255, 0.5);
            animation: twinkle 3s ease-in-out infinite;
        }

        @keyframes twinkle {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 1; }
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-8px); }
        }

        /* Header Styles */
        .header {
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo-section {
            flex: 1;
        }

        .logo {
            font-size: 1.8rem;
            font-weight: 300;
            color: white;
            text-shadow: 0 0 20px rgba(255, 255, 255, 0.3);
            letter-spacing: 2px;
            margin-bottom: 2px;
        }

        .slogan {
            font-size: 0.75rem;
            font-weight: 300;
            color: rgba(255, 255, 255, 0.8);
            font-style: italic;
            letter-spacing: 1px;
        }

        /* User Info */
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .user-info:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(45deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        .user-details {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }

        .user-name {
            font-size: 0.9rem;
            font-weight: 500;
        }

        .token-balance {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.8);
        }

        /* Cards */
        .card {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 20px;
        }

        .card-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Buttons */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 25px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            backdrop-filter: blur(10px);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        }

        .btn-small {
            padding: 6px 16px;
            font-size: 0.85rem;
        }

        /* Action Buttons */
        .action-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 24px;
        }

        .action-btn {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            text-decoration: none;
            color: white;
        }

        .action-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .btn-icon {
            font-size: 2rem;
            margin-bottom: 4px;
        }

        .btn-text {
            text-align: center;
        }

        .btn-title {
            font-weight: 600;
            display: block;
            margin-bottom: 2px;
        }

        .btn-subtitle {
            font-size: 0.75rem;
            opacity: 0.7;
        }

        /* Modals */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }

        .modal-content {
            background: #1a1a1a;
            border-radius: 20px;
            padding: 24px;
            width: 100%;
            max-width: 450px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from { transform: translateY(100px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 1.3rem;
            font-weight: 600;
        }

        .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 5px;
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        .close-btn:hover {
            opacity: 1;
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.9);
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            color: white;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: #667eea;
            background: rgba(255, 255, 255, 0.08);
        }

        textarea.form-input {
            resize: vertical;
            min-height: 80px;
        }

        .submit-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .submit-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }

        .submit-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Auth Modal */
        .auth-modal {
            position: fixed;
            inset: 0;
            background: #0a0a0a;
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .auth-modal.show {
            opacity: 1;
            visibility: visible;
        }

        .auth-content {
            width: 90%;
            max-width: 400px;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            padding: 30px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Friends Section */
        .friends-carousel {
            display: flex;
            gap: 12px;
            overflow-x: auto;
            padding: 10px 0;
            margin-bottom: 16px;
        }

        .friend-carousel-item {
            flex-shrink: 0;
            text-align: center;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .friend-carousel-item:hover {
            transform: scale(1.05);
        }

        .friend-carousel-avatar {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: linear-gradient(45deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            margin-bottom: 4px;
            position: relative;
        }

        .online-indicator {
            position: absolute;
            bottom: 2px;
            right: 2px;
            width: 12px;
            height: 12px;
            background: #4caf50;
            border-radius: 50%;
            border: 2px solid #0a0a0a;
        }

        .friend-name {
            font-size: 0.75rem;
            opacity: 0.8;
        }

        /* Messages */
        .message {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 24px;
            border-radius: 25px;
            font-weight: 500;
            z-index: 2000;
            animation: messageSlide 0.3s ease;
        }

        @keyframes messageSlide {
            from { transform: translate(-50%, -100%); }
            to { transform: translate(-50%, 0); }
        }

        .message.success {
            background: #4caf50;
            color: white;
        }

        .message.error {
            background: #f44336;
            color: white;
        }

        .message.info {
            background: #2196f3;
            color: white;
        }

        /* Loading */
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ===== GAME SYSTEM STYLES ===== */
        
        /* Challenge Cards */
        .challenge-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .challenge-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .challenge-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .challenge-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .challenge-badge {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .challenge-description {
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 16px;
            line-height: 1.4;
        }

        .challenge-meta {
            display: flex;
            gap: 16px;
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.6);
            margin-bottom: 16px;
        }

        .challenge-meta-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .challenge-actions {
            display: flex;
            gap: 10px;
        }

        .challenge-timer {
            position: absolute;
            top: 16px;
            right: 16px;
            background: rgba(0, 0, 0, 0.7);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            backdrop-filter: blur(10px);
        }

        .challenge-timer.urgent {
            background: rgba(255, 67, 54, 0.8);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        /* Category Selector */
        .category-selector {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .category-option {
            display: flex;
            align-items: center;
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .category-option input {
            display: none;
        }

        .category-option input:checked + span {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
        }

        /* Friend Selector */
        .friend-selector {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 8px;
        }

        .friend-select-item {
            display: flex;
            align-items: center;
            padding: 8px;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .friend-select-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .friend-select-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(45deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            font-size: 1.2rem;
        }

        /* AI Challenge Styles */
        .ai-challenge-container {
            text-align: center;
        }

        .ai-avatar {
            width: 80px;
            height: 80px;
            margin: 0 auto 16px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            animation: float 4s ease-in-out infinite;
        }

        .ai-categories {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 24px;
        }

        .ai-category-btn {
            padding: 12px 20px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            color: white;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .ai-category-btn.active {
            background: linear-gradient(45deg, #667eea, #764ba2);
            border-color: transparent;
        }

        .ai-challenge-display {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 20px;
            min-height: 150px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .ai-challenge-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 12px;
        }

        .ai-challenge-description {
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 16px;
            line-height: 1.4;
        }

        .ai-challenge-reward {
            font-size: 1.1rem;
            color: #ffd700;
        }

        /* Challenge Cost */
        .challenge-cost {
            text-align: center;
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .cost-amount {
            font-weight: 600;
            color: #ffd700;
        }

        /* Proof Upload */
        .proof-upload-area {
            margin-bottom: 20px;
        }

        .upload-placeholder {
            border: 2px dashed rgba(255, 255, 255, 0.3);
            border-radius: 16px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .upload-placeholder:hover {
            border-color: rgba(255, 255, 255, 0.5);
            background: rgba(255, 255, 255, 0.02);
        }

        .upload-icon {
            font-size: 3rem;
            display: block;
            margin-bottom: 16px;
        }

        .proof-preview {
            position: relative;
            border-radius: 16px;
            overflow: hidden;
        }

        .proof-preview img,
        .proof-preview video {
            width: 100%;
            height: auto;
            max-height: 300px;
            object-fit: contain;
            background: #000;
        }

        .remove-proof-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255, 67, 54, 0.9);
            color: white;
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2rem;
        }

        /* Game Stats Bar */
        .game-stats-bar {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            padding: 16px;
            display: flex;
            justify-content: space-around;
            margin-bottom: 24px;
        }

        .game-stat {
            text-align: center;
        }

        .game-stat-value {
            font-size: 1.5rem;
            font-weight: 600;
            color: #667eea;
        }

        .game-stat-label {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.6);
            margin-top: 4px;
        }

        /* Challenge Actions Bar */
        .challenge-actions-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 24px;
            overflow-x: auto;
            padding: 4px 0;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 40px;
            color: rgba(255, 255, 255, 0.5);
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        /* Feed Section */
        .feed-section {
            margin-bottom: 32px;
        }

        .feed-section-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Proof Container */
        .proofs-container {
            max-height: 500px;
            overflow-y: auto;
        }

        .proof-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .proof-header {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
        }

        .proof-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(45deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
        }

        .proof-user-info {
            flex: 1;
        }

        .proof-username {
            font-weight: 600;
            margin-bottom: 2px;
        }

        .proof-timestamp {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.6);
        }

        .proof-media {
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 12px;
        }

        .proof-media img,
        .proof-media video {
            width: 100%;
            height: auto;
            display: block;
        }

        .proof-caption {
            font-style: italic;
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 12px;
        }

        .proof-score {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
        }

        .ai-score {
            background: linear-gradient(45deg, #4caf50, #8bc34a);
            padding: 4px 12px;
            border-radius: 20px;
            font-weight: 600;
        }

        /* Leaderboard */
        .leaderboard-tabs {
            display: flex;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 20px;
        }

        .leaderboard-tab {
            flex: 1;
            padding: 12px;
            background: none;
            border: none;
            color: #888;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .leaderboard-tab.active {
            color: white;
            border-bottom: 2px solid #667eea;
        }

        .leaderboard-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .leaderboard-item {
            display: flex;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .leaderboard-item.current-user {
            background: rgba(102, 126, 234, 0.1);
        }

        .leaderboard-rank {
            width: 40px;
            text-align: center;
            font-weight: 600;
            font-size: 1.2rem;
        }

        .rank-1 { color: #ffd700; }
        .rank-2 { color: #c0c0c0; }
        .rank-3 { color: #cd7f32; }

        .leaderboard-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: linear-gradient(45deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 16px;
        }

        .leaderboard-info {
            flex: 1;
        }

        .leaderboard-name {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .leaderboard-stats {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.6);
        }

        .leaderboard-score {
            text-align: right;
        }

        .leaderboard-tokens {
            font-size: 1.2rem;
            font-weight: 600;
            color: #ffd700;
        }

        /* Achievement Popup */
        .achievement-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(45deg, #667eea, #764ba2);
            padding: 32px;
            border-radius: 20px;
            text-align: center;
            z-index: 10000;
            animation: achievementPop 0.5s ease;
        }

        @keyframes achievementPop {
            0% { transform: translate(-50%, -50%) scale(0); }
            50% { transform: translate(-50%, -50%) scale(1.1); }
            100% { transform: translate(-50%, -50%) scale(1); }
        }

        .achievement-icon {
            font-size: 4rem;
            margin-bottom: 16px;
        }

        .achievement-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .achievement-desc {
            font-size: 1rem;
            opacity: 0.9;
        }

        .achievement-reward {
            margin-top: 12px;
            font-size: 1.1rem;
            color: #ffd700;
        }

        /* ===== ENHANCED PROFILE STYLES ===== */
        
        /* Profile Modal */
        .profile-modal-content {
            background: #0a0a0a;
            border-radius: 20px 20px 0 0;
            padding: 0;
            width: 100%;
            max-width: 500px;
            max-height: 100vh;
            overflow-y: auto;
            animation: slideUp 0.3s ease;
        }

        /* Profile Header Section */
        .profile-header-section {
            position: relative;
            background: #1a1a1a;
        }

        .profile-cover-image {
            position: relative;
            width: 100%;
            height: 200px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            overflow: hidden;
        }

        .profile-cover-image.has-image {
            background: none;
        }

        .profile-cover-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .cover-edit-btn {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.7);
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            backdrop-filter: blur(10px);
            display: none;
        }

        .profile-cover-image:hover .cover-edit-btn {
            display: block;
        }

        .profile-header-actions {
            position: absolute;
            top: 20px;
            left: 0;
            right: 0;
            display: flex;
            justify-content: space-between;
            padding: 0 20px;
            z-index: 10;
        }

        .header-action-btn {
            width: 36px;
            height: 36px;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .header-action-btn:hover {
            background: rgba(0, 0, 0, 0.7);
            transform: scale(1.1);
        }

        /* Profile Avatar Section */
        .profile-main-info {
            padding: 0 20px 20px;
            margin-top: -40px;
            position: relative;
        }

        .profile-avatar-section {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }

        .profile-avatar-wrapper {
            position: relative;
            width: 100px;
            height: 100px;
        }

        .profile-avatar-img,
        .profile-avatar-emoji {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            border: 4px solid #0a0a0a;
            background: linear-gradient(45deg, #f093fb, #f5576c);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            box-shadow: 0 5px 20px rgba(240, 147, 251, 0.3);
        }

        .profile-avatar-img {
            display: none;
            object-fit: cover;
        }

        .avatar-edit-btn {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 32px;
            height: 32px;
            background: #e91e63;
            border: 2px solid #0a0a0a;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1rem;
            transition: transform 0.2s ease;
        }

        .avatar-edit-btn:hover {
            transform: scale(1.1);
        }

        /* Profile Info */
        .profile-info-section {
            text-align: center;
            margin-bottom: 20px;
        }

        .profile-username {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .profile-uid {
            font-size: 0.9rem;
            color: #888;
            margin-bottom: 5px;
        }

        .profile-location {
            font-size: 0.9rem;
            color: #aaa;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        /* Profile Bio */
        .profile-bio-section {
            margin-bottom: 20px;
        }

        .profile-bio {
            text-align: center;
            line-height: 1.5;
            margin-bottom: 15px;
            padding: 0 20px;
        }

        .profile-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
        }

        .profile-tag {
            background: rgba(255, 255, 255, 0.1);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        /* Profile Stats Grid */
        .profile-stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .stat-item {
            background: #0a0a0a;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .stat-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.85rem;
            color: #888;
        }

        /* Profile Action Buttons */
        .profile-action-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .profile-btn {
            flex: 1;
            padding: 12px 20px;
            border: none;
            border-radius: 25px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .primary-btn {
            background: linear-gradient(45deg, #9b59b6, #e91e63);
            color: white;
        }

        .secondary-btn {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .icon-btn {
            flex: 0 0 auto;
            width: 44px;
            padding: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.1);
            font-size: 1.2rem;
        }

        /* Content Tabs */
        .profile-content-section {
            background: #0a0a0a;
            min-height: 400px;
        }

        .profile-tabs {
            display: flex;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            position: sticky;
            top: 0;
            background: #0a0a0a;
            z-index: 10;
        }

        .profile-tab {
            flex: 1;
            padding: 15px;
            background: none;
            border: none;
            color: #888;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s ease;
            position: relative;
        }

        .profile-tab.active {
            color: white;
        }

        .profile-tab.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 20%;
            right: 20%;
            height: 2px;
            background: linear-gradient(45deg, #9b59b6, #e91e63);
        }

        .tab-icon {
            font-size: 1.1rem;
        }

        /* Content Grid */
        .profile-content-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 2px;
            padding: 2px;
        }

        .profile-grid-item {
            position: relative;
            aspect-ratio: 1;
            background: #1a1a1a;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .profile-grid-item:hover {
            transform: scale(0.98);
        }

        .profile-grid-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .grid-item-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);
            padding: 10px;
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
        }

        .grid-item-stats {
            display: flex;
            gap: 10px;
            font-size: 0.8rem;
        }

        .grid-item-stat {
            display: flex;
            align-items: center;
            gap: 3px;
        }

        .grid-item-multiple {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(0, 0, 0, 0.7);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.75rem;
        }

        /* Profile Empty State */
        .profile-empty-state {
            padding: 60px 20px;
            text-align: center;
        }

        .empty-state-btn {
            background: linear-gradient(45deg, #9b59b6, #e91e63);
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 25px;
            font-weight: 600;
            cursor: pointer;
        }

        /* Follow Lists */
        .follow-tabs {
            display: flex;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 20px;
        }

        .follow-tab {
            flex: 1;
            padding: 12px;
            background: none;
            border: none;
            color: #888;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .follow-tab.active {
            color: white;
            border-bottom: 2px solid #e91e63;
        }

        .follow-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .follow-item {
            display: flex;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .follow-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .follow-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: linear-gradient(45deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            margin-right: 12px;
        }

        .follow-info {
            flex: 1;
        }

        .follow-name {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .follow-username {
            color: #888;
            font-size: 0.9rem;
        }

        .follow-btn {
            padding: 6px 16px;
            border: 1px solid #e91e63;
            border-radius: 20px;
            background: none;
            color: #e91e63;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .follow-btn.following {
            background: #e91e63;
            color: white;
        }

        /* Menu Modal */
        .menu-modal-content {
            background: #1a1a1a;
            border-radius: 16px;
            padding: 8px;
            width: 90%;
            max-width: 300px;
        }

        .menu-options {
            display: flex;
            flex-direction: column;
        }

        .menu-option {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px;
            background: none;
            border: none;
            color: white;
            text-align: left;
            cursor: pointer;
            transition: background 0.2s ease;
            border-radius: 8px;
        }

        .menu-option:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .menu-option.danger {
            color: #ff4444;
        }

        .menu-icon {
            font-size: 1.2rem;
        }

        .menu-cancel {
            width: 100%;
            padding: 16px;
            margin-top: 8px;
            background: rgba(255, 255, 255, 0.05);
            border: none;
            color: white;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }

        /* Character Counter */
        .char-counter {
            display: block;
            text-align: right;
            color: #888;
            font-size: 0.8rem;
            margin-top: 4px;
        }

        /* Interest Tags */
        .interest-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .interest-tag {
            display: flex;
            align-items: center;
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .interest-tag input {
            display: none;
        }

        .interest-tag input:checked + span {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 4px 12px;
            border-radius: 16px;
        }

        /* Media Container */
        .media-container {
            position: relative;
            width: 100%;
            height: 100%;
            background: #1a1a1a;
            overflow: hidden;
        }

        .media-placeholder {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, #1a1a1a 0%, #2a2a2a 50%, #1a1a1a 100%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }

        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        /* Post Detail */
        .post-detail-content {
            background: #0a0a0a;
            border-radius: 16px;
            padding: 0;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .post-detail-header {
            position: sticky;
            top: 0;
            background: #0a0a0a;
            padding: 16px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 10;
            text-align: right;
        }

        /* View Proofs Modal Content */
        .view-proofs-content {
            background: #1a1a1a;
            max-width: 600px;
        }

        /* How to Play Button */
        .how-to-play-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 50px;
            padding: 12px 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4);
            transition: all 0.3s ease;
            z-index: 100;
        }

        .how-to-play-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 30px rgba(102, 126, 234, 0.6);
        }
    </style>
</head>
<body>
    <div class="starfield" id="starfield"></div>

    <!-- Auth Modal -->
    <div class="auth-modal" id="authModal">
        <div class="auth-content">
            <h1 class="logo" style="text-align: center; font-size: 3rem; margin-bottom: 10px;">JomBro</h1>
            <p style="text-align: center; opacity: 0.8; margin-bottom: 30px;">Let's Go!</p>
            
            <div id="loginForm">
                <form onsubmit="handleLogin(event)">
                    <div class="form-group">
                        <label>Phone Number</label>
                        <input type="tel" id="phoneNumber" class="form-input" placeholder="+60 12-345 6789" required>
                    </div>
                    <button type="submit" class="submit-btn">Send OTP</button>
                </form>
            </div>
            
            <div id="otpForm" style="display: none;">
                <form onsubmit="verifyOTP(event)">
                    <div class="form-group">
                        <label>Enter OTP Code</label>
                        <input type="text" id="otpCode" class="form-input" placeholder="123456" maxlength="6" required>
                    </div>
                    <button type="submit" class="submit-btn">Verify</button>
                </form>
            </div>
            
            <div id="profileForm" style="display: none;">
                <form onsubmit="createProfile(event)">
                    <div class="form-group">
                        <label>Username</label>
                        <input type="text" id="username" class="form-input" placeholder="Choose a username" required>
                    </div>
                    <div class="form-group">
                        <label>Select Avatar</label>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap; justify-content: center;">
                            <label style="cursor: pointer;">
                                <input type="radio" name="avatar" value="🎮" checked style="display: none;">
                                <span style="font-size: 2rem;">🎮</span>
                            </label>
                            <label style="cursor: pointer;">
                                <input type="radio" name="avatar" value="🎨" style="display: none;">
                                <span style="font-size: 2rem;">🎨</span>
                            </label>
                            <label style="cursor: pointer;">
                                <input type="radio" name="avatar" value="🚀" style="display: none;">
                                <span style="font-size: 2rem;">🚀</span>
                            </label>
                            <label style="cursor: pointer;">
                                <input type="radio" name="avatar" value="⭐" style="display: none;">
                                <span style="font-size: 2rem;">⭐</span>
                            </label>
                            <label style="cursor: pointer;">
                                <input type="radio" name="avatar" value="🌟" style="display: none;">
                                <span style="font-size: 2rem;">🌟</span>
                            </label>
                        </div>
                    </div>
                    <button type="submit" class="submit-btn">Start Playing!</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Main App Content -->
    <div class="app-content" id="appContent">
        <div class="container">
            <!-- Header -->
            <div class="header">
                <div class="header-top">
                    <div class="logo-section">
                        <div class="logo">JomBro</div>
                        <div class="slogan">Let's Go!</div>
                    </div>
                    <div class="user-info" onclick="showProfile()">
                        <div class="user-avatar" id="userAvatar">👤</div>
                        <div class="user-details">
                            <div class="user-name" id="userName">Guest</div>
                            <div class="token-balance">
                                <span>🪙</span>
                                <span id="tokenBalance">0</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="action-buttons">
                <button class="action-btn quick-challenge" onclick="showCreateChallenge()">
                    <div class="btn-icon">⚡</div>
                    <div class="btn-text">
                        <span class="btn-title">Quick Challenge</span>
                        <span class="btn-subtitle">Create a dare!</span>
                    </div>
                </button>
                <button class="action-btn ai-challenge" onclick="showAIChallenge()">
                    <div class="btn-icon">🤖</div>
                    <div class="btn-text">
                        <span class="btn-title">AI Challenge</span>
                        <span class="btn-subtitle">Get AI ideas</span>
                    </div>
                </button>
            </div>

            <!-- Friends Section -->
            <div class="card">
                <div class="card-title">
                    <span>👥</span>
                    <span>Friends Online</span>
                </div>
                <div class="friends-carousel" id="friendsCarousel">
                    <div class="friend-carousel-item" onclick="showAddFriend()">
                        <div class="friend-carousel-avatar">
                            <span>➕</span>
                        </div>
                        <div class="friend-name">Add Friend</div>
                    </div>
                </div>
            </div>

            <!-- Active Challenges Section -->
            <div class="card">
                <div class="card-title">
                    <span>🎯</span>
                    <span>Active Challenges</span>
                </div>
                <div class="challenges-section" id="challengesFeed">
                    <!-- Game content loads here -->
                </div>
            </div>
        </div>
    </div>

    <!-- How to Play Button -->
    <button class="how-to-play-btn" onclick="showHowToPlay()">
        <span>❓</span>
        <span>How to Play</span>
    </button>

    <!-- ===== GAME MODALS ===== -->
    
    <!-- Create Challenge Modal -->
    <div class="modal" id="createChallengeModal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Create Challenge</h3>
                <button class="close-btn" onclick="closeModal('createChallengeModal')">×</button>
            </div>
            <form onsubmit="createChallenge(event)">
                <div class="form-group">
                    <label>Challenge Title</label>
                    <input type="text" class="form-input" id="challengeTitle" maxlength="50" required placeholder="e.g., 10 Push-ups Challenge">
                </div>
                
                <div class="form-group">
                    <label>Description</label>
                    <textarea class="form-input" id="challengeDescription" rows="3" maxlength="200" required placeholder="Describe what participants need to do..."></textarea>
                </div>
                
                <div class="form-group">
                    <label>Category</label>
                    <div class="category-selector">
                        <label class="category-option">
                            <input type="radio" name="category" value="fitness" checked>
                            <span>💪 Fitness</span>
                        </label>
                        <label class="category-option">
                            <input type="radio" name="category" value="creative">
                            <span>🎨 Creative</span>
                        </label>
                        <label class="category-option">
                            <input type="radio" name="category" value="social">
                            <span>🤝 Social</span>
                        </label>
                        <label class="category-option">
                            <input type="radio" name="category" value="adventure">
                            <span>🏃 Adventure</span>
                        </label>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Difficulty</label>
                    <select class="form-input" id="challengeDifficulty">
                        <option value="easy">Easy (100 tokens)</option>
                        <option value="medium" selected>Medium (200 tokens)</option>
                        <option value="hard">Hard (500 tokens)</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Time Limit</label>
                    <select class="form-input" id="challengeTimeLimit">
                        <option value="1">1 hour</option>
                        <option value="6">6 hours</option>
                        <option value="24" selected>24 hours</option>
                        <option value="48">48 hours</option>
                        <option value="72">72 hours</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Challenge Friends</label>
                    <div id="friendSelector" class="friend-selector">
                        <!-- Friends will be loaded here -->
                    </div>
                </div>
                
                <div class="challenge-cost">
                    <span>Cost: </span>
                    <span class="cost-amount">50 tokens</span>
                </div>
                
                <button type="submit" class="submit-btn">Create Challenge 🚀</button>
            </form>
        </div>
    </div>

    <!-- AI Challenge Modal -->
    <div class="modal" id="aiChallengeModal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">AI Challenge Generator</h3>
                <button class="close-btn" onclick="closeModal('aiChallengeModal')">×</button>
            </div>
            <div class="ai-challenge-container">
                <div class="ai-avatar">🤖</div>
                <p class="ai-intro">I'll generate fun challenges for you!</p>
                
                <div class="ai-categories">
                    <button class="ai-category-btn active" onclick="generateAIChallenge('fitness')">💪 Fitness</button>
                    <button class="ai-category-btn" onclick="generateAIChallenge('creative')">🎨 Creative</button>
                    <button class="ai-category-btn" onclick="generateAIChallenge('social')">🤝 Social</button>
                    <button class="ai-category-btn" onclick="generateAIChallenge('random')">🎲 Random</button>
                </div>
                
                <div class="ai-challenge-display" id="aiChallengeDisplay">
                    <div class="loading-spinner">Generating challenge...</div>
                </div>
                
                <div class="ai-actions" id="aiActions" style="display: none;">
                    <button class="btn btn-secondary" onclick="generateAIChallenge()">🔄 New Challenge</button>
                    <button class="btn btn-primary" onclick="acceptAIChallenge()">Accept Challenge</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Submit Proof Modal -->
    <div class="modal" id="submitProofModal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Submit Challenge Proof</h3>
                <button class="close-btn" onclick="closeModal('submitProofModal')">×</button>
            </div>
            <div id="proofChallengeInfo" class="proof-challenge-info">
                <!-- Challenge info will be displayed here -->
            </div>
            
            <form onsubmit="submitProof(event)">
                <div class="proof-upload-area">
                    <input type="file" id="proofFile" accept="image/*,video/*" style="display: none;" onchange="previewProof(event)">
                    <div class="upload-placeholder" id="uploadPlaceholder" onclick="document.getElementById('proofFile').click()">
                        <span class="upload-icon">📸</span>
                        <p>Click to upload photo/video proof</p>
                        <small>Max size: 50MB</small>
                    </div>
                    <div class="proof-preview" id="proofPreview" style="display: none;">
                        <!-- Preview will be shown here -->
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Add a caption (optional)</label>
                    <input type="text" class="form-input" id="proofCaption" placeholder="Say something about your achievement...">
                </div>
                
                <button type="submit" class="submit-btn" id="submitProofBtn" disabled>Submit Proof & Claim Reward</button>
            </form>
        </div>
    </div>

    <!-- View Proofs Modal -->
    <div class="modal" id="viewProofsModal" style="display: none;">
        <div class="modal-content view-proofs-content">
            <div class="modal-header">
                <h3 class="modal-title">Challenge Submissions</h3>
                <button class="close-btn" onclick="closeModal('viewProofsModal')">×</button>
            </div>
            <div id="proofsContainer" class="proofs-container">
                <!-- Proofs will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Leaderboard Modal -->
    <div class="modal" id="leaderboardModal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">🏆 Leaderboard</h3>
                <button class="close-btn" onclick="closeModal('leaderboardModal')">×</button>
            </div>
            <div class="leaderboard-tabs">
                <button class="leaderboard-tab active" onclick="switchLeaderboard('weekly', this)">This Week</button>
                <button class="leaderboard-tab" onclick="switchLeaderboard('monthly', this)">This Month</button>
                <button class="leaderboard-tab" onclick="switchLeaderboard('alltime', this)">All Time</button>
            </div>
            <div class="leaderboard-list" id="leaderboardList">
                <!-- Leaderboard will be loaded here -->
            </div>
        </div>
    </div>

    <!-- ===== PROFILE MODALS ===== -->
    
    <!-- Enhanced Profile Modal -->
    <div class="modal" id="profileModal" style="display: none;">
        <div class="modal-content profile-modal-content">
            <!-- Profile Header -->
            <div class="profile-header-section">
                <div class="profile-cover-image" id="profileCover">
                    <input type="file" id="coverImageInput" accept="image/*" style="display: none;" onchange="uploadCoverImage(event)">
                    <div class="profile-header-actions">
                        <button class="header-action-btn" onclick="closeProfileModal()">
                            <span>←</span>
                        </button>
                        <button class="header-action-btn" onclick="showProfileMenu()">
                            <span>⋯</span>
                        </button>
                    </div>
                    <button class="cover-edit-btn" onclick="document.getElementById('coverImageInput').click()">
                        <span>📷 Edit Cover</span>
                    </button>
                </div>
                
                <div class="profile-main-info">
                    <div class="profile-avatar-section">
                        <div class="profile-avatar-wrapper">
                            <img class="profile-avatar-img" id="profileAvatarImg" src="" alt="">
                            <div class="profile-avatar-emoji" id="profileAvatarEmoji">🎮</div>
                            <input type="file" id="avatarImageInput" accept="image/*" style="display: none;" onchange="uploadAvatarImage(event)">
                            <button class="avatar-edit-btn" onclick="document.getElementById('avatarImageInput').click()">
                                <span>📷</span>
                            </button>
                        </div>
                    </div>
                    
                    <div class="profile-info-section">
                        <h2 class="profile-username" id="profileUsername">@player</h2>
                        <p class="profile-uid" id="profileUID">ID: 107096838</p>
                        <p class="profile-location" id="profileLocation">
                            <span>📍</span> <span id="userLocation">Petaling Jaya</span>
                        </p>
                    </div>
                    
                    <div class="profile-bio-section">
                        <p class="profile-bio" id="profileBio">
                            🎮 Gaming enthusiast | Challenge accepted! 
                            Let's Go! Let's Go! 🚀
                        </p>
                        <div class="profile-tags" id="profileTags">
                            <span class="profile-tag">🎯 Level <span id="userLevel">1</span></span>
                            <span class="profile-tag">🔥 Challenger</span>
                            <span class="profile-tag">🎨 Creator</span>
                        </div>
                    </div>
                    
                    <div class="profile-stats-grid">
                        <div class="stat-item" onclick="showFollowers()">
                            <div class="stat-value" id="followersCount">0</div>
                            <div class="stat-label">Followers</div>
                        </div>
                        <div class="stat-item" onclick="showFollowing()">
                            <div class="stat-value" id="followingCount">0</div>
                            <div class="stat-label">Following</div>
                        </div>
                        <div class="stat-item" onclick="showLikes()">
                            <div class="stat-value" id="likesCount">0</div>
                            <div class="stat-label">Likes & Col.</div>
                        </div>
                    </div>
                    
                    <div class="profile-action-buttons" id="profileActions">
                        <!-- Dynamic buttons based on own/other profile -->
                    </div>
                </div>
            </div>
            
            <!-- Content Tabs -->
            <div class="profile-content-section">
                <div class="profile-tabs">
                    <button class="profile-tab active" onclick="switchProfileTab('posts', this)">
                        <span class="tab-icon">📝</span>
                        <span>Posts</span>
                    </button>
                    <button class="profile-tab" onclick="switchProfileTab('collections', this)">
                        <span class="tab-icon">❤️</span>
                        <span>Collections</span>
                    </button>
                    <button class="profile-tab" onclick="switchProfileTab('liked', this)">
                        <span class="tab-icon">👍</span>
                        <span>Liked</span>
                    </button>
                </div>
                
                <div class="profile-content-grid" id="profileContentGrid">
                    <!-- Grid content will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Followers/Following Modal -->
    <div class="modal" id="followModal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="followModalTitle">Followers</h3>
                <button class="close-btn" onclick="closeModal('followModal')">×</button>
            </div>
            <div class="follow-tabs">
                <button class="follow-tab active" onclick="switchFollowTab('followers', this)">
                    Followers <span id="followersTabCount">(0)</span>
                </button>
                <button class="follow-tab" onclick="switchFollowTab('following', this)">
                    Following <span id="followingTabCount">(0)</span>
                </button>
            </div>
            <div class="follow-list" id="followList">
                <!-- User list will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Edit Profile Modal -->
    <div class="modal" id="editProfileModal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Edit Profile</h3>
                <button class="close-btn" onclick="closeModal('editProfileModal')">×</button>
            </div>
            <form onsubmit="saveProfile(event)">
                <div class="form-group">
                    <label>Username</label>
                    <input type="text" class="form-input" id="editUsername" maxlength="20" required>
                </div>
                
                <div class="form-group">
                    <label>Bio</label>
                    <textarea class="form-input" id="editBio" rows="3" maxlength="150"></textarea>
                    <small class="char-counter"><span id="bioCharCount">0</span>/150</small>
                </div>
                
                <div class="form-group">
                    <label>Location</label>
                    <input type="text" class="form-input" id="editLocation" placeholder="City, Country">
                </div>
                
                <div class="form-group">
                    <label>Interests</label>
                    <div class="interest-tags">
                        <label class="interest-tag">
                            <input type="checkbox" name="interests" value="gaming">
                            <span>🎮 Gaming</span>
                        </label>
                        <label class="interest-tag">
                            <input type="checkbox" name="interests" value="fitness">
                            <span>💪 Fitness</span>
                        </label>
                        <label class="interest-tag">
                            <input type="checkbox" name="interests" value="creative">
                            <span>🎨 Creative</span>
                        </label>
                        <label class="interest-tag">
                            <input type="checkbox" name="interests" value="social">
                            <span>🤝 Social</span>
                        </label>
                        <label class="interest-tag">
                            <input type="checkbox" name="interests" value="adventure">
                            <span>🏃 Adventure</span>
                        </label>
                    </div>
                </div>
                
                <button type="submit" class="submit-btn">Save Changes</button>
            </form>
        </div>
    </div>

    <!-- Profile Menu Modal -->
    <div class="modal" id="profileMenuModal" style="display: none;">
        <div class="modal-content menu-modal-content">
            <div class="menu-options">
                <button class="menu-option" onclick="shareProfile()">
                    <span class="menu-icon">🔗</span>
                    <span>Share Profile</span>
                </button>
                <button class="menu-option" onclick="copyProfileLink()">
                    <span class="menu-icon">📋</span>
                    <span>Copy Profile Link</span>
                </button>
                <button class="menu-option" onclick="showQRCode()">
                    <span class="menu-icon">📱</span>
                    <span>QR Code</span>
                </button>
                <button class="menu-option" onclick="showSettings()">
                    <span class="menu-icon">⚙️</span>
                    <span>Settings</span>
                </button>
                <button class="menu-option" onclick="showPrivacy()">
                    <span class="menu-icon">🔒</span>
                    <span>Privacy</span>
                </button>
                <button class="menu-option danger" onclick="blockUser()" id="blockUserBtn" style="display: none;">
                    <span class="menu-icon">🚫</span>
                    <span>Block User</span>
                </button>
            </div>
            <button class="menu-cancel" onclick="closeModal('profileMenuModal')">Cancel</button>
        </div>
    </div>

    <!-- How to Play Modal -->
    <div class="modal" id="howToPlayModal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">How to Play JomBro</h3>
                <button class="close-btn" onclick="closeModal('howToPlayModal')">×</button>
            </div>
            <div style="padding: 20px;">
                <div style="margin-bottom: 20px;">
                    <h4 style="margin-bottom: 10px;">1. Create Challenges</h4>
                    <p style="opacity: 0.8;">Create fun dares for your friends or accept AI-generated challenges!</p>
                </div>
                <div style="margin-bottom: 20px;">
                    <h4 style="margin-bottom: 10px;">2. Complete & Prove</h4>
                    <p style="opacity: 0.8;">Do the challenge and upload photo/video proof before time runs out.</p>
                </div>
                <div style="margin-bottom: 20px;">
                    <h4 style="margin-bottom: 10px;">3. Earn Rewards</h4>
                    <p style="opacity: 0.8;">Get tokens for completing challenges and level up!</p>
                </div>
                <div style="margin-bottom: 20px;">
                    <h4 style="margin-bottom: 10px;">4. Compete</h4>
                    <p style="opacity: 0.8;">Climb the leaderboard and unlock achievements!</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Friend Modal -->
    <div class="modal" id="addFriendModal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add Friend</h3>
                <button class="close-btn" onclick="closeModal('addFriendModal')">×</button>
            </div>
            <form onsubmit="addFriend(event)">
                <div class="form-group">
                    <label>Friend's Username</label>
                    <input type="text" class="form-input" id="friendUsername" placeholder="Enter username" required>
                </div>
                <button type="submit" class="submit-btn">Send Friend Request</button>
            </form>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyC_orriRUuf1ynDiFaJAPrO6-Gu3GeURxQ",
            authDomain: "jombro-9d129.firebaseapp.com",
            projectId: "jombro-9d129",
            storageBucket: "jombro-9d129.appspot.com",
            messagingSenderId: "107096838958",
            appId: "1:107096838958:web:6b8b5c6c8f8b5c6c8f8b5c"
        };

        // Global Variables
        let app, db, storage;
        let currentUser = null;
        let userData = {
            name: 'Guest',
            avatar: '👤',
            tokens: 0,
            level: 1,
            completedChallenges: 0,
            friendsCount: 0,
            followers: 0,
            following: 0,
            totalLikes: 0,
            bio: '',
            location: 'Petaling Jaya',
            achievements: [],
            streak: 0
        };

        // ===== CORE APP FUNCTIONS =====

        // Initialize App
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // Initialize Firebase
                app = firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                storage = firebase.storage();
                
                // Enable offline persistence
                await db.enablePersistence().catch(err => {
                    console.log('Persistence failed:', err.code);
                });
                
                // Setup auth
                firebase.auth().onAuthStateChanged(user => {
                    currentUser = user;
                    if (user) {
                        loadUserData();
                        document.getElementById('authModal').classList.remove('show');
                        document.getElementById('appContent').style.display = 'block';
                        initializeGameSystem();
                        initializeProfileSystem();
                    } else {
                        document.getElementById('authModal').classList.add('show');
                        document.getElementById('appContent').style.display = 'none';
                    }
                });
                
                // Create starfield
                createStarfield();
                
            } catch (error) {
                console.error('Initialization error:', error);
                showMessage('Failed to initialize app', 'error');
            }
        });

        // Create Starfield Background
        function createStarfield() {
            const starfield = document.getElementById('starfield');
            const starCount = 100;
            
            for (let i = 0; i < starCount; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                star.style.left = `${Math.random() * 100}%`;
                star.style.top = `${Math.random() * 100}%`;
                star.style.animationDelay = `${Math.random() * 3}s`;
                star.style.animationDuration = `${3 + Math.random() * 2}s`;
                starfield.appendChild(star);
            }
        }

        // Auth Functions
        async function handleLogin(event) {
            event.preventDefault();
            const phoneNumber = document.getElementById('phoneNumber').value;
            
            try {
                // For demo, skip actual phone auth
                document.getElementById('loginForm').style.display = 'none';
                document.getElementById('otpForm').style.display = 'block';
                showMessage('OTP sent! Use 123456', 'info');
            } catch (error) {
                showMessage('Login failed', 'error');
            }
        }

        async function verifyOTP(event) {
            event.preventDefault();
            const otp = document.getElementById('otpCode').value;
            
            if (otp === '123456') {
                // For demo, create a fake user
                const fakeUser = {
                    uid: 'demo_' + Date.now(),
                    phoneNumber: document.getElementById('phoneNumber').value
                };
                
                // Check if user exists
                const userDoc = await db.collection('users').doc(fakeUser.uid).get();
                
                if (!userDoc.exists) {
                    currentUser = fakeUser;
                    document.getElementById('otpForm').style.display = 'none';
                    document.getElementById('profileForm').style.display = 'block';
                } else {
                    currentUser = fakeUser;
                    await loadUserData();
                    document.getElementById('authModal').classList.remove('show');
                    document.getElementById('appContent').style.display = 'block';
                }
            } else {
                showMessage('Invalid OTP', 'error');
            }
        }

        async function createProfile(event) {
            event.preventDefault();
            
            const username = document.getElementById('username').value;
            const avatar = document.querySelector('input[name="avatar"]:checked').value;
            
            try {
                await db.collection('users').doc(currentUser.uid).set({
                    name: username,
                    avatar: avatar,
                    phoneNumber: currentUser.phoneNumber,
                    tokens: 1000,
                    level: 1,
                    completedChallenges: 0,
                    friendsCount: 0,
                    followers: 0,
                    following: 0,
                    totalLikes: 0,
                    bio: '🎮 New player ready for challenges!',
                    location: 'Petaling Jaya',
                    achievements: [],
                    streak: 0,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                showMessage('Welcome to JomBro! You got 1000 starter tokens!', 'success');
                await loadUserData();
                document.getElementById('authModal').classList.remove('show');
                document.getElementById('appContent').style.display = 'block';
                initializeGameSystem();
                initializeProfileSystem();
                
            } catch (error) {
                console.error('Profile creation error:', error);
                showMessage('Failed to create profile', 'error');
            }
        }

        // Load User Data
        async function loadUserData() {
            if (!currentUser) return;
            
            try {
                const userDoc = await db.collection('users').doc(currentUser.uid).get();
                if (userDoc.exists) {
                    userData = { ...userData, ...userDoc.data(), uid: currentUser.uid };
                    updateUI();
                }
            } catch (error) {
                console.error('Error loading user data:', error);
            }
        }

        // Update UI
        function updateUI() {
            document.getElementById('userAvatar').textContent = userData.avatar;
            document.getElementById('userName').textContent = userData.name;
            document.getElementById('tokenBalance').textContent = userData.tokens;
        }

        // Show Message
        function showMessage(text, type = 'info') {
            const existingMessages = document.querySelectorAll('.message');
            existingMessages.forEach(msg => msg.remove());
            
            const message = document.createElement('div');
            message.className = `message ${type}`;
            message.textContent = text;
            document.body.appendChild(message);
            
            setTimeout(() => {
                message.style.opacity = '0';
                setTimeout(() => message.remove(), 300);
            }, 3000);
        }

        // Close Modal
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // Show Add Friend
        function showAddFriend() {
            document.getElementById('addFriendModal').style.display = 'flex';
        }

        // Add Friend
        async function addFriend(event) {
            event.preventDefault();
            const username = document.getElementById('friendUsername').value;
            
            try {
                // Find user by username
                const usersQuery = await db.collection('users')
                    .where('name', '==', username)
                    .limit(1)
                    .get();
                
                if (usersQuery.empty) {
                    showMessage('User not found', 'error');
                    return;
                }
                
                const friendDoc = usersQuery.docs[0];
                const friendId = friendDoc.id;
                
                if (friendId === currentUser.uid) {
                    showMessage('You cannot add yourself', 'error');
                    return;
                }
                
                // Create friendship
                await db.collection('friendships').add({
                    users: [currentUser.uid, friendId],
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Update friend counts
                await db.collection('users').doc(currentUser.uid).update({
                    friendsCount: firebase.firestore.FieldValue.increment(1)
                });
                
                await db.collection('users').doc(friendId).update({
                    friendsCount: firebase.firestore.FieldValue.increment(1)
                });
                
                showMessage('Friend added successfully!', 'success');
                closeModal('addFriendModal');
                loadFriends();
                
            } catch (error) {
                console.error('Error adding friend:', error);
                showMessage('Failed to add friend', 'error');
            }
        }

        // Load Friends
        async function loadFriends() {
            try {
                const friendships = await db.collection('friendships')
                    .where('users', 'array-contains', currentUser.uid)
                    .get();
                
                const friendIds = [];
                friendships.forEach(doc => {
                    const users = doc.data().users;
                    const friendId = users.find(id => id !== currentUser.uid);
                    if (friendId) friendIds.push(friendId);
                });
                
                if (friendIds.length > 0) {
                    const friendDocs = await Promise.all(
                        friendIds.map(id => db.collection('users').doc(id).get())
                    );
                    
                    const carousel = document.getElementById('friendsCarousel');
                    carousel.innerHTML = `
                        <div class="friend-carousel-item" onclick="showAddFriend()">
                            <div class="friend-carousel-avatar">
                                <span>➕</span>
                            </div>
                            <div class="friend-name">Add Friend</div>
                        </div>
                    `;
                    
                    friendDocs.forEach((doc, index) => {
                        if (doc.exists) {
                            const friend = doc.data();
                            carousel.innerHTML += `
                                <div class="friend-carousel-item" onclick="showProfile('${friendIds[index]}')">
                                    <div class="friend-carousel-avatar">
                                        ${friend.avatar}
                                        <div class="online-indicator"></div>
                                    </div>
                                    <div class="friend-name">${friend.name}</div>
                                </div>
                            `;
                        }
                    });
                }
            } catch (error) {
                console.error('Error loading friends:', error);
            }
        }

        // Show How to Play
        function showHowToPlay() {
            document.getElementById('howToPlayModal').style.display = 'flex';
        }

        // ===== GAME SYSTEM IMPLEMENTATION =====
        
        // Game State
        const gameState = {
            activeChallenges: [],
            completedChallenges: [],
            myScore: 0,
            currentChallenge: null,
            currentAIChallenge: null,
            selectedFriends: [],
            aiChallenges: {
                fitness: [
                    { title: "Plank Master", description: "Hold a plank position for 60 seconds without dropping!", reward: 150 },
                    { title: "Jump Rope Champion", description: "Do 100 jump rope skips without stopping", reward: 200 },
                    { title: "Push-up Power", description: "Complete 20 perfect push-ups in a row", reward: 150 },
                    { title: "Squat Challenge", description: "Do 50 squats with proper form", reward: 200 },
                    { title: "Wall Sit Warrior", description: "Hold a wall sit for 90 seconds", reward: 250 }
                ],
                creative: [
                    { title: "Doodle Master", description: "Draw a self-portrait using only your non-dominant hand", reward: 100 },
                    { title: "Origami Artist", description: "Create an origami animal and make it dance", reward: 150 },
                    { title: "Song Writer", description: "Write and perform a 30-second song about your day", reward: 200 },
                    { title: "Dance Creator", description: "Create a 15-second dance routine and perform it", reward: 150 },
                    { title: "Story Teller", description: "Tell a 1-minute story using only emojis as prompts", reward: 100 }
                ],
                social: [
                    { title: "Compliment Spreader", description: "Give genuine compliments to 5 different people", reward: 150 },
                    { title: "Random Acts", description: "Do a random act of kindness and document it", reward: 200 },
                    { title: "Conversation Starter", description: "Start a conversation with someone new", reward: 100 },
                    { title: "Group Selfie", description: "Take a creative group selfie with at least 3 people", reward: 150 },
                    { title: "Teach Something", description: "Teach someone a new skill in under 5 minutes", reward: 200 }
                ]
            }
        };

        // Initialize Game System
        function initializeGameSystem() {
            if (currentUser) {
                loadActiveChallenges();
                loadGameStats();
                setupChallengeListeners();
                checkAchievements();
                loadFriends();
            }
        }

        // Show Create Challenge Modal
        function showCreateChallenge() {
            if (userData.tokens < 50) {
                showMessage('Not enough tokens! You need 50 tokens to create a challenge.', 'error');
                return;
            }
            
            loadFriendsForChallenge();
            document.getElementById('createChallengeModal').style.display = 'flex';
        }

        // Load Friends for Challenge
        async function loadFriendsForChallenge() {
            const friendSelector = document.getElementById('friendSelector');
            friendSelector.innerHTML = '<div style="text-align: center;">Loading friends...</div>';
            
            try {
                const friendships = await db.collection('friendships')
                    .where('users', 'array-contains', currentUser.uid)
                    .get();
                
                const friendIds = [];
                friendships.forEach(doc => {
                    const users = doc.data().users;
                    const friendId = users.find(id => id !== currentUser.uid);
                    if (friendId) friendIds.push(friendId);
                });
                
                if (friendIds.length === 0) {
                    friendSelector.innerHTML = '<div style="text-align: center; color: #888;">No friends yet. Add friends to challenge them!</div>';
                    return;
                }
                
                const friendDocs = await Promise.all(
                    friendIds.map(id => db.collection('users').doc(id).get())
                );
                
                const friends = friendDocs.map((doc, index) => ({
                    id: friendIds[index],
                    ...doc.data()
                })).filter(f => f.name);
                
                friendSelector.innerHTML = friends.map(friend => `
                    <label class="friend-select-item">
                        <input type="checkbox" value="${friend.id}" onchange="toggleFriendSelection('${friend.id}')">
                        <div class="friend-select-avatar">
                            ${friend.avatar || '👤'}
                        </div>
                        <span>${friend.name}</span>
                    </label>
                `).join('');
                
            } catch (error) {
                console.error('Error loading friends:', error);
                friendSelector.innerHTML = '<div style="text-align: center; color: #f44;">Failed to load friends</div>';
            }
        }

        // Toggle Friend Selection
        function toggleFriendSelection(friendId) {
            const index = gameState.selectedFriends.indexOf(friendId);
            if (index > -1) {
                gameState.selectedFriends.splice(index, 1);
            } else {
                gameState.selectedFriends.push(friendId);
            }
            updateChallengeCost();
        }

        // Update Challenge Cost
        function updateChallengeCost() {
            const baseCost = 50;
            const friendCost = gameState.selectedFriends.length * 10;
            const totalCost = baseCost + friendCost;
            document.querySelector('.cost-amount').textContent = `${totalCost} tokens`;
        }

        // Create Challenge
        async function createChallenge(event) {
            event.preventDefault();
            
            const title = document.getElementById('challengeTitle').value.trim();
            const description = document.getElementById('challengeDescription').value.trim();
            const category = document.querySelector('input[name="category"]:checked').value;
            const difficulty = document.getElementById('challengeDifficulty').value;
            const timeLimit = parseInt(document.getElementById('challengeTimeLimit').value);
            
            const rewards = { easy: 100, medium: 200, hard: 500 };
            const reward = rewards[difficulty];
            
            const totalCost = 50 + (gameState.selectedFriends.length * 10);
            
            if (userData.tokens < totalCost) {
                showMessage('Not enough tokens!', 'error');
                return;
            }
            
            try {
                const challengeData = {
                    title,
                    description,
                    category,
                    difficulty,
                    reward,
                    timeLimit,
                    creatorId: currentUser.uid,
                    creatorName: userData.name,
                    creatorAvatar: userData.avatar,
                    participants: [currentUser.uid, ...gameState.selectedFriends],
                    responses: {},
                    status: 'active',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    expiresAt: new Date(Date.now() + timeLimit * 60 * 60 * 1000)
                };
                
                const challengeRef = await db.collection('challenges').add(challengeData);
                
                await db.collection('users').doc(currentUser.uid).update({
                    tokens: firebase.firestore.FieldValue.increment(-totalCost)
                });
                
                for (const friendId of gameState.selectedFriends) {
                    await db.collection('notifications').add({
                        to: friendId,
                        type: 'challenge',
                        data: {
                            challengeId: challengeRef.id,
                            challengeTitle: title,
                            fromUser: currentUser.uid,
                            fromName: userData.name,
                            fromAvatar: userData.avatar
                        },
                        read: false,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }
                
                userData.tokens -= totalCost;
                updateGameStats();
                
                showMessage('Challenge created successfully! 🎯', 'success');
                closeModal('createChallengeModal');
                gameState.selectedFriends = [];
                loadActiveChallenges();
                
            } catch (error) {
                console.error('Error creating challenge:', error);
                showMessage('Failed to create challenge', 'error');
            }
        }

        // Show AI Challenge Modal
        function showAIChallenge() {
            document.getElementById('aiChallengeModal').style.display = 'flex';
            generateAIChallenge('fitness');
        }

        // Generate AI Challenge
        function generateAIChallenge(category = null) {
            const display = document.getElementById('aiChallengeDisplay');
            const actions = document.getElementById('aiActions');
            
            if (category) {
                document.querySelectorAll('.ai-category-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                event.target.classList.add('active');
            } else {
                category = document.querySelector('.ai-category-btn.active').textContent.toLowerCase();
                category = category.includes('fitness') ? 'fitness' : 
                           category.includes('creative') ? 'creative' : 
                           category.includes('social') ? 'social' : 'fitness';
            }
            
            display.innerHTML = '<div class="loading-spinner">Generating challenge...</div>';
            actions.style.display = 'none';
            
            setTimeout(() => {
                const challenges = category === 'random' ? 
                    [...gameState.aiChallenges.fitness, ...gameState.aiChallenges.creative, ...gameState.aiChallenges.social] :
                    gameState.aiChallenges[category];
                
                const challenge = challenges[Math.floor(Math.random() * challenges.length)];
                
                gameState.currentAIChallenge = {
                    ...challenge,
                    category: category === 'random' ? ['fitness', 'creative', 'social'][Math.floor(Math.random() * 3)] : category,
                    difficulty: challenge.reward <= 150 ? 'easy' : challenge.reward <= 250 ? 'medium' : 'hard',
                    timeLimit: 24
                };
                
                display.innerHTML = `
                    <div class="ai-challenge-title">${challenge.title}</div>
                    <div class="ai-challenge-description">${challenge.description}</div>
                    <div class="ai-challenge-reward">
                        <span>Reward: </span>
                        <span class="reward-amount">${challenge.reward} tokens</span>
                    </div>
                `;
                
                actions.style.display = 'flex';
            }, 1500);
        }

        // Accept AI Challenge
        async function acceptAIChallenge() {
            if (!gameState.currentAIChallenge) return;
            
            try {
                const challenge = gameState.currentAIChallenge;
                
                const challengeData = {
                    ...challenge,
                    creatorId: 'ai_bot',
                    creatorName: 'AI Bot',
                    creatorAvatar: '🤖',
                    participants: [currentUser.uid],
                    responses: {},
                    status: 'active',
                    isAI: true,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    expiresAt: new Date(Date.now() + challenge.timeLimit * 60 * 60 * 1000)
                };
                
                await db.collection('challenges').add(challengeData);
                
                showMessage('AI Challenge accepted! Complete it within 24 hours 🚀', 'success');
                closeModal('aiChallengeModal');
                loadActiveChallenges();
                
            } catch (error) {
                console.error('Error accepting AI challenge:', error);
                showMessage('Failed to accept challenge', 'error');
            }
        }

        // Load Active Challenges
        async function loadActiveChallenges() {
            try {
                const challengesSnap = await db.collection('challenges')
                    .where('participants', 'array-contains', currentUser.uid)
                    .where('status', '==', 'active')
                    .orderBy('createdAt', 'desc')
                    .limit(20)
                    .get();
                
                gameState.activeChallenges = challengesSnap.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                renderChallengeFeed();
                
            } catch (error) {
                console.error('Error loading challenges:', error);
                // Try without orderBy
                try {
                    const challengesSnap = await db.collection('challenges')
                        .where('participants', 'array-contains', currentUser.uid)
                        .where('status', '==', 'active')
                        .limit(20)
                        .get();
                    
                    gameState.activeChallenges = challengesSnap.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    
                    renderChallengeFeed();
                } catch (e) {
                    console.error('Error loading challenges without orderBy:', e);
                }
            }
        }

        // Render Challenge Feed
        function renderChallengeFeed() {
            const container = document.getElementById('challengesFeed');
            if (!container) return;
            
            const myChallenges = gameState.activeChallenges.filter(c => 
                !c.responses[currentUser.uid] || c.responses[currentUser.uid].status === 'pending'
            );
            
            const inProgress = gameState.activeChallenges.filter(c => 
                c.responses[currentUser.uid] && c.responses[currentUser.uid].status === 'accepted' && !c.responses[currentUser.uid].proofUrl
            );
            
            container.innerHTML = `
                <div class="game-stats-bar">
                    <div class="game-stat">
                        <div class="game-stat-value">${userData.tokens || 0}</div>
                        <div class="game-stat-label">Tokens</div>
                    </div>
                    <div class="game-stat">
                        <div class="game-stat-value">${userData.level || 1}</div>
                        <div class="game-stat-label">Level</div>
                    </div>
                    <div class="game-stat">
                        <div class="game-stat-value">${userData.completedChallenges || 0}</div>
                        <div class="game-stat-label">Completed</div>
                    </div>
                    <div class="game-stat">
                        <div class="game-stat-value">${userData.streak || 0}</div>
                        <div class="game-stat-label">Streak</div>
                    </div>
                </div>
                
                <div class="challenge-actions-bar">
                    <button class="btn btn-primary" onclick="showCreateChallenge()">
                        <span>➕</span> Create Challenge
                    </button>
                    <button class="btn btn-secondary" onclick="showAIChallenge()">
                        <span>🤖</span> AI Challenge
                    </button>
                    <button class="btn btn-secondary" onclick="showLeaderboard()">
                        <span>🏆</span> Leaderboard
                    </button>
                </div>
                
                ${myChallenges.length > 0 ? `
                    <div class="feed-section">
                        <h3 class="feed-section-title">
                            <span>🎯</span> New Challenges
                        </h3>
                        ${myChallenges.map(challenge => renderChallengeCard(challenge)).join('')}
                    </div>
                ` : ''}
                
                ${inProgress.length > 0 ? `
                    <div class="feed-section">
                        <h3 class="feed-section-title">
                            <span>⏳</span> In Progress
                        </h3>
                        ${inProgress.map(challenge => renderChallengeCard(challenge)).join('')}
                    </div>
                ` : ''}
                
                ${myChallenges.length === 0 && inProgress.length === 0 ? `
                    <div class="empty-state">
                        <div class="empty-state-icon">🎮</div>
                        <p>No active challenges</p>
                        <button class="btn btn-primary" onclick="showAIChallenge()">
                            Get AI Challenge
                        </button>
                    </div>
                ` : ''}
            `;
        }

        // Render Challenge Card
        function renderChallengeCard(challenge) {
            const userResponse = challenge.responses[currentUser.uid];
            const timeLeft = getTimeLeft(challenge.expiresAt);
            const isUrgent = timeLeft.hours < 6;
            
            let actions = '';
            
            if (!userResponse || userResponse.status === 'pending') {
                actions = `
                    <button class="btn btn-primary btn-small" onclick="respondToChallenge('${challenge.id}', 'accepted')">
                        Accept
                    </button>
                    <button class="btn btn-secondary btn-small" onclick="respondToChallenge('${challenge.id}', 'declined')">
                        Decline
                    </button>
                `;
            } else if (userResponse.status === 'accepted' && !userResponse.proofUrl) {
                actions = `
                    <button class="btn btn-primary btn-small" onclick="showSubmitProof('${challenge.id}')">
                        📸 Submit Proof
                    </button>
                `;
            }
            
            return `
                <div class="challenge-card">
                    <div class="challenge-timer ${isUrgent ? 'urgent' : ''}">
                        ⏱ ${timeLeft.display}
                    </div>
                    <div class="challenge-header">
                        <h3 class="challenge-title">
                            ${getCategoryIcon(challenge.category)} ${challenge.title}
                        </h3>
                        <div class="challenge-badge">${challenge.reward} tokens</div>
                    </div>
                    <p class="challenge-description">${challenge.description}</p>
                    <div class="challenge-meta">
                        <div class="challenge-meta-item">
                            <span>👤</span>
                            <span>${challenge.isAI ? 'AI Bot' : challenge.creatorName}</span>
                        </div>
                        <div class="challenge-meta-item">
                            <span>🎯</span>
                            <span>${challenge.difficulty}</span>
                        </div>
                        <div class="challenge-meta-item">
                            <span>👥</span>
                            <span>${challenge.participants.length} players</span>
                        </div>
                    </div>
                    <div class="challenge-actions">
                        ${actions}
                        ${hasProofsToView(challenge) ? `
                            <button class="btn btn-secondary btn-small" onclick="viewProofs('${challenge.id}')">
                                👁️ View Proofs
                            </button>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        // Respond to Challenge
        async function respondToChallenge(challengeId, response) {
            try {
                await db.collection('challenges').doc(challengeId).update({
                    [`responses.${currentUser.uid}`]: {
                        status: response,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    }
                });
                
                if (response === 'accepted') {
                    showMessage('Challenge accepted! Complete it before time runs out 🎯', 'success');
                } else {
                    showMessage('Challenge declined', 'info');
                }
                
                loadActiveChallenges();
                
            } catch (error) {
                console.error('Error responding to challenge:', error);
                showMessage('Failed to respond to challenge', 'error');
            }
        }

        // Show Submit Proof Modal
        function showSubmitProof(challengeId) {
            const challenge = gameState.activeChallenges.find(c => c.id === challengeId);
            if (!challenge) return;
            
            gameState.currentChallenge = challenge;
            
            const infoDiv = document.getElementById('proofChallengeInfo');
            infoDiv.innerHTML = `
                <h4>${challenge.title}</h4>
                <p>${challenge.description}</p>
                <div class="challenge-meta" style="margin-top: 12px;">
                    <span>🏆 Reward: ${challenge.reward} tokens</span>
                </div>
            `;
            
            document.getElementById('submitProofModal').style.display = 'flex';
        }

        // Preview Proof
        function previewProof(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const preview = document.getElementById('proofPreview');
            const placeholder = document.getElementById('uploadPlaceholder');
            const submitBtn = document.getElementById('submitProofBtn');
            
            if (file.size > 50 * 1024 * 1024) {
                showMessage('File must be less than 50MB', 'error');
                event.target.value = '';
                return;
            }
            
            const reader = new FileReader();
            reader.onload = (e) => {
                const isVideo = file.type.startsWith('video/');
                
                preview.innerHTML = `
                    ${isVideo ? 
                        `<video src="${e.target.result}" controls style="width: 100%; max-height: 300px;"></video>` :
                        `<img src="${e.target.result}" alt="Proof">`
                    }
                    <button class="remove-proof-btn" onclick="removeProof()">×</button>
                `;
                
                preview.style.display = 'block';
                placeholder.style.display = 'none';
                submitBtn.disabled = false;
            };
            
            reader.readAsDataURL(file);
        }

        // Remove Proof
        function removeProof() {
            document.getElementById('proofFile').value = '';
            document.getElementById('proofPreview').style.display = 'none';
            document.getElementById('uploadPlaceholder').style.display = 'block';
            document.getElementById('submitProofBtn').disabled = true;
        }

        // Submit Proof
        async function submitProof(event) {
            event.preventDefault();
            
            const file = document.getElementById('proofFile').files[0];
            const caption = document.getElementById('proofCaption').value.trim();
            
            if (!file || !gameState.currentChallenge) return;
            
            const submitBtn = document.getElementById('submitProofBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Uploading...';
            
            try {
                const timestamp = Date.now();
                const filename = `proofs/${currentUser.uid}/${gameState.currentChallenge.id}_${timestamp}`;
                const storageRef = storage.ref(filename);
                
                const snapshot = await storageRef.put(file);
                const proofUrl = await snapshot.ref.getDownloadURL();
                
                const aiScore = Math.floor(Math.random() * 30) + 70; // 70-100
                
                await db.collection('challenges').doc(gameState.currentChallenge.id).update({
                    [`responses.${currentUser.uid}`]: {
                        status: 'completed',
                        proofUrl: proofUrl,
                        proofType: file.type.startsWith('video/') ? 'video' : 'image',
                        caption: caption,
                        aiScore: aiScore,
                        submittedAt: firebase.firestore.FieldValue.serverTimestamp()
                    }
                });
                
                const reward = gameState.currentChallenge.reward;
                await db.collection('users').doc(currentUser.uid).update({
                    tokens: firebase.firestore.FieldValue.increment(reward),
                    completedChallenges: firebase.firestore.FieldValue.increment(1),
                    totalScore: firebase.firestore.FieldValue.increment(aiScore)
                });
                
                userData.tokens += reward;
                userData.completedChallenges = (userData.completedChallenges || 0) + 1;
                updateGameStats();
                
                checkAchievements();
                
                showMessage(`Challenge completed! You earned ${reward} tokens! 🎉`, 'success');
                closeModal('submitProofModal');
                loadActiveChallenges();
                
                removeProof();
                document.getElementById('proofCaption').value = '';
                
            } catch (error) {
                console.error('Error submitting proof:', error);
                showMessage('Failed to submit proof', 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Submit Proof & Claim Reward';
            }
        }

        // View Proofs
        async function viewProofs(challengeId) {
            const challenge = gameState.activeChallenges.find(c => c.id === challengeId);
            if (!challenge) return;
            
            const container = document.getElementById('proofsContainer');
            container.innerHTML = '<div style="text-align: center;">Loading proofs...</div>';
            
            document.getElementById('viewProofsModal').style.display = 'flex';
            
            try {
                const proofEntries = Object.entries(challenge.responses)
                    .filter(([userId, response]) => response.proofUrl);
                
                if (proofEntries.length === 0) {
                    container.innerHTML = '<div style="text-align: center; padding: 40px;">No proofs submitted yet</div>';
                    return;
                }
                
                const userDocs = await Promise.all(
                    proofEntries.map(([userId]) => db.collection('users').doc(userId).get())
                );
                
                const proofs = proofEntries.map(([userId, response], index) => ({
                    userId,
                    ...response,
                    userData: userDocs[index].data()
                }));
                
                container.innerHTML = proofs.map(proof => renderProofItem(proof)).join('');
                
            } catch (error) {
                console.error('Error loading proofs:', error);
                container.innerHTML = '<div style="text-align: center; color: #f44;">Failed to load proofs</div>';
            }
        }

        // Render Proof Item
        function renderProofItem(proof) {
            const isVideo = proof.proofType === 'video';
            const timeAgo = getTimeAgo(proof.submittedAt);
            
            return `
                <div class="proof-item">
                    <div class="proof-header">
                        <div class="proof-avatar">
                            ${proof.userData.avatar || '👤'}
                        </div>
                        <div class="proof-user-info">
                            <div class="proof-username">${proof.userData.name}</div>
                            <div class="proof-timestamp">${timeAgo}</div>
                        </div>
                        <div class="proof-score">
                            <span>AI Score:</span>
                            <span class="ai-score">${proof.aiScore}%</span>
                        </div>
                    </div>
                    <div class="proof-media">
                        ${isVideo ? 
                            `<video src="${proof.proofUrl}" controls></video>` :
                            `<img src="${proof.proofUrl}" alt="Proof">`
                        }
                    </div>
                    ${proof.caption ? `<p class="proof-caption">"${proof.caption}"</p>` : ''}
                </div>
            `;
        }

        // Show Leaderboard
        async function showLeaderboard() {
            document.getElementById('leaderboardModal').style.display = 'flex';
            loadLeaderboard('weekly');
        }

        // Switch Leaderboard
        function switchLeaderboard(period, element) {
            document.querySelectorAll('.leaderboard-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            element.classList.add('active');
            loadLeaderboard(period);
        }

        // Load Leaderboard
        async function loadLeaderboard(period) {
            const list = document.getElementById('leaderboardList');
            list.innerHTML = '<div style="text-align: center; padding: 20px;">Loading...</div>';
            
            try {
                const usersSnap = await db.collection('users')
                    .orderBy('completedChallenges', 'desc')
                    .limit(20)
                    .get();
                
                const users = usersSnap.docs.map((doc, index) => ({
                    id: doc.id,
                    rank: index + 1,
                    ...doc.data()
                }));
                
                list.innerHTML = users.map(user => renderLeaderboardItem(user)).join('');
                
            } catch (error) {
                console.error('Error loading leaderboard:', error);
                list.innerHTML = '<div style="text-align: center; color: #f44;">Failed to load leaderboard</div>';
            }
        }

        // Render Leaderboard Item
        function renderLeaderboardItem(user) {
            const isCurrentUser = user.id === currentUser.uid;
            const rankClass = user.rank <= 3 ? `rank-${user.rank}` : '';
            
            return `
                <div class="leaderboard-item ${isCurrentUser ? 'current-user' : ''}">
                    <div class="leaderboard-rank ${rankClass}">
                        ${user.rank <= 3 ? ['🥇', '🥈', '🥉'][user.rank - 1] : user.rank}
                    </div>
                    <div class="leaderboard-avatar">
                        ${user.avatar || '👤'}
                    </div>
                    <div class="leaderboard-info">
                        <div class="leaderboard-name">${user.name} ${isCurrentUser ? '(You)' : ''}</div>
                        <div class="leaderboard-stats">
                            Level ${user.level || 1} • ${user.completedChallenges || 0} challenges
                        </div>
                    </div>
                    <div class="leaderboard-score">
                        <div class="leaderboard-tokens">${user.tokens || 0}</div>
                        <div class="leaderboard-stats">tokens</div>
                    </div>
                </div>
            `;
        }

        // Check Achievements
        async function checkAchievements() {
            const achievements = [
                { id: 'first_challenge', name: 'First Steps', desc: 'Complete your first challenge', icon: '🎯', check: () => userData.completedChallenges >= 1 },
                { id: 'challenge_master', name: 'Challenge Master', desc: 'Complete 10 challenges', icon: '🏆', check: () => userData.completedChallenges >= 10 },
                { id: 'token_collector', name: 'Token Collector', desc: 'Earn 1000 tokens', icon: '💰', check: () => userData.tokens >= 1000 },
                { id: 'social_butterfly', name: 'Social Butterfly', desc: 'Have 10 friends', icon: '🦋', check: () => userData.friendsCount >= 10 },
                { id: 'streak_warrior', name: 'Streak Warrior', desc: '7 day challenge streak', icon: '🔥', check: () => userData.streak >= 7 }
            ];
            
            for (const achievement of achievements) {
                if (achievement.check() && !userData.achievements?.includes(achievement.id)) {
                    await unlockAchievement(achievement);
                }
            }
        }

        // Unlock Achievement
        async function unlockAchievement(achievement) {
            try {
                await db.collection('users').doc(currentUser.uid).update({
                    achievements: firebase.firestore.FieldValue.arrayUnion(achievement.id),
                    tokens: firebase.firestore.FieldValue.increment(100)
                });
                
                showAchievementPopup(achievement);
                
            } catch (error) {
                console.error('Error unlocking achievement:', error);
            }
        }

        // Show Achievement Popup
        function showAchievementPopup(achievement) {
            const popup = document.createElement('div');
            popup.className = 'achievement-popup';
            popup.innerHTML = `
                <div class="achievement-icon">${achievement.icon}</div>
                <div class="achievement-title">Achievement Unlocked!</div>
                <div class="achievement-name">${achievement.name}</div>
                <div class="achievement-desc">${achievement.desc}</div>
                <div class="achievement-reward">+100 bonus tokens!</div>
            `;
            
            document.body.appendChild(popup);
            
            setTimeout(() => {
                popup.style.opacity = '0';
                setTimeout(() => popup.remove(), 500);
            }, 3000);
        }

        // Setup Challenge Listeners
        function setupChallengeListeners() {
            // For now, skip real-time listeners
        }

        // Update Game Stats
        function updateGameStats() {
            updateUI();
        }

        // Load Game Stats
        async function loadGameStats() {
            try {
                const userDoc = await db.collection('users').doc(currentUser.uid).get();
                if (userDoc.exists) {
                    const data = userDoc.data();
                    userData = { ...userData, ...data };
                    updateGameStats();
                }
            } catch (error) {
                console.error('Error loading game stats:', error);
            }
        }

        // Helper Functions
        function getCategoryIcon(category) {
            const icons = {
                fitness: '💪',
                creative: '🎨',
                social: '🤝',
                adventure: '🏃'
            };
            return icons[category] || '🎯';
        }

        function getTimeLeft(expiresAt) {
            const now = new Date();
            const expires = expiresAt instanceof Date ? expiresAt : expiresAt.toDate();
            const diff = expires - now;
            
            if (diff <= 0) return { hours: 0, display: 'Expired' };
            
            const hours = Math.floor(diff / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            
            if (hours > 24) {
                const days = Math.floor(hours / 24);
                return { hours, display: `${days}d ${hours % 24}h` };
            }
            
            return { hours, display: `${hours}h ${minutes}m` };
        }

        function getTimeAgo(timestamp) {
            if (!timestamp) return 'just now';
            
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            const now = new Date();
            const diff = now - date;
            
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);
            
            if (minutes < 1) return 'just now';
            if (minutes < 60) return `${minutes}m ago`;
            if (hours < 24) return `${hours}h ago`;
            if (days < 7) return `${days}d ago`;
            
            return date.toLocaleDateString();
        }

        function hasProofsToView(challenge) {
            return Object.values(challenge.responses || {}).some(response => response.proofUrl);
        }

        // ===== ENHANCED PROFILE SYSTEM =====

        // Profile State Management
        const profileState = {
            currentUserId: null,
            viewingUserId: null,
            isOwnProfile: true,
            followers: [],
            following: [],
            posts: [],
            collections: [],
            liked: [],
            currentTab: 'posts',
            followTab: 'followers',
            isLoading: false,
            hasMore: true,
            page: 1,
            profileData: null,
            isFollowing: false
        };

        // Initialize Enhanced Profile System
        function initializeProfileSystem() {
            if (currentUser) {
                setupProfileListeners();
            }
        }

        // Setup Firebase Listeners
        function setupProfileListeners() {
            if (!currentUser) return;
            
            // Listen for profile updates
            db.collection('users').doc(currentUser.uid).onSnapshot((doc) => {
                if (doc.exists) {
                    const data = doc.data();
                    userData = { ...userData, ...data };
                    updateProfileStats();
                }
            });
        }

        // Update Profile Stats
        function updateProfileStats() {
            // Update any displayed profile stats
            if (document.getElementById('followersCount')) {
                document.getElementById('followersCount').textContent = formatNumber(userData.followers || 0);
            }
            if (document.getElementById('followingCount')) {
                document.getElementById('followingCount').textContent = formatNumber(userData.following || 0);
            }
        }

        // Show Profile (Enhanced)
        async function showProfile(userId = null) {
            const targetUserId = userId || currentUser?.uid;
            if (!targetUserId) {
                showMessage('Please login first', 'error');
                return;
            }
            
            profileState.viewingUserId = targetUserId;
            profileState.isOwnProfile = targetUserId === currentUser.uid;
            profileState.currentUserId = currentUser.uid;
            
            document.getElementById('profileModal').style.display = 'flex';
            
            await loadUserProfile(targetUserId);
            updateProfileUI();
            
            profileState.page = 1;
            profileState.hasMore = true;
            await loadProfileContent('posts');
        }

        // Load User Profile Data
        async function loadUserProfile(userId) {
            try {
                const userDoc = await db.collection('users').doc(userId).get();
                
                if (!userDoc.exists) {
                    throw new Error('User not found');
                }
                
                const profileData = userDoc.data();
                profileState.profileData = {
                    ...profileData,
                    uid: userId
                };
                
                // Simple follower/following counts
                profileState.profileData.followersCount = profileData.followers || 0;
                profileState.profileData.followingCount = profileData.following || 0;
                
            } catch (error) {
                console.error('Error loading profile:', error);
                showMessage('Failed to load profile', 'error');
            }
        }

        // Update Profile UI
        function updateProfileUI() {
            const data = profileState.profileData;
            if (!data) return;
            
            // Update avatar
            const avatarEmoji = document.getElementById('profileAvatarEmoji');
            const avatarImg = document.getElementById('profileAvatarImg');
            
            if (data.avatarUrl) {
                avatarImg.src = data.avatarUrl;
                avatarImg.style.display = 'block';
                avatarEmoji.style.display = 'none';
            } else {
                avatarEmoji.textContent = data.avatar || '🎮';
                avatarEmoji.style.display = 'flex';
                avatarImg.style.display = 'none';
            }
            
            // Update cover image
            const coverDiv = document.getElementById('profileCover');
            if (data.coverUrl) {
                const existingImg = coverDiv.querySelector('img');
                if (!existingImg) {
                    const img = document.createElement('img');
                    img.src = data.coverUrl;
                    coverDiv.insertBefore(img, coverDiv.firstChild);
                    coverDiv.classList.add('has-image');
                }
            }
            
            // Update info
            document.getElementById('profileUsername').textContent = '@' + data.name;
            document.getElementById('profileUID').textContent = 'ID: ' + (data.uid ? data.uid.slice(-9) : '123456789');
            document.getElementById('userLocation').textContent = data.location || 'Earth';
            document.getElementById('profileBio').textContent = data.bio || 'No bio yet';
            document.getElementById('userLevel').textContent = data.level || 1;
            
            // Update stats
            animateNumber('followersCount', data.followersCount || 0);
            animateNumber('followingCount', data.followingCount || 0);
            animateNumber('likesCount', data.totalLikes || 0);
            
            // Update tags
            updateProfileTags(data);
            
            // Update action buttons
            updateProfileActions();
            
            // Show/hide edit buttons
            document.querySelectorAll('.avatar-edit-btn, .cover-edit-btn').forEach(btn => {
                btn.style.display = profileState.isOwnProfile ? 'flex' : 'none';
            });
        }

        // Update Profile Tags
        function updateProfileTags(data) {
            const tagsContainer = document.getElementById('profileTags');
            const tags = [];
            
            tags.push(`<span class="profile-tag">🎯 Level ${data.level || 1}</span>`);
            
            if ((data.completedChallenges || 0) >= 10) {
                tags.push('<span class="profile-tag">🔥 Challenger</span>');
            }
            if ((data.followers || 0) >= 100) {
                tags.push('<span class="profile-tag">⭐ Popular</span>');
            }
            if ((data.streak || 0) >= 7) {
                tags.push('<span class="profile-tag">🏆 Dedicated</span>');
            }
            
            tagsContainer.innerHTML = tags.join('');
        }

        // Update Profile Action Buttons
        function updateProfileActions() {
            const actionsDiv = document.getElementById('profileActions');
            
            if (profileState.isOwnProfile) {
                actionsDiv.innerHTML = `
                    <button class="profile-btn primary-btn" onclick="editProfile()">
                        Edit Profile
                    </button>
                    <button class="profile-btn secondary-btn" onclick="shareProfile()">
                        Share Profile
                    </button>
                    <button class="profile-btn icon-btn" onclick="showSettings()">
                        ⚙️
                    </button>
                `;
            } else {
                actionsDiv.innerHTML = `
                    <button class="profile-btn primary-btn" onclick="sendMessage('${profileState.viewingUserId}')">
                        Message
                    </button>
                    <button class="profile-btn secondary-btn" onclick="addFriend('${profileState.viewingUserId}')">
                        Add Friend
                    </button>
                    <button class="profile-btn icon-btn" onclick="showProfileMenu()">
                        ⋯
                    </button>
                `;
            }
        }

        // Animate Number
        function animateNumber(elementId, targetValue) {
            const element = document.getElementById(elementId);
            if (!element) return;
            
            const startValue = parseInt(element.textContent) || 0;
            const duration = 1000;
            const steps = 30;
            const increment = (targetValue - startValue) / steps;
            let currentStep = 0;
            
            const timer = setInterval(() => {
                currentStep++;
                const currentValue = Math.round(startValue + increment * currentStep);
                element.textContent = formatNumber(currentValue);
                
                if (currentStep >= steps) {
                    clearInterval(timer);
                    element.textContent = formatNumber(targetValue);
                }
            }, duration / steps);
        }

        // Format Numbers
        function formatNumber(num) {
            if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
            return num.toString();
        }

        // Load Profile Content
        async function loadProfileContent(tab, append = false) {
            const grid = document.getElementById('profileContentGrid');
            
            if (profileState.isLoading) return;
            profileState.isLoading = true;
            
            if (!append) {
                profileState.page = 1;
                profileState.hasMore = true;
                grid.innerHTML = '<div class="loading-spinner" style="grid-column: 1/-1; text-align: center; padding: 40px;">Loading...</div>';
            }
            
            try {
                // For demo, just show placeholder content
                const demoItems = Array(12).fill(null).map((_, i) => ({
                    id: `${tab}_${Date.now()}_${i}`,
                    mediaUrl: `https://picsum.photos/400/400?random=${Date.now() + i}`,
                    likes: Math.floor(Math.random() * 1000),
                    comments: Math.floor(Math.random() * 100),
                    hasMultiple: Math.random() > 0.7,
                    type: tab
                }));
                
                if (!append) {
                    grid.innerHTML = '';
                }
                
                if (demoItems.length === 0 && profileState.page === 1) {
                    showEmptyState(tab);
                } else {
                    renderProfileGrid(demoItems, append);
                }
                
                profileState.hasMore = false; // For demo
                profileState.page++;
                
            } catch (error) {
                console.error('Error loading content:', error);
            } finally {
                profileState.isLoading = false;
            }
        }

        // Render Profile Grid
        function renderProfileGrid(items, append = false) {
            const grid = document.getElementById('profileContentGrid');
            const fragment = document.createDocumentFragment();
            
            items.forEach(item => {
                const gridItem = createGridItem(item);
                fragment.appendChild(gridItem);
            });
            
            if (append) {
                grid.appendChild(fragment);
            } else {
                grid.innerHTML = '';
                grid.appendChild(fragment);
            }
        }

        // Create Grid Item
        function createGridItem(item) {
            const div = document.createElement('div');
            div.className = 'profile-grid-item';
            div.onclick = () => openPost(item.id);
            
            div.innerHTML = `
                <div class="media-container">
                    <img src="${item.mediaUrl}" alt="Post">
                </div>
                ${item.hasMultiple ? '<div class="grid-item-multiple">📷 3</div>' : ''}
                <div class="grid-item-overlay">
                    <div class="grid-item-stats">
                        <div class="grid-item-stat">
                            <span>❤️</span>
                            <span>${formatNumber(item.likes)}</span>
                        </div>
                        ${item.comments !== undefined ? `
                            <div class="grid-item-stat">
                                <span>💬</span>
                                <span>${formatNumber(item.comments)}</span>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
            
            return div;
        }

        // Show Empty State
        function showEmptyState(tab) {
            const grid = document.getElementById('profileContentGrid');
            const messages = {
                posts: {
                    icon: '📝',
                    text: 'No posts yet',
                    action: 'Create your first post',
                    onclick: 'closeProfileModal()'
                },
                collections: {
                    icon: '❤️',
                    text: 'No collections yet',
                    action: 'Start collecting',
                    onclick: 'closeProfileModal()'
                },
                liked: {
                    icon: '👍',
                    text: 'No liked posts yet',
                    action: 'Explore posts',
                    onclick: 'closeProfileModal()'
                }
            };
            
            const message = messages[tab];
            
            grid.innerHTML = `
                <div class="profile-empty-state" style="grid-column: 1/-1;">
                    <div class="empty-state-icon">${message.icon}</div>
                    <p class="empty-state-text">${message.text}</p>
                    <button class="empty-state-btn" onclick="${message.onclick}">
                        ${message.action}
                    </button>
                </div>
            `;
        }

        // Switch Profile Tab
        function switchProfileTab(tab, element) {
            document.querySelectorAll('.profile-tab').forEach(t => t.classList.remove('active'));
            element.classList.add('active');
            
            profileState.currentTab = tab;
            loadProfileContent(tab);
        }

        // Open Post
        function openPost(postId) {
            console.log('Opening post:', postId);
            showMessage('Post details coming soon!', 'info');
        }

        // Edit Profile
        function editProfile() {
            const data = profileState.profileData;
            
            document.getElementById('editUsername').value = data.name || '';
            document.getElementById('editBio').value = data.bio || '';
            document.getElementById('editLocation').value = data.location || '';
            
            if (data.interests) {
                data.interests.forEach(interest => {
                    const checkbox = document.querySelector(`input[name="interests"][value="${interest}"]`);
                    if (checkbox) checkbox.checked = true;
                });
            }
            
            const bioInput = document.getElementById('editBio');
            const charCount = document.getElementById('bioCharCount');
            charCount.textContent = bioInput.value.length;
            
            bioInput.addEventListener('input', () => {
                charCount.textContent = bioInput.value.length;
            });
            
            document.getElementById('editProfileModal').style.display = 'flex';
        }

        // Save Profile
        async function saveProfile(event) {
            event.preventDefault();
            
            const username = document.getElementById('editUsername').value.trim();
            const bio = document.getElementById('editBio').value.trim();
            const location = document.getElementById('editLocation').value.trim();
            
            const interests = Array.from(document.querySelectorAll('input[name="interests"]:checked'))
                .map(cb => cb.value);
            
            try {
                await db.collection('users').doc(currentUser.uid).update({
                    name: username,
                    bio: bio,
                    location: location,
                    interests: interests,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                userData.name = username;
                userData.bio = bio;
                userData.location = location;
                userData.interests = interests;
                
                profileState.profileData = { ...profileState.profileData, ...userData };
                
                updateProfileUI();
                updateUI();
                closeModal('editProfileModal');
                showMessage('Profile updated successfully!', 'success');
                
            } catch (error) {
                console.error('Error updating profile:', error);
                showMessage('Failed to update profile', 'error');
            }
        }

        // Upload Avatar Image
        async function uploadAvatarImage(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (file.size > 5 * 1024 * 1024) {
                showMessage('Image must be less than 5MB', 'error');
                return;
            }
            
            try {
                showMessage('Uploading avatar...', 'info');
                
                const timestamp = Date.now();
                const filename = `avatars/${currentUser.uid}/${timestamp}_${file.name}`;
                const storageRef = storage.ref(filename);
                
                const snapshot = await storageRef.put(file);
                const downloadURL = await snapshot.ref.getDownloadURL();
                
                await db.collection('users').doc(currentUser.uid).update({
                    avatarUrl: downloadURL
                });
                
                userData.avatarUrl = downloadURL;
                profileState.profileData.avatarUrl = downloadURL;
                
                updateProfileUI();
                showMessage('Avatar updated!', 'success');
                
            } catch (error) {
                console.error('Error uploading avatar:', error);
                showMessage('Failed to upload avatar', 'error');
            }
        }

        // Upload Cover Image
        async function uploadCoverImage(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (file.size > 10 * 1024 * 1024) {
                showMessage('Image must be less than 10MB', 'error');
                return;
            }
            
            try {
                showMessage('Uploading cover image...', 'info');
                
                const timestamp = Date.now();
                const filename = `covers/${currentUser.uid}/${timestamp}_${file.name}`;
                const storageRef = storage.ref(filename);
                
                const snapshot = await storageRef.put(file);
                const downloadURL = await snapshot.ref.getDownloadURL();
                
                await db.collection('users').doc(currentUser.uid).update({
                    coverUrl: downloadURL
                });
                
                userData.coverUrl = downloadURL;
                profileState.profileData.coverUrl = downloadURL;
                
                const coverDiv = document.getElementById('profileCover');
                const existingImg = coverDiv.querySelector('img');
                if (existingImg) {
                    existingImg.src = downloadURL;
                } else {
                    const img = document.createElement('img');
                    img.src = downloadURL;
                    coverDiv.insertBefore(img, coverDiv.firstChild);
                    coverDiv.classList.add('has-image');
                }
                
                showMessage('Cover image updated!', 'success');
                
            } catch (error) {
                console.error('Error uploading cover:', error);
                showMessage('Failed to upload cover image', 'error');
            }
        }

        // Share Profile
        function shareProfile() {
            const profileUrl = `${window.location.origin}${window.location.pathname}?user=${profileState.viewingUserId}`;
            
            if (navigator.share) {
                navigator.share({
                    title: `@${profileState.profileData.name} on JomBro`,
                    text: profileState.profileData.bio || 'Check out this profile on JomBro!',
                    url: profileUrl
                }).then(() => {
                    showMessage('Profile shared!', 'success');
                }).catch(err => {
                    if (err.name !== 'AbortError') {
                        copyProfileLink();
                    }
                });
            } else {
                copyProfileLink();
            }
            
            closeModal('profileMenuModal');
        }

        // Copy Profile Link
        function copyProfileLink() {
            const profileUrl = `${window.location.origin}${window.location.pathname}?user=${profileState.viewingUserId}`;
            
            navigator.clipboard.writeText(profileUrl).then(() => {
                showMessage('Profile link copied!', 'success');
            }).catch(() => {
                showMessage('Failed to copy link', 'error');
            });
            
            closeModal('profileMenuModal');
        }

        // Show Profile Menu
        function showProfileMenu() {
            const blockBtn = document.getElementById('blockUserBtn');
            blockBtn.style.display = profileState.isOwnProfile ? 'none' : 'flex';
            document.getElementById('profileMenuModal').style.display = 'flex';
        }

        // Show Followers
        async function showFollowers() {
            showMessage('Followers list coming soon!', 'info');
        }

        // Show Following
        async function showFollowing() {
            showMessage('Following list coming soon!', 'info');
        }

        // Show Likes
        function showLikes() {
            showMessage('Likes list coming soon!', 'info');
        }

        // Show Settings
        function showSettings() {
            showMessage('Settings coming soon!', 'info');
        }

        // Show Privacy
        function showPrivacy() {
            showMessage('Privacy settings coming soon!', 'info');
        }

        // Show QR Code
        function showQRCode() {
            showMessage('QR Code feature coming soon!', 'info');
        }

        // Block User
        async function blockUser() {
            showMessage('Block feature coming soon!', 'info');
        }

        // Send Message
        function sendMessage(userId) {
            showMessage('Messaging feature coming soon!', 'info');
        }

        // Close Profile Modal
        function closeProfileModal() {
            document.getElementById('profileModal').style.display = 'none';
            profileState.viewingUserId = null;
            profileState.profileData = null;
        }

        // Switch Follow Tab
        function switchFollowTab(tab, element) {
            document.querySelectorAll('.follow-tab').forEach(t => t.classList.remove('active'));
            element.classList.add('active');
            profileState.followTab = tab;
        }
    </script>
</body>
</html>
