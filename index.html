<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#000000">
    <meta name="description" content="JomBro - Complete challenges, earn rewards, and have fun!">
    <title>JomBro - Challenge & Reward Platform</title>
    
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>🎮</text></svg>">
    
    <!-- Performance Optimization: Preconnect to external domains -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://www.gstatic.com">
    <link rel="preconnect" href="https://firebasestorage.googleapis.com">
    
    <!-- PWA meta tags -->
    <link rel="manifest" href="data:application/json,{%22name%22:%22JomBro%22,%22short_name%22:%22JomBro%22,%22start_url%22:%22/%22,%22display%22:%22standalone%22,%22background_color%22:%22%23000000%22,%22theme_color%22:%22%23000000%22,%22icons%22:[{%22src%22:%22data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>🎮</text></svg>%22,%22sizes%22:%22any%22}]}">
    
    <!-- Social sharing meta tags -->
    <meta property="og:title" content="JomBro - Challenge & Reward Platform">
    <meta property="og:description" content="Complete fun challenges with friends, earn rewards, and level up!">
    <meta property="og:type" content="website">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@100;200;300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
    
    <style>
        /* CSS Variables for easier theming */
        :root {
            --primary-color: #667eea;
            --secondary-color: #764ba2;
            --accent-color: #e91e63;
            --success-color: #4caf50;
            --warning-color: #ff9800;
            --error-color: #f44336;
            --primary-gradient: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            --secondary-gradient: linear-gradient(45deg, #9b59b6, #e91e63);
            --glass-bg: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.2);
            --text-primary: #fff;
            --text-secondary: rgba(255, 255, 255, 0.8);
            --text-tertiary: rgba(255, 255, 255, 0.6);
            --animation-speed: 0.3s;
            --animation-curve: cubic-bezier(0.4, 0, 0.2, 1);
            --safe-area-top: env(safe-area-inset-top);
            --safe-area-bottom: env(safe-area-inset-bottom);
        }
        
        /* Base Styles with Performance Optimizations */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: 'Montserrat', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            font-weight: 400;
            background: #000;
            color: var(--text-primary);
            overflow: hidden;
            position: fixed;
            width: 100%;
            height: 100%;
            overscroll-behavior: none;
            max-width: 480px;
            margin: 0 auto;
            position: relative;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        @media (min-width: 481px) {
            body {
                border-left: 1px solid #333;
                border-right: 1px solid #333;
            }
        }
        
        /* Hide scrollbars */
        ::-webkit-scrollbar {
            display: none;
        }
        
        .file-input {
            display: none;
        }
        
        /* GPU Accelerated Animations */
        .gpu-accelerated {
            transform: translateZ(0);
            will-change: transform;
            backface-visibility: hidden;
            perspective: 1000px;
        }
        
        /* Utility Classes */
        .glass-effect {
            background: var(--glass-bg);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid var(--glass-border);
        }
        
        .flex-center {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .no-select {
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }
        
        /* Enhanced Login Screen */
        #loginScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--primary-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            animation: fadeIn 0.5s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .login-content {
            text-align: center;
            padding: 20px;
            animation: slideInUp 0.6s var(--animation-curve);
        }
        
        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .app-logo {
            font-size: 5rem;
            margin-bottom: 20px;
            animation: logoFloat 3s ease-in-out infinite;
            filter: drop-shadow(0 10px 30px rgba(0,0,0,0.3));
        }
        
        @keyframes logoFloat {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            50% { transform: translateY(-20px) rotate(5deg); }
        }
        
        .app-title {
            font-size: 3rem;
            font-family: 'Montserrat', sans-serif;
            font-weight: 100;
            margin-bottom: 10px;
            color: white;
            letter-spacing: 2px;
            text-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        
        .app-subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
            margin-bottom: 40px;
            font-weight: 300;
        }
        
        .quick-start-btn {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            border: 2px solid white;
            color: white;
            padding: 20px 60px;
            font-size: 1.3rem;
            border-radius: 50px;
            cursor: pointer;
            transition: all var(--animation-speed) var(--animation-curve);
            font-weight: 600;
            position: relative;
            overflow: hidden;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .quick-start-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: white;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        
        .quick-start-btn:hover {
            color: var(--primary-color);
            transform: scale(1.05);
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        
        .quick-start-btn:hover::before {
            width: 300px;
            height: 300px;
        }
        
        .quick-start-btn span {
            position: relative;
            z-index: 1;
        }
        
        /* Enhanced Feed Container */
        .feed-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow-y: scroll;
            scroll-snap-type: y mandatory;
            -webkit-overflow-scrolling: touch;
            display: none;
            background: #000;
            scrollbar-width: none;
        }
        
        /* Enhanced Feed Post */
        .feed-post {
            position: relative;
            width: 100%;
            height: 100vh;
            height: 100dvh;
            scroll-snap-align: start;
            background: #000;
            overflow: hidden;
        }
        
        /* Post Media with Loading State */
        .post-media {
            width: 100%;
            height: 100%;
            position: relative;
            background: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1;
        }
        
        .post-media::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 40px;
            height: 40px;
            margin: -20px 0 0 -20px;
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            z-index: -1;
        }
        
        .post-video,
        .post-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .post-video.loaded,
        .post-image.loaded {
            opacity: 1;
        }
        
        /* Enhanced Frame Styles */
        .frame-wrapper {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 5;
        }
        
        .frame-gradient-border {
            background: linear-gradient(45deg, #ff006e, #8338ec, #3a86ff, #06c, #ff006e);
            background-size: 400% 400%;
            animation: gradientShift 10s ease infinite;
            padding: 3px;
            opacity: 0.8;
        }
        
        .frame-gradient-border::after {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            right: 3px;
            bottom: 3px;
            background: #000;
        }
        
        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        /* Enhanced Gradient Overlays */
        .gradient-overlay-top {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 200px;
            background: linear-gradient(to bottom, 
                rgba(0,0,0,0.8) 0%, 
                rgba(0,0,0,0.4) 50%, 
                transparent 100%);
            z-index: 15;
            pointer-events: none;
        }
        
        .gradient-overlay-bottom {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 200px;
            background: linear-gradient(to top, 
                rgba(0,0,0,0.95) 0%, 
                rgba(0,0,0,0.6) 50%, 
                transparent 100%);
            z-index: 15;
            pointer-events: none;
        }
        
        /* Enhanced Header */
        .feed-header {
            position: fixed;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 480px;
            z-index: 300;
            padding: 15px 20px;
            padding-top: max(15px, var(--safe-area-top));
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: transparent;
            transition: background 0.3s ease;
        }
        
        .feed-header.scrolled {
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(20px);
        }
        
        .header-left {
            font-size: 1.5rem;
            font-family: 'Montserrat', sans-serif;
            font-weight: 200;
            color: white;
            flex-shrink: 0;
            text-shadow: 0 2px 8px rgba(0,0,0,0.8);
            animation: fadeInDown 0.5s ease-out;
            letter-spacing: 1px;
        }
        
        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .header-center {
            display: flex;
            gap: 20px;
            background: rgba(0,0,0,0.3);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            padding: 10px 24px;
            border-radius: 35px;
            animation: fadeInDown 0.5s ease-out 0.1s backwards;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .header-tab {
            font-size: 1.1rem;
            font-weight: 600;
            opacity: 0.7;
            cursor: pointer;
            transition: all var(--animation-speed) var(--animation-curve);
            position: relative;
            background: none;
            border: none;
            color: white;
            text-shadow: 0 1px 4px rgba(0,0,0,0.8);
            padding: 5px 10px;
        }
        
        .header-tab.active {
            opacity: 1;
        }
        
        .header-tab.active::after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 50%;
            transform: translateX(-50%);
            width: 30px;
            height: 2px;
            background: white;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
        }
        
        .header-right {
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all var(--animation-speed) var(--animation-curve);
            border: 1px solid rgba(255, 255, 255, 0.2);
            font-size: 1.2rem;
        }
        
        .header-right:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.1);
        }
        
        /* Enhanced Post Actions */
        .post-actions {
            position: absolute;
            right: 15px;
            bottom: 120px;
            z-index: 25;
            display: flex;
            flex-direction: column;
            gap: 20px;
            align-items: center;
        }
        
        .action-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            transition: all var(--animation-speed) var(--animation-curve);
        }
        
        .action-item:active {
            transform: scale(0.95);
        }
        
        .action-icon {
            width: 48px;
            height: 48px;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            transition: all var(--animation-speed) var(--animation-curve);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .action-icon:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
        }
        
        .action-icon.liked {
            background: var(--accent-color);
            box-shadow: 0 2px 12px rgba(233, 30, 99, 0.5);
            animation: likeAnimation 0.6s var(--animation-curve);
        }
        
        @keyframes likeAnimation {
            0% { transform: scale(1); }
            25% { transform: scale(0.8); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        
        .action-count {
            font-size: 0.75rem;
            font-weight: 600;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.8);
        }
        
        /* Enhanced User Avatar */
        .user-avatar {
            width: 55px;
            height: 55px;
            border-radius: 50%;
            background: linear-gradient(45deg, #f093fb, #f5576c);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            border: 3px solid white;
            position: relative;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }
        
        .user-avatar img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }
        
        .follow-btn {
            position: absolute;
            bottom: -3px;
            background: var(--accent-color);
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            border: 2px solid #000;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.3);
            transition: all var(--animation-speed) var(--animation-curve);
        }
        
        .follow-btn:hover {
            transform: scale(1.1);
        }
        
        /* Enhanced Post Info */
        .post-info {
            position: absolute;
            bottom: 20px;
            bottom: calc(20px + var(--safe-area-bottom));
            left: 0;
            right: 80px;
            padding: 20px;
            z-index: 25;
        }
        
        .post-user {
            font-weight: 600;
            font-size: 1.1rem;
            margin-bottom: 10px;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.8);
        }
        
        .challenge-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: rgba(155, 89, 182, 0.3);
            backdrop-filter: blur(10px);
            padding: 6px 16px;
            border-radius: 20px;
            margin-bottom: 10px;
            font-size: 0.9rem;
            border: 1px solid rgba(155, 89, 182, 0.5);
            animation: fadeInUp 0.5s ease-out 0.3s backwards;
        }
        
        @keyframes fadeInUp {
            from { 
                opacity: 0;
                transform: translateY(20px);
            }
            to { 
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .post-caption {
            font-size: 0.95rem;
            margin-bottom: 10px;
            line-height: 1.4;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.8);
        }
        
        .post-music {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9rem;
            opacity: 0.8;
        }
        
        .music-icon {
            animation: musicSpin 3s linear infinite;
        }
        
        @keyframes musicSpin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        /* Enhanced Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            z-index: 300;
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            padding-bottom: calc(10px + var(--safe-area-bottom));
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            cursor: pointer;
            transition: all var(--animation-speed) var(--animation-curve);
            padding: 5px;
            background: none;
            border: none;
            color: white;
            position: relative;
        }
        
        .nav-item::before {
            content: '';
            position: absolute;
            top: -2px;
            left: 50%;
            transform: translateX(-50%) scaleX(0);
            width: 40px;
            height: 2px;
            background: var(--primary-gradient);
            transition: transform 0.3s var(--animation-curve);
        }
        
        .nav-item.active::before {
            transform: translateX(-50%) scaleX(1);
        }
        
        .nav-icon {
            font-size: 1.5rem;
            transition: transform 0.3s var(--animation-curve);
        }
        
        .nav-item:active .nav-icon {
            transform: scale(0.9);
        }
        
        .nav-label {
            font-size: 0.7rem;
            opacity: 0.6;
            transition: opacity 0.3s ease;
        }
        
        .nav-item.active .nav-icon,
        .nav-item.active .nav-label {
            opacity: 1;
        }
        
        /* Enhanced Create Button */
        .create-btn {
            position: relative;
            background: white;
            border-radius: 12px;
            padding: 8px 24px;
            overflow: hidden;
        }
        
        .create-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            transition: left 0.5s ease;
        }
        
        .create-btn:hover::before {
            left: 100%;
        }
        
        .create-btn .nav-icon {
            color: black;
            position: relative;
            z-index: 1;
        }
        
        /* Enhanced Modal Base */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 400;
            display: none;
            align-items: flex-end;
            justify-content: center;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        
        .modal.show {
            display: flex;
            animation: fadeIn 0.3s ease;
        }
        
        .modal-content {
            background: #1a1a1a;
            border-radius: 20px 20px 0 0;
            padding: 20px;
            width: 100%;
            max-width: 480px;
            max-height: 80vh;
            overflow-y: auto;
            animation: modalSlideUp var(--animation-speed) var(--animation-curve);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        @keyframes modalSlideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .modal-title {
            font-size: 1.3rem;
            font-weight: 600;
        }
        
        .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s ease;
        }
        
        .close-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        /* Enhanced Form Styles */
        .form-input, .form-textarea {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.15);
            color: white;
            padding: 15px;
            border-radius: 10px;
            font-size: 1rem;
            width: 100%;
            resize: vertical;
            transition: all var(--animation-speed) var(--animation-curve);
            font-family: inherit;
        }
        
        .form-input:focus, .form-textarea:focus {
            background: rgba(255, 255, 255, 0.12);
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .form-input::placeholder, .form-textarea::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }
        
        .form-label {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 8px;
            display: block;
            font-weight: 500;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        /* Enhanced Buttons */
        .submit-btn {
            width: 100%;
            padding: 15px;
            background: var(--secondary-gradient);
            border: none;
            border-radius: 10px;
            color: white;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--animation-speed) var(--animation-curve);
            position: relative;
            overflow: hidden;
        }
        
        .submit-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        
        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(155, 89, 182, 0.4);
        }
        
        .submit-btn:hover::before {
            width: 300px;
            height: 300px;
        }
        
        .submit-btn:active {
            transform: translateY(0);
        }
        
        /* Enhanced Toast */
        .toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
            padding: 15px 25px;
            border-radius: 25px;
            z-index: 600;
            animation: toastSlideUp 0.3s var(--animation-curve);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }
        
        @keyframes toastSlideUp {
            from { 
                opacity: 0;
                transform: translate(-50%, 20px);
            }
            to { 
                opacity: 1;
                transform: translate(-50%, 0);
            }
        }
        
        /* Enhanced Loading Spinner */
        .loading-spinner {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 60px;
            height: 60px;
            display: none;
            z-index: 10000;
        }
        
        .loading-spinner::before {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        /* Enhanced Profile Modal */
        #profileModal .modal-content {
            background: #000;
            color: #fff;
            padding: 0;
            max-height: 100vh;
            height: 100vh;
            border-radius: 0;
            position: relative;
            overflow: hidden;
        }
        
        .profile-modal-scroll {
            height: 100vh;
            overflow-y: auto;
            overflow-x: hidden;
            position: relative;
            background: #000;
            scroll-behavior: smooth;
        }
        
        /* Enhanced Profile Header */
        .profile-header {
            padding: 0;
            position: relative;
            background: #000;
            color: #fff;
            height: 40vh;
            overflow: hidden;
        }
        
        .profile-cover {
            width: 100%;
            height: 100%;
            position: relative;
            overflow: hidden;
        }
        
        .profile-cover::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(to bottom, 
                transparent 0%, 
                rgba(0,0,0,0.3) 50%, 
                rgba(0,0,0,0.8) 100%);
            z-index: 2;
            pointer-events: none;
        }
        
        .profile-cover-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .profile-cover-default {
            width: 100%;
            height: 100%;
            background: var(--primary-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 5rem;
        }
        
        .profile-cover-upload {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 10px 20px;
            border-radius: 30px;
            font-size: 0.85rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 10;
            transition: all 0.3s ease;
        }
        
        .profile-cover-upload:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(255, 255, 255, 0.1);
        }
        
        /* Profile Info Section */
        .profile-info-section {
            padding: 30px 20px;
            margin-top: -80px;
            position: relative;
            z-index: 10;
        }
        
        /* Enhanced Avatar */
        .profile-avatar-section {
            position: relative;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .profile-avatar-large {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: linear-gradient(45deg, #f093fb, #f5576c);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            border: 4px solid #000;
            box-shadow: 0 0 40px rgba(240, 147, 251, 0.5),
                        0 0 80px rgba(245, 87, 108, 0.3);
            position: relative;
            cursor: pointer;
            animation: avatarPulse 3s ease-in-out infinite;
            overflow: hidden;
        }
        
        @keyframes avatarPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .profile-avatar-img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }
        
        .profile-avatar-edit {
            position: absolute;
            bottom: 5px;
            right: 5px;
            background: var(--primary-gradient);
            color: white;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            border: 2px solid #000;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
            transition: all 0.3s ease;
        }
        
        .profile-avatar-edit:hover {
            transform: scale(1.1);
        }
        
        /* Profile Name and Stats */
        .profile-name-section {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .profile-username {
            font-size: 1.8rem;
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .profile-bio {
            font-size: 0.95rem;
            color: rgba(255, 255, 255, 0.8);
            line-height: 1.5;
            margin-bottom: 20px;
            padding: 0 20px;
        }
        
        /* Enhanced Stats */
        .profile-stats {
            display: flex;
            justify-content: space-around;
            padding: 20px 10px;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            margin-bottom: 30px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .stat-item {
            text-align: center;
            flex: 1;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .stat-item:hover {
            transform: scale(1.05);
        }
        
        .stat-value {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 2px;
        }
        
        .stat-label {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.6);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        /* Profile Tabs */
        .profile-tabs {
            display: flex;
            justify-content: space-around;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            margin: 0 -20px;
            padding: 0 20px;
            position: sticky;
            top: 0;
            background: #000;
            z-index: 20;
        }
        
        .profile-tab {
            flex: 1;
            padding: 15px;
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .profile-tab.active {
            color: white;
        }
        
        .profile-tab.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 60px;
            height: 2px;
            background: var(--primary-gradient);
        }
        
        /* Posts Grid */
        .posts-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 2px;
            padding: 2px;
        }
        
        .grid-post {
            position: relative;
            aspect-ratio: 1;
            background: #111;
            overflow: hidden;
            cursor: pointer;
        }
        
        .grid-post img,
        .grid-post video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s ease;
        }
        
        .grid-post:hover img,
        .grid-post:hover video {
            transform: scale(1.05);
        }
        
        .grid-post-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);
            padding: 10px;
            display: flex;
            gap: 15px;
            font-size: 0.8rem;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .grid-post:hover .grid-post-overlay {
            opacity: 1;
        }
        
        /* Profile Actions */
        .profile-actions {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .profile-btn {
            flex: 1;
            padding: 12px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }
        
        .profile-btn.primary {
            background: var(--primary-gradient);
            border: none;
        }
        
        .profile-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(255, 255, 255, 0.1);
        }
        
        /* Enhanced Camera Modal */
        #cameraModal .modal-content {
            background: #000;
            padding: 0;
            max-height: 100vh;
            height: 100vh;
            border-radius: 0;
        }
        
        .camera-container {
            position: relative;
            width: 100%;
            height: 100vh;
            overflow: hidden;
        }
        
        #cameraVideo,
        #recordedVideo {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .camera-controls {
            position: absolute;
            bottom: 40px;
            bottom: calc(40px + var(--safe-area-bottom));
            left: 0;
            right: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 30px;
            z-index: 10;
        }
        
        .camera-btn {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: 4px solid white;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .camera-btn::before {
            content: '';
            position: absolute;
            width: 30px;
            height: 30px;
            background: red;
            border-radius: 50%;
            transition: all 0.3s ease;
        }
        
        .camera-btn.recording::before {
            border-radius: 8px;
            width: 25px;
            height: 25px;
        }
        
        .camera-btn.recording {
            animation: recordPulse 1.5s ease-in-out infinite;
        }
        
        @keyframes recordPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        .camera-close {
            position: absolute;
            top: 40px;
            top: calc(40px + var(--safe-area-top));
            left: 20px;
            width: 40px;
            height: 40px;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.3s ease;
        }
        
        .camera-flip {
            position: absolute;
            top: 40px;
            top: calc(40px + var(--safe-area-top));
            right: 20px;
            width: 40px;
            height: 40px;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.3s ease;
        }
        
        .camera-close:hover,
        .camera-flip:hover {
            background: rgba(0, 0, 0, 0.8);
            transform: scale(1.1);
        }
        
        .gallery-btn {
            width: 50px;
            height: 50px;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.5rem;
            transition: all 0.3s ease;
        }
        
        .gallery-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }
        
        .timer {
            position: absolute;
            top: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 0, 0, 0.8);
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 1.2rem;
            font-weight: 600;
            display: none;
            backdrop-filter: blur(10px);
        }
        
        /* Enhanced Challenge Cards */
        .challenge-section {
            padding: 20px 0;
        }
        
        .challenge-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all var(--animation-speed) ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        
        .challenge-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transition: left 0.5s ease;
        }
        
        .challenge-card:hover {
            background: rgba(255, 255, 255, 0.08);
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
        }
        
        .challenge-card:hover::before {
            left: 100%;
        }
        
        .challenge-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 10px;
        }
        
        .challenge-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .challenge-category {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            background: rgba(155, 89, 182, 0.2);
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
            border: 1px solid rgba(155, 89, 182, 0.4);
        }
        
        .challenge-reward {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 1.2rem;
            font-weight: 700;
            color: #ffd700;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }
        
        .challenge-description {
            font-size: 0.9rem;
            opacity: 0.8;
            line-height: 1.4;
            margin-bottom: 10px;
        }
        
        .challenge-meta {
            display: flex;
            gap: 15px;
            font-size: 0.85rem;
            opacity: 0.6;
        }
        
        /* Enhanced Search Modal */
        #searchModal .modal-content {
            background: #111;
            max-height: 100vh;
            height: 100vh;
            border-radius: 0;
        }
        
        .search-header {
            padding: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            position: sticky;
            top: 0;
            background: #111;
            z-index: 10;
        }
        
        .search-input-container {
            display: flex;
            align-items: center;
            gap: 15px;
            background: rgba(255, 255, 255, 0.08);
            border-radius: 25px;
            padding: 12px 20px;
            transition: all 0.3s ease;
        }
        
        .search-input-container:focus-within {
            background: rgba(255, 255, 255, 0.12);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .search-input {
            flex: 1;
            background: none;
            border: none;
            color: white;
            font-size: 1rem;
            outline: none;
        }
        
        .search-results {
            padding: 20px;
        }
        
        .search-result-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            cursor: pointer;
            transition: all var(--animation-speed) ease;
            position: relative;
        }
        
        .search-result-item::before {
            content: '';
            position: absolute;
            left: -20px;
            right: -20px;
            top: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.05);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .search-result-item:hover::before {
            opacity: 1;
        }
        
        .search-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(45deg, #f093fb, #f5576c);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            position: relative;
            z-index: 1;
        }
        
        .search-info {
            flex: 1;
            position: relative;
            z-index: 1;
        }
        
        .search-name {
            font-weight: 600;
            margin-bottom: 2px;
        }
        
        .search-username {
            font-size: 0.9rem;
            opacity: 0.6;
        }
        
        /* Enhanced Comments Modal */
        #commentsModal .modal-content {
            max-height: 70vh;
        }
        
        .comments-list {
            padding: 20px 0;
            max-height: 50vh;
            overflow-y: auto;
        }
        
        .comment-item {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            animation: fadeInUp 0.3s ease;
        }
        
        .comment-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(45deg, #f093fb, #f5576c);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            flex-shrink: 0;
        }
        
        .comment-content {
            flex: 1;
        }
        
        .comment-header {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 5px;
        }
        
        .comment-author {
            font-weight: 600;
            font-size: 0.95rem;
        }
        
        .comment-time {
            font-size: 0.8rem;
            opacity: 0.5;
        }
        
        .comment-text {
            font-size: 0.95rem;
            line-height: 1.4;
        }
        
        .comment-input-container {
            display: flex;
            gap: 10px;
            padding: 15px 0;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            position: sticky;
            bottom: 0;
            background: #1a1a1a;
        }
        
        .comment-input {
            flex: 1;
            background: rgba(255, 255, 255, 0.08);
            border: none;
            padding: 10px 15px;
            border-radius: 20px;
            color: white;
            font-size: 0.95rem;
            outline: none;
            transition: all 0.3s ease;
        }
        
        .comment-input:focus {
            background: rgba(255, 255, 255, 0.12);
        }
        
        .comment-send-btn {
            background: var(--secondary-gradient);
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .comment-send-btn:hover {
            transform: scale(1.05);
        }
        
        .comment-send-btn:active {
            transform: scale(0.95);
        }
        
        /* Enhanced Discover Page */
        .discover-container {
            position: fixed;
            top: 60px;
            left: 0;
            right: 0;
            bottom: 60px;
            bottom: calc(60px + var(--safe-area-bottom));
            overflow-y: auto;
            background: #000;
            display: none;
            padding: 20px;
            max-width: 480px;
            margin: 0 auto;
        }
        
        .trending-section {
            margin-bottom: 30px;
        }
        
        .section-title {
            font-size: 1.3rem;
            font-weight: 700;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .trending-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }
        
        .trending-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            overflow: hidden;
            cursor: pointer;
            transition: all var(--animation-speed) ease;
            position: relative;
        }
        
        .trending-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .trending-card:hover {
            transform: scale(1.02);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }
        
        .trending-card:hover::before {
            opacity: 1;
        }
        
        .trending-media {
            width: 100%;
            aspect-ratio: 1;
            object-fit: cover;
        }
        
        .trending-info {
            padding: 12px;
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 1;
        }
        
        .trending-title {
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .trending-stats {
            display: flex;
            gap: 15px;
            font-size: 0.85rem;
            opacity: 0.7;
        }
        
        /* Edit Profile Modal */
        #editProfileModal .modal-content {
            max-height: 80vh;
            overflow-y: auto;
        }
        
        /* Mobile Optimizations */
        @media (max-width: 480px) {
            .header-center {
                gap: 15px;
                padding: 8px 20px;
            }
            
            .header-tab {
                font-size: 1rem;
            }
            
            .post-actions {
                right: 10px;
                gap: 15px;
            }
            
            .action-icon {
                width: 42px;
                height: 42px;
                font-size: 1.2rem;
            }
            
            .user-avatar {
                width: 48px;
                height: 48px;
            }
            
            .trending-grid {
                gap: 10px;
            }
        }
        
        /* Landscape Mode Fixes */
        @media (orientation: landscape) and (max-height: 500px) {
            .feed-header {
                padding: 10px 20px;
            }
            
            .bottom-nav {
                padding: 5px 0;
            }
            
            .nav-label {
                display: none;
            }
            
            .post-actions {
                bottom: 80px;
            }
        }
        
        /* Animation Performance */
        @media (prefers-reduced-motion: reduce) {
            *,
            *::before,
            *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
        
        /* High Contrast Mode */
        @media (prefers-contrast: high) {
            .glass-effect {
                background: rgba(0, 0, 0, 0.8);
                border: 2px solid white;
            }
            
            .form-input,
            .form-textarea {
                border: 2px solid white;
            }
        }
        
        /* Dark Mode Adjustments */
        @media (prefers-color-scheme: light) {
            /* Keep dark theme as default */
        }
        
        /* Accessibility Improvements */
        .visually-hidden {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
        
        /* Focus Indicators */
        *:focus-visible {
            outline: 2px solid var(--primary-color);
            outline-offset: 2px;
        }
        
        /* Loading States */
        .skeleton {
            background: linear-gradient(90deg, #222 25%, #333 50%, #222 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }
        
        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        /* Error States */
        .error-message {
            background: rgba(244, 67, 54, 0.1);
            border: 1px solid rgba(244, 67, 54, 0.3);
            color: #ff6b6b;
            padding: 10px 15px;
            border-radius: 10px;
            font-size: 0.9rem;
            margin-bottom: 15px;
        }
        
        /* Success States */
        .success-message {
            background: rgba(76, 175, 80, 0.1);
            border: 1px solid rgba(76, 175, 80, 0.3);
            color: #4caf50;
            padding: 10px 15px;
            border-radius: 10px;
            font-size: 0.9rem;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen">
        <div class="login-content">
            <div class="app-logo">🎮</div>
            <h1 class="app-title">JomBro</h1>
            <p class="app-subtitle">Let's Go! Let's Go!</p>
            <button class="quick-start-btn" onclick="App.quickStart()">
                <span>Start Playing →</span>
            </button>
        </div>
    </div>
    
    <!-- Feed Header -->
    <div class="feed-header" style="display: none;">
        <div class="header-left">JomBro</div>
        <div class="header-center">
            <button class="header-tab" onclick="App.switchFeed('stalking')">Stalking</button>
            <button class="header-tab active" onclick="App.switchFeed('trustmebro')">Trust Me Bro!</button>
        </div>
        <div class="header-right" onclick="App.showSearch()">🔍</div>
    </div>
    
    <!-- Main Feed -->
    <div class="feed-container" id="feedContainer" style="display: none;">
        <!-- Posts will be dynamically loaded here -->
    </div>
    
    <!-- Discover Container -->
    <div class="discover-container" id="discoverContainer">
        <!-- Discover content will be loaded here -->
    </div>
    
    <!-- Bottom Navigation -->
    <div class="bottom-nav" id="bottomNav" style="display: none;">
        <button class="nav-item active" onclick="App.switchNav('home', this)">
            <span class="nav-icon">🏠</span>
            <span class="nav-label">Home</span>
        </button>
        <button class="nav-item" onclick="App.switchNav('discover', this)">
            <span class="nav-icon">🔥</span>
            <span class="nav-label">Discover</span>
        </button>
        <button class="nav-item create-btn" onclick="App.openCamera()">
            <span class="nav-icon">➕</span>
        </button>
        <button class="nav-item" onclick="App.switchNav('inbox', this)">
            <span class="nav-icon">💬</span>
            <span class="nav-label">Inbox</span>
        </button>
        <button class="nav-item" onclick="App.showProfile()">
            <span class="nav-icon">👤</span>
            <span class="nav-label">Profile</span>
        </button>
    </div>
    
    <!-- Loading Spinner -->
    <div class="loading-spinner" id="loadingSpinner"></div>
    
    <!-- Profile Modal -->
    <div class="modal" id="profileModal">
        <div class="modal-content">
            <div class="profile-modal-scroll" id="profileContent">
                <!-- Profile content will be dynamically loaded -->
            </div>
        </div>
    </div>
    
    <!-- Camera Modal -->
    <div class="modal" id="cameraModal">
        <div class="modal-content">
            <div class="camera-container">
                <video id="cameraVideo" autoplay playsinline muted></video>
                <video id="recordedVideo" style="display: none;" playsinline></video>
                
                <div class="camera-close" onclick="App.closeCamera()">✕</div>
                <div class="camera-flip" onclick="App.flipCamera()">🔄</div>
                
                <div class="timer" id="recordTimer">00:00</div>
                
                <div class="camera-controls">
                    <div class="gallery-btn" onclick="document.getElementById('galleryInput').click()">
                        🖼️
                    </div>
                    <div class="camera-btn" id="recordBtn" onclick="App.toggleRecording()"></div>
                    <div style="width: 50px;"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Challenge Select Modal -->
    <div class="modal" id="challengeModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Select Challenge</h2>
                <button class="close-btn" onclick="App.closeModal('challengeModal')">✕</button>
            </div>
            <div class="challenge-section" id="challengeList">
                <!-- Challenges will be loaded here -->
            </div>
        </div>
    </div>
    
    <!-- Comments Modal -->
    <div class="modal" id="commentsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Comments</h2>
                <button class="close-btn" onclick="App.closeModal('commentsModal')">✕</button>
            </div>
            <div class="comments-list" id="commentsList">
                <!-- Comments will be loaded here -->
            </div>
            <div class="comment-input-container">
                <input type="text" class="comment-input" placeholder="Add a comment..." id="commentInput">
                <button class="comment-send-btn" onclick="App.postComment()">Send</button>
            </div>
        </div>
    </div>
    
    <!-- Search Modal -->
    <div class="modal" id="searchModal">
        <div class="modal-content">
            <div class="search-header">
                <div class="search-input-container">
                    <span>🔍</span>
                    <input type="text" class="search-input" placeholder="Search users, challenges..." id="searchInput" oninput="App.performSearch()">
                    <button class="close-btn" onclick="App.closeModal('searchModal')" style="width: auto; height: auto; background: none;">✕</button>
                </div>
            </div>
            <div class="search-results" id="searchResults">
                <!-- Search results will be loaded here -->
            </div>
        </div>
    </div>
    
    <!-- Inbox Modal -->
    <div class="modal" id="inboxModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Messages</h2>
                <button class="close-btn" onclick="App.closeModal('inboxModal')">✕</button>
            </div>
            <div class="chat-list" id="chatList" style="max-height: 70vh; overflow-y: auto;">
                <!-- Chat items will be loaded here -->
            </div>
        </div>
    </div>
    
    <!-- Friend Tag Modal -->
    <div class="modal" id="friendTagModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Tag Friends</h2>
                <button class="close-btn" onclick="App.closeModal('friendTagModal')">✕</button>
            </div>
            <div class="friend-list" id="friendList">
                <!-- Friend list will be loaded here -->
            </div>
            <button class="submit-btn" onclick="App.confirmFriendTags()">Tag Selected Friends</button>
        </div>
    </div>
    
    <!-- Post Upload Modal -->
    <div class="modal" id="postUploadModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Share Your Challenge</h2>
                <button class="close-btn" onclick="App.closeModal('postUploadModal')">✕</button>
            </div>
            <div class="form-group">
                <label class="form-label">Caption</label>
                <textarea class="form-textarea" id="postCaption" rows="3" placeholder="Write a caption..."></textarea>
            </div>
            <div class="form-group">
                <label class="form-label">Tag Friends</label>
                <button class="form-input" style="cursor: pointer; text-align: left;" onclick="App.showFriendTag()">
                    <span id="taggedFriendsText">Select friends to tag...</span>
                </button>
            </div>
            <div class="form-group">
                <label class="form-label">Challenge</label>
                <div class="challenge-card" id="selectedChallengeCard" style="cursor: default;">
                    <!-- Selected challenge will be shown here -->
                </div>
            </div>
            <button class="submit-btn" onclick="App.uploadPost()">Share Challenge 🚀</button>
        </div>
    </div>
    
    <!-- Edit Profile Modal -->
    <div class="modal" id="editProfileModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Edit Profile</h2>
                <button class="close-btn" onclick="App.closeModal('editProfileModal')">✕</button>
            </div>
            <div id="editProfileForm">
                <!-- Edit form will be loaded here -->
            </div>
        </div>
    </div>
    
    <!-- Hidden file inputs -->
    <input type="file" id="galleryInput" class="file-input" accept="image/*,video/*" onchange="App.handleGalleryUpload(event)">
    <input type="file" id="avatarInput" class="file-input" accept="image/*" onchange="App.handleAvatarUpload(event)">
    <input type="file" id="coverInput" class="file-input" accept="image/*" onchange="App.handleCoverUpload(event)">
    
    <script>
        'use strict';
        
        // App namespace with improved architecture
        const App = {
            // Firebase config
            firebaseConfig: {
                apiKey: "AIzaSyC_orriRUuf1ynDiFaJAPrO6-Gu3GeURxQ",
                authDomain: "jombro-9d129.firebaseapp.com",
                projectId: "jombro-9d129",
                storageBucket: "jombro-9d129.firebasestorage.app",
                messagingSenderId: "390572076435",
                appId: "1:390572076435:web:781f9f62b84542eb834c66"
            },
            
            // App state with better structure
            state: {
                currentUser: null,
                userData: null,
                feedPosts: [],
                currentPostIndex: 0,
                selectedChallenge: null,
                aiChallenges: [],
                usedChallenges: new Set(),
                challengeTimer: null,
                userPosts: [],
                currentGalleryFile: null,
                currentUploadFile: null,
                selectedFriends: new Set(),
                deferredPrompt: null,
                isFirstTime: true,
                isRecording: false,
                recordingStartTime: null,
                recordingTimer: null,
                mediaRecorder: null,
                recordedChunks: [],
                currentStream: null,
                currentCamera: 'user',
                comments: {},
                searchResults: [],
                chatMessages: [],
                friends: [],
                discoverContent: {},
                // Performance tracking
                lastScrollTime: 0,
                scrollThrottle: null,
                // UI state
                isModalOpen: false,
                activeModal: null,
                // Cache
                imageCache: new Map(),
                videoCache: new Map()
            },
            
            // Improved AI Challenge Templates with more variety
            aiChallengeTemplates: {
                fitness: [
                    { title: "20 Push-ups Challenge", description: "Complete 20 push-ups with proper form", reward: 100 },
                    { title: "1 Minute Plank", description: "Hold a plank position for 60 seconds", reward: 150 },
                    { title: "50 Jumping Jacks", description: "Do 50 jumping jacks non-stop", reward: 80 },
                    { title: "Wall Sit Challenge", description: "Hold wall sit for 45 seconds", reward: 120 },
                    { title: "Burpee Challenge", description: "Complete 15 burpees", reward: 200 },
                    { title: "Mountain Climbers", description: "30 seconds of mountain climbers", reward: 130 },
                    { title: "Squat Challenge", description: "25 squats with proper form", reward: 110 },
                    { title: "Lunges Marathon", description: "20 alternating lunges", reward: 90 }
                ],
                creative: [
                    { title: "Dance Battle", description: "Show your best 30-second dance moves", reward: 150 },
                    { title: "Beatbox Challenge", description: "Create a 20-second beatbox rhythm", reward: 120 },
                    { title: "Drawing Speed Run", description: "Draw JomBro logo in 30 seconds", reward: 100 },
                    { title: "Origami Challenge", description: "Make a paper crane in under 2 minutes", reward: 180 },
                    { title: "Freestyle Rap", description: "Rap about JomBro for 30 seconds", reward: 200 },
                    { title: "Sing Along", description: "Sing your favorite song chorus", reward: 130 },
                    { title: "Magic Trick", description: "Perform a simple magic trick", reward: 160 },
                    { title: "Voice Impressions", description: "Do 3 celebrity impressions", reward: 140 }
                ],
                social: [
                    { title: "Compliment Spree", description: "Give 5 genuine compliments to strangers", reward: 150 },
                    { title: "Random Act of Kindness", description: "Do something nice for someone", reward: 200 },
                    { title: "Teach Something", description: "Teach a skill in 60 seconds", reward: 180 },
                    { title: "Make Someone Laugh", description: "Tell jokes until someone laughs", reward: 100 },
                    { title: "High Five Marathon", description: "Get 10 high fives from different people", reward: 120 },
                    { title: "Spread Positivity", description: "Leave 3 positive messages", reward: 140 },
                    { title: "Team Challenge", description: "Complete a task with a friend", reward: 170 },
                    { title: "Interview Someone", description: "Ask 5 interesting questions", reward: 130 }
                ],
                food: [
                    { title: "Spicy Challenge", description: "Eat something super spicy without water", reward: 150 },
                    { title: "Blindfold Taste Test", description: "Guess 5 foods while blindfolded", reward: 130 },
                    { title: "Speed Eating", description: "Finish a meal in under 5 minutes", reward: 100 },
                    { title: "Cook Without Recipe", description: "Create a dish without any instructions", reward: 200 },
                    { title: "Chopstick Master", description: "Eat an entire meal with chopsticks", reward: 80 },
                    { title: "Food Art", description: "Create art with your food", reward: 160 },
                    { title: "Mystery Ingredient", description: "Cook with a random ingredient", reward: 180 },
                    { title: "No Hands Challenge", description: "Eat a snack without using hands", reward: 120 }
                ],
                gaming: [
                    { title: "No Death Run", description: "Complete a game level without dying", reward: 180 },
                    { title: "Speedrun Challenge", description: "Beat your best time in any game", reward: 150 },
                    { title: "Blindfold Gaming", description: "Play a game blindfolded for 2 minutes", reward: 200 },
                    { title: "One Hand Gaming", description: "Win a match using only one hand", reward: 160 },
                    { title: "Retro Game Master", description: "High score on any classic game", reward: 140 },
                    { title: "Rage Quit Challenge", description: "Play without rage quitting", reward: 170 },
                    { title: "Tutorial Speedrun", description: "Complete tutorial in record time", reward: 90 },
                    { title: "Backwards Controls", description: "Play with inverted controls", reward: 190 }
                ]
            },
            
            // Performance optimizations
            debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            },
            
            throttle(func, limit) {
                let inThrottle;
                return function(...args) {
                    if (!inThrottle) {
                        func.apply(this, args);
                        inThrottle = true;
                        setTimeout(() => inThrottle = false, limit);
                    }
                };
            },
            
            // Initialize app with better error handling
            async init() {
                try {
                    // Performance mark
                    performance.mark('app-init-start');
                    
                    // Initialize Firebase
                    await this.initFirebase();
                    
                    // Load saved data
                    this.loadSavedData();
                    
                    // Check if first time user
                    this.checkFirstTimeUser();
                    
                    // Setup PWA
                    this.setupPWA();
                    
                    // Setup event listeners with better organization
                    this.setupEventListeners();
                    
                    // Initialize features
                    await this.initializeFeatures();
                    
                    // Performance measure
                    performance.mark('app-init-end');
                    performance.measure('app-init', 'app-init-start', 'app-init-end');
                    
                    console.log('App initialized successfully! 🚀');
                    
                } catch (error) {
                    console.error('App initialization error:', error);
                    this.showToast('Error initializing app. Some features may be limited.');
                    // Continue in offline mode
                    this.initializeFeatures();
                }
            },
            
            // Initialize Firebase with better error handling
            async initFirebase() {
                try {
                    firebase.initializeApp(this.firebaseConfig);
                    this.db = firebase.firestore();
                    this.storage = firebase.storage();
                    console.log('Firebase initialized! 🔥');
                    
                    // Enable offline persistence
                    await this.db.enablePersistence().catch(err => {
                        if (err.code === 'failed-precondition') {
                            console.log('Multiple tabs open, persistence disabled');
                        } else if (err.code === 'unimplemented') {
                            console.log('Browser doesn\'t support persistence');
                        }
                    });
                } catch (error) {
                    console.warn('Firebase initialization failed, running in offline mode:', error);
                    this.db = null;
                    this.storage = null;
                }
            },
            
            // Initialize features with async support
            async initializeFeatures() {
                // Load saved challenges
                const saved = localStorage.getItem('usedChallenges');
                if (saved) {
                    this.state.usedChallenges = new Set(JSON.parse(saved));
                }
                
                // Load user posts
                this.loadUserPosts();
                
                // Setup swipe gestures with better touch handling
                this.setupSwipeGestures();
                
                // Generate initial AI challenges
                this.generateAIChallenges();
                
                // Load sample data
                this.loadSampleData();
                
                // Preload critical assets
                this.preloadAssets();
            },
            
            // Preload critical assets
            preloadAssets() {
                // Preload fonts
                const font = new FontFace('Montserrat', 'url(https://fonts.gstatic.com/s/montserrat/v25/JTUSjIg1_i6t8kCHKm459Wlhzg.woff2)');
                font.load().catch(console.warn);
                
                // Preload critical images
                const criticalImages = [
                    'https://picsum.photos/400/800?random=1',
                    'https://picsum.photos/400/800?random=2'
                ];
                
                criticalImages.forEach(src => {
                    const img = new Image();
                    img.src = src;
                    this.state.imageCache.set(src, img);
                });
            },
            
            // Improved sample data loading
            loadSampleData() {
                // Sample friends with more variety
                this.state.friends = [
                    { id: 'f1', name: 'Sarah Chen', username: 'sarahc', avatar: '👩', bio: 'Fitness enthusiast', followers: 1234 },
                    { id: 'f2', name: 'Mike Johnson', username: 'mikej', avatar: '👨', bio: 'Gamer & Creator', followers: 5678 },
                    { id: 'f3', name: 'Emma Wilson', username: 'emmaw', avatar: '👱‍♀️', bio: 'Dance lover', followers: 9012 },
                    { id: 'f4', name: 'Alex Kumar', username: 'alexk', avatar: '🧑', bio: 'Tech geek', followers: 3456 },
                    { id: 'f5', name: 'Lisa Park', username: 'lisap', avatar: '👩‍🦰', bio: 'Foodie & Chef', followers: 7890 },
                    { id: 'f6', name: 'David Lee', username: 'davidl', avatar: '👨‍💼', bio: 'Business minded', followers: 2345 },
                    { id: 'f7', name: 'Maria Garcia', username: 'mariag', avatar: '💃', bio: 'Artist & Creative', followers: 6789 },
                    { id: 'f8', name: 'James Kim', username: 'jamesk', avatar: '🤵', bio: 'Musician', followers: 4567 }
                ];
                
                // Enhanced sample comments
                this.state.comments = {
                    'post1': [
                        { id: 'c1', author: 'Sarah Chen', avatar: '👩', text: 'Amazing form! Keep it up 💪', time: '2m ago', likes: 5 },
                        { id: 'c2', author: 'Mike Johnson', avatar: '👨', text: 'Goals! I need to try this challenge', time: '5m ago', likes: 3 },
                        { id: 'c3', author: 'Emma Wilson', avatar: '👱‍♀️', text: 'You make it look so easy!', time: '10m ago', likes: 7 }
                    ],
                    'post2': [
                        { id: 'c4', author: 'Alex Kumar', avatar: '🧑', text: 'Those moves are fire! 🔥🔥', time: '10m ago', likes: 12 },
                        { id: 'c5', author: 'Lisa Park', avatar: '👩‍🦰', text: 'Tutorial please!', time: '15m ago', likes: 8 },
                        { id: 'c6', author: 'David Lee', avatar: '👨‍💼', text: 'Smooth! Can you teach me?', time: '20m ago', likes: 4 }
                    ]
                };
                
                // Enhanced chat messages
                this.state.chatMessages = [
                    { id: 'm1', name: 'Sarah Chen', avatar: '👩', preview: 'Hey! Want to do a challenge together?', time: '2m', unread: 2, online: true },
                    { id: 'm2', name: 'Gaming Squad', avatar: '🎮', preview: 'Mike: Who\'s up for the speedrun?', time: '15m', unread: 5, online: false, isGroup: true },
                    { id: 'm3', name: 'Emma Wilson', avatar: '👱‍♀️', preview: 'That was hilarious 😂', time: '1h', unread: 0, online: true },
                    { id: 'm4', name: 'Challenge Group', avatar: '🏆', preview: 'New fitness challenge posted!', time: '3h', unread: 1, online: false, isGroup: true },
                    { id: 'm5', name: 'Alex Kumar', avatar: '🧑', preview: 'Thanks for the tips!', time: '5h', unread: 0, online: false },
                    { id: 'm6', name: 'Food Lovers', avatar: '🍕', preview: 'Lisa: Check out my new recipe!', time: '1d', unread: 3, online: false, isGroup: true }
                ];
                
                // Enhanced discover content
                this.state.discoverContent = {
                    trending: [
                        { id: 't1', title: '#PushupChallenge', views: '2.3M', likes: '234K', image: 'https://picsum.photos/200/200?random=10' },
                        { id: 't2', title: '#DanceOff2025', views: '1.8M', likes: '189K', image: 'https://picsum.photos/200/200?random=11' },
                        { id: 't3', title: '#SpicyFoodChallenge', views: '945K', likes: '98K', image: 'https://picsum.photos/200/200?random=12' },
                        { id: 't4', title: '#GamingMarathon', views: '623K', likes: '67K', image: 'https://picsum.photos/200/200?random=13' },
                        { id: 't5', title: '#ArtChallenge', views: '512K', likes: '56K', image: 'https://picsum.photos/200/200?random=14' },
                        { id: 't6', title: '#CookingChallenge', views: '489K', likes: '45K', image: 'https://picsum.photos/200/200?random=15' }
                    ],
                    topCreators: [
                        { id: 'tc1', name: 'ProGamer123', followers: '125K', avatar: '🎮', verified: true },
                        { id: 'tc2', name: 'FitnessFanatic', followers: '98K', avatar: '💪', verified: true },
                        { id: 'tc3', name: 'DanceMachine', followers: '87K', avatar: '💃', verified: false },
                        { id: 'tc4', name: 'FoodieAdventure', followers: '76K', avatar: '🍕', verified: true },
                        { id: 'tc5', name: 'ArtistExtraordinaire', followers: '65K', avatar: '🎨', verified: false },
                        { id: 'tc6', name: 'ComedyKing', followers: '54K', avatar: '😂', verified: true }
                    ],
                    categories: [
                        { name: 'Fitness', icon: '💪', color: '#ff6b6b' },
                        { name: 'Dance', icon: '💃', color: '#4ecdc4' },
                        { name: 'Gaming', icon: '🎮', color: '#7c5ce6' },
                        { name: 'Food', icon: '🍔', color: '#f39c12' },
                        { name: 'Art', icon: '🎨', color: '#e91e63' },
                        { name: 'Comedy', icon: '😂', color: '#3498db' }
                    ]
                };
            },
            
            // Check first time user with better logic
            checkFirstTimeUser() {
                const hasVisited = localStorage.getItem('hasVisitedJomBro');
                const lastVisit = localStorage.getItem('lastVisitJomBro');
                const now = Date.now();
                
                if (!hasVisited) {
                    this.state.isFirstTime = true;
                    localStorage.setItem('hasVisitedJomBro', 'true');
                    localStorage.setItem('lastVisitJomBro', now.toString());
                } else {
                    this.state.isFirstTime = false;
                    // Check if returning user after long time
                    if (lastVisit && now - parseInt(lastVisit) > 30 * 24 * 60 * 60 * 1000) {
                        this.showToast('Welcome back! Check out new challenges 🎮');
                    }
                    localStorage.setItem('lastVisitJomBro', now.toString());
                }
            },
            
            // Enhanced PWA setup
            setupPWA() {
                if ('serviceWorker' in navigator) {
                    // Try to register external service worker first
                    navigator.serviceWorker.register('sw.js').catch(() => {
                        console.log('External SW registration failed, creating inline SW');
                        this.createInlineServiceWorker();
                    });
                    
                    // Listen for updates
                    navigator.serviceWorker.addEventListener('controllerchange', () => {
                        this.showToast('App updated! Refresh for new features 🔄');
                    });
                }
                
                // Handle install prompt
                window.addEventListener('beforeinstallprompt', (e) => {
                    e.preventDefault();
                    this.state.deferredPrompt = e;
                    // Show install button after user engagement
                    setTimeout(() => this.showInstallPrompt(), 30000);
                });
                
                // Handle app installed
                window.addEventListener('appinstalled', () => {
                    console.log('JomBro installed! 🎉');
                    this.showToast('JomBro installed successfully! 🎉');
                    // Track installation
                    this.trackEvent('app_installed');
                });
            },
            
            // Show install prompt
            showInstallPrompt() {
                if (this.state.deferredPrompt && !this.state.isFirstTime) {
                    const installBtn = document.createElement('button');
                    installBtn.className = 'install-prompt';
                    installBtn.innerHTML = '📱 Install JomBro App';
                    installBtn.style.cssText = `
                        position: fixed;
                        bottom: 80px;
                        left: 50%;
                        transform: translateX(-50%);
                        background: var(--primary-gradient);
                        color: white;
                        border: none;
                        padding: 15px 30px;
                        border-radius: 30px;
                        font-weight: 600;
                        z-index: 500;
                        animation: slideInUp 0.5s ease;
                    `;
                    
                    installBtn.onclick = async () => {
                        this.state.deferredPrompt.prompt();
                        const { outcome } = await this.state.deferredPrompt.userChoice;
                        console.log(`Install prompt outcome: ${outcome}`);
                        installBtn.remove();
                        this.state.deferredPrompt = null;
                    };
                    
                    document.body.appendChild(installBtn);
                    setTimeout(() => installBtn.remove(), 10000);
                }
            },
            
            // Enhanced inline service worker
            createInlineServiceWorker() {
                const swCode = `
                    const CACHE_NAME = 'jombro-v1';
                    const urlsToCache = [
                        '/',
                        'https://fonts.googleapis.com/css2?family=Montserrat:wght@100;200;300;400;500;600;700&display=swap',
                        'https://fonts.gstatic.com/s/montserrat/v25/JTUSjIg1_i6t8kCHKm459Wlhzg.woff2'
                    ];
                    
                    self.addEventListener('install', event => {
                        event.waitUntil(
                            caches.open(CACHE_NAME)
                                .then(cache => cache.addAll(urlsToCache))
                                .then(() => self.skipWaiting())
                        );
                    });
                    
                    self.addEventListener('activate', event => {
                        event.waitUntil(
                            caches.keys().then(cacheNames => {
                                return Promise.all(
                                    cacheNames.map(cacheName => {
                                        if (cacheName !== CACHE_NAME) {
                                            return caches.delete(cacheName);
                                        }
                                    })
                                );
                            }).then(() => self.clients.claim())
                        );
                    });
                    
                    self.addEventListener('fetch', event => {
                        event.respondWith(
                            caches.match(event.request)
                                .then(response => {
                                    if (response) {
                                        return response;
                                    }
                                    return fetch(event.request).then(response => {
                                        if (!response || response.status !== 200 || response.type !== 'basic') {
                                            return response;
                                        }
                                        const responseToCache = response.clone();
                                        caches.open(CACHE_NAME).then(cache => {
                                            cache.put(event.request, responseToCache);
                                        });
                                        return response;
                                    });
                                })
                        );
                    });
                `;
                
                const blob = new Blob([swCode], { type: 'application/javascript' });
                const swUrl = URL.createObjectURL(blob);
                navigator.serviceWorker.register(swUrl);
            },
            
            // Enhanced event listeners setup
            setupEventListeners() {
                // Navigation events
                window.addEventListener('popstate', this.handleBackButton.bind(this));
                
                // Network events
                window.addEventListener('online', () => {
                    this.showToast('Back online! 🌐');
                    this.syncOfflineData();
                });
                window.addEventListener('offline', () => this.showToast('Offline mode 📵'));
                
                // Visibility change
                document.addEventListener('visibilitychange', this.handleVisibilityChange.bind(this));
                
                // Keyboard events with better handling
                document.addEventListener('keydown', this.handleKeyboard.bind(this));
                
                // Enhanced haptic feedback
                if ('vibrate' in navigator) {
                    document.addEventListener('click', (e) => {
                        if (e.target.matches('button, .nav-item, .action-icon, .camera-btn')) {
                            navigator.vibrate(10);
                        }
                    });
                }
                
                // Orientation change
                window.addEventListener('orientationchange', this.handleOrientationChange.bind(this));
                
                // Resize handling with debounce
                window.addEventListener('resize', this.debounce(() => {
                    this.handleResize();
                }, 250));
                
                // Scroll events with throttle
                const feedContainer = document.getElementById('feedContainer');
                if (feedContainer) {
                    feedContainer.addEventListener('scroll', this.throttle(() => {
                        this.handleScroll();
                    }, 100));
                }
                
                // Touch events for better mobile experience
                this.setupTouchEvents();
                
                // Intersection Observer for lazy loading
                this.setupIntersectionObserver();
                
                // Performance observer
                this.setupPerformanceObserver();
            },
            
            // Setup touch events
            setupTouchEvents() {
                let touchStartX = 0;
                let touchStartY = 0;
                let touchEndX = 0;
                let touchEndY = 0;
                
                const handleTouchStart = (e) => {
                    touchStartX = e.touches[0].clientX;
                    touchStartY = e.touches[0].clientY;
                };
                
                const handleTouchMove = (e) => {
                    // Prevent overscroll on iOS
                    if (e.target.closest('.modal')) {
                        e.stopPropagation();
                    }
                };
                
                const handleTouchEnd = (e) => {
                    touchEndX = e.changedTouches[0].clientX;
                    touchEndY = e.changedTouches[0].clientY;
                    this.handleSwipe(touchStartX - touchEndX, touchStartY - touchEndY);
                };
                
                document.addEventListener('touchstart', handleTouchStart, { passive: true });
                document.addEventListener('touchmove', handleTouchMove, { passive: false });
                document.addEventListener('touchend', handleTouchEnd, { passive: true });
            },
            
            // Enhanced swipe handling
            handleSwipe(swipeX, swipeY) {
                const threshold = 50;
                const ratio = Math.abs(swipeX) / Math.abs(swipeY);
                const feedContainer = document.getElementById('feedContainer');
                
                // Only handle vertical swipes in feed
                if (feedContainer && feedContainer.style.display !== 'none' && ratio < 0.5) {
                    if (Math.abs(swipeY) > threshold) {
                        if (swipeY > 0) {
                            this.nextPost();
                        } else {
                            this.previousPost();
                        }
                    }
                }
            },
            
            // Setup Intersection Observer for better performance
            setupIntersectionObserver() {
                const options = {
                    root: null,
                    rootMargin: '0px',
                    threshold: [0.5, 0.75]
                };
                
                this.postObserver = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting && entry.intersectionRatio >= 0.75) {
                            const index = parseInt(entry.target.getAttribute('data-index'));
                            this.state.currentPostIndex = index;
                            
                            // Play video if present
                            const video = entry.target.querySelector('.post-video');
                            if (video && video.paused) {
                                video.play().catch(err => console.log('Autoplay prevented:', err));
                            }
                            
                            // Update view count
                            this.updateViewCount(index);
                        } else {
                            // Pause video when not visible
                            const video = entry.target.querySelector('.post-video');
                            if (video && !video.paused) {
                                video.pause();
                            }
                        }
                    });
                }, options);
            },
            
            // Setup Performance Observer
            setupPerformanceObserver() {
                if ('PerformanceObserver' in window) {
                    // Observe long tasks
                    try {
                        const observer = new PerformanceObserver((list) => {
                            for (const entry of list.getEntries()) {
                                if (entry.duration > 50) {
                                    console.warn('Long task detected:', entry);
                                }
                            }
                        });
                        observer.observe({ entryTypes: ['longtask'] });
                    } catch (e) {
                        // Not supported in all browsers
                    }
                }
            },
            
            // Handle orientation change
            handleOrientationChange() {
                const orientation = window.orientation;
                if (orientation === 90 || orientation === -90) {
                    document.body.classList.add('landscape');
                } else {
                    document.body.classList.remove('landscape');
                }
            },
            
            // Handle resize
            handleResize() {
                // Update CSS variables for dynamic sizing
                const vh = window.innerHeight * 0.01;
                document.documentElement.style.setProperty('--vh', `${vh}px`);
            },
            
            // Handle scroll with performance optimizations
            handleScroll() {
                const now = Date.now();
                if (now - this.state.lastScrollTime > 100) {
                    this.state.lastScrollTime = now;
                    
                    // Update header background on scroll
                    const feedContainer = document.getElementById('feedContainer');
                    const header = document.querySelector('.feed-header');
                    if (feedContainer && header) {
                        if (feedContainer.scrollTop > 50) {
                            header.classList.add('scrolled');
                        } else {
                            header.classList.remove('scrolled');
                        }
                    }
                }
            },
            
            // Sync offline data when back online
            async syncOfflineData() {
                if (!this.db) return;
                
                try {
                    // Sync user posts
                    const offlinePosts = this.state.userPosts.filter(post => !post.synced);
                    for (const post of offlinePosts) {
                        await this.db.collection('posts').doc(post.id).set(post);
                        post.synced = true;
                    }
                    
                    // Sync user data
                    if (this.state.currentUser && this.state.userData) {
                        await this.db.collection('users').doc(this.state.currentUser.uid).set(this.state.userData);
                    }
                    
                    this.saveData();
                    console.log('Offline data synced successfully');
                } catch (error) {
                    console.error('Error syncing offline data:', error);
                }
            },
            
            // Track events for analytics
            trackEvent(eventName, params = {}) {
                // Implement analytics tracking here
                console.log('Event tracked:', eventName, params);
                
                // Store events for offline sync if needed
                const events = JSON.parse(localStorage.getItem('pendingEvents') || '[]');
                events.push({ name: eventName, params, timestamp: Date.now() });
                localStorage.setItem('pendingEvents', JSON.stringify(events));
            },
            
            // Navigation functions with smooth scrolling
            nextPost() {
                const container = document.getElementById('feedContainer');
                const posts = container.querySelectorAll('.feed-post');
                if (this.state.currentPostIndex < posts.length - 1) {
                    this.state.currentPostIndex++;
                    posts[this.state.currentPostIndex].scrollIntoView({ 
                        behavior: 'smooth',
                        block: 'start'
                    });
                    
                    // Preload next video
                    if (this.state.currentPostIndex < posts.length - 1) {
                        const nextVideo = posts[this.state.currentPostIndex + 1].querySelector('.post-video');
                        if (nextVideo) {
                            nextVideo.load();
                        }
                    }
                }
            },
            
            previousPost() {
                const container = document.getElementById('feedContainer');
                const posts = container.querySelectorAll('.feed-post');
                if (this.state.currentPostIndex > 0) {
                    this.state.currentPostIndex--;
                    posts[this.state.currentPostIndex].scrollIntoView({ 
                        behavior: 'smooth',
                        block: 'start'
                    });
                }
            },
            
            // Enhanced keyboard handling
            handleKeyboard(e) {
                // Ignore if typing in input
                if (e.target.matches('input, textarea')) return;
                
                const keyMap = {
                    'ArrowUp': () => this.previousPost(),
                    'ArrowDown': () => this.nextPost(),
                    'k': () => this.previousPost(),
                    'j': () => this.nextPost(),
                    'l': () => {
                        const currentPost = this.state.feedPosts[this.state.currentPostIndex];
                        if (currentPost) this.toggleLike(currentPost.id);
                    },
                    ' ': (e) => {
                        e.preventDefault();
                        const video = document.querySelector(`.feed-post:nth-child(${this.state.currentPostIndex + 1}) video`);
                        if (video) {
                            video.paused ? video.play() : video.pause();
                        }
                    },
                    'Escape': () => {
                        if (this.state.isModalOpen && this.state.activeModal) {
                            this.closeModal(this.state.activeModal);
                        }
                    }
                };
                
                const handler = keyMap[e.key];
                if (handler) handler(e);
            },
            
            // Enhanced back button handling
            handleBackButton(e) {
                if (this.state.isModalOpen && this.state.activeModal) {
                    e.preventDefault();
                    this.closeModal(this.state.activeModal);
                    return;
                }
                
                // Handle navigation states
                const discoverContainer = document.getElementById('discoverContainer');
                if (discoverContainer && discoverContainer.style.display !== 'none') {
                    e.preventDefault();
                    this.switchNav('home', document.querySelector('.nav-item.active'));
                }
            },
            
            // Enhanced visibility change handling
            handleVisibilityChange() {
                if (document.hidden) {
                    // Pause all videos
                    document.querySelectorAll('video').forEach(video => video.pause());
                    
                    // Save state
                    this.saveData();
                    
                    // Clear timers
                    if (this.state.recordingTimer) {
                        clearInterval(this.state.recordingTimer);
                    }
                } else {
                    // Resume current video
                    const currentVideo = document.querySelector(`.feed-post:nth-child(${this.state.currentPostIndex + 1}) video`);
                    if (currentVideo && this.isElementInViewport(currentVideo)) {
                        currentVideo.play().catch(() => {});
                    }
                }
            },
            
            // Check if element is in viewport
            isElementInViewport(el) {
                const rect = el.getBoundingClientRect();
                return (
                    rect.top >= 0 &&
                    rect.left >= 0 &&
                    rect.bottom <= (window.innerHeight || document.documentElement.clientHeight) &&
                    rect.right <= (window.innerWidth || document.documentElement.clientWidth)
                );
            },
            
            // Enhanced data persistence
            loadSavedData() {
                try {
                    const savedUser = localStorage.getItem('currentUser');
                    if (savedUser) {
                        this.state.currentUser = JSON.parse(savedUser);
                    }
                    
                    const savedProfile = localStorage.getItem('userProfile');
                    if (savedProfile) {
                        this.state.userData = JSON.parse(savedProfile);
                    }
                    
                    const savedChallenges = localStorage.getItem('completedChallenges');
                    if (savedChallenges) {
                        this.state.completedChallenges = JSON.parse(savedChallenges);
                    }
                } catch (error) {
                    console.error('Error loading saved data:', error);
                    // Clear corrupted data
                    localStorage.removeItem('currentUser');
                    localStorage.removeItem('userProfile');
                }
            },
            
            // Enhanced data saving with compression
            saveData() {
                try {
                    if (this.state.currentUser) {
                        localStorage.setItem('currentUser', JSON.stringify(this.state.currentUser));
                    }
                    if (this.state.userData) {
                        localStorage.setItem('userProfile', JSON.stringify(this.state.userData));
                    }
                    
                    // Save challenge progress
                    const challengeProgress = {
                        completed: Array.from(this.state.usedChallenges),
                        timestamp: Date.now()
                    };
                    localStorage.setItem('challengeProgress', JSON.stringify(challengeProgress));
                } catch (error) {
                    if (error.name === 'QuotaExceededError') {
                        console.warn('Storage quota exceeded, clearing old data');
                        this.clearOldData();
                    }
                }
            },
            
            // Clear old data when storage is full
            clearOldData() {
                // Clear old posts
                const posts = this.state.userPosts;
                if (posts.length > 50) {
                    this.state.userPosts = posts.slice(-50);
                    this.saveUserPosts();
                }
                
                // Clear old cache
                this.state.imageCache.clear();
                this.state.videoCache.clear();
            },
            
            // Enhanced user posts management
            loadUserPosts() {
                try {
                    const savedPosts = localStorage.getItem('userPosts');
                    if (savedPosts) {
                        this.state.userPosts = JSON.parse(savedPosts);
                    }
                } catch (error) {
                    console.error('Error loading user posts:', error);
                    this.state.userPosts = [];
                }
            },
            
            saveUserPosts() {
                try {
                    localStorage.setItem('userPosts', JSON.stringify(this.state.userPosts));
                } catch (error) {
                    console.error('Error saving user posts:', error);
                }
            },
            
            // Enhanced toast notifications
            showToast(message, duration = 3000, type = 'info') {
                const existingToast = document.querySelector('.toast');
                if (existingToast) existingToast.remove();
                
                const toast = document.createElement('div');
                toast.className = `toast toast-${type}`;
                toast.innerHTML = `
                    <span class="toast-message">${message}</span>
                    <button class="toast-close" onclick="this.parentElement.remove()">×</button>
                `;
                
                // Add type-specific styling
                const typeStyles = {
                    'success': 'background: rgba(76, 175, 80, 0.9);',
                    'error': 'background: rgba(244, 67, 54, 0.9);',
                    'warning': 'background: rgba(255, 152, 0, 0.9);',
                    'info': 'background: rgba(0, 0, 0, 0.9);'
                };
                
                toast.style.cssText += typeStyles[type] || typeStyles.info;
                
                document.body.appendChild(toast);
                
                // Auto remove
                setTimeout(() => {
                    toast.style.animation = 'toastSlideDown 0.3s ease forwards';
                    setTimeout(() => toast.remove(), 300);
                }, duration);
            },
            
            // Enhanced loading states
            showLoading(message = '') {
                const spinner = document.getElementById('loadingSpinner');
                spinner.style.display = 'block';
                
                if (message) {
                    spinner.innerHTML = `
                        <div class="loading-message">${message}</div>
                    `;
                }
            },
            
            hideLoading() {
                const spinner = document.getElementById('loadingSpinner');
                spinner.style.display = 'none';
                spinner.innerHTML = '';
            },
            
            // Enhanced quick start with better UX
            async quickStart() {
                try {
                    console.log('Quick start initiated! 🚀');
                    
                    // Show loading
                    this.showLoading('Setting up your account...');
                    
                    // Generate user with better defaults
                    const userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                    const randomAdjectives = ['Epic', 'Super', 'Mega', 'Ultra', 'Pro', 'Master', 'Legend', 'Elite'];
                    const randomNouns = ['Gamer', 'Challenger', 'Player', 'Warrior', 'Champion', 'Hero', 'Star', 'Boss'];
                    const randomName = randomAdjectives[Math.floor(Math.random() * randomAdjectives.length)] + 
                                      randomNouns[Math.floor(Math.random() * randomNouns.length)] + 
                                      Math.floor(Math.random() * 999);
                    
                    this.state.currentUser = {
                        uid: userId,
                        name: randomName,
                        joinDate: Date.now()
                    };
                    
                    // Create enhanced user data
                    this.state.userData = {
                        name: this.state.currentUser.name,
                        avatar: ['🎮', '🎯', '🏆', '⭐', '🔥', '💎', '🎪', '🎨'][Math.floor(Math.random() * 8)],
                        avatarImage: '',
                        coverImage: '',
                        bio: 'Ready to take on any challenge! 🚀',
                        location: 'Malaysia',
                        tokens: 1000,
                        level: 1,
                        xp: 0,
                        nextLevelXp: 1000,
                        completedChallenges: 0,
                        followers: 0,
                        following: 0,
                        posts: 0,
                        streak: 0,
                        badges: ['newcomer'],
                        achievements: [],
                        stats: {
                            totalLikes: 0,
                            totalComments: 0,
                            totalShares: 0,
                            totalViews: 0
                        },
                        preferences: {
                            favoriteCategories: [],
                            notifications: true,
                            privacy: 'public'
                        },
                        social: {
                            instagram: '',
                            tiktok: '',
                            facebook: '',
                            website: '',
                            whatsapp: '',
                            email: ''
                        }
                    };
                    
                    // Save data
                    this.saveData();
                    
                    // Save to Firestore if available
                    if (this.db) {
                        try {
                            await this.db.collection('users').doc(userId).set({
                                ...this.state.userData,
                                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                                lastActive: firebase.firestore.FieldValue.serverTimestamp()
                            });
                        } catch (error) {
                            console.log('Offline mode - Firestore save queued');
                        }
                    }
                    
                    // Hide loading
                    this.hideLoading();
                    
                    // Animate transition
                    const loginScreen = document.getElementById('loginScreen');
                    loginScreen.style.animation = 'fadeOut 0.5s ease forwards';
                    
                    setTimeout(() => {
                        // Show app
                        loginScreen.style.display = 'none';
                        document.getElementById('feedContainer').style.display = 'block';
                        document.querySelector('.feed-header').style.display = 'flex';
                        document.getElementById('bottomNav').style.display = 'flex';
                        
                        // Start features
                        this.startChallengeTimer();
                        this.loadFeed();
                        
                        // Show welcome message
                        setTimeout(() => {
                            this.showToast(`Welcome ${this.state.currentUser.name}! 🎮`, 5000, 'success');
                        }, 500);
                        
                        // Show tutorial if first time
                        if (this.state.isFirstTime) {
                            setTimeout(() => this.showTutorial(), 2000);
                        }
                        
                        // Track event
                        this.trackEvent('quick_start_completed');
                    }, 500);
                    
                } catch (error) {
                    console.error('Error in quickStart:', error);
                    this.hideLoading();
                    this.showToast('Error starting app. Please refresh and try again.', 5000, 'error');
                }
            },
            
            // Enhanced tutorial
            showTutorial() {
                const steps = [
                    {
                        title: 'Welcome to JomBro! 🎮',
                        content: 'Your ultimate challenge & reward platform',
                        icon: '🎮'
                    },
                    {
                        title: 'Browse Challenges',
                        content: 'Swipe up/down to explore amazing challenges',
                        icon: '📱'
                    },
                    {
                        title: 'Complete & Earn',
                        content: 'Record yourself completing challenges to earn tokens',
                        icon: '🎯'
                    },
                    {
                        title: 'AI Scoring',
                        content: 'Our AI automatically rates your performance',
                        icon: '🤖'
                    },
                    {
                        title: 'Level Up!',
                        content: 'Gain XP, unlock badges, and climb the leaderboard',
                        icon: '🏆'
                    }
                ];
                
                let currentStep = 0;
                
                const tutorial = document.createElement('div');
                tutorial.className = 'tutorial-overlay';
                tutorial.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.95);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 10000;
                    padding: 20px;
                `;
                
                const updateStep = () => {
                    const step = steps[currentStep];
                    tutorial.innerHTML = `
                        <div style="background: #1a1a1a; border-radius: 20px; padding: 40px; max-width: 400px; text-align: center; position: relative;">
                            <div style="font-size: 4rem; margin-bottom: 20px; animation: bounce 2s infinite;">${step.icon}</div>
                            <h2 style="font-size: 1.5rem; margin-bottom: 15px;">${step.title}</h2>
                            <p style="font-size: 1rem; opacity: 0.8; margin-bottom: 30px;">${step.content}</p>
                            <div style="display: flex; gap: 10px; justify-content: center; margin-bottom: 20px;">
                                ${steps.map((_, i) => `
                                    <div style="width: 8px; height: 8px; border-radius: 50%; background: ${i === currentStep ? 'white' : 'rgba(255,255,255,0.3)'}; transition: all 0.3s;"></div>
                                `).join('')}
                            </div>
                            <button onclick="App.nextTutorialStep()" style="background: var(--primary-gradient); color: white; border: none; padding: 12px 40px; border-radius: 25px; font-size: 1.1rem; font-weight: 600; cursor: pointer;">
                                ${currentStep < steps.length - 1 ? 'Next →' : "Let's Go! 🚀"}
                            </button>
                        </div>
                    `;
                };
                
                window.App.nextTutorialStep = () => {
                    currentStep++;
                    if (currentStep >= steps.length) {
                        tutorial.style.animation = 'fadeOut 0.5s ease forwards';
                        setTimeout(() => tutorial.remove(), 500);
                        this.trackEvent('tutorial_completed');
                    } else {
                        updateStep();
                    }
                };
                
                updateStep();
                document.body.appendChild(tutorial);
            },
            
            // Enhanced AI challenge generation
            generateAIChallenges() {
                const categories = Object.keys(this.aiChallengeTemplates);
                const challenges = [];
                const usedTemplates = new Set();
                
                // Generate unique challenges
                while (challenges.length < 15) {
                    const category = categories[Math.floor(Math.random() * categories.length)];
                    const templates = this.aiChallengeTemplates[category];
                    const template = templates[Math.floor(Math.random() * templates.length)];
                    
                    const templateKey = `${category}-${template.title}`;
                    if (!usedTemplates.has(templateKey)) {
                        usedTemplates.add(templateKey);
                        
                        // Create enhanced challenge
                        const challenge = {
                            id: 'ai_' + Date.now() + '_' + challenges.length,
                            ...template,
                            category: category,
                            difficulty: ['Easy', 'Medium', 'Hard'][Math.floor(Math.random() * 3)],
                            timeLimit: Math.floor(Math.random() * 60) + 30,
                            participants: Math.floor(Math.random() * 5000) + 100,
                            trending: Math.random() > 0.7,
                            bonus: Math.random() > 0.8 ? Math.floor(template.reward * 0.5) : 0,
                            xpReward: Math.floor(template.reward * 0.1),
                            dedication: ['open-public', 'people-i-know', 'specific-friends'][Math.floor(Math.random() * 3)],
                            tags: this.generateChallengeTags(category, template.title),
                            createdAt: Date.now() - Math.floor(Math.random() * 7 * 24 * 60 * 60 * 1000),
                            expiresAt: Date.now() + Math.floor(Math.random() * 7 * 24 * 60 * 60 * 1000)
                        };
                        
                        challenges.push(challenge);
                    }
                }
                
                // Sort by trending and participants
                challenges.sort((a, b) => {
                    if (a.trending && !b.trending) return -1;
                    if (!a.trending && b.trending) return 1;
                    return b.participants - a.participants;
                });
                
                this.state.aiChallenges = challenges;
            },
            
            // Generate challenge tags
            generateChallengeTags(category, title) {
                const baseTags = [`#${category}Challenge`];
                const words = title.toLowerCase().split(' ');
                words.forEach(word => {
                    if (word.length > 3 && !['challenge', 'with', 'your', 'best'].includes(word)) {
                        baseTags.push(`#${word}`);
                    }
                });
                return baseTags.slice(0, 3);
            },
            
            // Enhanced feed loading
            async loadFeed() {
                try {
                    this.showLoading('Loading challenges...');
                    const container = document.getElementById('feedContainer');
                    
                    // Enhanced sample posts
                    const samplePosts = [
                        {
                            id: 'post1',
                            user: { 
                                name: 'alex_gamer', 
                                avatar: '😎',
                                verified: true,
                                level: 15
                            },
                            challenge: { 
                                title: '20 Pushup Challenge', 
                                category: 'fitness', 
                                reward: 100,
                                xpReward: 10,
                                dedication: 'people-i-know'
                            },
                            caption: 'Just crushed the pushup challenge! 💪 Who\'s next?',
                            likes: 234,
                            comments: 45,
                            shares: 12,
                            views: 1532,
                            mediaType: 'image',
                            mediaUrl: 'https://picsum.photos/400/800?random=1',
                            aiScore: 92,
                            timestamp: Date.now() - 3600000,
                            location: 'Kuala Lumpur',
                            tags: ['#fitness', '#pushupchallenge'],
                            isMyPost: false
                        },
                        {
                            id: 'post2',
                            user: { 
                                name: 'dance_queen', 
                                avatar: '💃',
                                verified: false,
                                level: 8
                            },
                            challenge: { 
                                title: 'TikTok Dance', 
                                category: 'creative', 
                                reward: 150,
                                xpReward: 15,
                                dedication: 'open-public'
                            },
                            caption: 'New dance moves! Who wants to learn? 🕺✨',
                            likes: 567,
                            comments: 89,
                            shares: 34,
                            views: 3421,
                            mediaType: 'image',
                            mediaUrl: 'https://picsum.photos/400/800?random=2',
                            aiScore: 88,
                            timestamp: Date.now() - 7200000,
                            location: 'Petaling Jaya',
                            tags: ['#dance', '#creative', '#trending'],
                            isMyPost: false
                        },
                        {
                            id: 'post3',
                            user: { 
                                name: 'foodie_master', 
                                avatar: '🍕',
                                verified: true,
                                level: 22
                            },
                            challenge: { 
                                title: 'Spicy Challenge', 
                                category: 'food', 
                                reward: 180,
                                xpReward: 18,
                                dedication: 'open-public'
                            },
                            caption: 'Level 10 spicy ramen completed! 🔥🍜 My tongue is on fire!',
                            likes: 892,
                            comments: 156,
                            shares: 45,
                            views: 5234,
                            mediaType: 'image',
                            mediaUrl: 'https://picsum.photos/400/800?random=3',
                            aiScore: 95,
                            timestamp: Date.now() - 10800000,
                            trending: true,
                            location: 'Subang Jaya',
                            tags: ['#spicychallenge', '#foodie', '#extreme'],
                            isMyPost: false
                        }
                    ];
                    
                    // Combine with user posts
                    const allPosts = [...this.state.userPosts, ...samplePosts].sort((a, b) => b.timestamp - a.timestamp);
                    
                    // Clear existing posts
                    container.innerHTML = '';
                    
                    // Create post elements with optimizations
                    const fragment = document.createDocumentFragment();
                    
                    allPosts.forEach((post, index) => {
                        const postElement = this.createPostElement(post, index);
                        fragment.appendChild(postElement);
                    });
                    
                    container.appendChild(fragment);
                    this.state.feedPosts = allPosts;
                    
                    // Setup observers
                    this.setupPostObservers();
                    
                    // Preload next images
                    this.preloadNextPosts();
                    
                    this.hideLoading();
                    
                    // Load from Firebase if available
                    if (this.db) {
                        this.loadFirebasePosts();
                    }
                    
                } catch (error) {
                    console.error('Error loading feed:', error);
                    this.hideLoading();
                    this.showToast('Error loading feed', 3000, 'error');
                }
            },
            
            // Load posts from Firebase
            async loadFirebasePosts() {
                if (!this.db) return;
                
                try {
                    const snapshot = await this.db.collection('posts')
                        .orderBy('timestamp', 'desc')
                        .limit(20)
                        .get();
                    
                    const firebasePosts = [];
                    snapshot.forEach(doc => {
                        firebasePosts.push({ id: doc.id, ...doc.data() });
                    });
                    
                    if (firebasePosts.length > 0) {
                        // Merge with existing posts
                        this.mergePosts(firebasePosts);
                    }
                } catch (error) {
                    console.log('Error loading Firebase posts:', error);
                }
            },
            
            // Merge posts intelligently
            mergePosts(newPosts) {
                const existingIds = new Set(this.state.feedPosts.map(p => p.id));
                const uniqueNewPosts = newPosts.filter(p => !existingIds.has(p.id));
                
                if (uniqueNewPosts.length > 0) {
                    this.state.feedPosts = [...this.state.feedPosts, ...uniqueNewPosts]
                        .sort((a, b) => b.timestamp - a.timestamp);
                    
                    // Update UI
                    this.loadFeed();
                }
            },
            
            // Enhanced post element creation
            createPostElement(post, index) {
                const postDiv = document.createElement('div');
                postDiv.className = 'feed-post gpu-accelerated';
                postDiv.setAttribute('data-index', index);
                postDiv.setAttribute('data-post-id', post.id);
                
                // Media element with lazy loading
                const mediaElement = post.mediaType === 'video' 
                    ? `<video class="post-video" data-src="${post.mediaUrl}" muted loop playsinline preload="none"></video>`
                    : `<img class="post-image" data-src="${post.mediaUrl}" alt="Challenge" loading="lazy">`;
                
                postDiv.innerHTML = `
                    <div class="post-media">
                        ${mediaElement}
                        <div class="frame-wrapper frame-gradient-border"></div>
                    </div>
                    
                    <div class="gradient-overlay-top"></div>
                    <div class="gradient-overlay-bottom"></div>
                    
                    ${post.aiScore ? `
                        <div style="position: absolute; top: 110px; left: 20px; background: linear-gradient(135deg, rgba(74, 144, 226, 0.9), rgba(138, 56, 236, 0.9)); backdrop-filter: blur(10px); padding: 8px 16px; border-radius: 20px; display: flex; align-items: center; gap: 8px; z-index: 25; border: 2px solid rgba(255, 255, 255, 0.3); box-shadow: 0 4px 15px rgba(74, 144, 226, 0.5);">
                            <span style="font-size: 1.1rem;">🤖</span>
                            <span style="font-weight: 700; font-size: 0.95rem;">AI Score: ${post.aiScore}%</span>
                        </div>
                    ` : ''}
                    
                    ${post.trending ? `
                        <div style="position: absolute; top: 110px; right: 20px; background: linear-gradient(135deg, rgba(255, 107, 107, 0.9), rgba(255, 142, 83, 0.9)); backdrop-filter: blur(10px); padding: 6px 14px; border-radius: 18px; display: flex; align-items: center; gap: 6px; z-index: 25; border: 2px solid rgba(255, 255, 255, 0.3); animation: pulse 2s infinite;">
                            <span>🔥</span>
                            <span style="font-weight: 600; font-size: 0.85rem;">Trending</span>
                        </div>
                    ` : ''}
                    
                    <!-- Enhanced Side Actions -->
                    <div class="post-actions">
                        <div class="action-item">
                            <div class="user-avatar" onclick="App.viewProfile('${post.user.name}')">
                                ${post.user.avatar}
                                ${post.user.verified ? '<div style="position: absolute; bottom: -2px; right: -2px; background: #1DA1F2; width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 2px solid black; font-size: 0.7rem;">✓</div>' : ''}
                                ${!post.isMyPost ? `<div class="follow-btn" onclick="event.stopPropagation(); App.followUser('${post.user.name}')">+</div>` : ''}
                            </div>
                            ${post.user.level ? `<div style="font-size: 0.7rem; margin-top: 5px; background: rgba(255,255,255,0.1); padding: 2px 6px; border-radius: 10px;">Lv ${post.user.level}</div>` : ''}
                        </div>
                        
                        <div class="action-item" onclick="App.toggleLike('${post.id}')">
                            <div class="action-icon ${post.liked ? 'liked' : ''}" id="like-${post.id}">❤️</div>
                            <div class="action-count">${this.formatCount(post.likes)}</div>
                        </div>
                        
                        <div class="action-item" onclick="App.showComments('${post.id}')">
                            <div class="action-icon">💬</div>
                            <div class="action-count">${this.formatCount(post.comments)}</div>
                        </div>
                        
                        <div class="action-item" onclick="App.sharePost('${post.id}')">
                            <div class="action-icon">↗️</div>
                            <div class="action-count">${post.shares ? this.formatCount(post.shares) : 'Share'}</div>
                        </div>
                        
                        <div class="action-item" onclick="App.savePost('${post.id}')">
                            <div class="action-icon ${post.saved ? 'saved' : ''}">🔖</div>
                            <div class="action-count">Save</div>
                        </div>
                    </div>
                    
                    <!-- Enhanced Bottom Info -->
                    <div class="post-info">
                        <div class="post-user" onclick="App.viewProfile('${post.user.name}')">
                            @${post.user.name}
                            ${post.location ? `<span style="font-size: 0.8rem; opacity: 0.7; margin-left: 10px;">📍 ${post.location}</span>` : ''}
                        </div>
                        <div class="challenge-badge" onclick="App.viewChallenge('${post.challenge.title}')">
                            🎯 ${post.challenge.title} • 🪙 ${post.challenge.reward} ${post.challenge.bonus ? `+${post.challenge.bonus} bonus` : ''}
                        </div>
                        <div class="post-caption">
                            ${post.caption}
                            ${post.tags ? `<div style="margin-top: 8px;">${post.tags.map(tag => `<span style="color: #3897f0; margin-right: 8px; cursor: pointer;" onclick="App.searchTag('${tag}')">${tag}</span>`).join('')}</div>` : ''}
                        </div>
                        <div class="post-music">
                            <span class="music-icon">🎵</span>
                            <span>Original sound - ${post.user.name}</span>
                        </div>
                        ${post.views ? `<div style="font-size: 0.8rem; opacity: 0.6; margin-top: 5px;">👁️ ${this.formatCount(post.views)} views</div>` : ''}
                    </div>
                `;
                
                // Setup lazy loading for media
                requestAnimationFrame(() => {
                    const media = postDiv.querySelector('.post-video, .post-image');
                    if (media && media.dataset.src) {
                        // Use Intersection Observer for lazy loading
                        this.lazyLoadMedia(media);
                    }
                });
                
                return postDiv;
            },
            
            // Lazy load media
            lazyLoadMedia(element) {
                const observer = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            const media = entry.target;
                            media.src = media.dataset.src;
                            media.removeAttribute('data-src');
                            
                            media.onload = media.onloadeddata = () => {
                                media.classList.add('loaded');
                            };
                            
                            observer.unobserve(media);
                        }
                    });
                }, { rootMargin: '50px' });
                
                observer.observe(element);
            },
            
            // Setup post observers
            setupPostObservers() {
                document.querySelectorAll('.feed-post').forEach(post => {
                    this.postObserver.observe(post);
                });
            },
            
            // Preload next posts
            preloadNextPosts() {
                const currentIndex = this.state.currentPostIndex;
                const posts = this.state.feedPosts;
                
                // Preload next 2 posts
                for (let i = currentIndex + 1; i <= currentIndex + 2 && i < posts.length; i++) {
                    const post = posts[i];
                    if (post.mediaUrl) {
                        if (post.mediaType === 'video') {
                            // Preload video metadata
                            const video = document.createElement('video');
                            video.preload = 'metadata';
                            video.src = post.mediaUrl;
                        } else {
                            // Preload image
                            const img = new Image();
                            img.src = post.mediaUrl;
                            this.state.imageCache.set(post.mediaUrl, img);
                        }
                    }
                }
            },
            
            // Update view count
            updateViewCount(index) {
                const post = this.state.feedPosts[index];
                if (post && !post.viewCounted) {
                    post.views = (post.views || 0) + 1;
                    post.viewCounted = true;
                    
                    // Update in Firebase if available
                    if (this.db && post.id) {
                        this.db.collection('posts').doc(post.id).update({
                            views: firebase.firestore.FieldValue.increment(1)
                        }).catch(() => {});
                    }
                }
            },
            
            // Format count with better logic
            formatCount(count) {
                if (count >= 1000000) {
                    return (count / 1000000).toFixed(1).replace(/\.0$/, '') + 'M';
                } else if (count >= 1000) {
                    return (count / 1000).toFixed(1).replace(/\.0$/, '') + 'K';
                }
                return count.toString();
            },
            
            // Enhanced like functionality
            toggleLike(postId) {
                const likeBtn = document.getElementById(`like-${postId}`);
                const post = this.state.feedPosts.find(p => p.id === postId);
                
                if (!post) return;
                
                if (likeBtn.classList.contains('liked')) {
                    likeBtn.classList.remove('liked');
                    post.likes--;
                    post.liked = false;
                } else {
                    likeBtn.classList.add('liked');
                    post.likes++;
                    post.liked = true;
                    
                    // Create enhanced heart animation
                    this.createHeartAnimation(likeBtn);
                    
                    // Haptic feedback
                    if ('vibrate' in navigator) {
                        navigator.vibrate([10, 20, 10]);
                    }
                }
                
                // Update count
                const countElement = likeBtn.nextElementSibling;
                if (countElement) {
                    countElement.textContent = this.formatCount(post.likes);
                }
                
                // Save to Firebase
                if (this.db && post.id) {
                    this.db.collection('posts').doc(post.id).update({
                        likes: post.likes,
                        likedBy: post.liked 
                            ? firebase.firestore.FieldValue.arrayUnion(this.state.currentUser.uid)
                            : firebase.firestore.FieldValue.arrayRemove(this.state.currentUser.uid)
                    }).catch(() => {});
                }
                
                // Update user stats
                this.state.userData.stats.totalLikes += post.liked ? 1 : -1;
                this.saveData();
            },
            
            // Enhanced heart animation
            createHeartAnimation(element) {
                const hearts = ['❤️', '💕', '💖', '💗', '💝'];
                const heart = document.createElement('div');
                heart.textContent = hearts[Math.floor(Math.random() * hearts.length)];
                heart.style.cssText = `
                    position: absolute;
                    font-size: ${2 + Math.random() * 2}rem;
                    animation: heartFloat ${1 + Math.random() * 0.5}s ease-out forwards;
                    pointer-events: none;
                    z-index: 1000;
                    filter: drop-shadow(0 0 10px rgba(255, 0, 100, 0.5));
                `;
                
                const rect = element.getBoundingClientRect();
                heart.style.left = rect.left + rect.width / 2 - 20 + (Math.random() - 0.5) * 40 + 'px';
                heart.style.top = rect.top + rect.height / 2 - 20 + 'px';
                
                document.body.appendChild(heart);
                
                setTimeout(() => heart.remove(), 1500);
            },
            
            // View profile
            viewProfile(username) {
                console.log('Viewing profile:', username);
                // Implement profile viewing
                this.showToast(`Viewing ${username}'s profile`);
            },
            
            // Follow user
            followUser(username) {
                this.state.userData.following = (this.state.userData.following || 0) + 1;
                this.saveData();
                this.showToast(`Following @${username}! ✨`, 2000, 'success');
                
                // Track event
                this.trackEvent('user_followed', { username });
            },
            
            // View challenge details
            viewChallenge(challengeTitle) {
                const challenge = this.state.aiChallenges.find(c => c.title === challengeTitle);
                if (challenge) {
                    // Show challenge details modal
                    this.showChallengeDetails(challenge);
                }
            },
            
            // Search by tag
            searchTag(tag) {
                document.getElementById('searchInput').value = tag;
                this.showSearch();
                this.performSearch();
            },
            
            // Save post
            savePost(postId) {
                const post = this.state.feedPosts.find(p => p.id === postId);
                if (post) {
                    post.saved = !post.saved;
                    const saveBtn = document.querySelector(`#like-${postId}`).parentElement.parentElement.querySelector('.action-icon:last-child');
                    if (saveBtn) {
                        saveBtn.classList.toggle('saved');
                    }
                    this.showToast(post.saved ? 'Post saved! 🔖' : 'Post unsaved');
                }
            },
            
            // Switch feed type
            switchFeed(type) {
                document.querySelectorAll('.header-tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                event.target.classList.add('active');
                
                const displayName = type === 'stalking' ? 'Stalking' : 'Trust Me Bro!';
                this.showToast(`Switched to ${displayName} feed`, 2000);
                
                // Reload feed with different content
                this.loadFeed();
                
                // Track event
                this.trackEvent('feed_switched', { type });
            },
            
            // Enhanced navigation switching
            switchNav(nav, element) {
                // Update active state
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.classList.remove('active');
                });
                element.classList.add('active');
                
                // Hide all containers
                document.getElementById('feedContainer').style.display = 'none';
                document.getElementById('discoverContainer').style.display = 'none';
                
                // Handle navigation
                switch(nav) {
                    case 'home':
                        document.getElementById('feedContainer').style.display = 'block';
                        // Resume current video
                        const currentVideo = document.querySelector(`.feed-post:nth-child(${this.state.currentPostIndex + 1}) video`);
                        if (currentVideo) currentVideo.play().catch(() => {});
                        break;
                        
                    case 'discover':
                        document.getElementById('discoverContainer').style.display = 'block';
                        this.loadDiscover();
                        break;
                        
                    case 'inbox':
                        this.showInbox();
                        break;
                }
                
                // Track navigation
                this.trackEvent('navigation', { to: nav });
            },
            
            // Enhanced camera functionality
            async openCamera() {
                try {
                    // Show challenge selection first
                    await this.showChallengeSelect();
                    
                    if (!this.state.selectedChallenge) return;
                    
                    // Check camera permission
                    const permission = await this.checkCameraPermission();
                    if (!permission) {
                        this.showToast('Camera permission required', 3000, 'error');
                        return;
                    }
                    
                    // Open camera modal
                    this.showModal('cameraModal');
                    
                    // Request camera with better constraints
                    const constraints = {
                        video: {
                            facingMode: this.state.currentCamera,
                            width: { ideal: 1920 },
                            height: { ideal: 1080 },
                            aspectRatio: { ideal: 9/16 }
                        },
                        audio: {
                            echoCancellation: true,
                            noiseSuppression: true,
                            autoGainControl: true
                        }
                    };
                    
                    const stream = await navigator.mediaDevices.getUserMedia(constraints);
                    
                    this.state.currentStream = stream;
                    const video = document.getElementById('cameraVideo');
                    video.srcObject = stream;
                    
                    // Show recording tips
                    this.showRecordingTips();
                    
                } catch (error) {
                    console.error('Camera error:', error);
                    let errorMessage = 'Camera access denied or not available';
                    
                    if (error.name === 'NotAllowedError') {
                        errorMessage = 'Please allow camera access in your browser settings';
                    } else if (error.name === 'NotFoundError') {
                        errorMessage = 'No camera found on this device';
                    }
                    
                    this.showToast(errorMessage, 5000, 'error');
                    this.closeModal('cameraModal');
                }
            },
            
            // Check camera permission
            async checkCameraPermission() {
                if (!navigator.permissions) return true;
                
                try {
                    const result = await navigator.permissions.query({ name: 'camera' });
                    return result.state !== 'denied';
                } catch {
                    return true; // Assume permission if API not available
                }
            },
            
            // Show recording tips
            showRecordingTips() {
                const tips = [
                    'Good lighting makes a difference! 💡',
                    'Keep your device steady for best results 📱',
                    'Show your full movement in frame 🎯',
                    'Have fun and be creative! 🎨',
                    'Clear audio helps with scoring 🎤'
                ];
                
                const randomTip = tips[Math.floor(Math.random() * tips.length)];
                
                const tipElement = document.createElement('div');
                tipElement.style.cssText = `
                    position: absolute;
                    top: 150px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: rgba(0, 0, 0, 0.8);
                    padding: 10px 20px;
                    border-radius: 20px;
                    font-size: 0.9rem;
                    z-index: 100;
                    animation: fadeInOut 3s ease forwards;
                `;
                tipElement.textContent = randomTip;
                
                document.querySelector('.camera-container').appendChild(tipElement);
                setTimeout(() => tipElement.remove(), 3000);
            },
            
            // Enhanced challenge selection
            showChallengeSelect() {
                return new Promise((resolve) => {
                    const modal = document.getElementById('challengeModal');
                    const list = document.getElementById('challengeList');
                    
                    // Clear existing
                    list.innerHTML = '';
                    
                    // Group challenges by category
                    const grouped = {};
                    this.state.aiChallenges.forEach(challenge => {
                        if (!grouped[challenge.category]) {
                            grouped[challenge.category] = [];
                        }
                        grouped[challenge.category].push(challenge);
                    });
                    
                    // Create category sections
                    Object.entries(grouped).forEach(([category, challenges]) => {
                        const section = document.createElement('div');
                        section.innerHTML = `
                            <h3 style="font-size: 1.1rem; margin: 20px 0 10px; opacity: 0.8;">
                                ${this.getCategoryEmoji(category)} ${category.charAt(0).toUpperCase() + category.slice(1)}
                            </h3>
                        `;
                        
                        challenges.forEach(challenge => {
                            const card = document.createElement('div');
                            card.className = 'challenge-card';
                            card.onclick = () => {
                                this.state.selectedChallenge = challenge;
                                this.closeModal('challengeModal');
                                resolve();
                            };
                            
                            const difficultyColors = {
                                'Easy': '#4caf50',
                                'Medium': '#ff9800',
                                'Hard': '#f44336'
                            };
                            
                            card.innerHTML = `
                                <div class="challenge-header">
                                    <div>
                                        <div class="challenge-title">${challenge.title}</div>
                                        <div class="challenge-category">
                                            ${this.getCategoryEmoji(challenge.category)} ${challenge.category}
                                        </div>
                                    </div>
                                    <div style="text-align: right;">
                                        <div class="challenge-reward">
                                            🪙 ${challenge.reward}
                                            ${challenge.bonus ? `<span style="font-size: 0.8rem; color: #ffd700;">+${challenge.bonus}</span>` : ''}
                                        </div>
                                        <div style="font-size: 0.8rem; margin-top: 5px; color: ${difficultyColors[challenge.difficulty]}">
                                            ${challenge.difficulty}
                                        </div>
                                    </div>
                                </div>
                                <div class="challenge-description">${challenge.description}</div>
                                <div class="challenge-meta">
                                    <span>⏱️ ${challenge.timeLimit}s</span>
                                    <span>👥 ${this.formatCount(challenge.participants)} joined</span>
                                    <span>⭐ +${challenge.xpReward} XP</span>
                                    ${challenge.trending ? '<span style="color: #ff6b6b;">🔥 Trending</span>' : ''}
                                </div>
                            `;
                            
                            section.appendChild(card);
                        });
                        
                        list.appendChild(section);
                    });
                    
                    this.showModal('challengeModal');
                });
            },
            
            // Get category emoji
            getCategoryEmoji(category) {
                const emojis = {
                    fitness: '💪',
                    creative: '🎨',
                    social: '🤝',
                    food: '🍔',
                    gaming: '🎮'
                };
                return emojis[category] || '🎯';
            },
            
            // Close camera
            closeCamera() {
                if (this.state.currentStream) {
                    this.state.currentStream.getTracks().forEach(track => track.stop());
                    this.state.currentStream = null;
                }
                
                if (this.state.isRecording) {
                    this.stopRecording();
                }
                
                // Reset video elements
                document.getElementById('cameraVideo').srcObject = null;
                document.getElementById('recordedVideo').src = '';
                
                this.closeModal('cameraModal');
                this.state.selectedChallenge = null;
            },
            
            // Flip camera
            async flipCamera() {
                this.state.currentCamera = this.state.currentCamera === 'user' ? 'environment' : 'user';
                
                if (this.state.currentStream) {
                    this.state.currentStream.getTracks().forEach(track => track.stop());
                }
                
                try {
                    const constraints = {
                        video: {
                            facingMode: this.state.currentCamera,
                            width: { ideal: 1920 },
                            height: { ideal: 1080 }
                        },
                        audio: true
                    };
                    
                    const stream = await navigator.mediaDevices.getUserMedia(constraints);
                    
                    this.state.currentStream = stream;
                    const video = document.getElementById('cameraVideo');
                    video.srcObject = stream;
                    
                    // Animate flip
                    video.style.transform = 'rotateY(180deg)';
                    setTimeout(() => {
                        video.style.transform = 'rotateY(0deg)';
                    }, 300);
                    
                } catch (error) {
                    console.error('Camera flip error:', error);
                    this.showToast('Camera switch failed', 3000, 'error');
                    // Revert camera
                    this.state.currentCamera = this.state.currentCamera === 'user' ? 'environment' : 'user';
                }
            },
            
            // Toggle recording
            toggleRecording() {
                if (this.state.isRecording) {
                    this.stopRecording();
                } else {
                    this.startRecording();
                }
            },
            
            // Enhanced recording
            startRecording() {
                if (!this.state.currentStream) return;
                
                this.state.recordedChunks = [];
                
                // Show countdown
                this.showCountdown(() => {
                    // Configure MediaRecorder
                    const options = {
                        mimeType: this.getOptimalMimeType(),
                        videoBitsPerSecond: 2500000
                    };
                    
                    try {
                        this.state.mediaRecorder = new MediaRecorder(this.state.currentStream, options);
                    } catch (e) {
                        console.error('MediaRecorder error:', e);
                        // Fallback to default
                        this.state.mediaRecorder = new MediaRecorder(this.state.currentStream);
                    }
                    
                    this.state.mediaRecorder.ondataavailable = (event) => {
                        if (event.data.size > 0) {
                            this.state.recordedChunks.push(event.data);
                        }
                    };
                    
                    this.state.mediaRecorder.onstop = () => {
                        const blob = new Blob(this.state.recordedChunks, { type: 'video/webm' });
                        this.handleRecordedVideo(blob);
                    };
                    
                    this.state.mediaRecorder.onerror = (error) => {
                        console.error('Recording error:', error);
                        this.showToast('Recording failed', 3000, 'error');
                        this.stopRecording();
                    };
                    
                    this.state.mediaRecorder.start(100); // Collect data every 100ms
                    this.state.isRecording = true;
                    this.state.recordingStartTime = Date.now();
                    
                    // Update UI
                    document.getElementById('recordBtn').classList.add('recording');
                    document.getElementById('recordTimer').style.display = 'block';
                    
                    // Start timer
                    this.updateRecordingTimer();
                    
                    // Show recording indicator
                    this.showRecordingIndicator();
                });
            },
            
            // Get optimal MIME type
            getOptimalMimeType() {
                const types = [
                    'video/webm;codecs=vp9,opus',
                    'video/webm;codecs=vp9',
                    'video/webm;codecs=vp8,opus',
                    'video/webm;codecs=vp8',
                    'video/webm'
                ];
                
                for (const type of types) {
                    if (MediaRecorder.isTypeSupported(type)) {
                        return type;
                    }
                }
                
                return 'video/webm';
            },
            
            // Show countdown
            showCountdown(callback) {
                let count = 3;
                const countdown = document.createElement('div');
                countdown.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    font-size: 5rem;
                    font-weight: bold;
                    color: white;
                    text-shadow: 0 0 20px rgba(0,0,0,0.8);
                    z-index: 1000;
                    animation: countdownPulse 1s ease-in-out;
                `;
                
                const updateCount = () => {
                    if (count > 0) {
                        countdown.textContent = count;
                        countdown.style.animation = 'none';
                        setTimeout(() => {
                            countdown.style.animation = 'countdownPulse 1s ease-in-out';
                        }, 10);
                        count--;
                        setTimeout(updateCount, 1000);
                    } else {
                        countdown.textContent = 'GO!';
                        setTimeout(() => {
                            countdown.remove();
                            callback();
                        }, 500);
                    }
                };
                
                document.body.appendChild(countdown);
                updateCount();
                
                // Add countdown animation
                if (!document.querySelector('#countdownAnimation')) {
                    const style = document.createElement('style');
                    style.id = 'countdownAnimation';
                    style.textContent = `
                        @keyframes countdownPulse {
                            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
                            50% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; }
                            100% { transform: translate(-50%, -50%) scale(1); opacity: 0.8; }
                        }
                    `;
                    document.head.appendChild(style);
                }
            },
            
            // Show recording indicator
            showRecordingIndicator() {
                const indicator = document.createElement('div');
                indicator.id = 'recordingIndicator';
                indicator.style.cssText = `
                    position: absolute;
                    top: 20px;
                    left: 20px;
                    background: red;
                    width: 20px;
                    height: 20px;
                    border-radius: 50%;
                    animation: recordingPulse 1.5s ease-in-out infinite;
                    z-index: 100;
                `;
                
                document.querySelector('.camera-container').appendChild(indicator);
                
                if (!document.querySelector('#recordingPulseAnimation')) {
                    const style = document.createElement('style');
                    style.id = 'recordingPulseAnimation';
                    style.textContent = `
                        @keyframes recordingPulse {
                            0%, 100% { opacity: 1; transform: scale(1); }
                            50% { opacity: 0.5; transform: scale(1.2); }
                        }
                    `;
                    document.head.appendChild(style);
                }
            },
            
            // Stop recording
            stopRecording() {
                if (this.state.mediaRecorder && this.state.isRecording) {
                    this.state.mediaRecorder.stop();
                    this.state.isRecording = false;
                    
                    // Update UI
                    document.getElementById('recordBtn').classList.remove('recording');
                    document.getElementById('recordTimer').style.display = 'none';
                    
                    // Remove recording indicator
                    const indicator = document.getElementById('recordingIndicator');
                    if (indicator) indicator.remove();
                    
                    // Clear timer
                    if (this.state.recordingTimer) {
                        clearInterval(this.state.recordingTimer);
                    }
                    
                    // Show processing
                    this.showLoading('Processing video...');
                }
            },
            
            // Update recording timer
            updateRecordingTimer() {
                this.state.recordingTimer = setInterval(() => {
                    const elapsed = Math.floor((Date.now() - this.state.recordingStartTime) / 1000);
                    const minutes = Math.floor(elapsed / 60).toString().padStart(2, '0');
                    const seconds = (elapsed % 60).toString().padStart(2, '0');
                    document.getElementById('recordTimer').textContent = `${minutes}:${seconds}`;
                    
                    // Auto stop at time limit
                    if (elapsed >= this.state.selectedChallenge.timeLimit) {
                        this.stopRecording();
                        this.showToast('Time limit reached!', 3000, 'warning');
                    }
                }, 100);
            },
            
            // Handle recorded video
            handleRecordedVideo(blob) {
                this.hideLoading();
                
                const url = URL.createObjectURL(blob);
                const video = document.getElementById('recordedVideo');
                video.src = url;
                video.style.display = 'block';
                document.getElementById('cameraVideo').style.display = 'none';
                
                this.state.currentUploadFile = blob;
                
                // Play preview
                video.play();
                
                // Show options
                this.showRecordingOptions();
            },
            
            // Show recording options
            showRecordingOptions() {
                const options = document.createElement('div');
                options.style.cssText = `
                    position: absolute;
                    bottom: 100px;
                    left: 50%;
                    transform: translateX(-50%);
                    display: flex;
                    gap: 20px;
                    z-index: 100;
                `;
                
                options.innerHTML = `
                    <button onclick="App.retakeRecording()" style="background: rgba(255,255,255,0.2); backdrop-filter: blur(10px); border: 2px solid white; color: white; padding: 15px 30px; border-radius: 30px; font-weight: 600; cursor: pointer;">
                        🔄 Retake
                    </button>
                    <button onclick="App.acceptRecording()" style="background: var(--primary-gradient); border: none; color: white; padding: 15px 30px; border-radius: 30px; font-weight: 600; cursor: pointer;">
                        ✅ Continue
                    </button>
                `;
                
                document.querySelector('.camera-container').appendChild(options);
            },
            
            // Retake recording
            retakeRecording() {
                // Reset video elements
                document.getElementById('recordedVideo').style.display = 'none';
                document.getElementById('cameraVideo').style.display = 'block';
                
                // Remove options
                const options = document.querySelector('.camera-container > div:last-child');
                if (options && options.style.position === 'absolute') {
                    options.remove();
                }
                
                // Clear recorded file
                this.state.currentUploadFile = null;
            },
            
            // Accept recording
            acceptRecording() {
                // Close camera and show upload modal
                this.closeCamera();
                this.showPostUpload();
            },
            
            // Handle gallery upload
            async handleGalleryUpload(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                // Validate file
                const maxSize = 100 * 1024 * 1024; // 100MB
                if (file.size > maxSize) {
                    this.showToast('File too large. Maximum size is 100MB', 3000, 'error');
                    return;
                }
                
                this.state.currentUploadFile = file;
                
                // Show challenge select if not already selected
                if (!this.state.selectedChallenge) {
                    await this.showChallengeSelect();
                    if (!this.state.selectedChallenge) {
                        this.state.currentUploadFile = null;
                        return;
                    }
                }
                
                // Close camera if open
                if (this.state.isModalOpen && this.state.activeModal === 'cameraModal') {
                    this.closeCamera();
                }
                
                // Show upload modal
                this.showPostUpload();
                
                // Clear input
                event.target.value = '';
            },
            
            // Show post upload modal
            showPostUpload() {
                if (!this.state.selectedChallenge || !this.state.currentUploadFile) return;
                
                // Update selected challenge card
                const card = document.getElementById('selectedChallengeCard');
                card.innerHTML = `
                    <div class="challenge-header">
                        <div>
                            <div class="challenge-title">${this.state.selectedChallenge.title}</div>
                            <div class="challenge-category">
                                ${this.getCategoryEmoji(this.state.selectedChallenge.category)} ${this.state.selectedChallenge.category}
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div class="challenge-reward">
                                🪙 ${this.state.selectedChallenge.reward}
                                ${this.state.selectedChallenge.bonus ? `<span style="font-size: 0.8rem; color: #ffd700;">+${this.state.selectedChallenge.bonus}</span>` : ''}
                            </div>
                            <div style="font-size: 0.8rem; margin-top: 5px;">
                                +${this.state.selectedChallenge.xpReward} XP
                            </div>
                        </div>
                    </div>
                `;
                
                // Show preview
                const previewContainer = document.createElement('div');
                previewContainer.style.cssText = 'margin: 20px 0; position: relative;';
                
                if (this.state.currentUploadFile.type.startsWith('video/')) {
                    previewContainer.innerHTML = `
                        <video src="${URL.createObjectURL(this.state.currentUploadFile)}" 
                               style="width: 100%; max-height: 200px; object-fit: cover; border-radius: 10px;" 
                               controls></video>
                    `;
                } else {
                    previewContainer.innerHTML = `
                        <img src="${URL.createObjectURL(this.state.currentUploadFile)}" 
                             style="width: 100%; max-height: 200px; object-fit: cover; border-radius: 10px;">
                    `;
                }
                
                card.parentElement.insertBefore(previewContainer, card.nextSibling);
                
                this.showModal('postUploadModal');
            },
            
            // Enhanced upload post
            async uploadPost() {
                if (!this.state.currentUploadFile || !this.state.selectedChallenge) return;
                
                this.showLoading('Processing your challenge...');
                
                try {
                    const caption = document.getElementById('postCaption').value.trim();
                    
                    // AI scoring simulation with better logic
                    await this.simulateAIScoring();
                    
                    const aiScore = this.calculateAIScore();
                    
                    // Create enhanced post object
                    const post = {
                        id: 'post_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                        user: {
                            name: this.state.currentUser.name,
                            avatar: this.state.userData.avatar,
                            verified: false,
                            level: this.state.userData.level
                        },
                        challenge: this.state.selectedChallenge,
                        caption: caption || `Just completed the ${this.state.selectedChallenge.title}! 🎯`,
                        likes: 0,
                        comments: 0,
                        shares: 0,
                        views: 0,
                        mediaType: this.state.currentUploadFile.type.startsWith('video/') ? 'video' : 'image',
                        mediaUrl: URL.createObjectURL(this.state.currentUploadFile),
                        aiScore: aiScore,
                        timestamp: Date.now(),
                        location: 'Petaling Jaya',
                        tags: this.state.selectedChallenge.tags || [],
                        isMyPost: true,
                        synced: false
                    };
                    
                    // Add to user posts
                    this.state.userPosts.unshift(post);
                    this.saveUserPosts();
                    
                    // Calculate rewards based on AI score
                    const baseReward = this.state.selectedChallenge.reward;
                    const bonusReward = this.state.selectedChallenge.bonus || 0;
                    const scoreMultiplier = aiScore / 100;
                    const earnedTokens = Math.floor((baseReward + bonusReward) * scoreMultiplier);
                    const earnedXP = Math.floor(this.state.selectedChallenge.xpReward * scoreMultiplier);
                    
                    // Update user stats
                    this.state.userData.posts++;
                    this.state.userData.completedChallenges++;
                    this.state.userData.tokens += earnedTokens;
                    this.state.userData.xp = (this.state.userData.xp || 0) + earnedXP;
                    
                    // Check for level up
                    while (this.state.userData.xp >= this.state.userData.nextLevelXp) {
                        this.state.userData.level++;
                        this.state.userData.xp -= this.state.userData.nextLevelXp;
                        this.state.userData.nextLevelXp = Math.floor(this.state.userData.nextLevelXp * 1.5);
                        
                        // Show level up animation
                        this.showLevelUpAnimation(this.state.userData.level);
                    }
                    
                    // Update achievements
                    this.checkAchievements();
                    
                    // Update streak
                    this.updateStreak();
                    
                    this.saveData();
                    
                    // Upload to Firebase if available
                    if (this.storage && this.db) {
                        this.uploadToFirebase(post, this.state.currentUploadFile);
                    }
                    
                    // Reset state
                    this.state.currentUploadFile = null;
                    this.state.selectedChallenge = null;
                    this.state.selectedFriends.clear();
                    
                    // Close modal
                    this.closeModal('postUploadModal');
                    
                    // Reload feed
                    await this.loadFeed();
                    
                    this.hideLoading();
                    
                    // Show success with detailed rewards
                    this.showRewardSummary(earnedTokens, earnedXP, aiScore);
                    
                    // Track event
                    this.trackEvent('challenge_completed', {
                        challenge: this.state.selectedChallenge.title,
                        category: this.state.selectedChallenge.category,
                        aiScore: aiScore,
                        earnedTokens: earnedTokens,
                        earnedXP: earnedXP
                    });
                    
                } catch (error) {
                    console.error('Upload error:', error);
                    this.hideLoading();
                    this.showToast('Upload failed. Please try again.', 3000, 'error');
                }
            },
            
            // Simulate AI scoring process
            async simulateAIScoring() {
                const steps = [
                    'Analyzing movement patterns...',
                    'Checking form accuracy...',
                    'Evaluating completion time...',
                    'Calculating final score...'
                ];
                
                for (const step of steps) {
                    this.showLoading(step);
                    await new Promise(resolve => setTimeout(resolve, 500));
                }
            },
            
            // Calculate AI score with better logic
            calculateAIScore() {
                // Base score based on challenge difficulty
                const difficultyScores = { 'Easy': 80, 'Medium': 75, 'Hard': 70 };
                let score = difficultyScores[this.state.selectedChallenge.difficulty] || 75;
                
                // Random variation
                score += Math.floor(Math.random() * 20);
                
                // Bonus for completing within time limit
                if (this.state.isRecording && this.state.recordingStartTime) {
                    const recordTime = (Date.now() - this.state.recordingStartTime) / 1000;
                    if (recordTime < this.state.selectedChallenge.timeLimit * 0.8) {
                        score += 5;
                    }
                }
                
                // Cap at 100
                return Math.min(score, 100);
            },
            
            // Show level up animation
            showLevelUpAnimation(newLevel) {
                const levelUp = document.createElement('div');
                levelUp.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: linear-gradient(135deg, #667eea, #764ba2);
                    padding: 40px;
                    border-radius: 20px;
                    text-align: center;
                    z-index: 10000;
                    animation: levelUpAnimation 0.5s ease-out;
                    box-shadow: 0 10px 40px rgba(102, 126, 234, 0.5);
                `;
                
                levelUp.innerHTML = `
                    <div style="font-size: 4rem; margin-bottom: 10px;">🎉</div>
                    <h2 style="font-size: 2rem; margin-bottom: 10px;">LEVEL UP!</h2>
                    <p style="font-size: 1.5rem; opacity: 0.9;">You're now Level ${newLevel}</p>
                    <div style="margin-top: 20px; font-size: 1rem; opacity: 0.8;">
                        Keep going to unlock more rewards!
                    </div>
                `;
                
                document.body.appendChild(levelUp);
                
                // Add animation
                if (!document.querySelector('#levelUpAnimationStyle')) {
                    const style = document.createElement('style');
                    style.id = 'levelUpAnimationStyle';
                    style.textContent = `
                        @keyframes levelUpAnimation {
                            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
                            50% { transform: translate(-50%, -50%) scale(1.1); }
                            100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
                        }
                    `;
                    document.head.appendChild(style);
                }
                
                // Play sound effect if available
                this.playSound('levelup');
                
                // Remove after animation
                setTimeout(() => {
                    levelUp.style.animation = 'fadeOut 0.5s ease forwards';
                    setTimeout(() => levelUp.remove(), 500);
                }, 3000);
            },
            
            // Check achievements
            checkAchievements() {
                const achievements = [
                    { id: 'first_post', name: 'First Steps', condition: () => this.state.userData.posts === 1 },
                    { id: 'five_challenges', name: 'Challenge Accepted', condition: () => this.state.userData.completedChallenges >= 5 },
                    { id: 'ten_challenges', name: 'Challenge Master', condition: () => this.state.userData.completedChallenges >= 10 },
                    { id: 'level_5', name: 'Rising Star', condition: () => this.state.userData.level >= 5 },
                    { id: 'level_10', name: 'Elite Player', condition: () => this.state.userData.level >= 10 },
                    { id: 'tokens_5000', name: 'Token Collector', condition: () => this.state.userData.tokens >= 5000 },
                    { id: 'perfect_score', name: 'Perfectionist', condition: () => this.state.userPosts.some(p => p.aiScore === 100) },
                    { id: 'streak_7', name: 'Weekly Warrior', condition: () => this.state.userData.streak >= 7 }
                ];
                
                achievements.forEach(achievement => {
                    if (!this.state.userData.achievements.includes(achievement.id) && achievement.condition()) {
                        this.state.userData.achievements.push(achievement.id);
                        this.showAchievementUnlocked(achievement.name);
                    }
                });
            },
            
            // Show achievement unlocked
            showAchievementUnlocked(achievementName) {
                const achievement = document.createElement('div');
                achievement.style.cssText = `
                    position: fixed;
                    top: 100px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: linear-gradient(135deg, #ffd700, #ffed4e);
                    color: #333;
                    padding: 15px 30px;
                    border-radius: 30px;
                    font-weight: 600;
                    z-index: 10000;
                    animation: achievementSlide 0.5s ease-out;
                    box-shadow: 0 5px 20px rgba(255, 215, 0, 0.5);
                `;
                
                achievement.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span style="font-size: 1.5rem;">🏆</span>
                        <div>
                            <div style="font-size: 0.8rem; opacity: 0.8;">Achievement Unlocked!</div>
                            <div style="font-size: 1.1rem;">${achievementName}</div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(achievement);
                
                // Add animation
                if (!document.querySelector('#achievementAnimation')) {
                    const style = document.createElement('style');
                    style.id = 'achievementAnimation';
                    style.textContent = `
                        @keyframes achievementSlide {
                            0% { transform: translate(-50%, -100px); opacity: 0; }
                            100% { transform: translate(-50%, 0); opacity: 1; }
                        }
                    `;
                    document.head.appendChild(style);
                }
                
                // Remove after delay
                setTimeout(() => {
                    achievement.style.animation = 'achievementSlide 0.5s ease-in reverse';
                    setTimeout(() => achievement.remove(), 500);
                }, 4000);
            },
            
            // Update streak
            updateStreak() {
                const lastPostDate = localStorage.getItem('lastPostDate');
                const today = new Date().toDateString();
                
                if (lastPostDate === today) {
                    // Already posted today
                    return;
                }
                
                const yesterday = new Date(Date.now() - 86400000).toDateString();
                
                if (lastPostDate === yesterday) {
                    // Continue streak
                    this.state.userData.streak = (this.state.userData.streak || 0) + 1;
                } else {
                    // Reset streak
                    this.state.userData.streak = 1;
                }
                
                localStorage.setItem('lastPostDate', today);
            },
            
            // Show reward summary
            showRewardSummary(tokens, xp, aiScore) {
                const summary = document.createElement('div');
                summary.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: #1a1a1a;
                    padding: 30px;
                    border-radius: 20px;
                    text-align: center;
                    z-index: 10000;
                    animation: fadeInScale 0.5s ease-out;
                    border: 1px solid rgba(255, 255, 255, 0.1);
                    min-width: 300px;
                `;
                
                summary.innerHTML = `
                    <h2 style="font-size: 1.8rem; margin-bottom: 20px;">Challenge Complete! 🎉</h2>
                    
                    <div style="background: linear-gradient(135deg, rgba(74, 144, 226, 0.2), rgba(138, 56, 236, 0.2)); padding: 20px; border-radius: 15px; margin-bottom: 20px;">
                        <div style="font-size: 3rem; margin-bottom: 10px;">🤖</div>
                        <div style="font-size: 1.5rem; font-weight: 600;">AI Score: ${aiScore}%</div>
                    </div>
                    
                    <div style="display: flex; gap: 20px; justify-content: center; margin-bottom: 20px;">
                        <div style="background: rgba(255, 215, 0, 0.1); padding: 15px 25px; border-radius: 15px; border: 1px solid rgba(255, 215, 0, 0.3);">
                            <div style="font-size: 1.3rem; color: #ffd700;">🪙 +${tokens}</div>
                            <div style="font-size: 0.8rem; opacity: 0.7; margin-top: 5px;">Tokens</div>
                        </div>
                        <div style="background: rgba(155, 89, 182, 0.1); padding: 15px 25px; border-radius: 15px; border: 1px solid rgba(155, 89, 182, 0.3);">
                            <div style="font-size: 1.3rem; color: #9b59b6;">⭐ +${xp}</div>
                            <div style="font-size: 0.8rem; opacity: 0.7; margin-top: 5px;">XP</div>
                        </div>
                    </div>
                    
                    <button onclick="this.parentElement.remove()" style="background: var(--primary-gradient); border: none; color: white; padding: 12px 40px; border-radius: 25px; font-size: 1.1rem; font-weight: 600; cursor: pointer;">
                        Awesome! 🚀
                    </button>
                `;
                
                document.body.appendChild(summary);
                
                // Add animation
                if (!document.querySelector('#fadeInScaleAnimation')) {
                    const style = document.createElement('style');
                    style.id = 'fadeInScaleAnimation';
                    style.textContent = `
                        @keyframes fadeInScale {
                            0% { transform: translate(-50%, -50%) scale(0.8); opacity: 0; }
                            100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
                        }
                    `;
                    document.head.appendChild(style);
                }
                
                // Auto remove
                setTimeout(() => {
                    summary.style.animation = 'fadeInScale 0.5s ease-in reverse';
                    setTimeout(() => summary.remove(), 500);
                }, 5000);
            },
            
            // Upload to Firebase
            async uploadToFirebase(post, file) {
                if (!this.storage || !this.db) return;
                
                try {
                    // Upload file to storage
                    const storageRef = this.storage.ref(`posts/${post.id}/${file.name}`);
                    const uploadTask = storageRef.put(file);
                    
                    uploadTask.on('state_changed',
                        (snapshot) => {
                            // Progress
                            const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                            console.log('Upload progress:', progress);
                        },
                        (error) => {
                            console.error('Upload error:', error);
                        },
                        async () => {
                            // Complete
                            const downloadURL = await uploadTask.snapshot.ref.getDownloadURL();
                            post.mediaUrl = downloadURL;
                            post.synced = true;
                            
                            // Save post to Firestore
                            await this.db.collection('posts').doc(post.id).set({
                                ...post,
                                userId: this.state.currentUser.uid,
                                createdAt: firebase.firestore.FieldValue.serverTimestamp()
                            });
                            
                            // Update local post
                            const localPost = this.state.userPosts.find(p => p.id === post.id);
                            if (localPost) {
                                localPost.mediaUrl = downloadURL;
                                localPost.synced = true;
                                this.saveUserPosts();
                            }
                            
                            console.log('Post uploaded to Firebase successfully');
                        }
                    );
                } catch (error) {
                    console.error('Firebase upload error:', error);
                }
            },
            
            // Play sound effect
            playSound(type) {
                // Implement sound effects here
                // For now, just use Web Audio API for simple beeps
                try {
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    const frequencies = {
                        'levelup': [523, 659, 784, 1047], // C, E, G, C
                        'achievement': [784, 880, 988, 1047], // G, A, B, C
                        'success': [523, 659, 784], // C, E, G
                        'error': [330, 311] // E, D#
                    };
                    
                    const notes = frequencies[type] || frequencies['success'];
                    let time = audioContext.currentTime;
                    
                    notes.forEach((freq, index) => {
                        oscillator.frequency.setValueAtTime(freq, time + index * 0.1);
                    });
                    
                    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                    
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.5);
                } catch (error) {
                    console.log('Sound playback not available');
                }
            },
            
            // Enhanced profile display
            showProfile() {
                const modal = document.getElementById('profileModal');
                const content = document.getElementById('profileContent');
                
                const stats = this.state.userData;
                
                content.innerHTML = `
                    <div class="profile-header">
                        <div class="profile-cover">
                            ${stats.coverImage ? 
                                `<img src="${stats.coverImage}" alt="Cover" class="profile-cover-img">` :
                                `<div class="profile-cover-default">${stats.avatar}</div>`
                            }
                        </div>
                        <div class="profile-cover-upload" onclick="document.getElementById('coverInput').click()">
                            📷 Edit Cover
                        </div>
                    </div>
                    
                    <div class="profile-info-section">
                        <div class="profile-avatar-section">
                            <div class="profile-avatar-large">
                                ${stats.avatarImage ? 
                                    `<img src="${stats.avatarImage}" alt="Avatar" class="profile-avatar-img">` :
                                    stats.avatar
                                }
                                <div class="profile-avatar-edit" onclick="document.getElementById('avatarInput').click()">
                                    📷
                                </div>
                            </div>
                        </div>
                        
                        <div class="profile-name-section">
                            <h2 class="profile-username">${stats.name}</h2>
                            <p class="profile-bio">${stats.bio}</p>
                            
                            <div style="display: flex; gap: 15px; justify-content: center; margin: 20px 0;">
                                <div style="background: rgba(255, 215, 0, 0.1); padding: 10px 20px; border-radius: 20px; border: 1px solid rgba(255, 215, 0, 0.3);">
                                    <span style="font-size: 1.2rem; color: #ffd700;">🪙 ${stats.tokens}</span>
                                </div>
                                <div style="background: rgba(155, 89, 182, 0.1); padding: 10px 20px; border-radius: 20px; border: 1px solid rgba(155, 89, 182, 0.3);">
                                    <span style="font-size: 1.2rem; color: #9b59b6;">⭐ Level ${stats.level}</span>
                                </div>
                            </div>
                            
                            ${stats.xp !== undefined ? `
                                <div style="margin: 20px 0;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 0.9rem;">
                                        <span>XP Progress</span>
                                        <span>${stats.xp}/${stats.nextLevelXp}</span>
                                    </div>
                                    <div style="background: rgba(255, 255, 255, 0.1); height: 8px; border-radius: 4px; overflow: hidden;">
                                        <div style="background: var(--primary-gradient); height: 100%; width: ${(stats.xp / stats.nextLevelXp) * 100}%; transition: width 0.5s ease;"></div>
                                    </div>
                                </div>
                            ` : ''}
                            
                            ${stats.streak > 0 ? `
                                <div style="background: linear-gradient(135deg, rgba(255, 107, 107, 0.1), rgba(255, 142, 83, 0.1)); padding: 10px 20px; border-radius: 20px; display: inline-block; margin: 10px 0;">
                                    <span style="font-size: 1.1rem;">🔥 ${stats.streak} day streak!</span>
                                </div>
                            ` : ''}
                        </div>
                        
                        <div class="profile-stats">
                            <div class="stat-item">
                                <div class="stat-value">${stats.posts || 0}</div>
                                <div class="stat-label">Posts</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value">${this.formatCount(stats.followers || 0)}</div>
                                <div class="stat-label">Followers</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value">${this.formatCount(stats.following || 0)}</div>
                                <div class="stat-label">Following</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value">${stats.completedChallenges || 0}</div>
                                <div class="stat-label">Challenges</div>
                            </div>
                        </div>
                        
                        <div class="profile-actions">
                            <button class="profile-btn primary" onclick="App.editProfile()">
                                Edit Profile
                            </button>
                            <button class="profile-btn" onclick="App.shareProfile()">
                                Share Profile
                            </button>
                        </div>
                        
                        <!-- Badges Section -->
                        ${stats.badges && stats.badges.length > 0 ? `
                            <div style="margin: 30px 0;">
                                <h3 style="font-size: 1.2rem; margin-bottom: 15px;">Badges</h3>
                                <div style="display: flex; gap: 15px; flex-wrap: wrap; justify-content: center;">
                                    ${stats.badges.map(badge => `
                                        <div style="background: rgba(255, 255, 255, 0.1); padding: 10px 15px; border-radius: 20px; display: flex; align-items: center; gap: 8px;">
                                            <span style="font-size: 1.2rem;">${this.getBadgeEmoji(badge)}</span>
                                            <span style="font-size: 0.9rem;">${this.getBadgeName(badge)}</span>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                        
                        <!-- Achievements Section -->
                        ${stats.achievements && stats.achievements.length > 0 ? `
                            <div style="margin: 30px 0;">
                                <h3 style="font-size: 1.2rem; margin-bottom: 15px;">Achievements</h3>
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                                    ${stats.achievements.map(achievement => `
                                        <div style="background: linear-gradient(135deg, rgba(255, 215, 0, 0.1), rgba(255, 255, 255, 0.05)); padding: 15px; border-radius: 15px; text-align: center; border: 1px solid rgba(255, 215, 0, 0.2);">
                                            <div style="font-size: 2rem; margin-bottom: 5px;">🏆</div>
                                            <div style="font-size: 0.9rem;">${this.getAchievementName(achievement)}</div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                        
                        <div class="profile-tabs">
                            <button class="profile-tab active" onclick="App.switchProfileTab('posts', this)">Posts</button>
                            <button class="profile-tab" onclick="App.switchProfileTab('liked', this)">Liked</button>
                            <button class="profile-tab" onclick="App.switchProfileTab('stats', this)">Stats</button>
                        </div>
                        
                        <div id="profileTabContent" style="min-height: 200px;">
                            ${this.getProfileTabContent('posts')}
                        </div>
                    </div>
                `;
                
                this.showModal('profileModal');
            },
            
            // Get badge emoji
            getBadgeEmoji(badge) {
                const badges = {
                    'newcomer': '🌟',
                    'challenger': '🎯',
                    'veteran': '⚡',
                    'elite': '💎',
                    'legend': '👑'
                };
                return badges[badge] || '🏅';
            },
            
            // Get badge name
            getBadgeName(badge) {
                const names = {
                    'newcomer': 'Newcomer',
                    'challenger': 'Challenger',
                    'veteran': 'Veteran',
                    'elite': 'Elite',
                    'legend': 'Legend'
                };
                return names[badge] || badge;
            },
            
            // Get achievement name
            getAchievementName(achievement) {
                const names = {
                    'first_post': 'First Steps',
                    'five_challenges': 'Challenge Accepted',
                    'ten_challenges': 'Challenge Master',
                    'level_5': 'Rising Star',
                    'level_10': 'Elite Player',
                    'tokens_5000': 'Token Collector',
                    'perfect_score': 'Perfectionist',
                    'streak_7': 'Weekly Warrior'
                };
                return names[achievement] || achievement;
            },
            
            // Enhanced profile tab content
            getProfileTabContent(tab) {
                switch(tab) {
                    case 'posts':
                        if (this.state.userPosts.length === 0) {
                            return `
                                <div style="text-align: center; padding: 60px 20px;">
                                    <div style="font-size: 3rem; margin-bottom: 20px; opacity: 0.5;">📸</div>
                                    <p style="font-size: 1.1rem; opacity: 0.7; margin-bottom: 20px;">No posts yet</p>
                                    <button onclick="App.openCamera()" style="background: var(--primary-gradient); border: none; color: white; padding: 12px 30px; border-radius: 25px; font-weight: 600; cursor: pointer;">
                                        Create your first post! 🎯
                                    </button>
                                </div>
                            `;
                        }
                        
                        return `
                            <div class="posts-grid">
                                ${this.state.userPosts.map(post => `
                                    <div class="grid-post" onclick="App.viewPost('${post.id}')">
                                        ${post.mediaType === 'video' ? 
                                            `<video src="${post.mediaUrl}" muted preload="metadata"></video>` :
                                            `<img src="${post.mediaUrl}" alt="Post" loading="lazy">`
                                        }
                                        <div class="grid-post-overlay">
                                            <span>❤️ ${this.formatCount(post.likes)}</span>
                                            <span>💬 ${this.formatCount(post.comments)}</span>
                                            ${post.aiScore ? `<span>🤖 ${post.aiScore}%</span>` : ''}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        `;
                        
                    case 'liked':
                        return `
                            <div style="text-align: center; padding: 60px 20px;">
                                <div style="font-size: 3rem; margin-bottom: 20px; opacity: 0.5;">❤️</div>
                                <p style="font-size: 1.1rem; opacity: 0.7;">Your liked posts will appear here</p>
                            </div>
                        `;
                        
                    case 'stats':
                        const stats = this.state.userData.stats || {};
                        return `
                            <div style="padding: 20px;">
                                <h3 style="font-size: 1.2rem; margin-bottom: 20px;">Performance Stats</h3>
                                
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 30px;">
                                    <div style="background: rgba(255, 255, 255, 0.05); padding: 20px; border-radius: 15px; text-align: center;">
                                        <div style="font-size: 2rem; font-weight: 600; color: #e91e63;">${stats.totalLikes || 0}</div>
                                        <div style="font-size: 0.9rem; opacity: 0.7;">Total Likes</div>
                                    </div>
                                    <div style="background: rgba(255, 255, 255, 0.05); padding: 20px; border-radius: 15px; text-align: center;">
                                        <div style="font-size: 2rem; font-weight: 600; color: #3897f0;">${stats.totalComments || 0}</div>
                                        <div style="font-size: 0.9rem; opacity: 0.7;">Total Comments</div>
                                    </div>
                                    <div style="background: rgba(255, 255, 255, 0.05); padding: 20px; border-radius: 15px; text-align: center;">
                                        <div style="font-size: 2rem; font-weight: 600; color: #4caf50;">${stats.totalShares || 0}</div>
                                        <div style="font-size: 0.9rem; opacity: 0.7;">Total Shares</div>
                                    </div>
                                    <div style="background: rgba(255, 255, 255, 0.05); padding: 20px; border-radius: 15px; text-align: center;">
                                        <div style="font-size: 2rem; font-weight: 600; color: #ff9800;">${this.formatCount(stats.totalViews || 0)}</div>
                                        <div style="font-size: 0.9rem; opacity: 0.7;">Total Views</div>
                                    </div>
                                </div>
                                
                                <h3 style="font-size: 1.2rem; margin-bottom: 15px;">Category Performance</h3>
                                <div style="display: flex; flex-direction: column; gap: 10px;">
                                    ${this.getCategoryStats().map(cat => `
                                        <div style="background: rgba(255, 255, 255, 0.05); padding: 15px; border-radius: 10px;">
                                            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                                <span>${this.getCategoryEmoji(cat.category)} ${cat.category}</span>
                                                <span>${cat.count} challenges</span>
                                            </div>
                                            <div style="background: rgba(255, 255, 255, 0.1); height: 6px; border-radius: 3px; overflow: hidden;">
                                                <div style="background: var(--primary-gradient); height: 100%; width: ${cat.percentage}%;"></div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                                
                                ${this.state.userPosts.length > 0 ? `
                                    <div style="margin-top: 30px; text-align: center;">
                                        <div style="font-size: 0.9rem; opacity: 0.7; margin-bottom: 5px;">Average AI Score</div>
                                        <div style="font-size: 2.5rem; font-weight: 600; background: linear-gradient(135deg, #667eea, #764ba2); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
                                            ${Math.round(this.state.userPosts.reduce((acc, post) => acc + (post.aiScore || 0), 0) / this.state.userPosts.length)}%
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                        `;
                }
            },
            
            // Get category statistics
            getCategoryStats() {
                const categories = {};
                const total = this.state.userPosts.length;
                
                this.state.userPosts.forEach(post => {
                    const cat = post.challenge.category;
                    categories[cat] = (categories[cat] || 0) + 1;
                });
                
                return Object.entries(categories).map(([category, count]) => ({
                    category,
                    count,
                    percentage: total > 0 ? Math.round((count / total) * 100) : 0
                })).sort((a, b) => b.count - a.count);
            },
            
            // View post
            viewPost(postId) {
                const post = this.state.userPosts.find(p => p.id === postId);
                if (post) {
                    // Navigate to post in feed
                    const index = this.state.feedPosts.findIndex(p => p.id === postId);
                    if (index !== -1) {
                        this.state.currentPostIndex = index;
                        this.closeModal('profileModal');
                        document.querySelectorAll('.feed-post')[index].scrollIntoView({ behavior: 'smooth' });
                    }
                }
            },
            
            // Share profile
            shareProfile() {
                const profileUrl = `${window.location.origin}/@${this.state.userData.name}`;
                const shareText = `Check out my JomBro profile! Level ${this.state.userData.level} with ${this.state.userData.completedChallenges} challenges completed! 🎮`;
                
                if (navigator.share) {
                    navigator.share({
                        title: 'My JomBro Profile',
                        text: shareText,
                        url: profileUrl
                    });
                } else {
                    navigator.clipboard.writeText(profileUrl);
                    this.showToast('Profile link copied! 🔗', 3000, 'success');
                }
            },
            
            // Switch profile tab
            switchProfileTab(tab, element) {
                document.querySelectorAll('.profile-tab').forEach(t => t.classList.remove('active'));
                element.classList.add('active');
                
                const content = document.getElementById('profileTabContent');
                content.style.opacity = '0';
                
                setTimeout(() => {
                    content.innerHTML = this.getProfileTabContent(tab);
                    content.style.opacity = '1';
                }, 300);
            },
            
            // Enhanced edit profile
            editProfile() {
                const modal = document.getElementById('editProfileModal');
                const form = document.getElementById('editProfileForm');
                
                form.innerHTML = `
                    <div class="form-group">
                        <label class="form-label">Name</label>
                        <input type="text" class="form-input" id="editName" value="${this.state.userData.name}" maxlength="30">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Bio</label>
                        <textarea class="form-textarea" id="editBio" rows="3" maxlength="150">${this.state.userData.bio}</textarea>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Location</label>
                        <input type="text" class="form-input" id="editLocation" value="${this.state.userData.location || ''}" placeholder="City, Country">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Social Links</label>
                        <div style="display: flex; flex-direction: column; gap: 10px;">
                            <input type="text" class="form-input" id="editInstagram" placeholder="Instagram username" value="${this.state.userData.social.instagram || ''}">
                            <input type="text" class="form-input" id="editTiktok" placeholder="TikTok username" value="${this.state.userData.social.tiktok || ''}">
                            <input type="text" class="form-input" id="editWebsite" placeholder="Website URL" value="${this.state.userData.social.website || ''}">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Privacy</label>
                        <select class="form-input" id="editPrivacy">
                            <option value="public" ${this.state.userData.preferences.privacy === 'public' ? 'selected' : ''}>Public</option>
                            <option value="friends" ${this.state.userData.preferences.privacy === 'friends' ? 'selected' : ''}>Friends Only</option>
                            <option value="private" ${this.state.userData.preferences.privacy === 'private' ? 'selected' : ''}>Private</option>
                        </select>
                    </div>
                    
                    <button class="submit-btn" onclick="App.saveProfile()">Save Changes</button>
                `;
                
                this.showModal('editProfileModal');
            },
            
            // Save profile
            saveProfile() {
                const updates = {
                    name: document.getElementById('editName').value.trim(),
                    bio: document.getElementById('editBio').value.trim(),
                    location: document.getElementById('editLocation').value.trim(),
                    social: {
                        ...this.state.userData.social,
                        instagram: document.getElementById('editInstagram').value.trim(),
                        tiktok: document.getElementById('editTiktok').value.trim(),
                        website: document.getElementById('editWebsite').value.trim()
                    },
                    preferences: {
                        ...this.state.userData.preferences,
                        privacy: document.getElementById('editPrivacy').value
                    }
                };
                
                // Validate
                if (!updates.name) {
                    this.showToast('Name is required', 3000, 'error');
                    return;
                }
                
                // Update local state
                Object.assign(this.state.userData, updates);
                this.saveData();
                
                // Update Firebase if available
                if (this.db && this.state.currentUser) {
                    this.db.collection('users').doc(this.state.currentUser.uid).update(updates)
                        .catch(error => console.error('Error updating profile:', error));
                }
                
                // Close modal and refresh profile
                this.closeModal('editProfileModal');
                this.showProfile();
                this.showToast('Profile updated! ✨', 3000, 'success');
            },
            
            // Handle avatar upload
            handleAvatarUpload(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                if (file.size > 5 * 1024 * 1024) {
                    this.showToast('Image too large. Maximum size is 5MB', 3000, 'error');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    this.state.userData.avatarImage = e.target.result;
                    this.saveData();
                    
                    // Update UI
                    const avatarElement = document.querySelector('.profile-avatar-large');
                    if (avatarElement) {
                        avatarElement.innerHTML = `
                            <img src="${e.target.result}" alt="Avatar" class="profile-avatar-img">
                            <div class="profile-avatar-edit" onclick="document.getElementById('avatarInput').click()">
                                📷
                            </div>
                        `;
                    }
                    
                    this.showToast('Avatar updated! 📸', 3000, 'success');
                };
                reader.readAsDataURL(file);
                
                event.target.value = '';
            },
            
            // Handle cover upload
            handleCoverUpload(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                if (file.size > 10 * 1024 * 1024) {
                    this.showToast('Image too large. Maximum size is 10MB', 3000, 'error');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    this.state.userData.coverImage = e.target.result;
                    this.saveData();
                    
                    // Update UI
                    const coverElement = document.querySelector('.profile-cover');
                    if (coverElement) {
                        coverElement.innerHTML = `<img src="${e.target.result}" alt="Cover" class="profile-cover-img">`;
                    }
                    
                    this.showToast('Cover photo updated! 🖼️', 3000, 'success');
                };
                reader.readAsDataURL(file);
                
                event.target.value = '';
            },
            
            // Enhanced comments functionality
            showComments(postId) {
                const modal = document.getElementById('commentsModal');
                const list = document.getElementById('commentsList');
                
                const post = this.state.feedPosts.find(p => p.id === postId);
                const comments = this.state.comments[postId] || [];
                
                // Update header with post info
                modal.querySelector('.modal-title').innerHTML = `
                    Comments (${comments.length})
                `;
                
                // Render comments
                list.innerHTML = comments.length > 0 ? comments.map(comment => `
                    <div class="comment-item" data-comment-id="${comment.id}">
                        <div class="comment-avatar" onclick="App.viewProfile('${comment.author}')">${comment.avatar}</div>
                        <div class="comment-content">
                            <div class="comment-header">
                                <span class="comment-author" onclick="App.viewProfile('${comment.author}')">${comment.author}</span>
                                <span class="comment-time">${comment.time}</span>
                            </div>
                            <div class="comment-text">${this.linkifyComment(comment.text)}</div>
                            <div style="display: flex; gap: 20px; margin-top: 8px; font-size: 0.85rem;">
                                <span style="cursor: pointer; opacity: 0.7;" onclick="App.likeComment('${postId}', '${comment.id}')">
                                    ${comment.liked ? '❤️' : '🤍'} ${comment.likes || 0}
                                </span>
                                <span style="cursor: pointer; opacity: 0.7;" onclick="App.replyToComment('${comment.author}')">
                                    Reply
                                </span>
                                ${comment.author === this.state.userData.name ? `
                                    <span style="cursor: pointer; opacity: 0.7;" onclick="App.deleteComment('${postId}', '${comment.id}')">
                                        Delete
                                    </span>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `).join('') : `
                    <div style="text-align: center; padding: 60px 20px; opacity: 0.6;">
                        <div style="font-size: 3rem; margin-bottom: 10px;">💬</div>
                        <p>No comments yet. Be the first!</p>
                    </div>
                `;
                
                // Store current post ID
                modal.setAttribute('data-post-id', postId);
                
                // Focus input
                this.showModal('commentsModal');
                setTimeout(() => {
                    document.getElementById('commentInput').focus();
                }, 300);
            },
            
            // Linkify comment text
            linkifyComment(text) {
                // Convert @mentions to links
                text = text.replace(/@(\w+)/g, '<span style="color: #3897f0; cursor: pointer;" onclick="App.viewProfile(\'$1\')">@$1</span>');
                
                // Convert hashtags to links
                text = text.replace(/#(\w+)/g, '<span style="color: #3897f0; cursor: pointer;" onclick="App.searchTag(\'#$1\')">#$1</span>');
                
                return text;
            },
            
            // Post comment
            postComment() {
                const input = document.getElementById('commentInput');
                const modal = document.getElementById('commentsModal');
                const postId = modal.getAttribute('data-post-id');
                
                const text = input.value.trim();
                if (!text) return;
                
                const comment = {
                    id: 'comment_' + Date.now(),
                    author: this.state.userData.name,
                    avatar: this.state.userData.avatar,
                    text: text,
                    time: 'just now',
                    likes: 0,
                    liked: false
                };
                
                if (!this.state.comments[postId]) {
                    this.state.comments[postId] = [];
                }
                
                this.state.comments[postId].unshift(comment);
                
                // Update post comment count
                const post = this.state.feedPosts.find(p => p.id === postId);
                if (post) {
                    post.comments++;
                    // Update UI
                    const commentCount = document.querySelector(`#like-${postId}`).parentElement.parentElement.querySelector('.action-item:nth-child(3) .action-count');
                    if (commentCount) {
                        commentCount.textContent = this.formatCount(post.comments);
                    }
                }
                
                // Update user stats
                this.state.userData.stats.totalComments = (this.state.userData.stats.totalComments || 0) + 1;
                this.saveData();
                
                // Clear input and refresh
                input.value = '';
                this.showComments(postId);
                
                // Haptic feedback
                if ('vibrate' in navigator) {
                    navigator.vibrate(10);
                }
            },
            
            // Like comment
            likeComment(postId, commentId) {
                const comment = this.state.comments[postId]?.find(c => c.id === commentId);
                if (comment) {
                    comment.liked = !comment.liked;
                    comment.likes = (comment.likes || 0) + (comment.liked ? 1 : -1);
                    this.showComments(postId);
                }
            },
            
            // Reply to comment
            replyToComment(username) {
                const input = document.getElementById('commentInput');
                input.value = `@${username} `;
                input.focus();
            },
            
            // Delete comment
            deleteComment(postId, commentId) {
                if (confirm('Delete this comment?')) {
                    this.state.comments[postId] = this.state.comments[postId].filter(c => c.id !== commentId);
                    
                    // Update post comment count
                    const post = this.state.feedPosts.find(p => p.id === postId);
                    if (post) {
                        post.comments--;
                    }
                    
                    this.showComments(postId);
                    this.showToast('Comment deleted', 2000);
                }
            },
            
            // Enhanced share functionality
            sharePost(postId) {
                const post = this.state.feedPosts.find(p => p.id === postId);
                if (!post) return;
                
                const shareOptions = document.createElement('div');
                shareOptions.style.cssText = `
                    position: fixed;
                    bottom: 0;
                    left: 0;
                    right: 0;
                    background: #1a1a1a;
                    padding: 20px;
                    border-radius: 20px 20px 0 0;
                    z-index: 500;
                    animation: slideInUp 0.3s ease;
                `;
                
                shareOptions.innerHTML = `
                    <h3 style="margin-bottom: 20px;">Share Challenge</h3>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                        <button onclick="App.shareToSocial('whatsapp', '${postId}')" style="background: #25D366; border: none; color: white; padding: 15px; border-radius: 10px; display: flex; flex-direction: column; align-items: center; gap: 5px; cursor: pointer;">
                            <span style="font-size: 2rem;">💬</span>
                            WhatsApp
                        </button>
                        <button onclick="App.shareToSocial('instagram', '${postId}')" style="background: linear-gradient(45deg, #f09433, #e6683c, #dc2743, #cc2366, #bc1888); border: none; color: white; padding: 15px; border-radius: 10px; display: flex; flex-direction: column; align-items: center; gap: 5px; cursor: pointer;">
                            <span style="font-size: 2rem;">📷</span>
                            Instagram
                        </button>
                        <button onclick="App.shareToSocial('tiktok', '${postId}')" style="background: #000; border: 1px solid white; color: white; padding: 15px; border-radius: 10px; display: flex; flex-direction: column; align-items: center; gap: 5px; cursor: pointer;">
                            <span style="font-size: 2rem;">🎵</span>
                            TikTok
                        </button>
                        <button onclick="App.shareToSocial('facebook', '${postId}')" style="background: #1877F2; border: none; color: white; padding: 15px; border-radius: 10px; display: flex; flex-direction: column; align-items: center; gap: 5px; cursor: pointer;">
                            <span style="font-size: 2rem;">📘</span>
                            Facebook
                        </button>
                        <button onclick="App.shareToSocial('twitter', '${postId}')" style="background: #1DA1F2; border: none; color: white; padding: 15px; border-radius: 10px; display: flex; flex-direction: column; align-items: center; gap: 5px; cursor: pointer;">
                            <span style="font-size: 2rem;">🐦</span>
                            Twitter
                        </button>
                        <button onclick="App.copyShareLink('${postId}')" style="background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); color: white; padding: 15px; border-radius: 10px; display: flex; flex-direction: column; align-items: center; gap: 5px; cursor: pointer;">
                            <span style="font-size: 2rem;">🔗</span>
                            Copy Link
                        </button>
                    </div>
                    <button onclick="this.parentElement.remove()" style="width: 100%; margin-top: 20px; background: rgba(255, 255, 255, 0.1); border: none; color: white; padding: 15px; border-radius: 10px; font-weight: 600;">
                        Cancel
                    </button>
                `;
                
                document.body.appendChild(shareOptions);
                
                // Update share count
                post.shares = (post.shares || 0) + 1;
                this.state.userData.stats.totalShares = (this.state.userData.stats.totalShares || 0) + 1;
                this.saveData();
            },
            
            // Share to social platforms
            shareToSocial(platform, postId) {
                const post = this.state.feedPosts.find(p => p.id === postId);
                const shareText = `Check out this JomBro challenge: ${post.challenge.title}! 🎮`;
                const shareUrl = `${window.location.origin}/challenge/${postId}`;
                
                const urls = {
                    whatsapp: `https://wa.me/?text=${encodeURIComponent(shareText + ' ' + shareUrl)}`,
                    instagram: shareUrl, // Instagram doesn't have direct share URL
                    tiktok: shareUrl, // TikTok doesn't have direct share URL
                    facebook: `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(shareUrl)}`,
                    twitter: `https://twitter.com/intent/tweet?text=${encodeURIComponent(shareText)}&url=${encodeURIComponent(shareUrl)}`
                };
                
                if (platform === 'instagram' || platform === 'tiktok') {
                    this.copyShareLink(postId);
                    this.showToast(`Link copied! Open ${platform} and paste to share`, 4000, 'success');
                } else {
                    window.open(urls[platform], '_blank');
                }
                
                // Remove share options
                document.querySelector('[style*="slideInUp"]')?.remove();
            },
            
            // Copy share link
            copyShareLink(postId) {
                const shareUrl = `${window.location.origin}/challenge/${postId}`;
                navigator.clipboard.writeText(shareUrl);
                this.showToast('Link copied! 🔗', 2000, 'success');
                
                // Remove share options
                document.querySelector('[style*="slideInUp"]')?.remove();
            },
            
            // Enhanced search functionality
            showSearch() {
                const modal = document.getElementById('searchModal');
                const results = document.getElementById('searchResults');
                const input = document.getElementById('searchInput');
                
                // Clear input
                input.value = '';
                
                // Show initial content
                results.innerHTML = `
                    <div class="search-section">
                        <h3 style="margin-bottom: 15px; opacity: 0.8;">🔥 Trending Challenges</h3>
                        ${this.state.aiChallenges.filter(c => c.trending).slice(0, 5).map(challenge => `
                            <div class="search-result-item" onclick="App.selectSearchChallenge('${challenge.id}')">
                                <div class="search-avatar">${this.getCategoryEmoji(challenge.category)}</div>
                                <div class="search-info">
                                    <div class="search-name">${challenge.title}</div>
                                    <div class="search-username">${this.formatCount(challenge.participants)} participants • ${challenge.difficulty}</div>
                                </div>
                                <div style="margin-left: auto; color: #ffd700; font-weight: 600;">🪙 ${challenge.reward}</div>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div class="search-section" style="margin-top: 30px;">
                        <h3 style="margin-bottom: 15px; opacity: 0.8;">👥 Suggested Users</h3>
                        ${this.state.friends.slice(0, 5).map(friend => `
                            <div class="search-result-item" onclick="App.viewProfile('${friend.username}')">
                                <div class="search-avatar">${friend.avatar}</div>
                                <div class="search-info">
                                    <div class="search-name">${friend.name}</div>
                                    <div class="search-username">@${friend.username} • ${this.formatCount(friend.followers)} followers</div>
                                </div>
                                <button onclick="event.stopPropagation(); App.followUser('${friend.username}')" style="margin-left: auto; background: var(--accent-color); border: none; color: white; padding: 6px 16px; border-radius: 20px; font-size: 0.85rem; font-weight: 600;">
                                    Follow
                                </button>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div class="search-section" style="margin-top: 30px;">
                        <h3 style="margin-bottom: 15px; opacity: 0.8;">📍 Popular Tags</h3>
                        <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                            ${['#PushupChallenge', '#DanceOff', '#SpicyFood', '#Gaming', '#Creative', '#Fitness'].map(tag => `
                                <button onclick="App.searchTag('${tag}')" style="background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); color: white; padding: 8px 16px; border-radius: 20px; font-size: 0.9rem;">
                                    ${tag}
                                </button>
                            `).join('')}
                        </div>
                    </div>
                `;
                
                this.showModal('searchModal');
                
                // Focus input after modal animation
                setTimeout(() => input.focus(), 300);
            },
            
            // Select challenge from search
            selectSearchChallenge(challengeId) {
                const challenge = this.state.aiChallenges.find(c => c.id === challengeId);
                if (challenge) {
                    this.state.selectedChallenge = challenge;
                    this.closeModal('searchModal');
                    this.openCamera();
                }
            },
            
            // Enhanced search
            performSearch() {
                const query = document.getElementById('searchInput').value.toLowerCase().trim();
                const results = document.getElementById('searchResults');
                
                if (!query) {
                    this.showSearch(); // Reset to default
                    return;
                }
                
                // Search with debounce
                clearTimeout(this.searchTimeout);
                this.searchTimeout = setTimeout(() => {
                    // Filter challenges
                    const matchingChallenges = this.state.aiChallenges.filter(c => 
                        c.title.toLowerCase().includes(query) || 
                        c.category.toLowerCase().includes(query) ||
                        c.tags.some(tag => tag.toLowerCase().includes(query))
                    );
                    
                    // Filter users
                    const matchingUsers = this.state.friends.filter(f => 
                        f.name.toLowerCase().includes(query) || 
                        f.username.toLowerCase().includes(query) ||
                        (f.bio && f.bio.toLowerCase().includes(query))
                    );
                    
                    // Filter posts by tags
                    const matchingPosts = this.state.feedPosts.filter(p =>
                        p.tags && p.tags.some(tag => tag.toLowerCase().includes(query))
                    );
                    
                    results.innerHTML = '';
                    
                    if (matchingChallenges.length > 0) {
                        results.innerHTML += `
                            <div class="search-section">
                                <h3 style="margin-bottom: 15px; opacity: 0.8;">🎯 Challenges</h3>
                                ${matchingChallenges.slice(0, 5).map(challenge => `
                                    <div class="search-result-item" onclick="App.selectSearchChallenge('${challenge.id}')">
                                        <div class="search-avatar">${this.getCategoryEmoji(challenge.category)}</div>
                                        <div class="search-info">
                                            <div class="search-name">${challenge.title}</div>
                                            <div class="search-username">${this.formatCount(challenge.participants)} participants</div>
                                        </div>
                                        <div style="margin-left: auto; color: #ffd700;">🪙 ${challenge.reward}</div>
                                    </div>
                                `).join('')}
                            </div>
                        `;
                    }
                    
                    if (matchingUsers.length > 0) {
                        results.innerHTML += `
                            <div class="search-section" style="margin-top: 20px;">
                                <h3 style="margin-bottom: 15px; opacity: 0.8;">👥 Users</h3>
                                ${matchingUsers.slice(0, 5).map(friend => `
                                    <div class="search-result-item" onclick="App.viewProfile('${friend.username}')">
                                        <div class="search-avatar">${friend.avatar}</div>
                                        <div class="search-info">
                                            <div class="search-name">${friend.name}</div>
                                            <div class="search-username">@${friend.username}</div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        `;
                    }
                    
                    if (matchingPosts.length > 0) {
                        results.innerHTML += `
                            <div class="search-section" style="margin-top: 20px;">
                                <h3 style="margin-bottom: 15px; opacity: 0.8;">📱 Posts</h3>
                                ${matchingPosts.slice(0, 3).map(post => `
                                    <div class="search-result-item" onclick="App.navigateToPost('${post.id}')">
                                        <div style="width: 50px; height: 50px; border-radius: 8px; overflow: hidden; flex-shrink: 0;">
                                            ${post.mediaType === 'video' ?
                                                `<video src="${post.mediaUrl}" style="width: 100%; height: 100%; object-fit: cover;" muted></video>` :
                                                `<img src="${post.mediaUrl}" style="width: 100%; height: 100%; object-fit: cover;">`
                                            }
                                        </div>
                                        <div class="search-info">
                                            <div class="search-name">${post.challenge.title}</div>
                                            <div class="search-username">by @${post.user.name}</div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        `;
                    }
                    
                    if (results.innerHTML === '') {
                        results.innerHTML = `
                            <div style="text-align: center; padding: 60px 20px; opacity: 0.6;">
                                <div style="font-size: 3rem; margin-bottom: 10px;">🔍</div>
                                <p>No results found for "${query}"</p>
                                <p style="font-size: 0.9rem; margin-top: 10px;">Try searching for challenges, users, or tags</p>
                            </div>
                        `;
                    }
                }, 300);
            },
            
            // Navigate to post
            navigateToPost(postId) {
                const index = this.state.feedPosts.findIndex(p => p.id === postId);
                if (index !== -1) {
                    this.closeModal('searchModal');
                    this.state.currentPostIndex = index;
                    document.querySelectorAll('.feed-post')[index].scrollIntoView({ behavior: 'smooth' });
                }
            },
            
            // Enhanced inbox
            showInbox() {
                const modal = document.getElementById('inboxModal');
                const list = document.getElementById('chatList');
                
                list.innerHTML = this.state.chatMessages.map(chat => `
                    <div class="chat-item" onclick="App.openChat('${chat.id}')">
                        <div class="chat-avatar">
                            ${chat.avatar}
                            ${chat.online ? '<div class="online-indicator"></div>' : ''}
                        </div>
                        <div class="chat-info">
                            <div class="chat-name">
                                ${chat.name}
                                ${chat.isGroup ? '<span style="font-size: 0.8rem; opacity: 0.7; margin-left: 5px;">• Group</span>' : ''}
                            </div>
                            <div class="chat-preview">${chat.preview}</div>
                        </div>
                        <div class="chat-meta">
                            <div class="chat-time">${chat.time}</div>
                            ${chat.unread > 0 ? `<div class="unread-badge">${chat.unread > 99 ? '99+' : chat.unread}</div>` : ''}
                        </div>
                    </div>
                `).join('');
                
                this.showModal('inboxModal');
            },
            
            // Open chat (placeholder)
            openChat(chatId) {
                const chat = this.state.chatMessages.find(c => c.id === chatId);
                if (chat) {
                    this.showToast(`Opening chat with ${chat.name}`, 2000);
                    // Implement full chat functionality here
                }
            },
            
            // Enhanced discover page
            loadDiscover() {
                const container = document.getElementById('discoverContainer');
                
                container.innerHTML = `
                    <!-- Hero Section -->
                    <div style="background: var(--primary-gradient); padding: 30px 20px; border-radius: 20px; margin-bottom: 30px; text-align: center;">
                        <h2 style="font-size: 1.8rem; margin-bottom: 10px;">Discover Amazing Challenges</h2>
                        <p style="opacity: 0.9;">Find your next adventure and earn rewards!</p>
                    </div>
                    
                    <!-- Categories -->
                    <div class="trending-section">
                        <h2 class="section-title">🎨 Categories</h2>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
                            ${this.state.discoverContent.categories.map(cat => `
                                <div onclick="App.filterByCategory('${cat.name.toLowerCase()}')" style="background: ${cat.color}20; border: 1px solid ${cat.color}40; padding: 20px; border-radius: 15px; text-align: center; cursor: pointer; transition: all 0.3s ease;">
                                    <div style="font-size: 2.5rem; margin-bottom: 5px;">${cat.icon}</div>
                                    <div style="font-weight: 600; font-size: 0.9rem;">${cat.name}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <!-- Trending Challenges -->
                    <div class="trending-section">
                        <h2 class="section-title">🔥 Trending Now</h2>
                        <div class="trending-grid">
                            ${this.state.discoverContent.trending.map(item => `
                                <div class="trending-card" onclick="App.viewTrending('${item.id}')">
                                    <img src="${item.image}" alt="${item.title}" class="trending-media">
                                    <div class="trending-info">
                                        <div class="trending-title">${item.title}</div>
                                        <div class="trending-stats">
                                            <span>👁️ ${item.views}</span>
                                            <span>❤️ ${item.likes}</span>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <!-- Top Creators -->
                    <div class="trending-section">
                        <h2 class="section-title">⭐ Top Creators This Week</h2>
                        <div style="display: flex; flex-direction: column; gap: 15px;">
                            ${this.state.discoverContent.topCreators.map((creator, index) => `
                                <div class="search-result-item" style="padding: 15px; background: rgba(255,255,255,0.05); border-radius: 15px;">
                                    <div style="font-size: 1.2rem; font-weight: 600; margin-right: 15px; opacity: 0.5;">#${index + 1}</div>
                                    <div class="search-avatar">${creator.avatar}</div>
                                    <div class="search-info">
                                        <div class="search-name">
                                            ${creator.name}
                                            ${creator.verified ? '<span style="color: #1DA1F2; margin-left: 5px;">✓</span>' : ''}
                                        </div>
                                        <div class="search-username">${creator.followers} followers</div>
                                    </div>
                                    <button onclick="event.stopPropagation(); App.followUser('${creator.name}')" style="margin-left: auto; background: var(--accent-color); border: none; color: white; padding: 8px 20px; border-radius: 20px; font-weight: 600;">
                                        Follow
                                    </button>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <!-- Daily Challenge -->
                    <div style="background: linear-gradient(135deg, rgba(255, 215, 0, 0.1), rgba(255, 255, 255, 0.05)); border: 1px solid rgba(255, 215, 0, 0.3); padding: 25px; border-radius: 20px; margin: 30px 0; text-align: center;">
                        <h3 style="font-size: 1.3rem; margin-bottom: 10px;">🏆 Daily Challenge</h3>
                        <p style="font-size: 1.1rem; margin-bottom: 15px;">Complete today's challenge for bonus rewards!</p>
                        <button onclick="App.showDailyChallenge()" style="background: linear-gradient(135deg, #ffd700, #ffed4e); color: #333; border: none; padding: 12px 30px; border-radius: 25px; font-weight: 600; cursor: pointer;">
                            View Challenge
                        </button>
                    </div>
                    
                    <!-- Recommended for You -->
                    <div class="trending-section">
                        <h2 class="section-title">💡 Recommended for You</h2>
                        <div style="display: flex; flex-direction: column; gap: 15px;">
                            ${this.getRecommendedChallenges().map(challenge => `
                                <div class="challenge-card" onclick="App.selectChallenge('${challenge.id}')">
                                    <div class="challenge-header">
                                        <div>
                                            <div class="challenge-title">${challenge.title}</div>
                                            <div class="challenge-category">
                                                ${this.getCategoryEmoji(challenge.category)} ${challenge.category}
                                            </div>
                                        </div>
                                        <div class="challenge-reward">
                                            🪙 ${challenge.reward}
                                        </div>
                                    </div>
                                    <div class="challenge-description">${challenge.description}</div>
                                    <div class="challenge-meta">
                                        <span>⏱️ ${challenge.timeLimit}s</span>
                                        <span>👥 ${this.formatCount(challenge.participants)} joined</span>
                                        <span>🎯 ${challenge.difficulty}</span>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            },
            
            // Get recommended challenges based on user activity
            getRecommendedChallenges() {
                // Analyze user's completed challenges to find preferences
                const categoryCount = {};
                this.state.userPosts.forEach(post => {
                    const cat = post.challenge.category;
                    categoryCount[cat] = (categoryCount[cat] || 0) + 1;
                });
                
                // Get favorite category
                const favoriteCategory = Object.keys(categoryCount).length > 0
                    ? Object.entries(categoryCount).sort((a, b) => b[1] - a[1])[0][0]
                    : 'fitness';
                
                // Filter challenges by favorite category and not completed
                const recommended = this.state.aiChallenges
                    .filter(c => c.category === favoriteCategory || Math.random() > 0.5)
                    .slice(0, 5);
                
                return recommended;
            },
            
            // Filter by category
            filterByCategory(category) {
                const challenges = this.state.aiChallenges.filter(c => c.category === category);
                
                const modal = document.createElement('div');
                modal.className = 'modal show';
                modal.innerHTML = `
                    <div class="modal-content" style="max-height: 80vh;">
                        <div class="modal-header">
                            <h2 class="modal-title">${this.getCategoryEmoji(category)} ${category.charAt(0).toUpperCase() + category.slice(1)} Challenges</h2>
                            <button class="close-btn" onclick="this.closest('.modal').remove()">✕</button>
                        </div>
                        <div style="padding: 20px 0;">
                            ${challenges.map(challenge => `
                                <div class="challenge-card" onclick="App.selectChallenge('${challenge.id}'); this.closest('.modal').remove();">
                                    <div class="challenge-header">
                                        <div>
                                            <div class="challenge-title">${challenge.title}</div>
                                            <div style="font-size: 0.9rem; opacity: 0.7; margin-top: 5px;">
                                                ${challenge.difficulty} • ${challenge.timeLimit}s
                                            </div>
                                        </div>
                                        <div class="challenge-reward">
                                            🪙 ${challenge.reward}
                                        </div>
                                    </div>
                                    <div class="challenge-description">${challenge.description}</div>
                                    <div class="challenge-meta">
                                        <span>👥 ${this.formatCount(challenge.participants)} participants</span>
                                        ${challenge.trending ? '<span style="color: #ff6b6b;">🔥 Trending</span>' : ''}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
            },
            
            // View trending item
            viewTrending(trendingId) {
                const trending = this.state.discoverContent.trending.find(t => t.id === trendingId);
                if (trending) {
                    this.showToast(`Viewing ${trending.title}`, 2000);
                    // Implement trending view functionality
                }
            },
            
            // Show daily challenge
            showDailyChallenge() {
                // Get or generate daily challenge
                const today = new Date().toDateString();
                let dailyChallenge = JSON.parse(localStorage.getItem('dailyChallenge') || '{}');
                
                if (dailyChallenge.date !== today) {
                    // Generate new daily challenge
                    const challenges = this.state.aiChallenges;
                    dailyChallenge = {
                        date: today,
                        challenge: challenges[Math.floor(Math.random() * challenges.length)],
                        completed: false,
                        bonusMultiplier: 2
                    };
                    localStorage.setItem('dailyChallenge', JSON.stringify(dailyChallenge));
                }
                
                const modal = document.createElement('div');
                modal.className = 'modal show';
                modal.innerHTML = `
                    <div class="modal-content">
                        <div class="modal-header">
                            <h2 class="modal-title">🏆 Daily Challenge</h2>
                            <button class="close-btn" onclick="this.closest('.modal').remove()">✕</button>
                        </div>
                        <div style="text-align: center; padding: 20px;">
                            <div style="font-size: 4rem; margin-bottom: 20px;">🎯</div>
                            <h3 style="font-size: 1.5rem; margin-bottom: 10px;">${dailyChallenge.challenge.title}</h3>
                            <p style="opacity: 0.8; margin-bottom: 20px;">${dailyChallenge.challenge.description}</p>
                            
                            <div style="background: linear-gradient(135deg, rgba(255, 215, 0, 0.2), rgba(255, 255, 255, 0.1)); padding: 20px; border-radius: 15px; margin-bottom: 20px;">
                                <div style="font-size: 1.2rem; margin-bottom: 10px;">🎁 Daily Bonus Active!</div>
                                <div style="font-size: 2rem; font-weight: 600; color: #ffd700;">
                                    🪙 ${dailyChallenge.challenge.reward * dailyChallenge.bonusMultiplier} tokens
                                </div>
                                <div style="font-size: 0.9rem; opacity: 0.7; margin-top: 5px;">
                                    (${dailyChallenge.bonusMultiplier}x bonus)
                                </div>
                            </div>
                            
                            <div style="display: flex; gap: 10px; justify-content: center;">
                                <button onclick="this.closest('.modal').remove()" style="background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); color: white; padding: 12px 30px; border-radius: 25px; font-weight: 600; cursor: pointer;">
                                    Maybe Later
                                </button>
                                <button onclick="App.selectDailyChallenge(); this.closest('.modal').remove();" style="background: var(--primary-gradient); border: none; color: white; padding: 12px 30px; border-radius: 25px; font-weight: 600; cursor: pointer;">
                                    Accept Challenge 🚀
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
            },
            
            // Select daily challenge
            selectDailyChallenge() {
                const dailyChallenge = JSON.parse(localStorage.getItem('dailyChallenge') || '{}');
                if (dailyChallenge.challenge) {
                    this.state.selectedChallenge = {
                        ...dailyChallenge.challenge,
                        isDaily: true,
                        bonusMultiplier: dailyChallenge.bonusMultiplier
                    };
                    this.openCamera();
                }
            },
            
            // Select challenge
            selectChallenge(challengeId) {
                const challenge = this.state.aiChallenges.find(c => c.id === challengeId);
                if (challenge) {
                    this.state.selectedChallenge = challenge;
                    this.openCamera();
                }
            },
            
            // Show friend tag modal
            showFriendTag() {
                const modal = document.getElementById('friendTagModal');
                const list = document.getElementById('friendList');
                
                list.innerHTML = this.state.friends.map(friend => `
                    <div class="friend-item ${this.state.selectedFriends.has(friend.id) ? 'selected' : ''}" 
                         onclick="App.toggleFriendSelection('${friend.id}')"
                         style="display: flex; align-items: center; gap: 15px; padding: 15px; cursor: pointer; border-radius: 10px; transition: all 0.3s ease;">
                        <div class="friend-checkbox" style="width: 24px; height: 24px; border: 2px solid rgba(255, 255, 255, 0.5); border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease;">
                            ${this.state.selectedFriends.has(friend.id) ? '✓' : ''}
                        </div>
                        <div class="search-avatar">${friend.avatar}</div>
                        <div class="search-info">
                            <div class="search-name">${friend.name}</div>
                            <div class="search-username">@${friend.username}</div>
                        </div>
                    </div>
                `).join('');
                
                this.showModal('friendTagModal');
            },
            
            // Toggle friend selection
            toggleFriendSelection(friendId) {
                if (this.state.selectedFriends.has(friendId)) {
                    this.state.selectedFriends.delete(friendId);
                } else {
                    this.state.selectedFriends.add(friendId);
                }
                
                // Update UI
                const item = document.querySelector(`.friend-item[onclick*="${friendId}"]`);
                if (item) {
                    item.classList.toggle('selected');
                    const checkbox = item.querySelector('.friend-checkbox');
                    checkbox.textContent = this.state.selectedFriends.has(friendId) ? '✓' : '';
                }
            },
            
            // Confirm friend tags
            confirmFriendTags() {
                const selectedCount = this.state.selectedFriends.size;
                const tagText = selectedCount > 0 
                    ? `${selectedCount} friend${selectedCount > 1 ? 's' : ''} tagged`
                    : 'Select friends to tag...';
                
                document.getElementById('taggedFriendsText').textContent = tagText;
                this.closeModal('friendTagModal');
            },
            
            // Modal management
            showModal(modalId) {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.style.display = 'flex';
                    modal.classList.add('show');
                    this.state.isModalOpen = true;
                    this.state.activeModal = modalId;
                    
                    // Prevent body scroll
                    document.body.style.overflow = 'hidden';
                }
            },
            
            closeModal(modalId) {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.style.animation = 'fadeOut 0.3s ease';
                    setTimeout(() => {
                        modal.style.display = 'none';
                        modal.classList.remove('show');
                        modal.style.animation = '';
                        
                        // Check if any other modals are open
                        const openModals = document.querySelectorAll('.modal.show');
                        if (openModals.length === 0) {
                            this.state.isModalOpen = false;
                            this.state.activeModal = null;
                            document.body.style.overflow = '';
                        }
                    }, 300);
                }
            },
            
            // Start challenge timer
            startChallengeTimer() {
                // Refresh challenges every 30 minutes
                this.state.challengeTimer = setInterval(() => {
                    this.generateAIChallenges();
                    this.showToast('🤖 New AI challenges available!', 3000, 'success');
                }, 30 * 60 * 1000);
            },
            
            // Challenge details modal
            showChallengeDetails(challenge) {
                const modal = document.createElement('div');
                modal.className = 'modal show';
                modal.innerHTML = `
                    <div class="modal-content">
                        <div class="modal-header">
                            <h2 class="modal-title">Challenge Details</h2>
                            <button class="close-btn" onclick="this.closest('.modal').remove()">✕</button>
                        </div>
                        <div style="padding: 20px;">
                            <div style="text-align: center; margin-bottom: 20px;">
                                <div style="font-size: 3rem; margin-bottom: 10px;">${this.getCategoryEmoji(challenge.category)}</div>
                                <h3 style="font-size: 1.5rem;">${challenge.title}</h3>
                            </div>
                            
                            <div style="background: rgba(255, 255, 255, 0.05); padding: 20px; border-radius: 15px; margin-bottom: 20px;">
                                <p style="line-height: 1.5;">${challenge.description}</p>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px;">
                                <div style="background: rgba(255, 255, 255, 0.05); padding: 15px; border-radius: 10px; text-align: center;">
                                    <div style="font-size: 2rem; margin-bottom: 5px;">🪙 ${challenge.reward}</div>
                                    <div style="font-size: 0.9rem; opacity: 0.7;">Reward</div>
                                </div>
                                <div style="background: rgba(255, 255, 255, 0.05); padding: 15px; border-radius: 10px; text-align: center;">
                                    <div style="font-size: 2rem; margin-bottom: 5px;">⏱️ ${challenge.timeLimit}s</div>
                                    <div style="font-size: 0.9rem; opacity: 0.7;">Time Limit</div>
                                </div>
                                <div style="background: rgba(255, 255, 255, 0.05); padding: 15px; border-radius: 10px; text-align: center;">
                                    <div style="font-size: 2rem; margin-bottom: 5px;">👥 ${this.formatCount(challenge.participants)}</div>
                                    <div style="font-size: 0.9rem; opacity: 0.7;">Participants</div>
                                </div>
                                <div style="background: rgba(255, 255, 255, 0.05); padding: 15px; border-radius: 10px; text-align: center;">
                                    <div style="font-size: 2rem; margin-bottom: 5px;">⭐ ${challenge.difficulty}</div>
                                    <div style="font-size: 0.9rem; opacity: 0.7;">Difficulty</div>
                                </div>
                            </div>
                            
                            <button onclick="App.state.selectedChallenge = ${JSON.stringify(challenge).replace(/"/g, '&quot;')}; App.openCamera(); this.closest('.modal').remove();" style="width: 100%; background: var(--primary-gradient); border: none; color: white; padding: 15px; border-radius: 10px; font-size: 1.1rem; font-weight: 600; cursor: pointer;">
                                Start Challenge 🚀
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
            },
            
            // Cleanup function
            cleanup() {
                // Clear timers
                if (this.state.challengeTimer) {
                    clearInterval(this.state.challengeTimer);
                }
                if (this.state.recordingTimer) {
                    clearInterval(this.state.recordingTimer);
                }
                
                // Stop media streams
                if (this.state.currentStream) {
                    this.state.currentStream.getTracks().forEach(track => track.stop());
                }
                
                // Save data
                this.saveData();
                this.saveUserPosts();
                
                // Clear caches
                this.state.imageCache.clear();
                this.state.videoCache.clear();
                
                // Remove observers
                if (this.postObserver) {
                    this.postObserver.disconnect();
                }
            }
        };
        
        // Initialize app when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                App.init();
            });
        } else {
            App.init();
        }
        
        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            App.cleanup();
        });
        
        // Handle app install
        window.addEventListener('appinstalled', () => {
            console.log('JomBro installed! 🎉');
            App.showToast('JomBro installed successfully! 🎉', 5000, 'success');
            App.trackEvent('app_installed');
        });
        
        // Performance monitoring
        if ('performance' in window && 'PerformanceObserver' in window) {
            try {
                const perfObserver = new PerformanceObserver((list) => {
                    for (const entry of list.getEntries()) {
                        if (entry.entryType === 'measure' && entry.name === 'app-init') {
                            console.log(`App initialization took ${entry.duration.toFixed(2)}ms`);
                        }
                    }
                });
                perfObserver.observe({ entryTypes: ['measure'] });
            } catch (e) {
                // PerformanceObserver not fully supported
            }
        }
        
        // Log app info
        console.log('%c🎮 JomBro', 'font-size: 30px; font-weight: bold; color: #667eea;');
        console.log('%cVersion 2.0.0 - Fine-Tuned Edition', 'font-size: 14px; color: #764ba2;');
        console.log('%c✨ Performance optimized', 'color: #4caf50;');
        console.log('%c🚀 Ready to challenge the world!', 'color: #ff6b6b;');
        console.log('%c💡 Press Ctrl+Shift+I for developer tools', 'color: #999;');
    </script>
</body>
</html>
