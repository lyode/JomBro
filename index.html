<!-- Example of how to integrate all profile features into your existing code -->

<!-- Add this to your existing <head> section -->
<style>
    /* Add all the enhanced CSS from jombro-profile-css artifact here */
    
    /* Additional integration styles */
    .app-loading {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: #0a0a0a;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
    }
    
    .app-loading.hide {
        animation: fadeOut 0.5s ease-out forwards;
    }
    
    @keyframes fadeOut {
        to {
            opacity: 0;
            visibility: hidden;
        }
    }
</style>

<!-- Add this loading screen right after <body> tag -->
<div class="app-loading" id="appLoader">
    <div style="text-align: center;">
        <div style="font-size: 4rem; margin-bottom: 20px; animation: bounce 2s infinite;">🎮</div>
        <h2 style="color: white; margin-bottom: 10px;">JomBro</h2>
        <div class="loading-spinner"></div>
    </div>
</div>

<!-- Update your existing script section with this complete integration -->
<script>
// ==========================================
// COMPLETE JOMBRO PROFILE SYSTEM INTEGRATION
// ==========================================

// Global State Management
const AppState = {
    initialized: false,
    user: null,
    friends: [],
    notifications: [],
    settings: {},
    ui: {
        dropdownOpen: false,
        activeModal: null,
        theme: 'dark'
    }
};

// Initialize Enhanced Features
async function initializeEnhancedFeatures() {
    console.log('🚀 Initializing Enhanced Profile Features...');
    
    try {
        // 1. Setup event listeners for profile system
        setupProfileEventListeners();
        
        // 2. Initialize notification system
        await initializeNotifications();
        
        // 3. Load user preferences
        await loadUserPreferences();
        
        // 4. Setup real-time listeners for profile updates
        setupProfileRealtimeListeners();
        
        // 5. Initialize achievement tracking
        initializeAchievementTracking();
        
        // 6. Setup keyboard shortcuts
        setupKeyboardShortcuts();
        
        // 7. Hide loading screen
        setTimeout(() => {
            const loader = document.getElementById('appLoader');
            if (loader) {
                loader.classList.add('hide');
                setTimeout(() => loader.remove(), 500);
            }
        }, 1000);
        
        console.log('✅ Enhanced Profile Features Initialized!');
        
    } catch (error) {
        console.error('❌ Failed to initialize enhanced features:', error);
        showMessage('Some features may not be available', 'error');
    }
}

// Setup all profile-related event listeners
function setupProfileEventListeners() {
    // Avatar click handler with improved UX
    const userAvatar = document.getElementById('userAvatar');
    if (userAvatar) {
        // Remove any existing listeners
        userAvatar.replaceWith(userAvatar.cloneNode(true));
        const newAvatar = document.getElementById('userAvatar');
        
        // Add click handler
        newAvatar.addEventListener('click', (e) => {
            e.stopPropagation();
            toggleUserDropdown();
        });
        
        // Add keyboard support
        newAvatar.setAttribute('tabindex', '0');
        newAvatar.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                toggleUserDropdown();
            }
        });
    }
    
    // Dropdown hover behavior
    const dropdown = document.getElementById('userDropdown');
    if (dropdown) {
        let hoverTimeout;
        
        dropdown.addEventListener('mouseenter', () => {
            clearTimeout(hoverTimeout);
            AppState.ui.dropdownHovered = true;
        });
        
        dropdown.addEventListener('mouseleave', () => {
            AppState.ui.dropdownHovered = false;
            hoverTimeout = setTimeout(() => {
                if (!AppState.ui.dropdownHovered) {
                    closeUserDropdown();
                }
            }, 300);
        });
    }
    
    // Global click handler
    document.addEventListener('click', handleGlobalClick);
    
    // Window resize handler
    window.addEventListener('resize', handleWindowResize);
}

// Handle global clicks for closing dropdowns/modals
function handleGlobalClick(e) {
    const avatar = document.getElementById('userAvatar');
    const dropdown = document.getElementById('userDropdown');
    
    // Close dropdown if clicking outside
    if (dropdown && dropdown.classList.contains('show')) {
        if (!avatar.contains(e.target) && !dropdown.contains(e.target)) {
            closeUserDropdown();
        }
    }
    
    // Close modals if clicking overlay
    if (e.target.classList.contains('auth-modal') || 
        e.target.classList.contains('settings-modal') ||
        e.target.classList.contains('profile-modal')) {
        closeModal(e.target);
    }
}

// Handle window resize for responsive behavior
function handleWindowResize() {
    // Adjust dropdown position on mobile
    if (window.innerWidth < 768) {
        const dropdown = document.getElementById('userDropdown');
        if (dropdown && dropdown.classList.contains('show')) {
            positionDropdownForMobile();
        }
    }
}

// Position dropdown for mobile screens
function positionDropdownForMobile() {
    const dropdown = document.getElementById('userDropdown');
    if (dropdown) {
        const rect = dropdown.getBoundingClientRect();
        if (rect.right > window.innerWidth) {
            dropdown.style.right = '10px';
        }
    }
}

// Initialize notification system
async function initializeNotifications() {
    // Request permission for browser notifications
    if ('Notification' in window && Notification.permission === 'default') {
        const permission = await Notification.requestPermission();
        console.log('Notification permission:', permission);
    }
    
    // Setup notification listener
    if (currentUser && db) {
        const notifRef = db.collection('notifications')
            .where('userId', '==', currentUser.uid)
            .where('read', '==', false)
            .orderBy('createdAt', 'desc');
        
        notifRef.onSnapshot((snapshot) => {
            const newNotifications = [];
            snapshot.forEach(doc => {
                newNotifications.push({ id: doc.id, ...doc.data() });
            });
            
            // Update notification count
            updateNotificationCount(newNotifications.length);
            
            // Show browser notification for new items
            if (newNotifications.length > AppState.notifications.length) {
                showBrowserNotification(newNotifications[0]);
            }
            
            AppState.notifications = newNotifications;
        });
    }
}

// Update notification count in UI
function updateNotificationCount(count) {
    const badges = document.querySelectorAll('.notification-badge');
    badges.forEach(badge => {
        if (count > 0) {
            badge.textContent = count > 99 ? '99+' : count;
            badge.style.display = 'inline-block';
        } else {
            badge.style.display = 'none';
        }
    });
}

// Show browser notification
function showBrowserNotification(notification) {
    if ('Notification' in window && Notification.permission === 'granted') {
        new Notification('JomBro', {
            body: notification.title,
            icon: '/favicon.ico',
            badge: '/badge.png',
            vibrate: [200, 100, 200],
            tag: notification.id
        });
    }
}

// Load user preferences
async function loadUserPreferences() {
    if (!currentUser || !db) return;
    
    try {
        const userDoc = await db.collection('users').doc(currentUser.uid).get();
        if (userDoc.exists) {
            const userData = userDoc.data();
            
            // Apply theme
            if (userData.settings?.theme) {
                applyTheme(userData.settings.theme);
            }
            
            // Apply other preferences
            AppState.settings = userData.settings || {};
            applyUserSettings(AppState.settings);
        }
    } catch (error) {
        console.error('Error loading preferences:', error);
    }
}

// Apply theme to the application
function applyTheme(themeName) {
    document.body.setAttribute('data-theme', themeName);
    AppState.ui.theme = themeName;
    
    // Update theme-specific styles
    switch(themeName) {
        case 'purple':
            document.documentElement.style.setProperty('--primary-color', '#9b59b6');
            document.documentElement.style.setProperty('--secondary-color', '#e91e63');
            break;
        case 'ocean':
            document.documentElement.style.setProperty('--primary-color', '#4facfe');
            document.documentElement.style.setProperty('--secondary-color', '#00f2fe');
            break;
        case 'neon':
            document.documentElement.style.setProperty('--primary-color', '#f093fb');
            document.documentElement.style.setProperty('--secondary-color', '#f5576c');
            break;
        default:
            document.documentElement.style.setProperty('--primary-color', '#667eea');
            document.documentElement.style.setProperty('--secondary-color', '#764ba2');
    }
}

// Apply user settings
function applyUserSettings(settings) {
    // Sound effects
    if (settings.soundEffects === false) {
        window.soundEnabled = false;
    }
    
    // Animations
    if (settings.animations === false) {
        document.body.classList.add('reduce-motion');
    }
    
    // Other settings...
}

// Setup real-time listeners for profile updates
function setupProfileRealtimeListeners() {
    if (!currentUser || !db) return;
    
    // Listen for user profile changes
    const userRef = db.collection('users').doc(currentUser.uid);
    userRef.onSnapshot((doc) => {
        if (doc.exists) {
            const userData = doc.data();
            
            // Update local state
            AppState.user = {
                ...AppState.user,
                ...userData
            };
            
            // Update UI
            updateAllProfileDisplays();
        }
    });
}

// Update all profile displays in the UI
function updateAllProfileDisplays() {
    // Update main display
    updateUserDisplay();
    
    // Update dropdown if open
    if (AppState.ui.dropdownOpen) {
        updateDropdownStats();
    }
    
    // Update profile modal if open
    if (currentViewingUserId === currentUser.uid) {
        const profileModal = document.getElementById('profileModal');
        if (profileModal && profileModal.classList.contains('show')) {
            updateProfileModalDisplay();
        }
    }
}

// Initialize achievement tracking
function initializeAchievementTracking() {
    // Track user actions for achievements
    window.achievementTracker = {
        trackAction: (action, data) => {
            console.log('Achievement tracked:', action, data);
            checkForNewAchievements(action, data);
        }
    };
}

// Check for new achievements
async function checkForNewAchievements(action, data) {
    // Achievement logic here
    const achievements = {
        firstFriend: appState.friends.length >= 1,
        socialButterfly: appState.friends.length >= 5,
        challengeMaster: challengeStats.total >= 10,
        tokenCollector: appState.user.tokens >= 5000,
        profileCustomizer: !!appState.user.avatarUrl
    };
    
    // Check and award new achievements
    for (const [key, earned] of Object.entries(achievements)) {
        if (earned && !AppState.user.achievements?.includes(key)) {
            await awardAchievement(key);
        }
    }
}

// Award achievement
async function awardAchievement(achievementId) {
    try {
        await db.collection('users').doc(currentUser.uid).update({
            achievements: firebase.firestore.FieldValue.arrayUnion(achievementId),
            tokens: firebase.firestore.FieldValue.increment(100)
        });
        
        showMessage(`🏆 Achievement unlocked: ${achievementId}! +100 tokens`, 'success');
        
        // Show achievement animation
        showAchievementAnimation(achievementId);
        
    } catch (error) {
        console.error('Error awarding achievement:', error);
    }
}

// Show achievement animation
function showAchievementAnimation(achievementId) {
    const achievementPopup = document.createElement('div');
    achievementPopup.className = 'achievement-popup';
    achievementPopup.innerHTML = `
        <div class="achievement-content">
            <div class="achievement-icon">🏆</div>
            <div class="achievement-text">
                <h3>Achievement Unlocked!</h3>
                <p>${achievementId}</p>
            </div>
        </div>
    `;
    
    document.body.appendChild(achievementPopup);
    
    setTimeout(() => {
        achievementPopup.classList.add('show');
    }, 100);
    
    setTimeout(() => {
        achievementPopup.classList.remove('show');
        setTimeout(() => achievementPopup.remove(), 500);
    }, 3000);
}

// Setup keyboard shortcuts
function setupKeyboardShortcuts() {
    document.addEventListener('keydown', (e) => {
        // Check for modifier key (Ctrl/Cmd)
        if (e.ctrlKey || e.metaKey) {
            switch(e.key.toLowerCase()) {
                case 'p': // Profile
                    e.preventDefault();
                    showOwnProfile();
                    break;
                case 'k': // Friends (Keep)
                    e.preventDefault();
                    showFriendModal();
                    break;
                case 'j': // Challenges (Jump)
                    e.preventDefault();
                    showChallengeModal();
                    break;
                case ',': // Settings
                    e.preventDefault();
                    showSettingsModal();
                    break;
                case '/': // Search
                    e.preventDefault();
                    focusSearch();
                    break;
                case 'n': // Notifications
                    e.preventDefault();
                    showNotifications();
                    break;
            }
        }
        
        // Escape key handling
        if (e.key === 'Escape') {
            handleEscapeKey();
        }
    });
}

// Handle escape key press
function handleEscapeKey() {
    // Close dropdowns first
    const dropdown = document.getElementById('userDropdown');
    if (dropdown && dropdown.classList.contains('show')) {
        closeUserDropdown();
        return;
    }
    
    // Then close modals
    const modals = document.querySelectorAll('.auth-modal.show, .settings-modal.show, .profile-modal.show, .friend-modal.show, .challenge-modal.show');
    modals.forEach(modal => {
        closeModal(modal);
    });
}

// Focus search input
function focusSearch() {
    // Open friend modal and focus search
    showFriendModal();
    setTimeout(() => {
        const searchInput = document.getElementById('usernameSearchInput');
        if (searchInput) {
            searchInput.focus();
            searchInput.select();
        }
    }, 300);
}

// Enhanced close modal function
function closeModal(modalElement) {
    if (modalElement) {
        modalElement.classList.add('closing');
        setTimeout(() => {
            if (modalElement.classList.contains('auth-modal') && modalElement.id !== 'authModal') {
                modalElement.remove();
            } else {
                modalElement.classList.remove('show', 'closing');
            }
        }, 300);
    }
}

// Call this after your existing initApp function
document.addEventListener('DOMContentLoaded', () => {
    // Your existing initialization...
    
    // Then initialize enhanced features
    setTimeout(() => {
        initializeEnhancedFeatures();
    }, 1000);
});

// Export for debugging
window.JomBroDebug = {
    state: AppState,
    showState: () => console.table(AppState),
    resetUI: () => location.reload(),
    testNotification: () => showBrowserNotification({ title: 'Test notification' }),
    testAchievement: () => showAchievementAnimation('Test Achievement')
};

console.log('✨ JomBro Enhanced Profile System Ready!');
console.log('💡 Press Ctrl+P for Profile, Ctrl+K for Friends, Ctrl+J for Challenges');
console.log('🐛 Debug: window.JomBroDebug.showState()');
</script>

<!-- Add this CSS for achievement popup -->
<style>
.achievement-popup {
    position: fixed;
    top: 20px;
    left: 50%;
    transform: translateX(-50%) translateY(-100px);
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    padding: 20px 30px;
    border-radius: 15px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
    z-index: 10000;
    opacity: 0;
    transition: all 0.5s ease;
}

.achievement-popup.show {
    transform: translateX(-50%) translateY(0);
    opacity: 1;
}

.achievement-content {
    display: flex;
    align-items: center;
    gap: 15px;
}

.achievement-icon {
    font-size: 2.5rem;
    animation: bounce 2s infinite;
}

.achievement-text h3 {
    margin: 0 0 5px 0;
    font-size: 1.2rem;
}

.achievement-text p {
    margin: 0;
    opacity: 0.9;
}
</style>
